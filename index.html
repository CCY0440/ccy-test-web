<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¹•å°¼å…‹éŸ³æ¨‚(é‡‘å±±æ ¡å€)èª²è¡¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
    }

    /* ä¸Šèª²ï¼šè‰æœ¬ç¶  (èª¿é«˜é£½å’Œï¼Œé‚Šæ¡†åŠ æ·±) */
    .status-present {
      background-color: #dcedc8 !important;
      /* æ›´æœ‰æ„Ÿçš„ç¶ è‰² */
      border: 1.5px solid #9ccc65 !important;
      color: #33691e !important;
    }

    /* è«‹å‡ï¼šæº«æ½¤æœ¨æ£• (å¢åŠ æš–åº¦ï¼Œæ˜é¡¯å€åˆ†) */
    .status-leave {
      background-color: #f0e4d7 !important;
      /* å¸¶æœ‰å¥¶èŒ¶æ„Ÿçš„èƒŒæ™¯ */
      border: 1.5px solid #bcaaa4 !important;
      color: #5d4037 !important;
    }

    /* æ› èª²ï¼šç…™ç‡»ç²‰ç´… (é™ä½äº®åº¦ä½†å¢åŠ è‰²å½©æ¿ƒåº¦) */
    .status-absent {
      background-color: #ffdad9 !important;
      /* æ˜é¡¯çš„ç²‰ç´…èƒŒæ™¯ */
      border: 1.5px solid #ef9a9a !important;
      color: #c62828 !important;
    }

    /* å­¸ç”Ÿç·´ç¿’ï¼šæµ·æ´‹è— (æ¸…çˆ½ã€ç¨ç«‹) */
    .status-practice {
      background-color: #e0f2fe !important;
      /* å¾ˆæ·¡çš„è— */
      border: 1.5px solid #7dd3fc !important;
      /* å¤©ç©ºè—é‚Šæ¡† */
      color: #0c4a6e !important;
      /* æ·±è—æ–‡å­— */
    }

    /* é è¨­/å°šæœªé»åï¼šå†·ç°è‰² (ä½èª¿ã€ç­‰å¾…ä¸­) */
    .status-pending {
      background-color: #f3f4f6 !important;
      border: 1.5px solid #d1d5db !important;
      color: #4b5563 !important;
    }

    /* å´é‚Šæ¬„é¸ä¸­ç‹€æ…‹ï¼šåŠ æ·±èƒŒæ™¯è‰² */
    .teacher-item.active {
      background-color: #e2e8f0 !important;
      /* Slate-200 (æ¯”åŸæœ¬çš„ç°è‰²æ·±) */
      color: #0f172a !important;
      /* æ·±è—é»‘è‰²æ–‡å­— */
      font-weight: 700 !important;
      /* åŠ ç²—æ–‡å­— */
      border-right: 4px solid #3b82f6;
      /* (é¸ç”¨) å³é‚ŠåŠ ä¸€æ¢è—è‰²ç·šæ¢å¢åŠ è­˜åˆ¥åº¦ */
    }

    /* å±•é–‹ç‹€æ…‹çš„å¡ç‰‡æ¨£å¼ */
    .card-expanded {
      height: auto !important;
      /* è®“å…§å®¹æ±ºå®šé«˜åº¦ */
      min-height: min-content;
      z-index: 100 !important;
      /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding-bottom: 12px !important;
      /* å¢åŠ åº•éƒ¨ç·©è¡ */
    }

    /* æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶è®“éš±å½¢çš„æ—¥æ›†é»æ“Šæ„Ÿæ‡‰å€æ’æ»¿æ•´å€‹å€åŸŸ */
    #date-picker::-webkit-calendar-picker-indicator {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 0;
      /* å®Œå…¨é€æ˜ä½†å……æ»¿æ•´æ ¼ */
      z-index: 25;
    }

    @media (max-width: 768px) {

      /* è®“æ‰‹æ©Ÿç‰ˆçš„æ™‚é–“è»¸çª„ä¸€é»é»ï¼Œç•™æ›´å¤šç©ºé–“çµ¦èª²è¡¨ */
      #schedule-container>div:first-child {
        width: 60px !important;
      }
    }
  </style>
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[800] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[900] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> è€å¸«åå–®
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="px-4 py-2">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm relative group">
        <div class="flex items-center gap-1.5 mb-2 text-yellow-700/80">
          <i data-lucide="sticky-note" class="w-3.5 h-3.5"></i>
          <span class="text-xs font-bold">å‚™å¿˜éŒ„</span>
          <span id="memo-status"
            class="ml-auto text-[10px] text-yellow-600 opacity-0 transition-opacity duration-500">å·²å„²å­˜</span>
        </div>
        <textarea id="teacher-memo"
          class="w-full bg-transparent text-xs text-gray-700 resize-none outline-none placeholder-yellow-700/30 leading-relaxed"
          rows="4" placeholder="éš¨æ‰‹è¨˜é»ä»€éº¼..." oninput="handleMemoInput(this.value)"></textarea>
      </div>
    </div>

    <div class="p-4">
      <button onclick="openTeacherModal()"
        class="w-full py-2 text-xs text-gray-500 hover:text-blue-600 border border-dashed rounded-lg flex items-center justify-center gap-1 transition-colors">
        <i data-lucide="settings-2" class="w-3 h-3"></i> ç®¡ç†è€å¸«åå–®
      </button>

      <button onclick="openInstructionsModal()"
        class="w-full py-2 mt-2 text-xs text-amber-600 hover:bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-medium">
        <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> ç³»çµ±ä½¿ç”¨èªªæ˜
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">ç¶²é ç‰ˆæœ¬ v1.35</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex flex-wrap lg:flex-nowrap items-center gap-y-3 gap-x-4 shadow-sm sticky top-0 z-30">

      <div class="flex items-center gap-3 order-1 flex-1 min-w-[150px]">
        <button onclick="toggleSidebar()"
          class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden shrink-0">
          <i data-lucide="menu"></i>
        </button>

        <div class="flex flex-col min-w-0">
          <h2 id="main-title" class="text-lg md:text-xl font-bold text-neutral-800 truncate leading-tight">
            è¼‰å…¥ä¸­...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium mt-0.5 -ml-2">
            å˜—è©¦é€£ç·š...
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 order-2 lg:order-3 shrink-0">
        <button onclick="freezeTeacherHistory()"
          class="flex items-center gap-2 bg-amber-50 text-amber-700 border border-amber-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-amber-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="archive" class="w-4 h-4"></i>
          <span>å‡çµæ­·å²</span>
        </button>

        <button onclick="openModal()"
          class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="hidden md:inline">æ–°å¢èª²ç¨‹</span><span class="md:hidden">æ–°å¢</span>
        </button>
      </div>

      <div
        class="flex items-center justify-between gap-3 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm order-3 w-full lg:w-auto lg:mx-4 lg:order-2 relative overflow-hidden">

        <button onclick="changeWeek(-1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>

        <div class="relative flex-1 flex justify-center items-center group px-2">

          <span id="current-date-range"
            class="text-sm md:text-base font-bold text-neutral-800 font-mono tracking-wide text-center cursor-pointer group-hover:text-blue-600 transition-colors select-none pointer-events-none">
            è¨ˆç®—ä¸­...
          </span>

          <input type="date" id="date-picker"
            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
            onchange="handleDatePick(this.value)">
        </div>

        <button onclick="changeWeek(1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>

    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1000] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] md:w-full max-w-md p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold">æ–°å¢èª²ç¨‹è³‡æ–™</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="course-form" class="space-y-4">
        <div class="space-y-3 pb-2 border-b border-gray-100">
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">èª²ç¨‹åç¨± ( å¦‚:EG-1ã€AG-1 )</label>
            <input type="text" name="subject" placeholder="è«‹è¼¸å…¥ç§‘ç›®åç¨±"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">å­¸ç”Ÿå§“å</label>
              <input type="text" name="course_name" required placeholder="å§“å"
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">å­¸ç”Ÿé›»è©±</label>
              <input type="tel" name="phone" placeholder="è¯çµ¡é›»è©±"
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
          </div>
        </div>

        <div class="space-y-3 pb-2 border-b border-gray-100">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">è² è²¬è€å¸«</label>
              <select name="teacher_id" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none"></select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">ä¸Šèª²æ˜ŸæœŸ</label>
              <select name="day_of_week" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none">
                <option value="1">é€±ä¸€</option>
                <option value="2">é€±äºŒ</option>
                <option value="3">é€±ä¸‰</option>
                <option value="4">é€±å››</option>
                <option value="5">é€±äº”</option>
                <option value="6">é€±å…­</option>
                <option value="7">é€±æ—¥</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">é–‹å§‹æ™‚é–“</label>
              <input type="time" name="start_time" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">çµæŸæ™‚é–“</label>
              <input type="time" name="end_time" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">æ•™å®¤</label>
            <input type="text" name="room_no" placeholder="æ•™å®¤åç¨±"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">è–ªè³‡ (NT$)</label>
            <input type="number" name="amount" min="0" placeholder="0"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">èª²ç¨‹ç‹€æ…‹</label>
            <select name="color_class"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none">
              <option value="status-pending" selected>â¬œ å°šæœªé»å (ç°)</option>
              <option value="status-present">âœ… ä¸Šèª² (ç¶ )</option>
              <option value="status-leave">â˜• è«‹å‡ (å’–)</option>
              <option value="status-absent">âŒ æ› èª² (ç´…)</option>
              <option value="status-practice">ğŸ¹ å­¸ç”Ÿç·´ç¿’ (è—)</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-4 gap-4 mt-4 pt-4 border-t border-gray-100">

          <div class="col-span-3 relative">
            <div class="flex justify-between items-center mb-1">
              <label class="text-xs font-bold text-gray-400">å‚™è¨»å…§å®¹</label>
              <div class="flex items-center gap-1.5 cursor-pointer group">
                <input type="checkbox" name="is_persistent" id="is_persistent"
                  class="w-3.5 h-3.5 rounded border-gray-300 cursor-pointer text-blue-600 focus:ring-0">
                <label for="is_persistent"
                  class="text-[10px] text-gray-400 font-medium cursor-pointer group-hover:text-blue-600 transition-colors select-none">
                  è¨­ç‚ºå¸¸é§ (æ¯é€±é¡¯ç¤º)
                </label>
              </div>
            </div>
            <textarea name="record_remark" placeholder="ä¾‹å¦‚ï¼šæœƒè€ƒè«‹å‡ã€è£œèª²..."
              class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-100 outline-none resize-none h-[72px]"
              rows="2"></textarea>
          </div>

          <div class="col-span-1 flex flex-col h-full">
            <label class="block text-xs font-bold text-gray-400 mb-1 text-center whitespace-nowrap">èª²ç¨‹æ€§è³ª</label>

            <div
              class="flex flex-col items-center justify-center bg-gray-50 border border-dashed border-gray-300 rounded-lg h-[72px] w-full px-2 hover:bg-gray-100 transition-colors cursor-pointer group relative">

              <input type="checkbox" name="is_temporary" id="is_temporary"
                class="w-5 h-5 rounded border-gray-300 cursor-pointer accent-blue-600 z-10">
              <label for="is_temporary"
                class="text-[11px] font-bold text-neutral-500 mt-1 cursor-pointer group-hover:text-blue-600 z-10 whitespace-nowrap">åƒ…é™æœ¬é€±</label>

              <div class="absolute inset-0" onclick="document.getElementById('is_temporary').click()"></div>
            </div>
          </div>
        </div>

        <p class="text-[10px] text-amber-600 mt-2 flex items-center gap-1 italic">
          <i data-lucide="alert-circle" class="w-3 h-3"></i> å‚™è¨»å…§å®¹èˆ‡å–®æ¬¡è¨­å®šä¸æœƒé€£å‹•åˆ°æœªä¾†èª²è¡¨ã€‚
        </p>

        <div class="pt-4">
          <button type="submit"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜èª²ç¨‹è³‡æ–™
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="teacher-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1000] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-80 p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold">è€å¸«åå–®ç®¡ç†</h3>
        <button onclick="closeTeacherModal()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex gap-2 mb-4">
        <input type="text" id="new-teacher-name" placeholder="å§“å"
          class="flex-1 border rounded-lg px-2 py-1 text-sm outline-none" />
        <button onclick="addTeacher()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
          æ–°å¢
        </button>
      </div>
      <div id="teacher-manage-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
    </div>
  </div>

  <div id="instructions-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-lg p-0 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col border border-neutral-200">

      <div class="bg-neutral-50 px-6 py-4 border-b border-neutral-200 flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2 text-neutral-800">
          ğŸ“… ç³»çµ±ä½¿ç”¨èªªæ˜ (v1.35ç‰ˆæœ¬)
        </h3>
        <button onclick="closeInstructionsModal()"
          class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-200 rounded-full transition-all">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 text-sm text-neutral-700 leading-relaxed">

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-700 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
            è®Šæ›´ã€Œé»åã€orã€Œç·¨è¼¯å›ºå®šèª²è¡¨ã€
          </h4>
          <div class="grid gap-3">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-blue-800 mb-1 flex items-center gap-1"><i data-lucide="mouse-pointer-2"
                  class="w-3.5 h-3.5"></i> é»å (é»æ“Šå¡ç‰‡)</h5>
              <p class="text-xs text-blue-900/80">â€¢ åƒ…å½±éŸ¿ã€Œé€™ä¸€å¤©ã€ã€‚é©ç”¨æ–¼é»åã€æ„Ÿå†’è«‹å‡ã€æ› èª²æˆ–è‡¨æ™‚è£œèª²ã€‚</p>
            </div>
            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-orange-800 mb-1 flex items-center gap-1"><i data-lucide="edit-3"
                  class="w-3.5 h-3.5"></i> ç·¨è¼¯å›ºå®šèª²è¡¨ (å³ä¸Šè§’ç­†é ­)</h5>
              <p class="text-xs text-orange-900/80">â€¢ æœƒå½±éŸ¿ã€Œæœªä¾†æ¯ä¸€é€±ã€ã€‚é©ç”¨æ–¼æ›´æ›ä¸Šèª²æ™‚æ®µã€æ°¸ä¹…æ›´æ›æ•™å®¤ç­‰ã€‚</p>
            </div>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-700 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
            å‡çµæ­·å² (ä¿è­·æ­·å²ç´€éŒ„)
          </h4>

          <ul class="space-y-3 mt-3">

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-neutral-400 shrink-0 mt-2"></span>
              <p class="text-neutral-700">
                <b class="text-neutral-900">åŠŸèƒ½ï¼š</b>å°‡éå»çš„èª²ç¨‹å‡çµï¼Œé˜²æ­¢å› ä¿®æ”¹å›ºå®šèª²è¡¨è€Œå°è‡´èˆŠç´€éŒ„éºå¤±ã€‚
              </p>
            </li>

            <li class="list-none">
              <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                <ul class="space-y-1">
                  <li class="flex gap-2.5 items-start">
                    <span class="w-1 h-1 rounded-full bg-amber-500 shrink-0 mt-2"></span>
                    <div>
                      <p class="font-bold text-amber-800 text-sm">ç°¡å–®å°æƒ…å¢ƒæ¨¡æ“¬ï¼š</p>
                      <p class="text-xs text-amber-900/70">
                        ç•¶é•·å‡å­¸ç”Ÿæº–å‚™å›æ­¸èª²å ‚æ™‚ï¼Œèƒ½å¿«é€Ÿå‡çµ<b>é•·å‡æ™‚æœŸçš„æ—¥æœŸ</b>ï¼Œå‡çµå¾Œå†æ”¹å‹•å¾ŒçºŒå­¸ç”Ÿçš„èª²ç¨‹ã€‚
                      </p>
                    </div>
                  </li>
                  <li class="flex gap-2.5 items-start">
                    <span class="w-1 h-1 rounded-full bg-amber-500 shrink-0 mt-2"></span>
                    <div>
                      <p class="font-bold text-amber-800 text-sm">å¿«é€Ÿè·³è½‰å°æŠ€å·§ï¼š</p>
                      <p class="text-xs text-amber-900/70">
                        é»æ“Šã€Œè¨­å®šä¸Šæœˆã€æŒ‰éˆ•ï¼Œæ¯é»ä¸€æ¬¡æ—¥æœŸå°±æœƒ<b>å¾€å›æ¨ä¸€å€‹æœˆ</b>ï¼Œæ–¹ä¾¿æ‚¨å¿«é€Ÿå‡çµå¥½å¹¾å€‹æœˆå‰çš„è³‡æ–™ï¼
                      </p>
                    </div>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-700 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">3</span>
            å‚™è¨»åŠŸèƒ½
          </h4>
          <ul class="space-y-3 mt-3">
            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-neutral-400 shrink-0 mt-2"></span>
              <p class="text-neutral-700"><b class="text-neutral-900">ä¸å‹¾é¸è¨­ç‚ºå¸¸é§ï¼š</b>é€™å‰‡å‚™è¨»åªæœƒå‡ºç¾åœ¨ã€Œä»Šå¤©ã€ï¼Œé©åˆè¨˜éŒ„ã€Œç•¶å¤©æ„Ÿå†’è«‹å‡çš„å­¸ç”Ÿã€ç­‰ã€‚</p>
            </li>
            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-neutral-400 shrink-0 mt-2"></span>
              <p class="text-neutral-700"><b class="text-neutral-900">å‹¾é¸è¨­ç‚ºå¸¸é§ï¼š</b>é€™å‰‡å‚™è¨»æœƒå‡ºç¾åœ¨ã€Œæœªä¾†æ¯ä¸€é€±ã€ï¼Œé©åˆè¨˜éŒ„ã€Œé•·å‡ã€å‡ºåœ‹ã€æº–å‚™è€ƒè©¦ã€ç­‰é•·æœŸè«‹å‡çš„å­¸ç”Ÿã€‚</p>
            </li>
          </ul>
        </section>

        <hr class="border-gray-100">

        <section class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
          <h4 class="font-bold text-indigo-800 mb-3 flex items-center gap-2">
            <i data-lucide="sparkles" class="w-4 h-4"></i> æ•ˆç‡æ·å¾‘
          </h4>

          <ul class="space-y-3">

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">å¿«é€Ÿåˆ‡æ›èµ·å§‹æ—¥æœŸ</p>
                <p class="text-xs text-indigo-800/70">é»æ“Šç•«é¢æ­£ä¸Šæ–¹çš„ã€Œæ—¥æœŸç¯„åœã€ï¼Œå³å¯å½ˆå‡ºæ—¥æ›†é¸æ“‡æ‚¨æƒ³é¡¯ç¤ºçš„ç¬¬ä¸€å¤©ã€‚</p>
              </div>
            </li>

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">æŸ¥çœ‹å®Œæ•´èª²ç¨‹è³‡è¨Š</p>
                <p class="text-xs text-indigo-800/70">é»æ“Šå¡ç‰‡å³ä¸Šè§’çš„ã€Œå‘ä¸‹ç®­é ­ã€å¯å±•é–‹å¡ç‰‡ï¼ŒæŸ¥çœ‹é›»è©±ã€è–ªè³‡èˆ‡æ•™å®¤ã€‚</p>
              </div>
            </li>

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">æ–°å¢ç‰¹æ®Š/è‡¨æ™‚æ•™å®¤</p>
                <p class="text-xs text-indigo-800/70">æ–°å¢èª²ç¨‹æ™‚å‹¾é¸ã€Œåƒ…é™æœ¬é€±ã€ï¼Œè³‡æ–™å°±ä¸æœƒå‡ºç¾åœ¨å…¶ä»–é€±æ¬¡ï¼Œé©åˆæœ‰èª¿èª²ã€æ–°å¢è‡¨æ™‚å–®é€±èª²ç¨‹æˆ–é ç´„åˆ¶æ•™å®¤ã€‚</p>
              </div>
            </li>
          </ul>
        </section>

        <section
          class="text-[11px] text-gray-400 px-4 space-y-1 bg-gray-50/50 py-3 rounded-lg border border-dashed border-gray-200">
          <p class="font-bold mb-1 text-gray-500">ç‰¹åˆ¥æé†’</p>
          <ul class="space-y-1.5">
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>ä½¿ç”¨éç¨‹è‹¥æœ‰é¡¯ç¤ºä»»ä½•éŒ¯èª¤è¨Šæ¯ï¼Œè«‹ç‚ºè¨­è¨ˆå¸«ä¿ç•™é¡¯ç¤ºçš„éŒ¯èª¤è³‡è¨Šï¼Œè¬è¬ã€‚</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>æœ‰ä»»ä½•ç›¸é—œçš„ä¿®æ”¹å»ºè­°è«‹è¯ç¹« <b class="text-gray-500">é®ªé­šè€å¸«</b> :)</p>
            </li>
          </ul>
        </section>

        <section class="text-center space-y-3 pt-2">
          <button onclick="closeInstructionsModal()"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all active:scale-95 shadow-md">
            æˆ‘ç­è§£äº†
          </button>
        </section>

      </div>
    </div>
  </div>

  <div id="freeze-date-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1200] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-80 p-6 shadow-2xl border border-amber-100">
      <h3 class="font-bold mb-4 flex items-center gap-2 text-amber-800">
        <i data-lucide="archive" class="w-4 h-4"></i> è‡ªè¨‚å‡çµç¯„åœ
      </h3>

      <div class="flex gap-2 mb-4">
        <button onclick="quickSetFreezeDates('current')"
          class="flex-1 py-1.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-md hover:bg-amber-100 hover:text-amber-700 transition-colors">è¨­å®šæœ¬æœˆ</button>
        <button onclick="quickSetFreezeDates('last')"
          class="flex-1 py-1.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-md hover:bg-amber-100 hover:text-amber-700 transition-colors">è¨­å®šä¸Šæœˆ</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-400 mb-1">èµ·å§‹æ—¥æœŸ (From)</label>
          <input type="date" id="freeze-start-date"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-100" />
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-400 mb-1">çµæŸæ—¥æœŸ (To)</label>
          <input type="date" id="freeze-end-date"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-100" />
        </div>

        <div class="pt-2">
          <button onclick="executeFreeze()"
            class="w-full bg-amber-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-amber-700 transition-all active:scale-95">
            ç¢ºèªä¸¦åŸ·è¡Œå‡çµ
          </button>
          <button onclick="closeFreezeModal()" class="w-full text-gray-400 text-xs py-2 mt-1 hover:text-gray-600">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co"; // è«‹ç¢ºèªæ‚¨çš„ URL
    const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP"; // è«‹ç¢ºèªæ‚¨çš„ KEY
    const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentTid = null;
    let editingId = null;
    let editingCurrentStatus = null;
    let editingDateStr = null;
    // --- æ–°å¢å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†æš«å­˜è³‡æ–™èˆ‡æ’åº ---
    let _cachedSchedule = []; // æš«å­˜èª²è¡¨è³‡æ–™
    let _cachedRecords = [];  // æš«å­˜ç´€éŒ„è³‡æ–™
    let _userSortOrder = [];  // è¨˜ä½ä½¿ç”¨è€…æ’å¥½çš„å¡ç‰‡é †åº (å­˜ ID)

    // --- ä½¿ç”¨èªªæ˜å½ˆçª—æ§åˆ¶ ---
    function openInstructionsModal() {
      // é–‹å•Ÿæ™‚è‡ªå‹•æ”¶èµ·æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
      document.getElementById("instructions-modal").classList.remove("hidden");
    }

    function closeInstructionsModal() {
      document.getElementById("instructions-modal").classList.add("hidden");
    }

    // --- æ‹–æ›³æ’åºåŠŸèƒ½æ ¸å¿ƒ ---

    // 1. é–‹å§‹æ‹–æ›³
    function handleDragStart(e, id) {
      e.dataTransfer.setData("text/plain", id);
      e.dataTransfer.effectAllowed = "move";
      // è®“è¢«æ‹–çš„å¡ç‰‡ç¨å¾®è®Šé€æ˜ï¼Œå¢åŠ è¦–è¦ºå›é¥‹
      e.target.style.opacity = '0.4';
    }

    // 2. æ‹–æ›³çµæŸ (ä¸ç®¡æœ‰æ²’æœ‰æˆåŠŸæ”¾ä¸‹ï¼Œéƒ½è¦æŠŠé€æ˜åº¦æ”¹å›ä¾†)
    function handleDragEnd(e) {
      e.target.style.opacity = '1';
    }

    // 3. æ”¾ä¸‹å¡ç‰‡ (äº¤æ›é †åº)
    function handleDrop(e, targetId) {
      e.preventDefault();
      e.stopPropagation();

      const sourceId = e.dataTransfer.getData("text/plain");
      if (sourceId === targetId) return; // è‡ªå·±ä¸Ÿè‡ªå·±ï¼Œä¸åšäº‹

      // èª¿æ•´é™£åˆ—é †åº
      const fromIndex = _userSortOrder.indexOf(sourceId);
      const toIndex = _userSortOrder.indexOf(targetId);

      if (fromIndex > -1 && toIndex > -1) {
        // æŠŠåŸæœ¬çš„é‚£å¼µæ‹¿å‡ºä¾†
        _userSortOrder.splice(fromIndex, 1);
        // æ’éšŠåˆ°æ–°ç›®æ¨™çš„ä½ç½®
        _userSortOrder.splice(toIndex, 0, sourceId);

        // â˜… é‡æ–°ç¹ªåœ–ï¼é€™æ¨£ç•«é¢æ‰æœƒè®Š
        renderSchedule(_cachedSchedule, _cachedRecords);
      }
    }

    // --- ç©æœ¨ä¸€ï¼šæ—¥æœŸæ§åˆ¶æ ¸å¿ƒ ---
    // 1. è¨­å®šç›®å‰é¸æ“‡çš„æ—¥æœŸ (é è¨­ä»Šå¤©)
    let currentBaseDate = new Date();

    // 2. å·¥å…·ï¼šå–å¾—æœ¬é€±ä¸€çš„æ—¥æœŸ (é€™æ¨£æˆ‘å€‘æ‰çŸ¥é“é€™é€±æ˜¯å¾å“ªå¤©é–‹å§‹)
    function getMonday(d) {
      d = new Date(d);
      var day = d.getDay(),
        diff = d.getDate() - day + (day == 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    // 3. å·¥å…·ï¼šåŠ æ¸›å¤©æ•¸ (ç”¨ä¾†åˆ‡æ›ä¸Šä¸€é€±ã€ä¸‹ä¸€é€±)
    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // 4. å·¥å…·ï¼šæŠŠæ—¥æœŸè®Šå­—ä¸² (ä¿®æ­£ç‰ˆï¼šä½¿ç”¨ç•¶åœ°æ™‚é–“ï¼Œè§£æ±ºæ—©æ™¨æ—¥æœŸè·‘æ‰çš„å•é¡Œ)
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // 5. åˆ‡æ›é€±æ¬¡çš„åŠŸèƒ½
    function changeWeek(direction) {
      // direction: -1 ä»£è¡¨ä¸Šä¸€é€±ï¼Œ 1 ä»£è¡¨ä¸‹ä¸€é€±
      currentBaseDate = addDays(currentBaseDate, direction * 7);

      // åˆ‡æ›å¾Œï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ (é€™æ¨£ç•«é¢æ‰æœƒè®Š)
      refreshData();
    }

    // 1. è™•ç†æ—¥æ›†é¸æ“‡ (æ»¾å‹•å¼ï¼šé¸å“ªå¤©ï¼Œå“ªå¤©å°±æ˜¯èµ·é»)
    function handleDatePick(val) {
      if (!val) return;
      // ç›´æ¥æŠŠ currentBaseDate è¨­ç‚ºä½¿ç”¨è€…é¸çš„é‚£ä¸€å¤© (ä¸æ‰¾ç¦®æ‹œä¸€äº†)
      currentBaseDate = new Date(val);
      refreshData();
    }

    // â–¼ é—œéµä¿®æ­£ 1ï¼šå®£å‘Šå…¨åŸŸè®Šæ•¸ä¾†å­˜è€å¸«è³‡æ–™ â–¼
    let allTeachers = [];
    let memoTimeout = null;

    // 1. åˆå§‹åŒ–é é¢
    window.onload = async () => {
      await fetchTeachers();
      lucide.createIcons();
    };

    // 2. ç²å–è€å¸«åˆ—è¡¨ (ä¿®æ­£ç‰ˆ)
    async function fetchTeachers() {
      // é€™è£¡ä¸€å®šè¦æŠŠ memo æ¬„ä½ä¹Ÿé¸å‡ºä¾† (select * æœƒåŒ…å« memo)
      const { data, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");

      if (error) return setStatus("è¼‰å…¥è€å¸«å¤±æ•—", "error");

      // â–¼ é—œéµä¿®æ­£ 2ï¼šæŠŠæŠ“ä¸‹ä¾†çš„è³‡æ–™å­˜åˆ°å…¨åŸŸè®Šæ•¸ allTeachers â–¼
      allTeachers = data;

      const menu = document.getElementById("teacher-menu");
      const select = document.querySelector('select[name="teacher_id"]');
      const manageList = document.getElementById("teacher-manage-list");

      menu.innerHTML = "";
      select.innerHTML = "";
      manageList.innerHTML = "";

      data.forEach((t, index) => {
        // A. å´é‚Šæ¬„æŒ‰éˆ• (ç˜¦èº«ç‰ˆ)
        const btn = document.createElement("button");
        btn.dataset.id = t.id;

        // ä¿®æ”¹é‡é» 1: p-3 æ”¹æˆ py-1.5 px-2 (ä¸Šä¸‹è®Šçª„ï¼Œå·¦å³é©ä¸­)ï¼Œgap-3 æ”¹æˆ gap-2 (é–“è·è®Šå°)
        btn.className = `teacher-item w-full flex items-center gap-2 py-1.5 px-2 rounded-lg text-left transition-all hover:bg-gray-100 ${currentTid === t.id ? "active bg-gray-100" : ""}`;

        btn.onclick = () => switchTeacher(t.id, t.name);

        // ä¿®æ”¹é‡é» 2: é ­åƒæ¡†å¾ w-8 h-8 æ”¹æˆ w-6 h-6 (è®Šå°)ï¼ŒIcon åŠ ä¸Š class="w-3.5 h-3.5" (è®Šç²¾ç·»)
        btn.innerHTML = `
            <span class="w-6 h-6 rounded bg-gray-100 flex items-center justify-center text-gray-500 shrink-0">
                <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </span>
            <span class="font-medium text-sm truncate">${t.name}</span>
        `;
        menu.appendChild(btn);

        // B. è¡¨å–®ä¸‹æ‹‰é¸å–®
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;

        // C. ç®¡ç†æ¸…å–®
        manageList.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm"><span>${t.name}</span><button onclick="deleteTeacher('${t.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>`;

        // é è¨­é¸ä¸­ç¬¬ä¸€ä½
        if (!currentTid && index === 0) switchTeacher(t.id, t.name);
      });
      lucide.createIcons();
    }

    async function switchTeacher(tid, name) {
      currentTid = tid;
      document.getElementById("main-title").textContent = `${name} Â· æœ¬é€±èª²è¡¨`;

      // â–¼ é—œéµä¿®æ”¹ 2ï¼šè™•ç†æŒ‰éˆ•è®Šè‰²é‚è¼¯ â–¼
      // 1. å…ˆç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
      document.querySelectorAll(".teacher-item").forEach((btn) => {
        btn.classList.remove("active"); // ç§»é™¤ CSS å®šç¾©çš„æ·±è‰²æ¨£å¼
        btn.classList.remove("bg-gray-100"); // ç§»é™¤åŸæœ¬å¯èƒ½æ®˜ç•™çš„æ·ºè‰²èƒŒæ™¯
      });

      // 2. æ‰¾åˆ°ç¾åœ¨é»æ“Šçš„é€™ä½è€å¸«çš„æŒ‰éˆ•ï¼ŒåŠ ä¸Š active
      const activeBtn = document.querySelector(`.teacher-item[data-id="${tid}"]`);
      if (activeBtn) {
        activeBtn.classList.add("active");
      }
      // â–² ä¿®æ”¹çµæŸ â–²


      // --- ä¸‹é¢ç¶­æŒæ‚¨åŸæœ¬çš„å‚™å¿˜éŒ„èˆ‡è³‡æ–™è®€å–é‚è¼¯ ---
      const targetTeacher = allTeachers.find(t => t.id === tid);
      const memoInput = document.getElementById("teacher-memo");
      if (memoInput) {
        memoInput.value = (targetTeacher && targetTeacher.memo) ? targetTeacher.memo : "";
      }

      if (window.innerWidth < 768) {
        toggleSidebar();
      }

      await refreshData();
    }

    // 4. å‚™å¿˜éŒ„è‡ªå‹•å„²å­˜åŠŸèƒ½ (æ–°å¢)
    async function handleMemoInput(text) {
      const status = document.getElementById("memo-status");
      if (status) {
        status.textContent = "è¼¸å…¥ä¸­...";
        status.classList.remove("opacity-0");
      }

      // é˜²æ‰‹éœ‡ï¼šæ¸…é™¤ä¸Šä¸€æ¬¡çš„è¨ˆæ™‚å™¨
      if (memoTimeout) clearTimeout(memoTimeout);

      // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼šåœæ­¢æ‰“å­— 0.8 ç§’å¾Œæ‰å„²å­˜
      memoTimeout = setTimeout(async () => {
        if (!currentTid) return;

        if (status) status.textContent = "å„²å­˜ä¸­...";

        // æ›´æ–°è³‡æ–™åº«
        const { error } = await _client
          .from("teachers")
          .update({ memo: text })
          .eq("id", currentTid);

        if (!error) {
          if (status) status.textContent = "å·²å„²å­˜";

          // â–¼ é—œéµä¿®æ­£ 4ï¼šå„²å­˜æˆåŠŸå¾Œï¼ŒåŒæ­¥æ›´æ–°æœ¬åœ°è®Šæ•¸ allTeachers â–¼
          // é€™æ¨£åˆ‡æ›å»åˆ¥çš„è€å¸«å†åˆ‡å›ä¾†ï¼Œè³‡æ–™æ‰æœƒæ˜¯æ–°çš„
          const localTeacher = allTeachers.find(t => t.id === currentTid);
          if (localTeacher) {
            localTeacher.memo = text;
          }

          // 2ç§’å¾Œéš±è—ç‹€æ…‹æ–‡å­—
          setTimeout(() => {
            if (status) status.classList.add("opacity-0");
          }, 2000);
        } else {
          console.error("å„²å­˜å¤±æ•—:", error); // åœ¨ Console é¡¯ç¤ºéŒ¯èª¤ä»¥ä¾¿é™¤éŒ¯
          if (status) {
            status.textContent = "å„²å­˜å¤±æ•—";
            status.classList.remove("text-yellow-600");
            status.classList.add("text-red-500");
          }
        }
      }, 800);
    }

    // 2. é‡æ–°æ•´ç†è³‡æ–™ (ä¿®æ”¹ç‰ˆï¼šä»¥ currentBaseDate ç‚ºèµ·é»ï¼Œå¾€å¾Œæ¨ 7 å¤©)
    async function refreshData() {
      if (!currentTid) return;

      // --- ä¿®æ”¹é‡é»é–‹å§‹ ---
      // åŸæœ¬ï¼šconst monday = getMonday(currentBaseDate);
      // ç¾åœ¨ï¼šç›´æ¥ç”¨ currentBaseDate ç•¶ä½œé–‹å§‹æ—¥
      const startDate = new Date(currentBaseDate);
      const endDate = addDays(startDate, 6); // å¾€å¾Œæ¨ 6 å¤© (å…± 7 å¤©)

      const startStr = formatDate(startDate);
      const endStr = formatDate(endDate);
      // --- ä¿®æ”¹é‡é»çµæŸ ---

      document.getElementById("current-date-range").textContent = `${startStr} ~ ${endStr}`;

      // åŒæ­¥éš±è—æ—¥æ›†çš„å€¼
      const picker = document.getElementById("date-picker");
      if (picker) picker.value = startStr;

      setStatus("æ­£åœ¨åŒæ­¥ç´€éŒ„...");

      try {
        // A. æŠ“æ¯ç‰ˆ (é‚è¼¯ä¸è®Šï¼šåªè¦æ—¥æœŸæœ‰é‡ç–Šæˆ–æ˜¯å¸¸é§çš„éƒ½æŠ“)
        const { data: sData, error: sErr } = await _client
          .from("schedules")
          .select("*")
          .eq("teacher_id", currentTid)
          .or(`target_date.is.null,and(target_date.gte.${startStr},target_date.lte.${endStr})`);
        if (sErr) throw sErr;

        // B. æŠ“æ—¥è¨˜ (æŠ“é€™ 7 å¤©çš„ç´€éŒ„)
        const { data: rData, error: rErr } = await _client.from("lesson_records").select("*")
          .eq("teacher_id", currentTid)
          .gte("actual_date", startStr)
          .lte("actual_date", endStr);
        if (rErr) throw rErr;

        _cachedSchedule = sData || [];
        _cachedRecords = rData || [];

        // C. åŸ·è¡Œç¹ªåœ– (æŠŠ startDate å‚³é€²å»ï¼Œå› ç‚ºç¹ªåœ–éœ€è¦çŸ¥é“ç¬¬ä¸€å¤©æ˜¯èª°)
        renderSchedule(_cachedSchedule, _cachedRecords, startDate);

        // ... (ä¸‹æ–¹çš„è¨ˆç®—çµ±è¨ˆé‚è¼¯ç¶­æŒä¸è®Š) ...
        const total = _cachedSchedule.length;
        const attendedOrAbsent = _cachedRecords.filter(r =>
          ['attended', 'status-present', 'absent', 'status-absent'].includes(r.status)
        ).length;
        const onLeave = _cachedRecords.filter(r =>
          ['leave', 'status-leave'].includes(r.status)
        ).length;
        setStatus(`ç¸½å ‚æ•¸ï¼š${total} | å·²é»å+æ› èª²ï¼š${attendedOrAbsent} | è«‹å‡ï¼š${onLeave}`, "success");

      } catch (e) {
        console.error(e);
        setStatus(`é€£ç·šéŒ¯èª¤: ${e.message}`, "error");
      }
    }

    // --- æ–°å¢ï¼šå¿«é€Ÿåˆ‡æ›èª²ç¨‹ç‹€æ…‹ ---
    async function toggleCourseStatus(id, currentStatus) {
      // å®šç¾©ç‹€æ…‹å¾ªç’°é †åºï¼šç° -> ç¶  -> å’– -> ç´… -> ç°
      const statusCycle = {
        'status-pending': 'status-present', // ç° -> ç¶  (é»å)
        'status-present': 'status-leave',   // ç¶  -> å’– (è«‹å‡)
        'status-leave': 'status-absent',    // å’– -> ç´… (æ› èª²)
        'status-absent': 'status-pending'   // ç´… -> ç° (é‡ç½®)
      };

      // å¦‚æœç›®å‰çš„ç‹€æ…‹ä¸åœ¨å¾ªç’°ä¸­ (ä¾‹å¦‚èˆŠè³‡æ–™)ï¼Œé è¨­è½‰ç‚ºç¶ è‰²
      const nextStatus = statusCycle[currentStatus] || 'status-present';

      // æ›´æ–°è³‡æ–™åº«
      const { error } = await _client
        .from("schedules")
        .update({ color_class: nextStatus })
        .eq("id", id);

      if (!error) {
        // æ›´æ–°æˆåŠŸå¾Œï¼Œé‡æ–°è®€å–è³‡æ–™ä»¥åˆ·æ–°ç•«é¢
        await refreshData();
      } else {
        alert("ç‹€æ…‹åˆ‡æ›å¤±æ•—");
      }
    }

    // 3. ç¹ªåœ–å‡½å¼ (ä¿®æ”¹ç‰ˆï¼šæ¥æ”¶ startDateï¼Œå‹•æ…‹ç”¢ç”Ÿ 7 å€‹æ¬„ä½)
    function renderSchedule(list, records = [], startDate) {
      const container = document.getElementById("schedule-container");
      if (!container) return;
      container.innerHTML = "";

      const slots = ["09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
      const ROW_HEIGHT = 120;
      const HEADER_HEIGHT = 60;
      const START_HOUR = 9;
      const CARD_WIDTH = 140;
      const MIN_COL_WIDTH = CARD_WIDTH;
      // å®šç¾©æ˜ŸæœŸåç¨±å°ç…§è¡¨ (0=é€±æ—¥, 1=é€±ä¸€...)
      const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

      // 1. å»ºç«‹å·¦å´æ™‚é–“è»¸
      const timeCol = document.createElement("div");
      // ä¿®æ”¹é‡é»ï¼šæé«˜ z-index åˆ° 500 (é«˜æ–¼èª²è¡¨å¡ç‰‡)ï¼Œç¢ºä¿æ©«å‘æ²å‹•æ™‚å›ºå®šåœ¨æœ€å·¦é‚Š
      timeCol.className = "sticky left-0 z-[500] bg-white border-r border-[#e9e9e7] flex flex-col shrink-0";
      timeCol.style.width = "90px";

      const timeHeader = document.createElement("div");
      // ä¿®æ”¹é‡é»ï¼š
      // 1. z-[600]ï¼šå®ƒæ˜¯ã€Œè§’è½ä¹‹ç‹ã€ï¼Œå¿…é ˆé«˜æ–¼æ‰€æœ‰äººï¼Œæ‰ä¸æœƒåœ¨æ²å‹•æ™‚æ¶ˆå¤±
      // 2. ç§»é™¤ border-rï¼šå› ç‚ºå¤–å±¤ timeCol å·²ç¶“æœ‰ border-r äº†ï¼Œè£¡é¢å†åŠ æœƒå°è‡´ 1px çš„å°é½Šæ–·å±¤
      timeHeader.className = "sticky top-0 z-[600] bg-gray-50 border-b border-[#e9e9e7] text-sm font-bold text-gray-600 flex items-center justify-center leading-tight box-border";
      timeHeader.style.height = `${HEADER_HEIGHT}px`;
      timeHeader.textContent = "æ™‚é–“";
      timeCol.appendChild(timeHeader);
      slots.forEach(h => {
        const cell = document.createElement("div");
        cell.className = "flex items-center justify-center text-sm font-semibold text-gray-500 border-b border-[#e9e9e7] bg-gray-50/50";
        cell.style.height = `${ROW_HEIGHT}px`;
        cell.textContent = `${h}:00`;
        timeCol.appendChild(cell);
      });
      container.appendChild(timeCol);

      // --- ä¿®æ”¹é‡é»ï¼šå‹•æ…‹ç”¢ç”Ÿ 7 å¤© ---
      // å¦‚æœæ²’æœ‰å‚³å…¥ startDateï¼Œå°±ç”¨å…¨åŸŸçš„ (é˜²å‘†)
      const baseDate = startDate || currentBaseDate;

      // è¿´åœˆè·‘ 0~6 (ä»£è¡¨ç¬¬1å¤©åˆ°ç¬¬7å¤©)
      for (let i = 0; i < 7; i++) {
        // è¨ˆç®—é€™ä¸€æ¬„çš„æ—¥æœŸ
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);

        // å–å¾—é€™ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾ (0~6)
        const jsDay = thisDayDate.getDay();

        // è½‰æ›æˆè³‡æ–™åº«çš„ day_of_week (1=é€±ä¸€... 7=é€±æ—¥)
        // JSçš„é€±æ—¥æ˜¯0ï¼Œæˆ‘å€‘è¦è½‰æˆ7
        const dbDay = jsDay === 0 ? 7 : jsDay;

        // ç¯©é¸å‡ºå±¬æ–¼ã€Œé€™ä¸€å¤© (dbDay)ã€çš„èª²ç¨‹
        const dayItems = list.filter(item => item.day_of_week === dbDay);

        // --- ä»¥ä¸‹ç¹ªè£½é‚è¼¯è·ŸåŸæœ¬å¹¾ä¹ä¸€æ¨£ï¼Œåªæ˜¯è®Šæ•¸ä¾†æºè®Šäº† ---

        // è¨ˆç®—é‡ç–Šå¯¬åº¦
        let maxConcurrent = 0;
        if (dayItems.length > 0) {
          dayItems.forEach(item => {
            const [checkH] = item.start_time.split(":").map(Number);
            if (checkH < START_HOUR) return;
            const [sH, sM] = item.start_time.split(":").map(Number);
            const [eH, eM] = item.end_time.split(":").map(Number);
            const sMin = (sH - START_HOUR) * 60 + sM;
            const eMin = (eH - START_HOUR) * 60 + eM;
            const overlaps = dayItems.filter(other => {
              const [osH] = other.start_time.split(":").map(Number);
              if (osH < START_HOUR) return false;
              const [otherSH, otherSM] = other.start_time.split(":").map(Number);
              const [otherEH, otherEM] = other.end_time.split(":").map(Number);
              const oStart = (otherSH - START_HOUR) * 60 + otherSM;
              const oEnd = (otherEH - START_HOUR) * 60 + otherEM;
              return sMin < oEnd && eMin > oStart;
            });
            if (overlaps.length > maxConcurrent) maxConcurrent = overlaps.length;
          });
        }
        if (maxConcurrent === 0) maxConcurrent = 1;
        const colWidth = Math.max(MIN_COL_WIDTH, maxConcurrent * CARD_WIDTH) + 0.75;

        const dayCol = document.createElement("div");
        // ä¿®æ”¹é‡é»ï¼šborder-r ä¾ç„¶ä¿ç•™åœ¨å®¹å™¨ä¸Šï¼Œé€™å°±æ˜¯æ¨™é¡Œå’Œæ ¼å­èƒ½ã€Œå®Œç¾é€£ç·šã€çš„é—œéµ
        dayCol.className = "flex flex-col border-r border-[#e9e9e7] shrink-0 relative bg-white";
        dayCol.style.width = `${colWidth}px`;

        // Header é¡¯ç¤ºï¼šä¸Šé¢æ˜¯ã€Œé€±Xã€ï¼Œä¸‹é¢æ˜¯ã€Œæ—¥æœŸã€
        const header = document.createElement("div");
        // ä¿®æ”¹é‡é»ï¼š
        // 1. z-[400]ï¼šç¢ºä¿å®ƒæœƒä¹–ä¹–å¾…åœ¨ã€Œæ™‚é–“ã€æ¨™é¡Œçš„ä¸‹é¢
        // 2. ç§»é™¤ border-rï¼šè®“å®ƒç›´æ¥ä½¿ç”¨çˆ¶å®¹å™¨ dayCol çš„é‚Šæ¡†ï¼Œé”æˆå¦³è¦çš„ã€Œæ”¶åˆ°è£¡é¢ã€å®Œç¾å°é½Šæ„Ÿ
        header.className = "sticky top-0 z-[400] bg-gray-50 border-b border-[#e9e9e7] text-lg font-bold text-gray-800 flex flex-col items-center justify-center leading-tight box-border w-full";
        header.style.height = `${HEADER_HEIGHT}px`;

        const dateDisplay = `${thisDayDate.getMonth() + 1}/${thisDayDate.getDate()}`;

        // å¦³æƒ³ä¿ç•™çš„é€±äºŒè—è‰²é«˜äº®
        const isToday = formatDate(new Date()) === thisDayDateStr;
        const colorClass = isToday ? "text-blue-600" : "text-gray-800";

        header.innerHTML = `
            <span class="${colorClass}">${dayNames[jsDay]}</span>
            <span class="text-[11px] text-gray-400 font-mono font-normal">${dateDisplay}</span>
        `;
        dayCol.appendChild(header);

        const contentLayer = document.createElement("div");
        contentLayer.className = "relative w-full";
        contentLayer.style.height = `${slots.length * ROW_HEIGHT}px`;

        slots.forEach(() => {
          const line = document.createElement("div");
          line.className = "border-b border-[#e9e9e7] w-full";
          line.style.height = `${ROW_HEIGHT}px`;
          contentLayer.appendChild(line);
        });

        // ç¹ªè£½å¡ç‰‡
        dayItems.forEach((item) => {
          // ... (å¡ç‰‡å…§éƒ¨ç¹ªè£½é‚è¼¯å®Œå…¨ä¸ç”¨å‹•ï¼Œç›´æ¥è¤‡è£½åŸæœ¬çš„å³å¯) ...
          const [sH, sM] = item.start_time.split(":").map(Number);
          const [eH, eM] = item.end_time.split(":").map(Number);
          if (sH < START_HOUR) return;

          const startMin = (sH - START_HOUR) * 60 + sM;
          const endMin = (eH - START_HOUR) * 60 + eM;
          const topPx = (startMin / 60) * ROW_HEIGHT;
          const heightPx = ((endMin - startMin) / 60) * ROW_HEIGHT;

          // æ’åºè¨ˆç®— (ç¶­æŒä¸è®Š)
          const overlaps = dayItems.filter(other => {
            const [osH] = other.start_time.split(":").map(Number);
            if (osH < START_HOUR) return false;
            const [otherSH, otherSM] = other.start_time.split(":").map(Number);
            const [otherEH, otherEM] = other.end_time.split(":").map(Number);
            const oStart = (otherSH - START_HOUR) * 60 + otherSM;
            const oEnd = (otherEH - START_HOUR) * 60 + otherEM;
            return startMin < oEnd && endMin > oStart;
          });

          if (typeof _userSortOrder !== 'undefined') {
            [item, ...overlaps].forEach(i => {
              if (!_userSortOrder.includes(i.id)) _userSortOrder.push(i.id);
            });
            var sortedGroup = [item, ...overlaps].sort((a, b) => _userSortOrder.indexOf(a.id) - _userSortOrder.indexOf(b.id));
            var orderIndex = sortedGroup.findIndex(i => i.id === item.id);
          } else {
            var orderIndex = 0;
          }
          const leftPx = orderIndex * CARD_WIDTH;

          // ç‹€æ…‹èˆ‡é¡è‰² (ç¶­æŒä¸è®Š)
          const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          let displayStatus = item.color_class || 'status-pending';
          if (record) displayStatus = record.status;

          const statusMap = {
            'attended': 'status-present', 'status-present': 'status-present',
            'leave': 'status-leave', 'status-leave': 'status-leave',
            'absent': 'status-absent', 'status-absent': 'status-absent',
            'status-practice': 'status-practice', 'status-pending': 'status-pending'
          };
          let finalColorClass = statusMap[displayStatus] || 'status-pending';

          let btnIcon = 'circle-dashed';
          let btnColor = 'text-neutral-800';
          switch (finalColorClass) {
            case 'status-present': btnIcon = 'check-circle-2'; btnColor = 'text-green-600'; break;
            case 'status-leave': btnIcon = 'coffee'; btnColor = 'text-amber-700'; break;
            case 'status-absent': btnIcon = 'x-circle'; btnColor = 'text-red-500'; break;
            case 'status-practice': btnIcon = 'headphones'; btnColor = 'text-blue-500'; break;
            default: btnIcon = 'circle-dashed'; btnColor = 'text-neutral-800'; break;
          }

          const remarkText = (record && record.remark) ? record.remark : (item.remark || "");
          const showPin = remarkText !== "";

          // å»ºç«‹å¡ç‰‡ DOM (ç¶­æŒä¸è®Š)
          const card = document.createElement("div");
          // ... æ¨£å¼çœç•¥ï¼Œè«‹ä¿æŒåŸæœ¬çš„ ...
          card.className = `absolute rounded-md p-2 text-sm ${finalColorClass} border-l-4 border-white shadow-sm flex flex-col transition-all duration-300 group box-border overflow-hidden hover:brightness-95 hover:z-50`;
          card.style.cssText = `top: ${topPx}px; height: ${heightPx + 1}px; left: ${leftPx}px; width: ${CARD_WIDTH}px; z-index: 20;`;

          card.draggable = true;
          card.ondragstart = (e) => handleDragStart(e, item.id);
          card.ondragend = (e) => handleDragEnd(e);
          card.ondragover = (e) => e.preventDefault();
          card.ondrop = (e) => handleDrop(e, item.id);

          const rawPhone = item.phone || '';
          const noteMatch = rawPhone.match(/\((.*?)\)/);
          const phoneNote = noteMatch ? noteMatch[1] : "";
          const phoneMain = rawPhone.replace(/\(.*?\)/, "").replace(/\D/g, "");

          card.innerHTML = `
            <div class="absolute top-1 right-1 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-[60]" onclick="event.stopPropagation()">
                <button type="button" onclick="openEditModal('${item.id}', '${displayStatus}', '${thisDayDateStr}')" 
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-blue-600 shadow-sm border border-gray-100 cursor-pointer">
                    <i data-lucide="edit-3" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>
                <button type="button" onclick="deleteCourse('${item.id}')" 
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-red-600 shadow-sm border border-gray-100 cursor-pointer">
                    <i data-lucide="trash-2" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>
                <button type="button" onclick="handleToggleExpand(this)" 
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-blue-600 shadow-sm border border-gray-100 transition-transform duration-300 cursor-pointer">
                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>
            </div>

            <div class="flex flex-col h-full min-w-0 pr-8 cursor-pointer" 
                 onclick="toggleRecordStatus('${item.id}', '${thisDayDateStr}', '${displayStatus}')">
                
                <div class="flex items-center gap-1.5 mb-1.5 shrink-0 pointer-events-none">
                    <i data-lucide="${btnIcon}" class="w-4 h-4 ${btnColor}"></i>
                    <div class="font-bold text-sm text-neutral-800 truncate leading-tight">${item.course_name || 'æœªå‘½å'}</div>
                </div>

                <div class="mt-0.5 text-[10px] text-red-600 font-bold bg-white/60 px-1 rounded flex items-center gap-1 w-fit pointer-events-none ${showPin ? 'block' : 'hidden'}">
                    <i data-lucide="pin" class="w-2.5 h-2.5"></i> ${remarkText}
                </div>

                <div class="flex flex-col gap-y-2 flex-1 min-h-0 overflow-hidden relative mt-1 pointer-events-none">
                    <div class="w-full flex items-start gap-1 ${phoneMain ? 'flex' : 'hidden'}">
                        <i data-lucide="phone" class="w-3.5 h-3.5 text-neutral-800"></i>
                        <div class="flex flex-col min-w-0 leading-tight">
                            <span class="text-sm text-neutral-800 font-medium truncate">${phoneMain}</span>
                            <span class="text-sm text-neutral-800 truncate ${phoneNote ? 'block' : 'hidden'}">${phoneNote}</span>
                        </div>
                    </div>
                    <div class="w-full flex items-center gap-1"><i data-lucide="music" class="w-3.5 h-3.5 text-neutral-800"></i><span class="text-sm text-neutral-800 truncate">${item.subject || ''}</span></div>
                    <div class="w-full flex items-center gap-1 ${item.room_no ? 'flex' : 'hidden'}"><i data-lucide="map-pin" class="w-3.5 h-3.5 text-neutral-800"></i><span class="text-sm text-neutral-800 truncate">${item.room_no}</span></div>
                </div>
                <div class="mt-auto pt-2 shrink-0 pb-0.5 pointer-events-none">
                    <div class="text-sm font-mono text-neutral-800 bg-white border border-black/10 rounded px-2 py-0.5 inline-block whitespace-nowrap shadow-sm">
                        ${item.start_time.slice(0, 5)}-${item.end_time.slice(0, 5)}
                    </div>
                </div>
            </div>`;
          // ... 
          contentLayer.appendChild(card);
        });

        dayCol.appendChild(contentLayer);
        container.appendChild(dayCol);
      }
      lucide.createIcons();
    }

    async function toggleRecordStatus(scheduleId, dateStr, currentStatus) {
      let nextStatus = '';
      let action = 'save';

      // ç°¡åŒ–å¾Œçš„å¾ªç’°ï¼šç° -> ç¶  -> å’– -> ç´… -> åˆªé™¤(å›åˆ°ç°)
      if (!currentStatus || currentStatus === 'status-pending') {
        nextStatus = 'attended'; // è®Šç¶ è‰²
      } else if (currentStatus === 'attended' || currentStatus === 'status-present') {
        nextStatus = 'leave';    // è®Šå’–å•¡è‰²
      } else if (currentStatus === 'leave' || currentStatus === 'status-leave') {
        nextStatus = 'absent';   // è®Šç´…è‰²
      } else {
        action = 'delete';       // ç§»é™¤ç´€éŒ„ (å›åˆ°ç°è‰²)
      }

      try {
        if (action === 'delete') {
          await _client.from("lesson_records").delete().eq("schedule_id", scheduleId).eq("actual_date", dateStr);
        } else {
          const { data: existing } = await _client.from("lesson_records").select("id").eq("schedule_id", scheduleId).eq("actual_date", dateStr).maybeSingle();
          if (existing) {
            await _client.from("lesson_records").update({ status: nextStatus }).eq("id", existing.id);
          } else {
            await _client.from("lesson_records").insert({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus });
          }
        }
        setTimeout(() => { refreshData(); }, 150);
      } catch (err) {
        console.error("é»åå¤±æ•—:", err);
      }
    }

    // --- å°ˆé–€è™•ç†å¡ç‰‡å±•é–‹/æ”¶åˆçš„å‡½å¼ ---
    function handleToggleExpand(btn) {
      // 1. æ‰¾åˆ°è©²æŒ‰éˆ•æ‰€å±¬çš„å¡ç‰‡
      const card = btn.closest('.absolute.rounded-md');
      if (!card) return;

      // 2. åˆ‡æ›å±•é–‹ class
      const isExpanded = card.classList.toggle('card-expanded');

      // 3. è¦–è¦ºå›é¥‹ï¼šæ—‹è½‰ç®­é ­ 180 åº¦
      if (isExpanded) {
        btn.style.transform = 'rotate(180deg)';
      } else {
        btn.style.transform = 'rotate(0deg)';
      }

      // 4. é‡æ–°è§¸ç™¼ Lucide åœ–ç¤ºæ¸²æŸ“ (ç¢ºä¿åœ–ç¤ºæ­£ç¢ºé¡¯ç¤º)
      lucide.createIcons();
    }

    // 5. è€å¸«ç®¡ç†åŠŸèƒ½
    async function addTeacher() {
      const name = document.getElementById("new-teacher-name").value.trim();
      if (!name) return;
      const { error } = await _client.from("teachers").insert([{ name }]);
      if (error) alert("æ–°å¢å¤±æ•—");
      document.getElementById("new-teacher-name").value = "";
      await fetchTeachers();
    }

    async function deleteTeacher(id) {
      if (!confirm("ç¢ºå®šåˆªé™¤è€å¸«å—ï¼Ÿç›¸é—œèª²ç¨‹ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚")) return;
      await _client.from("teachers").delete().eq("id", id);
      if (currentTid === id) currentTid = null;
      await fetchTeachers();
    }

    // 6. è¼”åŠ©å‡½æ•¸ (åŠ å¤§ç‰ˆï¼špx-2.5, py-1, -ml-2)
    function setStatus(msg, type = "warn") {
      const el = document.getElementById("status-tag");
      el.textContent = `è³‡æ–™åº«é€£ç·šç‹€æ…‹ï¼š${msg}`;

      // å®šç¾©é¡è‰²
      let colorClass = "bg-yellow-100 text-yellow-800"; // é è¨­ (é»ƒ)
      if (type === "error") colorClass = "bg-red-100 text-red-800"; // éŒ¯èª¤ (ç´…)
      if (type === "success") colorClass = "bg-green-100 text-green-800"; // æˆåŠŸ (ç¶ )

      // å¥—ç”¨æ¨£å¼ (åŒæ­¥åŠ å¤§èˆ‡å°é½Šä¿®æ­£)
      el.className = `text-[10px] md:text-xs px-2.5 py-1 rounded-md font-medium mt-0.5 -ml-2 ${colorClass}`;
    }
    // æ–°å¢é€™å€‹å‡½å¼ï¼Œè®“å½ˆçª—å¯ä»¥æ‰“é–‹
    function openModal() {
      document.getElementById("course-modal").classList.remove("hidden");
    }
    function closeModal() {
      editingId = null;
      document.getElementById("course-modal").classList.add("hidden");
      document.getElementById("course-form").reset();
      document.querySelector("#course-modal h3").textContent = "æ–°å¢èª²ç¨‹è³‡æ–™";
    }
    function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
    }
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
    }

    // 7. ä¿®æ”¹èˆ‡åˆªé™¤
    // ä¿®æ”¹å¾Œï¼šç¬¬ä¸€å€‹åƒæ•¸æ¥æ”¶ itemId (å­—ä¸²)ï¼Œè€Œä¸æ˜¯ item (ç‰©ä»¶)
    function openEditModal(itemId, currentStatus, dateStr) {
      editingId = itemId;
      editingDateStr = dateStr;

      // â–¼ é—œéµï¼šç”¨ ID å»å…¨åŸŸè®Šæ•¸ _cachedSchedule æ‰¾è³‡æ–™ï¼Œé¿å… HTML å‚³é€éŒ¯èª¤ â–¼
      const item = _cachedSchedule.find(i => i.id === itemId);
      if (!item) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²èª²ç¨‹è³‡æ–™");

      document.querySelector("#course-modal h3").textContent = "ä¿®æ”¹èª²ç¨‹è³‡æ–™";
      const form = document.getElementById("course-form");

      // å¡«å…¥è³‡æ–™
      form.day_of_week.value = item.day_of_week;
      form.teacher_id.value = item.teacher_id;
      form.course_name.value = item.course_name;
      form.start_time.value = item.start_time.slice(0, 5);
      form.end_time.value = item.end_time.slice(0, 5);
      form.room_no.value = item.room_no || "";
      form.amount.value = item.amount || 0;
      form.phone.value = item.phone || "";
      form.subject.value = item.subject || "";

      // â–¼ è®€å–å‚™è¨»é‚è¼¯æ›´æ–° â–¼
      // å„ªå…ˆæ‰¾ã€Œæ—¥è¨˜ (record)ã€çš„å‚™è¨»ï¼Œå¦‚æœæ²’æœ‰ï¼Œå°±æ‰¾ã€Œæ¯ç‰ˆ (item)ã€çš„å¸¸é§å‚™è¨»
      const record = _cachedRecords.find(r => r.schedule_id === item.id && r.actual_date === dateStr);

      if (record && record.remark) {
        // å¦‚æœä»Šå¤©æœ‰å¯«æ—¥è¨˜ï¼Œå°±é¡¯ç¤ºæ—¥è¨˜çš„å…§å®¹ï¼Œä¸”ã€Œå¸¸é§ã€ä¸æ‰“å‹¾ (å› ç‚ºé€™æ˜¯ç‰¹ä¾‹)
        form.record_remark.value = record.remark;
        form.is_persistent.checked = false;
      } else {
        // å¦‚æœä»Šå¤©æ²’æ—¥è¨˜ï¼Œå°±é¡¯ç¤ºæ¯ç‰ˆçš„å¸¸é§å…§å®¹ï¼Œä¸¦æŠŠã€Œå¸¸é§ã€æ‰“å‹¾
        form.record_remark.value = item.remark || "";
        form.is_persistent.checked = !!item.remark; // æœ‰å…§å®¹å°±è‡ªå‹•å‹¾é¸
      }

      // è™•ç†ç‹€æ…‹é¡è‰²å°ç…§
      const reverseMap = {
        'attended': 'status-present', 'status-present': 'status-present',
        'leave': 'status-leave', 'status-leave': 'status-leave',
        'absent': 'status-absent', 'status-absent': 'status-absent',
        'practice': 'status-practice', 'status-practice': 'status-practice'
      };
      const statusValue = currentStatus || item.color_class || 'status-pending';
      form.color_class.value = reverseMap[statusValue] || 'status-pending';

      openModal();
    }

    async function deleteCourse(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
      await _client.from("schedules").delete().eq("id", id);
      await refreshData();
    }

    // 8. è¡¨å–®æäº¤ (ä¿®æ­£ç‰ˆï¼šç¢ºä¿æ‰€æœ‰è³‡æ–™éƒ½å­˜å®Œæ‰åˆ·æ–°ç•«é¢)
    // 8. è¡¨å–®æäº¤ (è¨ºæ–·ç‰ˆ)
    document
      .getElementById("course-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);

        if (f.get("start_time") >= f.get("end_time")) return alert("æ™‚é–“éŒ¯èª¤ï¼");

        const isTemporary = e.target.is_temporary.checked;
        const monday = getMonday(currentBaseDate);
        const targetDate = isTemporary ? formatDate(addDays(monday, parseInt(f.get("day_of_week")) - 1)) : null;

        const scheduleData = {
          teacher_id: f.get("teacher_id"),
          day_of_week: parseInt(f.get("day_of_week")),
          course_name: f.get("course_name"),
          start_time: f.get("start_time") + ":00",
          end_time: f.get("end_time") + ":00",
          room_no: f.get("room_no"),
          amount: parseInt(f.get("amount")) || 0,
          phone: f.get("phone"),
          subject: f.get("subject"),
          color_class: f.get("color_class"),
          target_date: targetDate
        };

        // â–¼ æ–°å¢ï¼šè™•ç†å¸¸é§å‚™è¨» â–¼
        const isPersistent = f.get("is_persistent") === "on"; // æª¢æŸ¥æ˜¯å¦å‹¾é¸
        const remarkContent = f.get("record_remark");

        // å¦‚æœå‹¾é¸ã€Œå¸¸é§ã€ï¼Œå°±æŠŠå‚™è¨»å­˜é€² scheduleData (æ¯ç‰ˆ)
        if (isPersistent) {
          scheduleData.remark = remarkContent;
        } else {
          // å¦‚æœæ²’å‹¾é¸ï¼Œæ¯ç‰ˆçš„å‚™è¨»è¦è¨­ç‚º null (æˆ–æ˜¯ä¿æŒåŸæ¨£ï¼Ÿé€™è£¡å»ºè­°è¨­ç‚º null ä»£è¡¨å–æ¶ˆå¸¸é§)
          // ä½†ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘å…ˆè¨­ç‚ºç©ºå­—ä¸²ï¼Œä»£è¡¨ã€Œç§»é™¤å¸¸é§ã€
          scheduleData.remark = "";
        }

        // 1. å­˜æ¯ç‰ˆ (Schedules)
        console.log("Saving schedule...");
        const res = editingId
          ? await _client.from("schedules").update(scheduleData).eq("id", editingId)
          : await _client.from("schedules").insert([scheduleData]);

        if (res.error) return alert("æ“ä½œå¤±æ•—: " + res.error.message);

        // 2. å­˜æ—¥è¨˜ (Lesson Records)
        // å¦‚æœã€Œæ²’æœ‰ã€å‹¾é¸å¸¸é§ï¼Œä»£è¡¨é€™æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæˆ‘å€‘æ‰å­˜é€²æ—¥è¨˜
        // æˆ–è€…ï¼šç‚ºäº†ä¿éšªèµ·è¦‹ï¼Œæˆ‘å€‘ã€Œç¸½æ˜¯ã€æŠŠç•¶å¤©çš„ç‹€æ…‹å­˜é€²æ—¥è¨˜ï¼Œç¢ºä¿æ­·å²æ­£ç¢º
        if (editingId && editingDateStr) {
          console.log("Upserting record...");
          await _client.from("lesson_records").upsert({
            schedule_id: editingId,
            teacher_id: f.get("teacher_id"),
            actual_date: editingDateStr,
            status: f.get("color_class"),
            remark: remarkContent || "" // é€™è£¡ä¸ç®¡æ˜¯ä¸æ˜¯å¸¸é§ï¼Œéƒ½æŠŠç•¶ä¸‹çš„æ–‡å­—å¯«å…¥ä»Šå¤©çš„æ—¥è¨˜ï¼Œä½œç‚ºå¿«ç…§
          }, { onConflict: 'schedule_id,actual_date' });
        }

        // 3. åˆ·æ–°
        closeModal();
        await refreshData();
      });

    // --- è€å¸«ç®¡ç†åŠŸèƒ½é‚è¼¯ ---

    // 1. é–‹å•Ÿç®¡ç†è¦–çª—ä¸¦è®€å–æœ€æ–°æ¸…å–®
    async function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
      await renderTeacherManageList();
      lucide.createIcons();
    }

    // 2. é—œé–‰è¦–çª—
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
      document.getElementById("new-teacher-name").value = "";
    }

    // 3. æ¸²æŸ“ç®¡ç†è¦–çª—å…§çš„è€å¸«åˆ—è¡¨ (æ”¯æ´ç·¨è¼¯æ¨¡å¼)
    async function renderTeacherManageList() {
      const { data: teachers, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");
      if (error) return;

      const manageList = document.getElementById("teacher-manage-list");
      manageList.innerHTML = "";

      teachers.forEach((t) => {
        const item = document.createElement("div");
        // åŠ ä¸Š group è®“æŒ‰éˆ•åœ¨ hover æ™‚é¡¯ç¤º
        item.className = "flex justify-between items-center p-2.5 bg-gray-50 rounded-lg border border-gray-100 group transition-all hover:bg-white hover:shadow-sm";

        // ä½¿ç”¨ data-id å±¬æ€§æ–¹ä¾¿å¾ŒçºŒæ“ä½œ
        item.dataset.id = t.id;

        // é€™è£¡æˆ‘å€‘æº–å‚™å…©ç¨®ç‹€æ…‹çš„ HTMLï¼š
        // 1. é¡¯ç¤ºç‹€æ…‹ (é è¨­)
        // 2. ç·¨è¼¯ç‹€æ…‹ (é è¨­éš±è—)
        item.innerHTML = `
      <div class="view-mode flex items-center justify-between w-full">
        <span class="text-sm font-medium text-neutral-700 select-none cursor-pointer" onclick="toggleEditMode('${t.id}')" title="é»æ“Šä¿®æ”¹">${t.name}</span>
        <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
          <button onclick="toggleEditMode('${t.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition-colors" title="ä¿®æ”¹">
            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
          </button>
          <button onclick="deleteTeacher('${t.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded-md hover:bg-red-50 transition-colors" title="åˆªé™¤">
            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
          </button>
        </div>
      </div>

      <div class="edit-mode hidden w-full flex items-center gap-2">
        <input type="text" value="${t.name}" 
          class="edit-input flex-1 border border-blue-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100"
          onkeydown="if(event.key === 'Enter') updateTeacher('${t.id}', this.value)"
        />
        <button onclick="updateTeacher('${t.id}', this.previousElementSibling.value)" class="p-1 text-green-600 hover:bg-green-100 rounded">
          <i data-lucide="check" class="w-4 h-4"></i>
        </button>
        <button onclick="toggleEditMode('${t.id}', false)" class="p-1 text-gray-400 hover:bg-gray-100 rounded">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
    `;
        manageList.appendChild(item);
      });
      lucide.createIcons();
    }
    // --- æ–°å¢çš„åŠŸèƒ½ï¼šåˆ‡æ›ç·¨è¼¯æ¨¡å¼ ---
    function toggleEditMode(id, showEdit = true) {
      const item = document.querySelector(`div[data-id="${id}"]`);
      if (!item) return;

      const viewMode = item.querySelector('.view-mode');
      const editMode = item.querySelector('.edit-mode');
      const input = item.querySelector('.edit-input');

      if (showEdit) {
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        input.focus(); // è‡ªå‹•èšç„¦åˆ°è¼¸å…¥æ¡†
        input.select(); // å…¨é¸æ–‡å­—æ–¹ä¾¿ä¿®æ”¹
      } else {
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
      }
    }

    // --- æ–°å¢çš„åŠŸèƒ½ï¼šåŸ·è¡Œæ›´æ–°è€å¸«åå­— ---
    async function updateTeacher(id, newName) {
      newName = newName.trim();
      if (!newName) return alert("è€å¸«åå­—ä¸èƒ½ç‚ºç©ºï¼");

      setStatus("æ­£åœ¨æ›´æ–°è³‡æ–™...");

      // 1. æ›´æ–°è³‡æ–™åº«
      const { error } = await _client
        .from("teachers")
        .update({ name: newName })
        .eq("id", id);

      if (error) {
        setStatus("æ›´æ–°å¤±æ•—", "error");
        alert("æ›´æ–°å¤±æ•—: " + error.message);
      } else {
        setStatus("æ›´æ–°æˆåŠŸ", "success");

        // 2. å¦‚æœç›®å‰æ­£å¥½é¸ä¸­é€™ä½è€å¸«ï¼Œè¦åŒæ­¥æ›´æ–°æ¨™é¡Œ
        if (currentTid === id) {
          document.getElementById("main-title").textContent = `${newName} Â· æœ¬é€±èª²è¡¨`;
        }

        // 3. é‡æ–°æ•´ç†åˆ—è¡¨èˆ‡å´é‚Šæ¬„
        await fetchTeachers(); // æ›´æ–°å´é‚Šæ¬„
        await renderTeacherManageList(); // æ›´æ–°ç®¡ç†åˆ—è¡¨ (æœƒè‡ªå‹•åˆ‡å›é¡¯ç¤ºæ¨¡å¼)
      }
    }

    // 4. åŸ·è¡Œæ–°å¢è€å¸«åˆ°è³‡æ–™åº«
    async function addTeacher() {
      const input = document.getElementById("new-teacher-name");
      const name = input.value.trim();

      if (!name) return alert("è«‹è¼¸å…¥è€å¸«å§“å");

      setStatus("æ­£åœ¨æ–°å¢è€å¸«...");
      const { error } = await _client.from("teachers").insert([{ name }]);

      if (error) {
        setStatus("æ–°å¢å¤±æ•—", "error");
        alert("æ–°å¢å¤±æ•—: " + error.message);
      } else {
        input.value = "";
        setStatus("è€å¸«æ–°å¢æˆåŠŸ", "success");
        // é—œéµï¼šæ–°å¢å®Œå¾Œè¦åŒæ™‚æ›´æ–°å´é‚Šæ¬„èˆ‡ç®¡ç†æ¸…å–®
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 5. åŸ·è¡Œåˆªé™¤è€å¸« (æœƒé€£å‹•åˆªé™¤è©²è€å¸«çš„èª²è¡¨)
    async function deleteTeacher(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½è€å¸«å—ï¼Ÿç›¸é—œçš„æ‰€æœ‰èª²ç¨‹å°‡æœƒä¸€ä½µæ¶ˆå¤±ï¼"))
        return;

      setStatus("æ­£åœ¨åˆªé™¤è€å¸«...");
      const { error } = await _client.from("teachers").delete().eq("id", id);

      if (error) {
        setStatus("åˆªé™¤å¤±æ•—", "error");
        alert("åˆªé™¤å¤±æ•—: " + error.message);
      } else {
        setStatus("è€å¸«å·²åˆªé™¤", "success");
        // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸å–çš„è€å¸«ï¼Œé‡ç½® ID é¿å…é¡¯ç¤ºéŒ¯èª¤
        if (currentTid === id) currentTid = null;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // --- å´é‚Šæ¬„æ§åˆ¶ ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      // åˆ‡æ› CSS class
      if (sidebar.classList.contains('-translate-x-full')) {
        // æ‰“é–‹
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        // é—œé–‰
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    // 1. æ‰“é–‹é¸æ“‡è¦–çª— (é è¨­é¡¯ç¤ºæœ¬æœˆ)
    function freezeTeacherHistory() {
      if (!currentTid) return alert("è«‹å…ˆé¸æ“‡ä¸€ä½è€å¸«");
      // é è¨­å…ˆå¹«å¦³å¡«å¥½ã€Œæœ¬æœˆã€çš„ç¯„åœ
      quickSetFreezeDates('current');
      document.getElementById("freeze-date-modal").classList.remove("hidden");
    }

    // 2. å¿«é€Ÿè¨­å®šæ—¥æœŸçš„æ ¸å¿ƒé‚è¼¯ (å‡ç´šç‰ˆï¼šæ”¯æ´é€£çºŒé»æ“Šè·³è½‰)
    function quickSetFreezeDates(type) {
      // å–å¾—ç›®å‰è¼¸å…¥æ¡†ä¸­é¡¯ç¤ºçš„èµ·å§‹æ—¥æœŸ
      const currentInputVal = document.getElementById("freeze-start-date").value;

      // å¦‚æœè¼¸å…¥æ¡†æœ‰å€¼å°±ç”¨å®ƒç•¶åŸºæº–ï¼Œæ²’æœ‰å°±ç”¨ä»Šå¤©
      let baseDate = currentInputVal ? new Date(currentInputVal) : new Date();
      let start, end;

      if (type === 'current') {
        // ã€è¨­å®šæœ¬æœˆã€‘ï¼šå›ºå®šå›åˆ°ã€Œä»Šå¤©ã€æ‰€å±¬çš„æœˆä»½
        const now = new Date();
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      } else {
        // ã€è¨­å®šä¸Šæœˆã€‘ï¼šå¾ç›®å‰é¡¯ç¤ºçš„æ—¥æœŸå†å¾€å›æ¨ä¸€å€‹æœˆ
        // æŠ“å–ç›®å‰é¡¯ç¤ºæœˆä»½çš„ 1 è™Ÿï¼Œä¸¦æ¸›å» 1 å€‹æœˆ
        start = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, 1);
        // è¨­å®šç‚ºè©²æœˆæœ€å¾Œä¸€å¤©
        end = new Date(baseDate.getFullYear(), baseDate.getMonth(), 0);
      }

      // æ›´æ–°è¼¸å…¥æ¡†
      document.getElementById("freeze-start-date").value = formatDate(start);
      document.getElementById("freeze-end-date").value = formatDate(end);
    }

    // 2.5. é—œé–‰è¦–çª—
    function closeFreezeModal() {
      document.getElementById("freeze-date-modal").classList.add("hidden");
    }

    // 3. åŸ·è¡Œå‡çµ (è®€å–è¼¸å…¥æ¡†çš„å€¼)
    async function executeFreeze() {
      const startStr = document.getElementById("freeze-start-date").value;
      const endStr = document.getElementById("freeze-end-date").value;
      const teacherName = document.getElementById("main-title").textContent.split(' Â· ')[0];

      if (!startStr || !endStr) return alert("è«‹å®Œæ•´é¸æ“‡æ—¥æœŸç¯„åœï¼");

      const startDate = new Date(startStr);
      const endDate = new Date(endStr);
      if (startDate > endDate) return alert("èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸå”·ï¼");

      if (!confirm(`ç¢ºå®šè¦ä¿ç•™ã€Œ${teacherName}ã€è€å¸«\nå¾ ${startStr} åˆ° ${endStr} çš„ç´€éŒ„å—ï¼Ÿ`)) return;

      closeFreezeModal();
      setStatus(`æ­£åœ¨ä¿è­· ${startStr} ~ ${endStr} çš„æ­·å²ç´€éŒ„...`);

      const recordsToInsert = [];
      _cachedSchedule.forEach(course => {
        let checkDate = new Date(startDate);
        while (checkDate <= endDate) {
          let dayOfWeek = checkDate.getDay();
          if (dayOfWeek === 0) dayOfWeek = 7;
          if (dayOfWeek === course.day_of_week) {
            recordsToInsert.push({
              schedule_id: course.id,
              teacher_id: currentTid,
              actual_date: formatDate(checkDate),
              status: course.color_class || 'status-pending',
              remark: course.remark || "ç³»çµ±è‡ªå‹•è£œæª”"
            });
          }
          checkDate.setDate(checkDate.getDate() + 1);
        }
      });

      if (recordsToInsert.length === 0) return setStatus("ç¯„åœå…§æ²’æœ‰éœ€è¦è£œæª”çš„èª²ç¨‹", "success");

      const { error } = await _client.from("lesson_records").upsert(recordsToInsert, {
        onConflict: 'schedule_id,actual_date', ignoreDuplicates: true
      });

      if (error) {
        setStatus("å­˜æª”å¤±æ•—", "error");
      } else {
        setStatus(`æˆåŠŸï¼å·²è£œæ»¿ ${recordsToInsert.length} å€‹æ­·å²ç©ºç¼ºã€‚`, "success");
        await refreshData();
      }
    }
  </script>
</body>

</html>