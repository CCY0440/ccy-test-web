<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>多老師課表管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
    }

    .bg-notion-pink {
      background-color: #fce4ec !important;
      border: 1px solid #f8bbd0 !important;
    }

    .bg-notion-blue {
      background-color: #e3f2fd !important;
      border: 1px solid #bbdefb !important;
    }

    .bg-notion-green {
      background-color: #e8f5e9 !important;
      border: 1px solid #c8e6c9 !important;
    }

    .bg-notion-amber {
      background-color: #fff8e1 !important;
      border: 1px solid #ffecb3 !important;
    }

    .bg-notion-purple {
      background-color: #f3e5f5 !important;
      border: 1px solid #e1bee7 !important;
    }

    .teacher-item.active {
      background-color: #f3f4f6;
      border-left: 4px solid #3b82f6;
    }

    /* 處理手機底部安全區域，防止按鈕被切掉 */
    .pb-safe {
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="text-neutral-800 h-screen overflow-hidden flex flex-col md:flex-row bg-[#fbfbfa]">

  <div class="md:hidden bg-white border-b border-[#e9e9e7] p-4 flex justify-between items-center z-[100]">
    <h1 class="font-bold text-lg flex items-center gap-2">
      <i data-lucide="calendar"></i>課表管理
    </h1>
    <button onclick="toggleMobileMenu()" class="p-2 hover:bg-gray-100 rounded-lg">
      <i data-lucide="menu" id="menu-icon"></i>
    </button>
  </div>

  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[90] w-64 bg-white border-r border-[#e9e9e7] transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 flex flex-col">
    <div class="p-6 hidden md:block">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="calendar"></i>課表管理
      </h1>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto no-scrollbar"></nav>

    <div class="p-4 border-t border-[#e9e9e7] bg-white pb-safe md:pb-4">
      <button onclick="openTeacherModal()"
        class="w-full py-2.5 text-xs text-gray-500 hover:text-blue-600 border border-dashed border-gray-300 rounded-lg flex items-center justify-center gap-1 transition-colors">
        <i data-lucide="settings-2" class="w-3 h-3"></i> 管理老師名單
      </button>
    </div>
  </aside>

  <div id="sidebar-overlay" onclick="toggleMobileMenu()"
    class="hidden fixed inset-0 bg-black/20 z-[80] backdrop-blur-sm md:hidden"></div>

  <main class="flex-1 flex flex-col min-w-0">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex justify-between items-center shadow-sm">
      <h2 id="main-title" class="text-base md:text-xl font-bold text-neutral-800 truncate">
        載入中...
      </h2>
      <div class="flex items-center gap-2">
        <div id="status-tag"
          class="hidden sm:block text-[10px] px-3 py-1.5 rounded-full bg-yellow-100 text-yellow-800 font-medium">
          連線中...
        </div>
        <button onclick="openModal()"
          class="flex items-center gap-1.5 bg-neutral-800 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i> 新增
        </button>
      </div>
    </header>

    <div class="flex-1 overflow-auto p-3 md:p-6 bg-[#fbfbfa]">
      <div class="bg-white rounded-xl border border-[#e9e9e7] shadow-sm overflow-x-auto">
        <div class="min-w-[800px] relative">
          <div
            class="grid grid-cols-8 bg-gray-50 border-b border-[#e9e9e7] text-xs md:text-sm text-gray-500 font-medium text-center">
            <div class="p-3 border-r border-[#e9e9e7]">時間</div>
            <div class="p-3 border-r border-[#e9e9e7]">週一</div>
            <div class="p-3 border-r border-[#e9e9e7]">週二</div>
            <div class="p-3 border-r border-[#e9e9e7]">週三</div>
            <div class="p-3 border-r border-[#e9e9e7]">週四</div>
            <div class="p-3 border-r border-[#e9e9e7]">週五</div>
            <div class="p-3 border-r border-[#e9e9e7]">週六</div>
            <div class="p-3 border-r border-[#e9e9e7]">週日</div>
          </div>
          <div id="schedule-container" class="relative"></div>
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[110] backdrop-blur-sm p-4">
    <div class="bg-white rounded-xl w-full max-w-md p-5 md:p-6 shadow-2xl max-h-[95vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold">課程資料</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-1">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="course-form" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">星期 (1-7)</label>
            <input type="number" name="day_of_week" min="1" max="7" required
              class="w-full border rounded-lg p-2 text-sm outline-none" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">老師</label>
            <select name="teacher_id" required
              class="w-full border rounded-lg p-2 text-sm outline-none bg-white"></select>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">課程名稱</label>
          <input type="text" name="course_name" required class="w-full border rounded-lg p-2 text-sm" />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">開始時間</label>
            <input type="time" name="start_time" required class="w-full border rounded-lg p-2 text-sm" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">結束時間</label>
            <input type="time" name="end_time" required class="w-full border rounded-lg p-2 text-sm" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">教室</label>
            <input type="text" name="room_no" class="w-full border rounded-lg p-2 text-sm" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">金額</label>
            <input type="number" name="amount" class="w-full border rounded-lg p-2 text-sm" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">卡片顏色</label>
            <select name="color_class" class="w-full border rounded-lg p-2 text-sm bg-white">
              <option value="bg-notion-pink">櫻花粉</option>
              <option value="bg-notion-blue">天空藍</option>
              <option value="bg-notion-green">薄荷綠</option>
              <option value="bg-notion-amber" selected>奶油黃</option>
              <option value="bg-notion-purple">薰衣草紫</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">電話</label>
            <input type="text" name="phone" class="w-full border rounded-lg p-2 text-sm" />
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">學習項目</label>
          <input type="text" name="subject" class="w-full border rounded-lg p-2 text-sm" />
        </div>
        <button type="submit"
          class="w-full bg-neutral-800 text-white py-3 rounded-lg font-medium hover:bg-black transition-all mt-2">
          確認儲存
        </button>
      </form>
    </div>
  </div>

  <div id="teacher-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[120] backdrop-blur-sm p-4">
    <div class="bg-white rounded-xl w-full max-w-xs p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold">老師管理</h3>
        <button onclick="closeTeacherModal()"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div class="flex gap-2 mb-4">
        <input type="text" id="new-teacher-name" placeholder="姓名"
          class="flex-1 border rounded-lg px-2 py-1 text-sm outline-none" />
        <button onclick="addTeacher()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm shrink-0">新增</button>
      </div>
      <div id="teacher-manage-list" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co";
    const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP";
    const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentTid = null;
    let editingId = null;

    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const icon = document.getElementById('menu-icon');
      const isOpen = !sidebar.classList.contains('-translate-x-full');

      if (isOpen) {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
        icon.setAttribute('data-lucide', 'menu');
      } else {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        icon.setAttribute('data-lucide', 'x');
      }
      lucide.createIcons();
    }

    window.onload = async () => {
      await fetchTeachers();
      lucide.createIcons();
    };

    async function fetchTeachers() {
      const { data, error } = await _client.from("teachers").select("*").order("created_at");
      if (error) return setStatus("載入失敗", "error");

      const menu = document.getElementById("teacher-menu");
      const select = document.querySelector('select[name="teacher_id"]');
      menu.innerHTML = "";
      select.innerHTML = "";

      data.forEach((t, index) => {
        const btn = document.createElement("button");
        btn.className = `teacher-item w-full flex items-center gap-3 p-3 rounded-xl text-left transition-all hover:bg-gray-100 ${currentTid === t.id ? "active bg-gray-100" : ""}`;
        btn.onclick = () => switchTeacher(t.id, t.name);
        btn.innerHTML = `<span class="w-8 h-8 rounded bg-gray-50 flex items-center justify-center text-gray-400"><i data-lucide="user" class="w-4 h-4"></i></span><span class="font-medium text-sm">${t.name}</span>`;
        menu.appendChild(btn);

        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        if (!currentTid && index === 0) switchTeacher(t.id, t.name);
      });
      lucide.createIcons();
    }

    async function switchTeacher(tid, name) {
      currentTid = tid;
      document.getElementById("main-title").textContent = `${name} · 本週課表`;

      if (window.innerWidth < 768) {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('-translate-x-full')) toggleMobileMenu();
      }

      document.querySelectorAll(".teacher-item").forEach((btn) => btn.classList.remove("active", "bg-gray-100"));
      const activeBtn = Array.from(document.querySelectorAll(".teacher-item")).find(b => b.textContent.includes(name));
      if (activeBtn) activeBtn.classList.add("active");

      await refreshData();
    }

    async function refreshData() {
      if (!currentTid) return;
      setStatus("同步中...");
      try {
        const { data, error } = await _client.from("schedules").select("*").eq("teacher_id", currentTid);
        if (error) throw error;
        renderSchedule(data || []);
        setStatus(`已同步 (${data.length} 筆)`, "success");
      } catch (e) {
        setStatus("錯誤", "error");
      }
    }

    function renderSchedule(list) {
      const container = document.getElementById("schedule-container");
      container.innerHTML = "";

      const slots = ["08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
      const ROW_HEIGHT = 110;
      const START_HOUR = 8;

      slots.forEach((h) => {
        const row = document.createElement("div");
        row.className = "grid grid-cols-8 border-b border-[#e9e9e7]";
        row.style.height = `${ROW_HEIGHT}px`;

        let rowHtml = `<div class="p-2 border-r border-[#e9e9e7] bg-gray-50/50 text-[10px] text-gray-400 flex items-center justify-center font-mono">${h}:00</div>`;
        for (let day = 1; day <= 7; day++) {
          rowHtml += `<div class="border-r border-[#e9e9e7] last:border-0"></div>`;
        }
        row.innerHTML = rowHtml;
        container.appendChild(row);
      });

      const cardLayer = document.createElement("div");
      cardLayer.style.cssText = `position: absolute; top: 0; left: 12.5%; right: 0; bottom: 0; pointer-events: none;`;
      container.appendChild(cardLayer);

      list.forEach((item) => {
        if (!item.start_time || !item.end_time) return;
        const [sH, sM] = item.start_time.split(":").map(Number);
        const [eH, eM] = item.end_time.split(":").map(Number);
        const startTotalMin = (sH - START_HOUR) * 60 + sM;
        const endTotalMin = (eH - START_HOUR) * 60 + eM;

        const topPx = (startTotalMin / 60) * ROW_HEIGHT;
        const heightPx = ((endTotalMin - startTotalMin) / 60) * ROW_HEIGHT;
        const dayWidthPercent = 100 / 7;
        const leftPercent = (item.day_of_week - 1) * dayWidthPercent;

        const card = document.createElement("div");
        card.className = `absolute rounded-xl p-3 text-xs ${item.color_class} border border-black/5 shadow-md flex flex-col pointer-events-auto cursor-pointer transition-all hover:shadow-lg group overflow-hidden`;
        card.style.cssText = `top: ${topPx + 2}px; height: ${heightPx - 4}px; left: calc(${leftPercent}% + 4px); width: calc(${dayWidthPercent}% - 8px); z-index: 10;`;

        card.innerHTML = `
          <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="event.stopPropagation(); openEditModal(${JSON.stringify(item).replace(/"/g, "&quot;")})" class="p-1 bg-white/80 rounded shadow-sm hover:text-blue-600"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
            <button onclick="event.stopPropagation(); deleteCourse('${item.id}')" class="p-1 bg-white/80 rounded shadow-sm hover:text-red-600"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
          </div>
          <div class="font-bold text-[13px] truncate pr-8">${item.course_name}</div>
          <div class="mt-1 text-[11px] text-gray-500 space-y-0.5 truncate ${heightPx < 60 ? 'hidden' : ''}">
            <p><i data-lucide="map-pin" class="w-2.5 h-2.5 inline mr-1 opacity-60"></i>${item.room_no || '-'}</p>
            <p class="font-bold text-blue-600">$${item.amount || 0}</p>
          </div>
          <div class="mt-auto text-[10px] font-mono text-gray-500 bg-black/5 px-1 py-0.5 rounded text-center">
            ${item.start_time.slice(0, 5)}-${item.end_time.slice(0, 5)}
          </div>
        `;
        cardLayer.appendChild(card);
      });
      lucide.createIcons();
    }

    function openModal() { document.getElementById("course-modal").classList.remove("hidden"); }
    function closeModal() {
      editingId = null;
      document.getElementById("course-modal").classList.add("hidden");
      document.getElementById("course-form").reset();
    }
    async function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
      const { data } = await _client.from("teachers").select("*").order("created_at");
      const list = document.getElementById("teacher-manage-list");
      list.innerHTML = data.map(t => `
        <div class="flex justify-between items-center p-2.5 bg-gray-50 rounded-lg border border-gray-100">
          <span class="text-sm font-medium">${t.name}</span>
          <button onclick="deleteTeacher('${t.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
        </div>
      `).join("");
      lucide.createIcons();
    }
    function closeTeacherModal() { document.getElementById("teacher-modal").classList.add("hidden"); }

    async function addTeacher() {
      const input = document.getElementById("new-teacher-name");
      const name = input.value.trim();
      if (!name) return;
      await _client.from("teachers").insert([{ name }]);
      input.value = "";
      await fetchTeachers();
      await openTeacherModal();
    }

    async function deleteTeacher(id) {
      if (!confirm("確定刪除嗎？課程會一併移除。")) return;
      await _client.from("teachers").delete().eq("id", id);
      if (currentTid === id) currentTid = null;
      await fetchTeachers();
      await openTeacherModal();
    }

    function openEditModal(item) {
      editingId = item.id;
      const f = document.getElementById("course-form");
      f.day_of_week.value = item.day_of_week;
      f.teacher_id.value = item.teacher_id;
      f.course_name.value = item.course_name;
      f.start_time.value = item.start_time.slice(0, 5);
      f.end_time.value = item.end_time.slice(0, 5);
      f.room_no.value = item.room_no || "";
      f.amount.value = item.amount || 0;
      f.phone.value = item.phone || "";
      f.subject.value = item.subject || "";
      f.color_class.value = item.color_class;
      openModal();
    }

    async function deleteCourse(id) {
      if (confirm("確定刪除課程？")) {
        await _client.from("schedules").delete().eq("id", id);
        await refreshData();
      }
    }

    function setStatus(msg, type = "warn") {
      const el = document.getElementById("status-tag");
      el.textContent = msg;
      el.className = `hidden sm:block text-[10px] px-3 py-1.5 rounded-full font-medium ${type === 'error' ? 'bg-red-100 text-red-800' : type === 'success' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
    }

    document.getElementById("course-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = new FormData(e.target);
      const data = {
        teacher_id: f.get("teacher_id"),
        day_of_week: parseInt(f.get("day_of_week")),
        course_name: f.get("course_name"),
        start_time: f.get("start_time") + ":00",
        end_time: f.get("end_time") + ":00",
        room_no: f.get("room_no"),
        amount: parseInt(f.get("amount")) || 0,
        phone: f.get("phone"),
        subject: f.get("subject"),
        color_class: f.get("color_class"),
      };
      const res = editingId ? await _client.from("schedules").update(data).eq("id", editingId) : await _client.from("schedules").insert([data]);
      if (res.error) alert("錯誤: " + res.error.message);
      else { closeModal(); await refreshData(); }
    });
  </script>
</body>

</html>