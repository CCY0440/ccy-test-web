<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¹•å°¼å…‹éŸ³æ¨‚(é‡‘å±±æ ¡å€)èª²è¡¨</title>
  <meta name="color-scheme" content="light">
  <meta name="supported-color-schemes" content="light">
  <meta name="nightmode" content="disable">
  <meta name="force-dark-mode" content="false">
  <meta name="darkreader-lock">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    * {
      font-family: "Noto Sans TC", sans-serif !important;
    }

    .schedule-card * {
      line-height: 1.15 !important;
    }

    html,
    body,
    * {
      -webkit-text-size-adjust: none !important;
      -moz-text-size-adjust: none !important;
      text-size-adjust: none !important;
    }

    /* è®“ç¶²é è¼‰å…¥å‰å…ˆéš±å½¢ï¼Œä¸¦å¢åŠ ä¸€é»å¹³æ»‘éåº¦çš„æ•ˆæœ */
    body {
      opacity: 0;
      font-family: "Noto Sans TC", sans-serif;
      transition: opacity 0.3s ease-in-out;
    }

    /* ç•¶è£ä¿®å¥½äº†ï¼ŒåŠ ä¸Šé€™å€‹ class å°±æœƒé¡¯ç¤ºå‡ºä¾† */
    body.page-ready {
      opacity: 1;
    }

    /* â˜… è§£æ±ºæ‹–æ›³æ„Ÿæ‡‰ä¸è‰¯ï¼šæ‹–æ›³æ™‚ï¼Œè®“å¡ç‰‡å…§æ‰€æœ‰å­å…ƒç´ æ»‘é¼ ç©¿é€ â˜… */
    body.is-dragging .schedule-card * {
      pointer-events: none !important;
    }

    /* --- æ–°ç‰ˆå¡ç‰‡æ¨£å¼ï¼šç™½åº• + å·¦å´è‰²æ¢ --- */

    /* ä¸Šèª²ï¼šç¶ è‰²é‚Šæ¡† + æ¥µæ·¡ç¶ åº• */
    .status-present {
      background-color: #f0fdf4 !important;
      border-left: 4px solid #22c55e !important;
      /* é¡¯çœ¼çš„å·¦é‚Šæ¢ */
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #14532d !important;
    }

    /* è«‹å‡ï¼šç¥ç€è‰²é‚Šæ¡† */
    .status-leave {
      background-color: #fffbeb !important;
      border-left: 4px solid #f59e0b !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #78350f !important;
    }

    /* æ› èª²ï¼šç´…è‰²é‚Šæ¡† */
    .status-absent {
      background-color: #fef2f2 !important;
      border-left: 4px solid #ef4444 !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #7f1d1d !important;
    }

    /* å­¸ç”Ÿç·´ç¿’ï¼šè—è‰²é‚Šæ¡† */
    .status-practice {
      background-color: #eff6ff !important;
      border-left: 4px solid #3b82f6 !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #1e3a8a !important;
    }

    /* å°šæœªé»åï¼šç°è‰²é‚Šæ¡† */
    .status-pending {
      background-color: #ffffff !important;
      border-left: 4px solid #d1d5db !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #374151 !important;
    }

    /* å´é‚Šæ¬„é¸ä¸­ç‹€æ…‹ï¼šçµ±ä¸€è‰²èª¿ç‰ˆ */
    .teacher-item.active {
      background-color: #eff6ff !important;
      /* Tailwind blue-50 */
      color: #1d4ed8 !important;
      /* Tailwind blue-700 */
      font-weight: 700 !important;
      border-right: 4px solid #2563eb !important;
      /* å¼·åˆ¶åŠ ä¸Šæ˜é¡¯çš„å³é‚Šæ¢ */
    }

    /* å±•é–‹ç‹€æ…‹çš„å¡ç‰‡æ¨£å¼ */
    .card-expanded {
      height: auto !important;
      /* è®“å…§å®¹æ±ºå®šé«˜åº¦ */
      min-height: min-content;
      z-index: 100 !important;
      /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding-bottom: 12px !important;
      /* å¢åŠ åº•éƒ¨ç·©è¡ */
    }

    /* é–å®šå¡ç‰‡çš„å¤–è§€ï¼šå¾®é€æ˜ + ç¦ç”¨é»æ“Š */
    .card-locked {
      opacity: 0.6 !important;
      pointer-events: none !important;
      /* å¾¹åº•ç¦æ­¢é»æ“Šèˆ‡ Hover æ•ˆæœ */
      filter: grayscale(20%);
    }

    /* é–å®šæ¨™ç±¤ï¼šåœ¨å¡ç‰‡å³ä¸Šè§’ç§€ä¸€å€‹å°é–é ­ */
    .lock-icon-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      padding: 2px;
    }

    /* æ‰¾åˆ°é€™ä¸€æ®µï¼ŒæŠŠ #stu-date-picker ä¹Ÿè£œä¸Šå» */
    #date-picker::-webkit-calendar-picker-indicator,
    #stu-date-picker::-webkit-calendar-picker-indicator {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 0;
      /* å®Œå…¨é€æ˜ä½†å……æ»¿æ•´æ ¼ */
      z-index: 25;
    }

    #schedule-container {
      transform-origin: 0 0;
      transition: none !important;
    }

    /* é¡å¤–ä¿®æ­£ï¼šç¢ºä¿ç¸®æ”¾å¾Œæ ¼ç·šä¾ç„¶æ¸…æ™° */
    #schedule-wrapper {
      -webkit-overflow-scrolling: touch;
    }

    /* â˜… ç¸®æ”¾æ™‚å¼·åˆ¶é—œé–‰æ‰€æœ‰è½‰å ´å‹•ç•«ï¼Œæ‰¾å› 60fps çµ²æ»‘æ‰‹æ„Ÿ */
    body.is-pinching,
    body.is-pinching * {
      transition: none !important;
    }

    /* è®“æ§åˆ¶å°çš„åˆ†é é¸å–®åœ¨æ‰‹æ©Ÿä¸Šå¯ä»¥æ»‘å‹• */
    .admin-tab-container {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      /* éš±è—æ²è»¸ */
    }

    .admin-tab-container::-webkit-scrollbar {
      display: none;
    }

    /* --- æ§åˆ¶å°æ‰‹æ©Ÿç‰ˆï¼šéš±è—åˆ†é åœ–ç¤ºã€é˜²æ­¢æ–‡å­—æ–·è¡Œ --- */
    .admin-tab {
      white-space: nowrap !important;
      /* çµ•å°ä¸å‡†æ–·è¡Œ */
      flex-shrink: 0 !important;
      /* é˜²æ­¢è¢«æ“ å£“ */
    }

    /* --- å¼·åŒ–é›»è…¦ç‰ˆçš„æ©«å‘æ²è»¸é«”é©— --- */
    .admin-tab-content .overflow-auto::-webkit-scrollbar {
      height: 12px;
      /* æ²è»¸é«˜åº¦åŠ ç²—ï¼Œè®“æ»‘é¼ å¥½æŠ“ */
      width: 12px;
    }

    .admin-tab-content .overflow-auto::-webkit-scrollbar-track {
      background: #f8fafc;
      /* æ·¡ç°è‰²è»Œé“ */
      border-radius: 8px;
    }

    .admin-tab-content .overflow-auto::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      /* æ²è»¸æœ¬é«”é¡è‰² */
      border-radius: 8px;
      border: 2px solid #f8fafc;
      /* è£½é€ ä¸€é»ç•™ç™½è³ªæ„Ÿ */
    }

    .admin-tab-content .overflow-auto::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
      /* æ»‘é¼ ç§»ä¸Šå»è®Šæ·± */
    }

    /* --- å¼·åŒ–é›»è…¦ç‰ˆçš„æ©«å‘æ²è»¸é«”é©— (åŒ…å«ä¸‹æ–¹è¡¨æ ¼èˆ‡é ‚éƒ¨åˆ†é ) --- */

    /* 1. ä¸‹æ–¹è¡¨æ ¼å€å¡Šçš„äº®è‰²æ²è»¸ */
    .admin-tab-content .overflow-auto::-webkit-scrollbar {
      height: 10px;
    }

    .admin-tab-content .overflow-auto::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 8px;
    }

    .admin-tab-content .overflow-auto::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 8px;
      border: 2px solid #f1f5f9;
    }

    .admin-tab-content .overflow-auto::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* 2. é ‚éƒ¨åˆ†é åˆ—çš„æ·±è‰²æ²è»¸ */
    .admin-tabs-scroll::-webkit-scrollbar {
      height: 8px;
      /* ç¨å¾®ç´°ä¸€é»ï¼Œæ¯”è¼ƒç²¾ç·» */
    }

    .admin-tabs-scroll::-webkit-scrollbar-track {
      background: #262626;
      border-radius: 8px;
    }

    .admin-tabs-scroll::-webkit-scrollbar-thumb {
      background: #525252;
      border-radius: 8px;
    }

    .admin-tabs-scroll::-webkit-scrollbar-thumb:hover {
      background: #737373;
    }

    @media (max-width: 640px) {
      .admin-tab i {
        display: none !important;
        /* æ‰‹æ©Ÿç‰ˆéš±è—åœ–ç¤º */
      }

      .admin-tab {
        padding: 14px 16px !important;
        /* æ‰‹æ©Ÿç‰ˆç¸®å°æŒ‰éˆ•é«˜åº¦ */
        font-size: 14px !important;
        /* å­—é«”å¾®èª¿ */
      }
    }
  </style>
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[800] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[900] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> è€å¸«åå–®
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="px-4 py-2">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm relative group">
        <div class="flex items-center gap-1.5 mb-2 text-yellow-700/80">
          <i data-lucide="sticky-note" class="w-3.5 h-3.5"></i>
          <span class="text-xs font-bold">å‚™å¿˜éŒ„</span>
          <span id="memo-status"
            class="ml-auto text-[10px] text-yellow-600 opacity-0 transition-opacity duration-500">å·²å„²å­˜</span>
        </div>
        <textarea id="teacher-memo"
          class="w-full bg-transparent text-xs text-gray-700 resize-none outline-none placeholder-yellow-700/30 leading-relaxed"
          rows="4" placeholder="éš¨æ‰‹è¨˜é»ä»€éº¼..." oninput="handleMemoInput(this.value)"></textarea>
      </div>
    </div>

    <div class="p-4">

      <div id="user-profile-card"
        class="flex items-center gap-3 mb-4 p-2.5 bg-white border border-gray-200 rounded-xl shadow-sm">
        <div
          class="w-9 h-9 rounded-full bg-neutral-800 text-white flex items-center justify-center font-bold text-sm shrink-0 border-2 border-gray-100 shadow-sm">
          <span id="current-user-initial">?</span>
        </div>
        <div class="flex flex-col min-w-0">
          <div class="flex items-center gap-2"> <span class="text-xs font-bold text-neutral-800 truncate leading-tight"
              id="current-user-name">è¼‰å…¥ä¸­...</span>
            <button onclick="openPasswordModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
              <i data-lucide="settings" class="w-3 h-3"></i>
            </button>
          </div>
          <span class="text-[10px] text-neutral-500 truncate leading-tight mt-0.5 flex items-center gap-1"
            id="current-user-role">
            <i data-lucide="shield-check" class="w-3 h-3"></i> é©—è­‰ä¸­
          </span>
        </div>
      </div>

      <button id="admin-entry-btn" onclick="openAdminModal()"
        class="hidden w-full py-2 text-xs text-gray-500 hover:text-neutral-800 border border-dashed border-gray-300 hover:border-neutral-400 rounded-lg flex items-center justify-center gap-1.5 transition-all group">
        <i data-lucide="settings-2" class="w-3.5 h-3.5 group-hover:rotate-90 transition-transform"></i>
        <span class="font-bold">ç®¡ç†æ§åˆ¶å°</span>
      </button>

      <button onclick="openInstructionsModal()"
        class="w-full py-2 mt-2 text-xs text-amber-600 hover:bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-medium">
        <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> ç³»çµ±ä½¿ç”¨èªªæ˜
      </button>

      <button onclick="handleLogout()"
        class="w-full py-2 mt-2 text-xs text-red-600 hover:bg-red-50 border border-red-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-bold">
        <i data-lucide="log-out" class="w-3.5 h-3.5"></i> ç™»å‡ºå¸³è™Ÿ
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">ç¶²é ç‰ˆæœ¬ v1.13 æ­£å¼ç‰ˆ</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex flex-wrap items-center gap-y-3 gap-x-4 shadow-sm sticky top-0 z-30">

      <div class="flex items-center gap-3 order-1 flex-1 min-w-[150px]">
        <button onclick="toggleSidebar()"
          class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden shrink-0">
          <i data-lucide="menu"></i>
        </button>

        <div class="flex flex-col min-w-0">
          <h2 id="main-title" class="text-lg md:text-xl font-bold text-neutral-800 truncate leading-tight">
            è¼‰å…¥ä¸­...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium mt-0.5 -ml-2">
            å˜—è©¦é€£ç·š...
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 order-2 lg:order-3 shrink-0">
        <button onclick="openSalaryModal()"
          class="flex items-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-emerald-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="calculator" class="w-4 h-4"></i>
          <span>è–ªè³‡è©¦ç®—</span>
        </button>

        <button onclick="openBatchModal()"
          class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-indigo-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="sheet" class="w-4 h-4"></i>
          <span>æ‰¹æ¬¡ç®¡ç†</span>
        </button>

        <button onclick="openModal()"
          class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="hidden md:inline">æ–°å¢èª²ç¨‹</span><span class="md:hidden">æ–°å¢</span>
        </button>
      </div>

      <div
        class="flex items-center justify-between gap-3 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm order-3 w-full lg:w-auto lg:mx-4 lg:order-2 relative overflow-hidden">

        <button onclick="changeWeek(-1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>

        <div class="relative flex-1 flex justify-center items-center group px-2 min-w-[220px]">

          <span id="current-date-range"
            class="text-sm md:text-base font-bold text-neutral-800 font-mono tracking-wide text-center cursor-pointer group-hover:text-blue-600 transition-colors select-none pointer-events-none whitespace-nowrap">
            è¨ˆç®—ä¸­...
          </span>

          <input type="date" id="date-picker"
            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
            onchange="handleDatePick(this.value)">
        </div>

        <button onclick="changeWeek(1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>

    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1000] backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl w-[95%] md:w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50">
        <div class="flex items-center gap-2 text-blue-800">
          <i data-lucide="book-open" class="w-5 h-5"></i>
          <h3 class="font-bold m-0">æ–°å¢èª²ç¨‹è³‡æ–™</h3>
        </div>
        <button onclick="closeModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <form id="course-form" class="flex flex-col flex-1 min-h-0">
        <div class="p-6 overflow-y-auto bg-white space-y-4">

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div>
              <label class="block text-[11px] font-bold text-gray-500 mb-1">èª²ç¨‹åç¨± ( å¦‚:EG-1ã€AG-1 )</label>
              <input type="text" name="subject" placeholder="è«‹è¼¸å…¥ç§‘ç›®åç¨±"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">å­¸ç”Ÿå§“å</label>
                <input type="text" name="course_name" required placeholder="å§“å"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">å­¸ç”Ÿé›»è©± (è‹¥ç‚ºå¤šå° è«‹ç”¨ç©ºæ ¼éš”é–‹)</label>
                <input type="tel" name="phone" placeholder="è¯çµ¡é›»è©±"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
            </div>
          </div>

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">è² è²¬è€å¸«</label>
                <select name="teacher_id" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner"></select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">ä¸Šèª²æ˜ŸæœŸ</label>
                <select name="day_of_week" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                  <option value="1">é€±ä¸€</option>
                  <option value="2">é€±äºŒ</option>
                  <option value="3">é€±ä¸‰</option>
                  <option value="4">é€±å››</option>
                  <option value="5">é€±äº”</option>
                  <option value="6">é€±å…­</option>
                  <option value="7">é€±æ—¥</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                <input type="time" name="start_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                <input type="time" name="end_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">æ•™å®¤</label>
              <input type="text" name="room_no" placeholder="æ•™å®¤åç¨±"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">è–ªè³‡ (NT$)</label>
              <input type="number" name="amount" min="0" max="9999999" placeholder="0"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">é è¨­ç‹€æ…‹</label>
              <select name="color_class"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-[11px] md:text-xs outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                <option value="status-pending" selected>â¬œ å°šæœªé»å</option>
                <option value="status-present">âœ… ä¸Šèª²</option>
                <option value="status-leave">â˜• è«‹å‡</option>
                <option value="status-absent">âŒ æ› èª²</option>
                <option value="status-practice">ğŸ¹ å­¸ç”Ÿç·´ç¿’</option>
              </select>
            </div>
          </div>

          <div class="mt-4 pt-4">
            <div
              class="bg-blue-50/50 border border-blue-100 rounded-xl p-4 relative overflow-hidden transition-all shadow-sm">
              <div class="flex items-center gap-2 relative z-10">
                <input type="checkbox" name="is_temporary" id="is_temporary"
                  class="w-4 h-4 cursor-pointer accent-blue-600 rounded"
                  onchange="document.getElementById('temp-date-wrapper').classList.toggle('hidden', !this.checked)">
                <label for="is_temporary" class="text-sm font-bold text-blue-800 cursor-pointer select-none">ğŸ“Œ
                  è¨­ç‚ºã€Œå–®æ¬¡/è‡¨æ™‚èª²ç¨‹ã€</label>
              </div>
              <div id="temp-date-wrapper" class="hidden mt-3 relative z-10 pl-6 border-l-2 border-blue-300 ml-2">
                <label class="block text-[10px] font-bold text-blue-700 mb-1">ä¸Šèª²æ—¥æœŸ <span
                    class="font-normal text-blue-500">(å°‡è‡ªå‹•æ¨ç®—æ˜ŸæœŸ)</span></label>
                <input type="date" name="target_date" id="target_date_input"
                  class="w-full border border-blue-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-white">
              </div>
            </div>
          </div>

        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2 shrink-0">
          <button type="button" onclick="closeModal()"
            class="px-5 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">å–æ¶ˆ</button>
          <button type="submit"
            class="px-5 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è¨­å®š
          </button>
        </div>
      </form>

    </div>
  </div>

  <div id="permissions-modal"
    class="hidden fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 flex items-center gap-2" id="perm-modal-title">
          <i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> è¨­å®šå¯è¦‹åå–®
        </h3>
        <button type="button" onclick="closePermissionsModal()"
          class="text-gray-400 hover:text-red-500 transition-colors bg-white p-1 rounded-full shadow-sm">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="p-2 overflow-y-auto flex-1 bg-white space-y-1" id="perm-checkbox-list">
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closePermissionsModal()"
          class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded-xl transition-colors">å–æ¶ˆ</button>
        <button type="button" onclick="savePermissions()"
          class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è¨­å®š
        </button>
      </div>
    </div>
  </div>

  <div id="undo-modal"
    class="hidden fixed inset-0 bg-black/60 z-[2000] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-md max-h-[90vh] flex flex-col border border-gray-100 overflow-hidden">

      <div class="p-4 border-b border-gray-100 flex items-center gap-2 bg-amber-50 shrink-0">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i>
        <h3 class="font-bold text-amber-800" id="undo-modal-title">ç¢ºèªå¾©åŸæ“ä½œ</h3>
      </div>

      <div class="p-5 text-sm text-gray-700 bg-white overflow-y-auto flex-1">
        <div id="undo-modal-content"
          class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 text-xs font-mono shadow-inner">
        </div>
        <p class="mt-4 text-[11px] font-bold text-red-500 text-center bg-red-50 py-1.5 rounded-lg border border-red-100"
          id="undo-modal-warning">
          ğŸ‘‰ åŸ·è¡Œå¾Œï¼Œè³‡æ–™å°‡é€€å›åˆ°ä¿®æ”¹å‰çš„ç‹€æ…‹ï¼
        </p>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2 shrink-0">
        <button type="button" onclick="closeUndoModal()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">å–æ¶ˆ</button>
        <button type="button" onclick="confirmUndo()"
          class="px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="undo-2" class="w-4 h-4"></i> ç¢ºèªå¾©åŸ
        </button>
      </div>
    </div>
  </div>

  <div id="instructions-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-lg p-0 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col border border-neutral-200">

      <div class="bg-neutral-50 px-6 py-4 border-b border-neutral-200 flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2 text-neutral-800">
          ğŸ“… ç³»çµ±ä½¿ç”¨æŒ‡å— (v1.13 æ­£å¼ç‰ˆ)
        </h3>
        <button onclick="closeInstructionsModal()"
          class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-200 rounded-full transition-all">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 text-sm text-neutral-700 leading-relaxed">

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
            é ‚éƒ¨å·¥å…·åˆ— (æ—¥æœŸèˆ‡ç®¡ç†)
          </h4>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
            <ul class="space-y-2 text-xs text-gray-700">
              <li class="flex items-start gap-2">
                <i data-lucide="calendar" class="w-3.5 h-3.5 mt-0.5 text-blue-500"></i>
                <span><b>æ—¥æœŸåˆ‡æ›ï¼š</b>é»æ“Šå·¦å³ç®­é ­ä¸­é–“çš„æ—¥æœŸå¯é¸èµ·å§‹æ—¥ï¼Œå·¦å³ç®­é ­åˆ‡æ›é€±æ¬¡ã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="calculator" class="w-3.5 h-3.5 mt-0.5 text-emerald-600"></i>
                <span><b>è–ªè³‡è©¦ç®—ï¼š</b>è¨ˆç®—æŒ‡å®šæ—¥æœŸç¯„åœå…§çš„ç¸½è–ªè³‡èˆ‡å ‚æ•¸ï¼Œæ”¯æ´åŒ¯å‡º Excelã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="sheet" class="w-3.5 h-3.5 mt-0.5 text-indigo-600"></i>
                <span><b>æ‰¹æ¬¡ç®¡ç†ï¼š</b>ä¸‹è¼‰æˆ–åŒ¯å…¥ Excelï¼Œå¯å¿«é€Ÿå¤§é‡ä¿®æ”¹ã€Œå›ºå®šèª²è¡¨ã€è¨­å®šã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="plus" class="w-3.5 h-3.5 mt-0.5 text-neutral-800"></i>
                <span><b>æ–°å¢èª²ç¨‹ï¼š</b>å»ºç«‹ä¸€å ‚æ–°çš„å›ºå®šèª²ç¨‹æˆ–å–®æ¬¡/è‡¨æ™‚èª²ç¨‹ã€‚</span>
              </li>
            </ul>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
            æ—¥å¸¸æ“ä½œ (é»åèˆ‡é–å®š)
          </h4>
          <div class="grid gap-3">
            <div class="bg-neutral-100 border-l-4 border-neutral-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-neutral-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="lock" class="w-3.5 h-3.5"></i> æ™ºæ…§é–å®šæ©Ÿåˆ¶ (New!)
              </h5>
              <p class="text-xs text-neutral-600">
                ç³»çµ±å°‡è‡ªå‹•é–å®š<b>ã€Œå‰å…©å€‹æœˆä»¥å‰ã€</b>çš„æ­·å²è³‡æ–™ã€‚è¢«é–å®šçš„å¡ç‰‡æœƒè®Šæ·¡ä¸”å‡ºç¾é–é ­ï¼Œç„¡æ³•å†é€²è¡Œé»åæˆ–ä¿®æ”¹ï¼Œç¢ºä¿è–ªè³‡çµç®—æ•¸æ“šä¸è¢«èª¤è§¸è·‘æ‰ã€‚
              </p>
              <p class="text-xs text-neutral-600">
                <b>è‹¥æœ‰ç‰¹æ®Šæ›´æ”¹éœ€æ±‚å¯èˆ‡ç®¡ç†è€…è¯çµ¡!</b>
              </p>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-blue-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="mouse-pointer-2" class="w-3.5 h-3.5"></i> é»æ“Šå¡ç‰‡å€å¡Š (é»å)
              </h5>
              <p class="text-xs text-blue-900/80">
                é»ä¸€ä¸‹åˆ‡æ›ç‹€æ…‹ï¼š
                <span class="font-bold text-green-700">ç¶ (ä¸Šèª²)</span> â†’
                <span class="font-bold text-amber-700">å’–(è«‹å‡)</span> â†’
                <span class="font-bold text-red-700">ç´…(æ› èª²)</span> â†’
                <span class="font-bold text-gray-500">ç°(æœªé»å)</span>ã€‚
              </p>
            </div>

            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-orange-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="edit-3" class="w-3.5 h-3.5"></i> å¡ç‰‡å³ä¸ŠæŒ‰éˆ• (æ»‘é¼ ç§»å…¥é¡¯ç¤º)
              </h5>
              <ul class="text-xs text-orange-900/80 list-disc pl-4 space-y-1">
                <li><b class="text-yellow-700">é»ƒè‰²è²¼ç´™ï¼š</b>è¨­å®šã€Œæ—¥æœŸå€é–“ã€å‚™è¨»ï¼Œå¯è‡ªå‹•åµæ¸¬é‡è¤‡å‚™è¨»ã€‚</li>
                <li><b class="text-blue-700">è—è‰²é‰›ç­†ï¼š</b>ä¿®æ”¹æœ¬å ‚èª²åœ¨è³‡æ–™åº«çš„å›ºå®šæ¯ç‰ˆè¨­å®šã€‚</li>
                <li><b class="text-gray-600">ç°è‰²è¤‡è£½ï¼š</b>å¿«é€Ÿè¤‡è£½è³‡æ–™æ’å…¥æŒ‡å®šæ—¥æœŸ (èª¿èª²ç¥å™¨)ã€‚</li>
                <li><b class="text-red-600">ç´…è‰²åƒåœ¾æ¡¶ï¼š</b>åˆªé™¤æ­¤èª²ç¨‹çš„æ‰€æœ‰å›ºå®šæ’ç¨‹ã€‚</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">3</span>
            å¯¦ç”¨å°èŠå£«ğŸ§€
          </h4>
          <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-3">
            <ul class="space-y-2 text-xs text-emerald-900">
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>è‡ªå‹•å°é½Šï¼š</b>æ‹–æ›³å¡ç‰‡å¯è‡ªè¨‚ç•¶æ—¥çš„é¡¯ç¤ºé †åºï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜æ†¶å¦³çš„ç¿’æ…£ã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>éš¨æ‰‹å‚™å¿˜éŒ„ï¼š</b>å´é‚Šæ¬„é»ƒè‰²ä¾¿æ¢ç´™æœƒéš¨æ‰“éš¨å­˜ï¼Œé©åˆç´€éŒ„ç‰¹æ®Šæ´»å‹•ç­‰ã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>èª¿èª²æœ€é€ŸæŠ€ï¼š</b>æŒ‰ä¸‹ã€Œè¤‡è£½(ç°)ã€æŒ‰éˆ• â†’ é¸å–ç›®æ¨™æ—¥æœŸ â†’ å­˜æª”å³å®Œæˆèª¿èª²ã€‚</span>
              </li>
            </ul>
          </div>
        </section>

        <section
          class="text-sm text-gray-400 px-4 space-y-1 bg-gray-50/50 py-3 rounded-lg border border-dashed border-gray-200">
          <p class="font-bold mb-1 text-gray-500">ç‰¹åˆ¥æé†’</p>
          <ul class="space-y-1.5 text-xs">
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>åˆæ¬¡ç™»å…¥è«‹å‹™å¿…æ›´æ”¹å¯†ç¢¼ä¸¦å¦¥å–„ä¿å­˜ï¼Œå¾Œå°åƒ…èƒ½å”åŠ©é‡è¨­ã€‚</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>è‹¥æœ‰ä»»ä½•åŠŸèƒ½å»ºè­°æˆ–éŒ¯èª¤å›å ±ï¼Œè«‹æˆªåœ–è¯ç¹« <b class="text-gray-500">é®ªé­šè€å¸«</b> :D</p>
            </li>
          </ul>
        </section>

        <section class="text-center pt-2">
          <button onclick="closeInstructionsModal()"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all active:scale-95 shadow-md">
            æˆ‘ç­è§£äº†
          </button>
        </section>
      </div>
    </div>
  </div>

  <div id="batch-modal"
    class="hidden fixed inset-0 bg-slate-900/75 backdrop-blur-sm z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl flex flex-col overflow-hidden max-h-[85vh]">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 shrink-0">
        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
          <i data-lucide="database" class="w-5 h-5 text-indigo-600"></i> è³‡æ–™ç¶­è­·ä¸­å¿ƒ
        </h3>
        <button onclick="closeBatchModal()"
          class="p-1.5 hover:bg-gray-200 rounded-lg text-gray-500 transition-colors"><i data-lucide="x"
            class="w-5 h-5"></i></button>
      </div>
      <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-5">
        <div class="bg-indigo-50/50 border border-indigo-100 rounded-xl p-5 shadow-sm">
          <h4 class="font-bold text-indigo-800 flex items-center gap-2 mb-2 text-sm">
            <i data-lucide="calendar-check" class="w-4 h-4"></i> å›ºå®šèª²è¡¨æ¨¡ç‰ˆ
          </h4>
          <p class="text-xs text-gray-500 mb-4 leading-relaxed">ç®¡ç†æ¯é€±è¦å¾‹çš„èª²ç¨‹ã€‚åŒ¯å…¥æ™‚å°‡é‡ç½®ç‚ºã€Œå°šæœªé»åã€ç°è‰²ç‹€æ…‹ã€‚</p>
          <div class="flex flex-col gap-2.5">
            <button onclick="exportMasterData()"
              class="w-full py-2.5 bg-white border border-indigo-200 text-indigo-700 rounded-lg text-sm font-bold hover:bg-indigo-50 transition-colors flex justify-center items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i> ä¸‹è¼‰å›ºå®šèª²è¡¨
            </button>
            <label
              class="w-full py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors cursor-pointer flex justify-center items-center gap-2">
              <i data-lucide="upload" class="w-4 h-4"></i> åŒ¯å…¥ä¸¦è¦†è“‹
              <input type="file" class="hidden" accept=".xlsx, .xls, .csv" onchange="executeMasterCopyImport(this)">
            </label>
          </div>
        </div>
        <div class="bg-amber-50/50 border border-amber-100 rounded-xl p-5 shadow-sm">
          <h4 class="font-bold text-amber-800 flex items-center gap-2 mb-2 text-sm">
            <i data-lucide="history" class="w-4 h-4"></i> æ­·å²é»åç´€éŒ„
          </h4>
          <p class="text-xs text-gray-500 mb-4 leading-relaxed">ä¸‹è¼‰æˆ–ä¿®æ­£éå»çš„é»åäº‹å¯¦ã€‚é€™ä¸æœƒæ”¹å‹•æ‚¨çš„èª²è¡¨æ¨¡ç‰ˆã€‚</p>
          <div class="flex flex-col gap-2.5">
            <button onclick="openDatePickerModal('export')"
              class="w-full py-2.5 bg-white border border-amber-200 text-amber-700 rounded-lg text-sm font-bold hover:bg-amber-50 transition-colors flex justify-center items-center gap-2">
              <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> åŒ¯å‡ºé»åç´€éŒ„
            </button>
            <button onclick="openDatePickerModal('edit')"
              class="w-full py-2.5 bg-amber-500 text-white rounded-lg text-sm font-bold hover:bg-amber-600 transition-colors flex justify-center items-center gap-2 shadow-sm">
              <i data-lucide="edit-3" class="w-4 h-4"></i> åœ¨ç·šä¿®æ­£ / åˆªé™¤
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="salary-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-2xl h-[85vh] p-6 shadow-2xl border border-emerald-100 flex flex-col">

      <div class="flex justify-between items-center mb-4 shrink-0">
        <h3 class="font-bold text-lg flex items-center gap-2 text-emerald-800">
          <i data-lucide="calculator" class="w-5 h-5"></i> è–ªè³‡çµç®—å ±å‘Š
        </h3>
        <button onclick="closeSalaryModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 shrink-0 bg-emerald-50/50 p-3 rounded-lg border border-emerald-100">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label>
          <input type="date" id="salary-start-date" onchange="autoUpdateEndDate(this.value)"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ—¥æœŸ</label>
          <input type="date" id="salary-end-date"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div class="flex items-end">
          <button onclick="calculateSalary()"
            class="w-full bg-emerald-600 text-white py-1.5 rounded-lg text-sm font-bold shadow hover:bg-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 h-[34px]">
            <i data-lucide="search" class="w-4 h-4"></i> é–‹å§‹è¨ˆç®—
          </button>
        </div>
      </div>

      <div id="salary-result" class="hidden flex flex-col flex-1 min-h-0 overflow-hidden">

        <div class="flex gap-4 mb-4 shrink-0">
          <div
            class="flex-1 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="absolute -right-4 -bottom-4 opacity-20"><i data-lucide="coins" class="w-24 h-24"></i></div>
            <p class="text-emerald-100 text-xs font-bold mb-1">é ä¼°ç¸½è–ªè³‡</p>
            <p class="text-3xl font-bold tracking-tight" id="total-salary">$0</p>
          </div>
          <div class="flex-1 bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-gray-500">ç¸½å ‚æ•¸</span>
              <span class="text-lg font-bold text-gray-800" id="total-count">0 å ‚</span>
            </div>
            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
              <div class="bg-emerald-500 h-full w-full"></div>
            </div>
            <div class="mt-2 text-[10px] text-gray-400">
              *åƒ…è¨ˆç®—ã€Œä¸Šèª²ã€èˆ‡ã€Œæ› èª²ã€
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-auto border border-gray-200 rounded-lg relative bg-white">
          <table class="w-full text-sm text-left min-w-max">
            <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm select-none">
              <tr>
                <th onclick="sortSalary('date')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">æ—¥æœŸ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('name')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">å­¸ç”Ÿ/èª²ç¨‹ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('status')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">ç‹€æ…‹ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('amount')"
                  class="p-3 text-right bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center justify-end gap-1">é‡‘é¡ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
              </tr>
            </thead>
            <tbody id="salary-list" class="divide-y divide-gray-100 text-gray-700">
            </tbody>
          </table>
        </div>

        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-3 shrink-0">

          <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg border border-emerald-100">
            <div class="flex flex-col">
              <span class="text-xs font-bold text-emerald-800">è–ªè³‡çµç®—ä¿®æ­£</span>
              <span class="text-[10px] text-emerald-600">åƒ…ä¿®æ”¹å°æ‡‰æ™‚é–“çš„ã€Œç‹€æ…‹ã€å‚™è¨»èˆ‡ç•¶æ—¥è–ªè³‡ã€ï¼Œä¸¦ä¸æœƒä¿®æ”¹åˆ°å…¶ä»–æ™‚é–“çš„èª²è¡¨ã€‚</span>
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-daily-input" accept=".xlsx, .xls" class="hidden"
                onchange="handleImportDaily(this)" />
              <button onclick="exportDailyReport()"
                class="bg-white text-emerald-700 border border-emerald-200 text-xs font-bold px-3 py-2 rounded hover:bg-emerald-100 transition-all flex items-center gap-1">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> åŒ¯å‡ºå ±è¡¨
              </button>
              <button onclick="document.getElementById('import-daily-input').click()"
                class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded shadow hover:bg-emerald-700 transition-all flex items-center gap-1">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> åŒ¯å…¥ä¿®æ­£
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="password-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[90%] max-w-xs p-6 shadow-2xl border border-neutral-200">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ”‘ ä¿®æ”¹ç™»å…¥å¯†ç¢¼</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-gray-400 mb-1">æ–°å¯†ç¢¼</label>
          <input type="password" id="new-password"
            class="w-full border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-neutral-800"
            placeholder="è‡³å°‘ 6 ä½æ•¸">
        </div>
        <button onclick="handleUpdatePassword()"
          class="w-full bg-neutral-800 text-white py-2 rounded-lg font-bold hover:bg-black transition-all active:scale-95 shadow-md text-sm">
          ç¢ºèªè®Šæ›´
        </button>
        <button onclick="closePasswordModal()"
          class="w-full text-gray-400 text-xs py-1 hover:text-gray-600 transition-colors">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <div id="remark-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1400] backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl w-80 shadow-2xl flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-yellow-100 flex justify-between items-center bg-yellow-50">
        <h3 class="font-bold text-yellow-800 flex items-center gap-2 m-0">
          <i data-lucide="sticky-note" class="w-5 h-5 text-yellow-600"></i> è¨­å®šå‚™è¨»
        </h3>
        <button onclick="closeRemarkModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="p-5 bg-white space-y-4 text-sm">
        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-inner">
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="remark-start-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">çµæŸæ—¥æœŸ</label>
            <input type="date" id="remark-end-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
        </div>
        <div>
          <textarea id="quick-remark-input"
            class="w-full bg-gray-50 focus:bg-white border border-gray-200 focus:border-yellow-400 rounded-xl p-3 text-sm outline-none resize-none text-neutral-700 shadow-inner transition-colors"
            rows="3" placeholder="ä¾‹å¦‚ï¼šè£œèª²ã€è«‹å‡..."></textarea>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between gap-2 items-center">
        <button onclick="saveQuickRemark(true)"
          class="p-2 bg-white text-red-500 border border-gray-200 hover:bg-red-50 hover:border-red-200 rounded-xl font-bold transition-all shadow-sm flex items-center justify-center group"
          title="æ¸…ç©ºæ­¤å€é–“çš„å‚™è¨»">
          <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
        </button>
        <div class="flex gap-2">
          <button onclick="closeRemarkModal()"
            class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">å–æ¶ˆ</button>
          <button onclick="saveQuickRemark(false)"
            class="px-5 py-2 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600 transition-all text-sm shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜
          </button>
        </div>
      </div>

    </div>
  </div>

  <div id="admin-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1500] backdrop-blur-sm">
    <div
      class="bg-white rounded-xl w-[95%] max-w-4xl h-[90vh] shadow-2xl flex flex-col border border-neutral-200 overflow-hidden">

      <div class="bg-neutral-800 text-white flex shrink-0">
        <div class="px-6 py-4 font-bold text-lg flex items-center gap-2 border-r border-neutral-700 min-w-[200px]">
          <i data-lucide="shield-alert" class="w-5 h-5"></i> ç®¡ç†æ§åˆ¶å°
        </div>
        <div class="flex flex-1 overflow-x-auto admin-tabs-scroll">
          <button onclick="switchAdminTab('directory')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-directory">
            <i data-lucide="contact" class="w-4 h-4"></i> é€šè¨ŠéŒ„
          </button>
          <button onclick="switchAdminTab('stats')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-stats">
            <i data-lucide="pie-chart" class="w-4 h-4"></i> çµ±è¨ˆå ±è¡¨
          </button>
          <button onclick="switchAdminTab('teachers')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-teachers">
            <i data-lucide="users" class="w-4 h-4"></i> è€å¸«ç®¡ç†
          </button>
          <button onclick="switchAdminTab('logs')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-logs">
            <i data-lucide="history" class="w-4 h-4"></i> æ“ä½œæ—¥èªŒ
          </button>
          <button onclick="switchAdminTab('admin-info')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-admin-info">
            <i data-lucide="info" class="w-4 h-4"></i> å¾Œå°æŒ‡å—
          </button>
        </div>
        <button onclick="closeAdminModal()"
          class="px-6 hover:bg-neutral-700 text-gray-400 hover:text-white transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="flex-1 bg-gray-50 overflow-hidden relative">

        <div id="tab-content-directory" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div class="flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-3 mb-4 shrink-0">
            <div class="relative w-full sm:w-72">
              <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
              <input type="text" id="dir-search" oninput="renderDirectory()" placeholder="æœå°‹å§“åã€é›»è©±..."
                class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-neutral-800 shadow-sm">
            </div>
            <div
              class="text-[11px] sm:text-xs text-gray-500 bg-gray-50/80 px-2.5 py-1.5 rounded-md border border-gray-200 shadow-sm w-full sm:w-auto text-center sm:text-left">
              ğŸ’¡ æç¤ºï¼šé»æ“Šä»»ä½•æ¬„ä½å³å¯è¤‡è£½
            </div>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('name')">
                    <div class="flex items-center gap-1">å­¸ç”Ÿå§“å <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('phone')">
                    <div class="flex items-center gap-1">é›»è©± <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('subject')">
                    <div class="flex items-center gap-1">ç§‘ç›® <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('teacher')">
                    <div class="flex items-center gap-1">è² è²¬è€å¸« <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 w-16 text-center whitespace-nowrap">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="directory-list" class="divide-y divide-gray-100 text-neutral-700"></tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-stats" class="admin-tab-content w-full h-full flex flex-col p-6 hidden overflow-y-auto">
          <div
            class="flex flex-wrap items-end gap-3 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm shrink-0">

            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1">1. é¸æ“‡è€å¸«</label>
              <select id="stat-teacher" onchange="updateStudentList()"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none bg-white min-w-[120px] focus:ring-2 focus:ring-neutral-800">
                <option value="all">ALL</option>
              </select>
            </div>

            <div class="flex-1 min-w-[180px] relative group">
              <label class="block text-xs font-bold text-gray-500 mb-1">2. æœå°‹å­¸ç”Ÿ</label>

              <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                <input type="text" id="stat-student" placeholder="è¼¸å…¥å§“åæœå°‹..."
                  class="w-full border border-gray-300 rounded-lg pl-9 pr-8 py-1.5 text-sm outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800 transition-all"
                  oninput="filterStudentList(this.value)" onfocus="showStudentList()" autocomplete="off">

                <button id="clear-student-btn" onclick="clearStudentSearch()"
                  class="hidden absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                  <i data-lucide="x-circle" class="w-4 h-4"></i>
                </button>
              </div>

              <ul id="student-dropdown-list"
                class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto divide-y divide-gray-50">
                <li class="p-3 text-sm text-gray-400 text-center">è«‹å…ˆé¸æ“‡è€å¸«...</li>
              </ul>
            </div>

            <div><label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date"
                id="stat-start" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ—¥æœŸ</label><input type="date" id="stat-end"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>

            <button onclick="calculateStats()"
              class="bg-neutral-800 text-white px-5 py-1.5 rounded-lg text-sm font-bold hover:bg-black transition-all shadow-md h-[34px] flex items-center">
              <i data-lucide="search" class="w-3.5 h-3.5 mr-1"></i> æŸ¥è©¢
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center min-h-[300px]">
              <h4 class="font-bold text-gray-700 mb-6 flex items-center gap-2"><i data-lucide="pie-chart"
                  class="w-4 h-4"></i> æ•´é«”ç‹€æ…‹åˆ†ä½ˆ</h4>
              <div id="stat-pie-chart" class="w-48 h-48 rounded-full shadow-inner relative"
                style="background: conic-gradient(#d1d5db 0% 100%);">
                <div
                  class="absolute inset-0 m-auto w-24 h-24 bg-white rounded-full flex items-center justify-center flex-col">
                  <span id="stat-total-lessons" class="text-xl font-bold text-neutral-800">0</span><span
                    class="text-[10px] text-gray-400">ç¸½å ‚æ•¸</span>
                </div>
              </div>
              <div class="mt-6 flex flex-wrap gap-4 justify-center text-xs font-bold">
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-green-500"></span> ä¸Šèª² <span
                    id="label-present">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-amber-400"></span> è«‹å‡ <span
                    id="label-leave">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-red-500"></span> æ› èª² <span
                    id="label-absent">0%</span></div>
                <div class="flex items-center gap-1.5">
                  <span class="w-3 h-3 rounded-full bg-gray-300"></span> å°šæœªé»å <span id="label-pending">0%</span>
                </div>
              </div>
            </div>
            <div class="bg-white p-0 rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col">
              <div class="p-4 bg-gray-50 border-b border-gray-200 font-bold text-gray-700">è©³ç´°æ•¸æ“š</div>
              <div class="flex-1 overflow-y-auto p-4 space-y-3" id="stat-details">
                <p class="text-center text-gray-400 text-sm py-10">è«‹é¸æ“‡æ—¥æœŸä¸¦é–‹å§‹åˆ†æ...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-content-teachers"
          class="admin-tab-content w-full h-full flex flex-col md:flex-row gap-4 md:gap-6 p-4 md:p-6 hidden overflow-y-auto md:overflow-hidden bg-gray-50/50">
          <div
            class="w-full md:w-80 shrink-0 flex flex-col bg-white rounded-2xl border border-gray-200 shadow-sm p-5 h-fit">
            <div class="flex items-center gap-2 mb-5">
              <div class="w-1.5 h-4 bg-blue-600 rounded-full shrink-0"></div>
              <h4 class="font-bold text-gray-800 text-base m-0 leading-none">æ–°å¢è€å¸«èˆ‡å¸³è™Ÿ</h4>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1.5">è€å¸«å§“å</label>
                <input type="text" id="new-teacher-name" placeholder="ä¾‹ï¼šç« é­šè€å¸«"
                  class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none transition-all bg-gray-50 focus:bg-white shadow-inner">
              </div>

              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1.5">ç™»å…¥å¸³è™Ÿ <span
                    class="text-blue-500 font-normal">(è‹±æ–‡æˆ–æ•¸å­—)</span></label>
                <input type="text" id="new-teacher-username" placeholder="ä¾‹ï¼šoctopus"
                  class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none transition-all bg-gray-50 focus:bg-white shadow-inner">
              </div>

              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1.5">é è¨­å¯†ç¢¼ <span
                    class="text-blue-500 font-normal">(è‡³å°‘ 6 ç¢¼)</span></label>
                <input type="text" id="new-teacher-password" placeholder="è«‹è¨­å®šçµ¦é€™ä½è€å¸«åˆå§‹å¯†ç¢¼"
                  class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none transition-all bg-gray-50 focus:bg-white shadow-inner">
              </div>

              <div class="pt-2">
                <button onclick="addTeacher()"
                  class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-700 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm">
                  <i data-lucide="check-circle" class="w-4 h-4"></i> å»ºç«‹å¸³è™Ÿä¸¦æ–°å¢
                </button>
              </div>
            </div>
          </div>

          <div
            class="flex-1 flex flex-col bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden min-h-[500px] md:min-h-0 md:h-full">

            <div class="p-4 bg-gray-50 border-b border-gray-100 flex items-center justify-between shrink-0">
              <h4 class="font-bold text-gray-700 flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4 text-gray-400"></i> ç¾æœ‰è€å¸«åå–®
              </h4>
              <span
                class="text-[10px] text-gray-400 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">é»æ“Šå¡ç‰‡å³å´å¯ä¿®æ”¹æˆ–åˆªé™¤</span>
            </div>

            <div class="p-4 flex-1 overflow-y-auto bg-[#fbfbfa]">
              <div id="teacher-manage-list" class="flex flex-col gap-2.5"></div>
            </div>
          </div>

        </div>

        <div id="tab-content-logs" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div
            class="flex justify-between items-center mb-4 shrink-0 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">

            <div class="flex flex-col gap-1">
              <h3 class="font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i> ç³»çµ±æ“ä½œè»Œè·¡
              </h3>
              <div
                class="flex items-center gap-1.5 text-[10px] text-amber-600 bg-amber-50 px-2 py-0.5 rounded-md border border-amber-100 w-fit">
                <i data-lucide="clock" class="w-3 h-3"></i>
                <span class="font-bold">ç³»çµ±ç¶­è­·ï¼šåƒ…æœƒä¿ç•™è¿‘ 3 å€‹æœˆç´€éŒ„</span>
              </div>
            </div>

            <button onclick="loadLogs()"
              class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition-colors flex items-center gap-1">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> é‡æ–°æ•´ç†
            </button>
          </div>
          <div class="flex-1 overflow-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left min-w-max">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 whitespace-nowrap">æ™‚é–“</th>
                  <th class="p-4 whitespace-nowrap">æ“ä½œäººå“¡</th>
                  <th class="p-4 whitespace-nowrap">å‹•ä½œ</th>
                  <th class="p-4 min-w-[250px]">è©³ç´°å…§å®¹</th>
                  <th class="p-4 whitespace-nowrap text-center">å¾©åŸ</th>
                </tr>
              </thead>
              <tbody id="logs-list" class="divide-y divide-gray-100 text-neutral-700">
              </tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-admin-info"
          class="admin-tab-content w-full h-full flex flex-col p-8 hidden overflow-y-auto bg-[#fbfbfa]">
          <div class="max-w-2xl mx-auto w-full space-y-10">

            <div class="flex flex-col items-center">
              <div
                class="px-3 py-1 bg-neutral-800 text-white text-[10px] font-bold rounded-full mb-3 tracking-widest uppercase">
                Admin Terminal
              </div>
              <h3 class="text-2xl font-bold text-neutral-800 tracking-tighter">ç®¡ç†è€…æ ¸å¿ƒæ“ä½œæ‰‹å†Š</h3>
              <p class="text-neutral-400 text-xs mt-2 font-medium">é‡å°å¾Œå°é€²éšåŠŸèƒ½çš„æ“ä½œèªªæ˜èˆ‡ç¶­è­·å»ºè­°ã€‚</p>
            </div>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">1</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">æ•¸æ“šè³‡ç”¢ç›£æ§</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-blue-400 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-blue-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">é€šè¨ŠéŒ„ç®¡ç†</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">æ•´åˆæ‰€æœ‰ç­ç´šå­¸ç”Ÿçš„è¯ç¹«é›»è©±ã€‚é»æ“Šè™Ÿç¢¼å€å¡Šå³å¯è¤‡è£½è‡³å‰ªè²¼ç°¿ï¼Œçœå»æ‰‹å‹•è¼¸å…¥çš„æ™‚é–“ã€‚</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-emerald-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">çµ±è¨ˆå ±è¡¨ (å°å¸³æ ¸å°)</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">è¿½è¹¤å­¸ç”Ÿå‡ºå¸­ç‡èˆ‡å ‚æ•¸ã€‚é©åˆåœ¨æœˆåº•é€²è¡Œæ•™å­¸é€²åº¦æ ¸å°ï¼Œæˆ–ä½œç‚ºè–ªè³‡ç™¼æ”¾çš„åƒè€ƒæ•¸æ“šã€‚</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">2</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">äººäº‹æ¬Šé™ç®¡ç†</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-yellow-500 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-blue-600 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">å¸«è³‡åå–®ç•°å‹•</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">æ”¯æ´ä¿®æ”¹é¡¯ç¤ºå§“åã€‚è‹¥è€å¸«é›¢è·ï¼Œè«‹åœ¨æ­¤åŸ·è¡Œåˆªé™¤ï¼Œç¢ºä¿ç³»çµ±åå–®çš„å³æ™‚æ€§ã€‚</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-yellow-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">å´é‚Šæ¬„å¯è¦‹æ¬Šé™</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">é»æ“Šè€å¸«æ—çš„ã€Œçœ¼ç›åœ–ç¤ºã€ï¼Œå¯è¨­å®šè©²è€å¸«ç™»å…¥å¾Œå…è¨±æŸ¥é–±çš„å°è±¡ï¼Œç¶­æŒå´é‚Šæ¬„ç°¡æ½”ã€‚</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">3</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">å®‰å…¨èˆ‡è‡ªå‹•åŒ–ç¶­è­·</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-amber-600 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-amber-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">æ“ä½œè»Œè·¡èˆ‡å¾©åŸ</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">ç´€éŒ„æ‰€æœ‰é»åèˆ‡ä¿®æ”¹å‹•ä½œã€‚è‹¥ç™¼ç”Ÿèª¤æ“ä½œï¼Œå¯è‡³æ—¥èªŒåˆ†é é»æ“Šã€Œå¾©åŸã€æŒ‰éˆ•æ’¤éŠ·è©²æ¬¡æ›´å‹•ã€‚</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-neutral-300 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">è‡ªå‹•æ¸…ç†æ©Ÿåˆ¶</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">ç³»çµ±æ¯æ—¥å‡Œæ™¨å°‡è‡ªå‹•åŸ·è¡Œç¶­è­·ï¼Œåƒ…ä¿ç•™è¿‘ 3 å€‹æœˆä¹‹æ—¥èªŒç´€éŒ„ï¼Œä»¥ç¶­æŒæ•¸æ“šè¼‰å…¥æ•ˆç‡ã€‚</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="bg-emerald-50 border border-emerald-100 rounded-2xl p-6">
              <h4 class="font-bold text-emerald-800 text-sm mb-3 flex items-center gap-2">
                <i data-lucide="zap" class="w-4 h-4 fill-emerald-500"></i> ç®¡ç†è€…å°ˆå±¬èŠå£« ğŸ§€
              </h4>
              <ul class="text-[11px] text-emerald-900/70 space-y-2 leading-relaxed">
                <li class="flex gap-2"><span>â€¢</span> <span><b>æ‰¹é‡æ›´æ–°ï¼š</b>ä¿®æ”¹å¤§é‡å­¸è²»é‡‘é¡æˆ–æ•™å®¤æ™‚ï¼Œç›´æ¥ç”¨ã€Œæ‰¹æ¬¡ç®¡ç†ã€åŒ¯å‡º Excel æ”¹æœ€å¿«ã€‚</span></li>
                <li class="flex gap-2"><span>â€¢</span> <span><b>æ™ºæ…§é–å®šï¼š</b>ç³»çµ±æœƒè‡ªå‹•ä¿è­·å‰å…©å€‹æœˆè³‡æ–™ï¼Œè‹¥éœ€æ›´å‹•èˆŠç´€éŒ„ï¼Œè«‹ç¢ºä¿ä»¥ç®¡ç†å“¡èº«åˆ†æ“ä½œã€‚</span></li>
              </ul>
            </section>

            <section class="text-xs text-gray-400 px-5 py-4 bg-white rounded-xl border border-dashed border-gray-300">
              <div class="flex items-center gap-2 mb-3 text-neutral-500 font-bold">
                <i data-lucide="shield-alert" class="w-4 h-4"></i>
                <span>é–‹ç™¼è€…å®‰å…¨é ˆçŸ¥</span>
              </div>
              <ul class="space-y-3 text-[11px] leading-relaxed">
                <li class="flex gap-2">
                  <span class="text-neutral-400 font-bold">â€¢</span>
                  <span>ä¿®æ”¹èª²ç¨‹æ¯ç‰ˆå‰ï¼Œå»ºè­°å…ˆæ ¸å°ã€Œè–ªè³‡çµç®—ã€åˆ†é æ˜¯å¦æœ‰å°šæœªè™•ç†çš„é‡‘é¡ä¿®æ­£ï¼Œé¿å…æœªä¾†é€£å‹•è¨ˆç®—ç”¢ç”Ÿæ•¸æ“šè½å·®ã€‚</span>
                </li>
                <li class="flex gap-2">
                  <span class="text-neutral-400 font-bold">â€¢</span>
                  <p>æœ¬ç³»çµ±ç”± <i class="text-slate-500 font-bold not-italic">@CCY</i> å°ˆå±¬é–‹ç™¼ä¸¦æˆäºˆä½¿ç”¨æ¬Šäºˆ <span
                      class="text-neutral-500 font-bold">å¹•å°¼å…‹éŸ³æ¨‚(é‡‘å±±æ ¡å€)</span>ï¼Œé–‹ç™¼è€…ä»ä¿ç•™ç³»çµ±åº•å±¤é‚è¼¯èˆ‡æ•¸æ“šæ¶æ§‹ä¹‹æœ€çµ‚è§£é‡‹æ¬Šã€‚</p>
                </li>
              </ul>
            </section>

            <div class="pt-4 text-center">
              <div
                class="inline-flex items-center gap-2 px-4 py-1.5 bg-white border border-neutral-200 rounded-xl shadow-sm">
                <span class="text-[10px] text-neutral-400 font-mono italic">Powered by</span>
                <span class="text-xs font-bold italic text-slate-500 tracking-widest">@CCY DEV</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="sys-dialog-modal"
    class="hidden fixed inset-0 bg-black/40 z-[3000] flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
    <div
      class="bg-white rounded-xl shadow-2xl w-[85%] max-w-sm overflow-hidden flex flex-col transform scale-95 transition-transform duration-200"
      id="sys-dialog-box">
      <div class="p-6">
        <h3 class="font-bold text-gray-900 text-lg mb-2 flex items-center gap-2" id="sys-dialog-title">æç¤º</h3>
        <p class="text-sm text-gray-600 leading-relaxed" id="sys-dialog-msg">å…§å®¹</p>
      </div>
      <div class="px-5 py-3 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
        <button id="sys-dialog-cancel" onclick="closeSysDialog()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-800 rounded-lg transition-colors">å–æ¶ˆ</button>
        <button id="sys-dialog-confirm" onclick="execSysDialog()"
          class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div id="student-edit-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1600] backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[90%] max-w-sm p-6 shadow-2xl border border-neutral-200">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800">
        <i data-lucide="user-cog" class="w-5 h-5"></i> ä¿®æ”¹åŸºæœ¬è³‡æ–™
      </h3>
      <div
        class="mb-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-800 leading-relaxed border border-blue-100 shadow-inner">
        ğŸ’¡ é€™è£¡çš„ä¿®æ”¹æœƒ<b>ä¸€æ¬¡æ€§åŒæ­¥æ›´æ–°</b>è©²å­¸ç”Ÿåä¸‹æ‰€æœ‰ç§‘ç›®çš„å§“åèˆ‡é›»è©±ã€‚
      </div>
      <div class="space-y-4">
        <input type="hidden" id="edit-student-ids">
        <input type="hidden" id="edit-student-old-name">
        <div>
          <label class="block text-[11px] font-bold text-gray-500 mb-1">å­¸ç”Ÿå§“å</label>
          <input type="text" id="edit-student-name"
            class="w-full border border-gray-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-gray-50 focus:bg-white transition-all">
        </div>
        <div>
          <label class="block text-[11px] font-bold text-gray-500 mb-1">è¯çµ¡é›»è©±</label>
          <input type="text" id="edit-student-phone"
            class="w-full border border-gray-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-gray-50 focus:bg-white transition-all">
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button onclick="closeStudentEditModal()"
            class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg font-bold transition-colors">å–æ¶ˆ</button>
          <button onclick="saveStudentProfile()"
            class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center gap-1">
            <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è®Šæ›´
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="student-schedule-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1700] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-4xl h-[85vh] shadow-2xl flex flex-col overflow-hidden border border-gray-200">

      <div class="p-4 border-b border-gray-100 bg-emerald-50 flex flex-wrap justify-between items-center gap-3">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-lg shadow-sm"
            id="stu-modal-initial"></div>
          <div>
            <h3 class="font-bold text-emerald-900 m-0" id="stu-modal-name">å­¸ç”Ÿèª²è¡¨</h3>
            <p class="text-[10px] text-emerald-600 font-medium" id="stu-modal-phone"></p>
          </div>
        </div>

        <div class="flex items-center gap-2 bg-white rounded-xl border border-emerald-200 p-1 shadow-sm relative group">
          <button onclick="changeStudentWeek(-1)"
            class="p-1.5 hover:bg-gray-100 rounded-lg text-emerald-600 transition-colors z-20 relative">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>

          <div
            class="relative flex justify-center items-center px-2 min-w-[160px] cursor-pointer group-hover:bg-emerald-50 transition-colors rounded-lg">
            <span id="stu-modal-date-range" class="text-xs font-bold text-gray-700 font-mono select-none"></span>
            <input type="date" id="stu-date-picker"
              class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
              onchange="handleStudentDatePick(this.value)">
          </div>

          <button onclick="changeStudentWeek(1)"
            class="p-1.5 hover:bg-gray-100 rounded-lg text-emerald-600 transition-colors z-20 relative">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>

        <button onclick="closeStudentScheduleModal()"
          class="text-gray-400 hover:text-red-500 bg-white p-1.5 rounded-full transition-colors border border-gray-100 shadow-sm">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="flex-1 overflow-auto bg-[#fbfbfa]" id="stu-schedule-wrapper">
        <div id="stu-schedule-container" class="flex min-w-max p-4">
        </div>
      </div>

      <div class="p-3 bg-gray-50 border-t border-gray-100 text-center">
        <span class="text-[10px] text-gray-400 font-bold">ğŸ’¡ é»æ“Šå¡ç‰‡å¯ç›´æ¥é»åï¼Œç³»çµ±æœƒåŒæ­¥æ›´æ–°è‡³è©²è€å¸«çš„èª²è¡¨ä¸­</span>
      </div>
    </div>
  </div>

  <div id="date-picker-modal"
    class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[99999] flex items-center justify-center p-4">
    <div
      class="bg-white rounded-2xl w-full max-w-sm shadow-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200">
      <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <h3 class="text-md font-bold text-gray-800" id="date-picker-title">é¸æ“‡å€é–“</h3>
        <button onclick="closeDatePickerModal()" class="p-1.5 hover:bg-gray-200 rounded-lg text-gray-500"><i
            data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-700 mb-1.5 flex items-center gap-1"><i data-lucide="calendar"
              class="w-3.5 h-3.5 text-gray-400"></i> é–‹å§‹æ—¥æœŸ</label>
          <input type="date" id="export-start-date"
            class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-700 mb-1.5 flex items-center gap-1"><i data-lucide="calendar"
              class="w-3.5 h-3.5 text-gray-400"></i> çµæŸæ—¥æœŸ</label>
          <input type="date" id="export-end-date"
            class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
        </div>
      </div>
      <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
        <button onclick="closeDatePickerModal()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 rounded-xl">å–æ¶ˆ</button>
        <button id="date-picker-confirm-btn"
          class="px-5 py-2 text-sm font-bold bg-amber-500 text-white hover:bg-amber-600 rounded-xl shadow-md">ç¢ºèªåŸ·è¡Œ</button>
      </div>
    </div>
  </div>

  <div id="history-editor-modal"
    class="hidden fixed inset-0 bg-slate-900/85 backdrop-blur-sm z-[99999] flex items-center justify-center p-4">
    <div
      class="bg-white rounded-2xl w-full max-w-3xl shadow-2xl flex flex-col overflow-hidden max-h-[85vh] animate-in fade-in zoom-in duration-200">
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 shrink-0">
        <h3 class="text-md font-bold text-gray-800 flex items-center gap-2"><i data-lucide="edit-3"
            class="w-5 h-5 text-amber-600"></i> åœ¨ç·šä¿®æ­£é»åç´€éŒ„</h3>
        <button onclick="closeHistoryEditorModal()" class="p-1.5 hover:bg-gray-200 rounded-lg text-gray-500"><i
            data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="p-0 overflow-y-auto custom-scrollbar flex-1">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50 sticky top-0 shadow-sm">
            <tr>
              <th class="p-4 text-xs font-bold text-gray-500">æ—¥æœŸ</th>
              <th class="p-4 text-xs font-bold text-gray-500">å­¸ç”Ÿåç¨±</th>
              <th class="p-4 text-xs font-bold text-gray-500">ç‹€æ…‹ (é»æ“Šä¸‹æ‹‰å¯ç›´æ¥ä¿®æ”¹)</th>
              <th class="p-4 text-xs font-bold text-gray-500 text-center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="history-editor-body">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co";
    const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP";
    const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // â˜… å…¨åŸŸè®Šæ•¸ï¼šå­˜ç›®å‰ç™»å…¥è€…æ˜¯èª° â˜…
    let currentUserInfo = null;

    let currentTid = null;
    let editingId = null;
    let editingCurrentStatus = null;
    let editingDateStr = null;
    // --- æ–°å¢å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†æš«å­˜è³‡æ–™èˆ‡æ’åº ---
    let _cachedSchedule = []; // æš«å­˜èª²è¡¨è³‡æ–™
    let _cachedRecords = [];  // æš«å­˜ç´€éŒ„è³‡æ–™
    let _userSortOrder = [];  // è¨˜ä½ä½¿ç”¨è€…æ’å¥½çš„å¡ç‰‡é †åº (å­˜ ID)
    // â˜… æ ¸å¿ƒè£œä¸ï¼šåˆå§‹åŒ–é€šè¨ŠéŒ„çš„è³‡æ–™èˆ‡æ’åºç‹€æ…‹
    let _allSchedulesForAdmin = [];
    let _dirSortState = { key: 'name', dir: 1 }; // é è¨­ä¾å§“åé †å‘æ’åº

    // --- ä½¿ç”¨èªªæ˜å½ˆçª—æ§åˆ¶ ---
    function openInstructionsModal() {
      // é–‹å•Ÿæ™‚è‡ªå‹•æ”¶èµ·æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
      document.getElementById("instructions-modal").classList.remove("hidden");
    }

    function closeInstructionsModal() {
      document.getElementById("instructions-modal").classList.add("hidden");
    }

    // --- æ‹–æ›³æ’åºåŠŸèƒ½æ ¸å¿ƒ (çµ²æ»‘å‹•ç•«ç‰ˆ) ---
    // 1. é–‹å§‹æ‹–æ›³
    function handleDragStart(e, id) {
      e.dataTransfer.setData("text/plain", id);
      e.dataTransfer.effectAllowed = "move";
      e.target.style.opacity = '0.4';

      // â˜… é—œéµæ–°å¢ï¼šå‘Šè¨´æ•´å€‹ç¶²é ã€Œç¾åœ¨é€²å…¥æ‹–æ›³æ¨¡å¼äº†ï¼ã€è§¸ç™¼ CSS å¹½éˆç‹€æ…‹
      document.body.classList.add('is-dragging');
    }

    // 2. æ‹–æ›³çµæŸ
    function handleDragEnd(e) {
      e.target.style.opacity = '1';

      // â˜… é—œéµæ–°å¢ï¼šè§£é™¤æ‹–æ›³æ¨¡å¼ï¼ŒæŒ‰éˆ•èˆ‡æ–‡å­—æ¢å¾©æ­£å¸¸
      document.body.classList.remove('is-dragging');

      // ç¢ºä¿æ¸…é™¤æ‰€æœ‰æ®˜ç•™çš„æ‹–æ›³æç¤ºæ¨£å¼
      document.querySelectorAll('.schedule-card').forEach(c => {
        c.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'opacity-60', 'z-50');
      });
    }

    function handleDrop(e, targetId) {
      e.preventDefault();
      e.stopPropagation();

      const sourceId = String(e.dataTransfer.getData("text/plain"));
      const tId = String(targetId);

      if (sourceId === tId) return;

      const fromIndex = _userSortOrder.indexOf(sourceId);
      const toIndex = _userSortOrder.indexOf(tId);

      if (fromIndex > -1 && toIndex > -1) {
        _userSortOrder.splice(fromIndex, 1);
        _userSortOrder.splice(toIndex, 0, sourceId);

        // èƒŒæ™¯å„²å­˜è³‡æ–™åº« (ä¸å¡ä½ç•«é¢å‹•ç•«)
        if (currentTid) {
          const orderStr = _userSortOrder.join(',');
          localStorage.setItem(`sort_order_${currentTid}`, orderStr);
          _client.from("teachers").update({ card_order: orderStr }).eq("id", currentTid)
            .then(({ error }) => {
              if (!error) setStatus("é †åºå·²æ°¸ä¹…å„²å­˜", "success");
            });
          const t = allTeachers.find(t => t.id === currentTid);
          if (t) t.card_order = orderStr;
        }

        // â˜… å‹•ç•« Step 1: ç´€éŒ„é‡ç¹ªå‰çš„ã€ŒèˆŠä½ç½®ã€
        const oldPositions = new Map();
        document.querySelectorAll('.schedule-card').forEach(card => {
          oldPositions.set(card.dataset.id, card.getBoundingClientRect());
        });

        // é‡æ–°ç¹ªè£½æ–°é †åºçš„å¡ç‰‡
        renderSchedule(_cachedSchedule, _cachedRecords);

        // â˜… å‹•ç•« Step 2: è¨ˆç®—ä½ç§»ï¼Œæ’­æ”¾æ»‘å‹•èˆ‡ç¶ è‰²ç™¼å…‰ç‰¹æ•ˆ
        requestAnimationFrame(() => {
          document.querySelectorAll('.schedule-card').forEach(card => {
            const id = card.dataset.id;

            // 1. æ»‘å‹•å‹•ç•« (FLIP)
            if (oldPositions.has(id)) {
              const oldPos = oldPositions.get(id);
              const newPos = card.getBoundingClientRect();
              const dx = oldPos.left - newPos.left;
              const dy = oldPos.top - newPos.top;

              if (dx !== 0 || dy !== 0) {
                card.style.transition = 'none';
                card.style.transform = `translate(${dx}px, ${dy}px)`;
                card.style.zIndex = '100'; // å‹•ç•«æœŸé–“æ‹‰åˆ°æœ€ä¸Šå±¤

                requestAnimationFrame(() => {
                  card.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                  card.style.transform = 'translate(0, 0)';
                  setTimeout(() => {
                    card.style.transition = '';
                    card.style.transform = '';
                    card.style.zIndex = '';
                  }, 400);
                });
              }
            }
          });
        });
      }
    }

    // --- ç©æœ¨ä¸€ï¼šæ—¥æœŸæ§åˆ¶æ ¸å¿ƒ ---
    // 1. è¨­å®šç›®å‰é¸æ“‡çš„æ—¥æœŸ (é è¨­ä»Šå¤©)
    let currentBaseDate = new Date();

    // 2. å·¥å…·ï¼šå–å¾—æœ¬é€±ä¸€çš„æ—¥æœŸ (é€™æ¨£æˆ‘å€‘æ‰çŸ¥é“é€™é€±æ˜¯å¾å“ªå¤©é–‹å§‹)
    function getMonday(d) {
      d = new Date(d);
      var day = d.getDay(),
        diff = d.getDate() - day + (day == 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    // 3. å·¥å…·ï¼šåŠ æ¸›å¤©æ•¸ (ç”¨ä¾†åˆ‡æ›ä¸Šä¸€é€±ã€ä¸‹ä¸€é€±)
    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // 4. å·¥å…·ï¼šæŠŠæ—¥æœŸè®Šå­—ä¸² (ä¿®æ­£ç‰ˆï¼šä½¿ç”¨ç•¶åœ°æ™‚é–“ï¼Œè§£æ±ºæ—©æ™¨æ—¥æœŸè·‘æ‰çš„å•é¡Œ)
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // 5. åˆ‡æ›é€±æ¬¡çš„åŠŸèƒ½
    function changeWeek(direction) {
      // direction: -1 ä»£è¡¨ä¸Šä¸€é€±ï¼Œ 1 ä»£è¡¨ä¸‹ä¸€é€±
      currentBaseDate = addDays(currentBaseDate, direction * 7);

      // åˆ‡æ›å¾Œï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ (é€™æ¨£ç•«é¢æ‰æœƒè®Š)
      refreshData();
    }

    // 1. è™•ç†æ—¥æ›†é¸æ“‡ (æ»¾å‹•å¼ï¼šé¸å“ªå¤©ï¼Œå“ªå¤©å°±æ˜¯èµ·é»)
    function handleDatePick(val) {
      if (!val) return;
      // ç›´æ¥æŠŠ currentBaseDate è¨­ç‚ºä½¿ç”¨è€…é¸çš„é‚£ä¸€å¤© (ä¸æ‰¾ç¦®æ‹œä¸€äº†)
      currentBaseDate = new Date(val);
      refreshData();
    }

    // â–¼ é—œéµä¿®æ­£ 1ï¼šå®£å‘Šå…¨åŸŸè®Šæ•¸ä¾†å­˜è€å¸«è³‡æ–™ â–¼
    let allTeachers = [];
    let memoTimeout = null;

    window.onload = async () => {
      // A. æª¢æŸ¥ç™»å…¥
      const { data: { session } } = await _client.auth.getSession();
      if (!session) {
        window.location.href = "login.html";
        return;
      }

      // B. æŠ“è³‡æ–™ (é€™è£¡æœƒä¸€è·¯ç­‰å¾…èª²è¡¨ç•«å®Œ)
      await fetchUserProfile(session.user.email);
      await fetchTeachers();
      enableAutomation(); // å•Ÿå‹•è‡ªå‹•åŒ–å¼•æ“

      // C. åœ–ç¤ºæ¸²æŸ“
      lucide.createIcons();

      // â˜…â˜…â˜… çµ‚æ¥µä¿®æ­£ï¼šçµ¦ç€è¦½å™¨ 100ms çš„ç·©è¡æ™‚é–“ä¾†ã€Œåˆ·æ²¹æ¼†ã€ â˜…â˜…â˜…
      setTimeout(() => {
        document.body.classList.add("page-ready");
      }, 550);
    };

    // --- çµ‚æ¥µé˜²æš´è¡å†·å‡è¦–çª—ç‰ˆï¼šè§£æ±ºåŸç”Ÿè¡çª + æ‰¾å›æ¶ˆå¤±å¡ç‰‡ ---
    const wrapper = document.getElementById('schedule-wrapper');

    // å¦‚æœé‚„æ²’æœ‰å»ºç«‹å†·å‡è¦–çª—ï¼Œå°±å»ºç«‹å®ƒ
    if (wrapper && !wrapper.parentElement.classList.contains('zoom-viewport')) {
      const viewport = document.createElement('div');
      viewport.className = 'zoom-viewport';

      // â˜… é—œéµä¿®å¾© 1ï¼šheight: 100% æ‰¾å›å› ç‚º 0 é«˜åº¦è€Œæ¶ˆå¤±çš„å¡ç‰‡
      // â˜… é—œéµä¿®å¾© 2ï¼štouch-action: pan-x pan-y å¾¹åº•å°å°æ‰‹æ©Ÿçš„ã€ŒåŸç”Ÿç¸®æ”¾ã€ï¼Œè§£æ±ºã€Œä¸€ç¸®å°å°±æš´è¡ã€çš„æ­»è¿´åœˆå¹²æ“¾ï¼
      // â˜… é—œéµä¿®å¾© 3ï¼šoverscroll-behavior: none é˜²æ­¢ç•«é¢é‚Šç·£å›å½ˆå¹²æ“¾è¨ˆç®—
      viewport.style.cssText = 'position: relative; width: 100%; height: 100%; overflow: hidden; background: #ffffff; touch-action: pan-x pan-y; overscroll-behavior: none;';

      wrapper.parentNode.insertBefore(viewport, wrapper);
      viewport.appendChild(wrapper);

      // è§£æ”¾ wrapper æˆç‚ºç´”ç²¹çš„ç•«å¸ƒ
      wrapper.style.position = 'absolute';
      wrapper.style.top = '0';
      wrapper.style.left = '0';
      wrapper.style.width = '100%';
      wrapper.style.height = '100%';
      wrapper.style.transformOrigin = '0 0';
      wrapper.style.transition = 'none';
      // é˜²æ­¢ç€è¦½å™¨é›å©†èª¿æ•´æ²å‹•æ¢ä½ç½®
      wrapper.style.overflowAnchor = 'none';

      let currentScale = 1;
      let startScale = 1;
      let startDist = 0;
      let startScrollX = 0;
      let startScrollY = 0;
      let startTouchX = 0;
      let startTouchY = 0;
      let isPinching = false;
      let ticking = false;

      viewport.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          isPinching = true;
          // æš«åœæ‰€æœ‰ Hover å‹•ç•«ï¼Œç¢ºä¿æ‰‹æ©Ÿ CPU å°ˆå¿ƒè™•ç†ç¸®æ”¾
          document.body.classList.add('is-pinching');

          startDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          startScale = currentScale;

          // ç´€éŒ„è§¸ç¢°é»åœ¨è¢å¹•ä¸Šçš„ä½ç½®
          const rect = viewport.getBoundingClientRect();
          startTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
          startTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;

          // ç´€éŒ„ç•¶ä¸‹æ²å‹•æ¢ä½ç½®
          startScrollX = wrapper.scrollLeft;
          startScrollY = wrapper.scrollTop;
        }
      }, { passive: false });

      viewport.addEventListener('touchmove', (e) => {
        if (isPinching && e.touches.length === 2) {
          // e.preventDefault() é…åˆ touch-action é›™é‡ä¿è­·ï¼Œçµ•å°é˜»æ–·æš´è¡
          e.preventDefault();
          if (ticking) return;
          ticking = true;

          window.requestAnimationFrame(() => {
            const currentDist = Math.hypot(
              e.touches[0].clientX - e.touches[1].clientX,
              e.touches[0].clientY - e.touches[1].clientY
            );

            // é˜²å‘†æ©Ÿåˆ¶ï¼šæ‰‹æŒ‡é–“è·ç§»å‹•è¶…é 10px æ‰é–‹å§‹ç®—ï¼Œé¿å…å¾®å°è§¸ç¢°å¼•ç™¼èª¤åˆ¤
            if (startDist > 10) {
              let newScale = startScale * (currentDist / startDist);
              newScale = Math.min(Math.max(newScale, 0.2), 2.0); // ç¸®æ”¾é™åˆ¶ç¯„åœ

              if (newScale !== currentScale) {
                // åå‘æ’é–‹è™›æ“¬ç•«å¸ƒï¼Œè®“é‚Šç•Œé–æ­»
                wrapper.style.width = `${100 / newScale}%`;
                wrapper.style.height = `${100 / newScale}%`;
                wrapper.style.transform = `scale(${newScale})`;

                const rect = viewport.getBoundingClientRect();
                const currentTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                const currentTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;

                // å®Œç¾ç‰©ç†è¿½è¹¤ï¼Œé–å®šæ‰‹æŒ‡ä¸‹çš„å¡ç‰‡ä¸åç§»
                wrapper.scrollLeft = startScrollX + (startTouchX / startScale) - (currentTouchX / newScale);
                wrapper.scrollTop = startScrollY + (startTouchY / startScale) - (currentTouchY / newScale);

                currentScale = newScale;
              }
            }
            ticking = false;
          });
        }
      }, { passive: false });

      const stopPinching = (e) => {
        if (e.touches.length < 2) {
          isPinching = false;
          startDist = 0;
          document.body.classList.remove('is-pinching');
        }
      };

      viewport.addEventListener('touchend', stopPinching);
      viewport.addEventListener('touchcancel', stopPinching);
    }

    // 1. ç™»å…¥æª¢æŸ¥èˆ‡ç¨±è™Ÿé¡¯ç¤ºå„ªåŒ– (Ccy å°ˆå±¬ç¨±è™Ÿ + è€å¸«é¡¯ç¤º Email)
    async function fetchUserProfile(email) {
      const { data, error } = await _client.from("teachers").select("*").eq("email", email).maybeSingle();

      if (error || !data) {
        await sysAlert("éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿæœªç¶å®šæ•™å¸«è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ï¼", "ç™»å…¥å¤±æ•—");
        await _client.auth.signOut();
        window.location.href = "login.html";
        return;
      }

      currentUserInfo = data;
      const initialEl = document.getElementById("current-user-initial");
      const nameEl = document.getElementById("current-user-name");
      const roleEl = document.getElementById("current-user-role");

      if (initialEl && nameEl && roleEl) {
        initialEl.textContent = data.name.charAt(0);
        nameEl.textContent = data.name;

        if (data.is_admin) {
          // å¦‚æœæ˜¯ Ccy ä¸”ç‚ºç®¡ç†å“¡ï¼Œé¡¯ç¤ºã€Œç³»çµ±é–‹ç™¼è€…ã€
          const isDev = data.name === "Ccy";
          const roleTitle = isDev ? "ç³»çµ±é–‹ç™¼è€…" : "ç³»çµ±ç®¡ç†å“¡";
          const roleIcon = isDev ? "code" : "shield-alert";

          roleEl.innerHTML = `<i data-lucide="${roleIcon}" class="w-3 h-3 text-amber-500"></i> ${roleTitle}`;
          roleEl.classList.add("text-amber-600");
        } else {
          // â˜… é—œéµä¿®æ”¹ï¼šå°‡ä¸€èˆ¬çš„ã€Œæˆèª²æ•™å¸«ã€æ”¹æˆé¡¯ç¤ºä½¿ç”¨è€…çš„ Email
          // ä¸¦æŠŠåœ–ç¤ºæ›æˆä¿¡å° (mail)
          roleEl.innerHTML = `<i data-lucide="mail" class="w-3 h-3"></i> ${data.email}`;
          roleEl.classList.remove("text-amber-600");
        }

        // é‡æ–°æ¸²æŸ“åœ–ç¤º
        lucide.createIcons();
      }
    }

    // 2. å„²å­˜æ¬Šé™é˜²å‘†
    async function savePermissions() {
      const checkboxes = document.querySelectorAll('#perm-checkbox-list input[type="checkbox"]:checked:not(:disabled)');
      const selectedIds = Array.from(checkboxes).map(cb => cb.value);
      if (!selectedIds.includes(String(editingPermTeacherId))) {
        selectedIds.push(String(editingPermTeacherId));
      }
      const idsString = selectedIds.join(',');
      const res = await _client.from('teachers').update({ viewable_teachers: idsString }).eq('id', editingPermTeacherId);

      if (res.error) {
        await sysAlert('å„²å­˜å¤±æ•—ï¼š' + res.error.message, "ç³»çµ±éŒ¯èª¤");
      } else {
        const t = allTeachers.find(t => t.id === editingPermTeacherId);
        if (t) t.viewable_teachers = idsString;
        setStatus('æ¬Šé™åå–®å·²æˆåŠŸå„²å­˜ï¼', 'success');
        closePermissionsModal();
        // å¯«å…¥æ—¥èªŒ
        const targetTeacher = allTeachers.find(t => t.id === editingPermTeacherId);
        await recordLog('æ¬Šé™è¨­å®š', `ä¿®æ”¹äº†è€å¸« [${targetTeacher?.name}] çš„å´é‚Šæ¬„å¯è¦‹åå–®`, 'teachers', null, null);
      }
    }

    // ç™»å‡ºå‡½å¼
    async function handleLogout() {
      if (!(await sysConfirm("æ‚¨ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ", "ç™»å‡ºç¢ºèª", "info"))) return;
      // â˜… å¯«å…¥æ—¥èªŒ
      await recordLog('ç³»çµ±æ“ä½œ', 'ç™»å‡ºç³»çµ±', 'auth', null, null);
      await _client.auth.signOut();
      window.location.href = "login.html";
    }

    // 2. ç²å–è€å¸«åˆ—è¡¨ (åŒæ­¥ä¿®å¾©ä¸‹æ‹‰é¸å–®ç‰ˆ)
    async function fetchTeachers() {
      setStatus("æ­£åœ¨åŒæ­¥æœ€æ–°å‹•æ…‹...", "loading");
      try {
        const { data: teachers, error: tErr } = await _client.from("teachers").select("*").order("created_at");
        if (tErr) throw tErr;

        allTeachers = teachers;
        const menu = document.getElementById("teacher-menu");
        if (!menu) return;
        menu.innerHTML = "";

        // â˜… é—œéµä¿®æ­£ï¼šåŒæ™‚å¡«å¯«ã€Œæ–°å¢èª²ç¨‹ã€å½ˆçª—è£¡çš„è€å¸«é¸å–® â˜…
        const teacherSelect = document.querySelector('select[name="teacher_id"]');
        if (teacherSelect) teacherSelect.innerHTML = "";

        function getRelativeTime(dateStr) {
          if (!dateStr) return "ç„¡ç´€éŒ„";
          const now = new Date(); const past = new Date(dateStr);
          const diffMins = Math.floor((now - past) / (1000 * 60));
          if (diffMins < 1) return "å‰›å‰›";
          if (diffMins < 60) return `${diffMins} åˆ†é˜å‰`;
          if (diffMins < 1440) return `${Math.floor(diffMins / 60)} å°æ™‚å‰`;
          return `${Math.floor(diffMins / 1440)} å¤©å‰`;
        }

        // â˜… æ›¿æ›é€™æ®µéæ¿¾é‚è¼¯
        const viewableIds = currentUserInfo.viewable_teachers ? currentUserInfo.viewable_teachers.split(',') : [];
        const visibleTeachers = teachers.filter(t => {
          // ğŸ¦¸â€â™‚ï¸ éš±å½¢æ–—ç¯· 1ï¼šåªè¦åå­—åŒ…å« ccyï¼Œå°±çµ•å°ä¸é¡¯ç¤º (é™¤éæ˜¯ ccy è‡ªå·±ç™»å…¥)
          if (t.name.toLowerCase().includes('ccy') && String(t.id) !== String(currentUserInfo.id)) return false;

          if (t.is_hidden) return false;
          if (currentUserInfo.is_admin) return true;
          return String(t.id) === String(currentUserInfo.id) || viewableIds.includes(String(t.id));
        });

        visibleTeachers.forEach((t, index) => {
          const btn = document.createElement("button");
          btn.dataset.id = t.id;
          const isActive = String(currentTid) === String(t.id);
          btn.className = `teacher-item w-full flex items-center gap-2 py-2.5 px-2 rounded-lg text-left transition-all duration-200 ${isActive ? "active bg-blue-50 text-blue-700 ring-1 ring-blue-100" : "hover:bg-gray-50 text-neutral-700"}`;
          btn.onclick = () => switchTeacher(t.id, t.name);

          btn.innerHTML = `
              <div class="w-9 h-9 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 border transition-colors ${isActive ? "bg-blue-600 text-white border-blue-600" : "bg-gray-100 text-gray-500 border-gray-200"}">${t.name.charAt(0)}</div>
              <div class="flex flex-col min-w-0">
                <span class="font-bold text-sm truncate">${t.name}</span>
                <span class="text-[10px] leading-tight mt-0.5 flex items-center gap-1 ${isActive ? "text-blue-500" : "text-gray-400"}">
                  <span class="w-1.5 h-1.5 rounded-full ${isActive ? "bg-blue-500 animate-pulse" : "bg-green-400"}"></span>
                  ${getRelativeTime(t.updated_at || t.created_at)}ç·¨è¼¯
                </span>
              </div>
          `;
          menu.appendChild(btn);

          // â˜… åŒæ­¥å¡«å¯«é¸å–® â˜…
          if (teacherSelect) {
            const opt = document.createElement("option");
            opt.value = t.id; opt.textContent = t.name;
            if (String(t.id) === String(currentTid)) opt.selected = true;
            teacherSelect.appendChild(opt);
          }
          if (!currentTid && index === 0) switchTeacher(t.id, t.name);
        });

        const adminEntryBtn = document.getElementById("admin-entry-btn");
        if (adminEntryBtn && currentUserInfo) adminEntryBtn.classList.toggle("hidden", !currentUserInfo.is_admin);

        lucide.createIcons();
        setStatus("è³‡æ–™åº«é€£ç·šï¼šé€£ç·šæˆåŠŸ", "success");
      } catch (err) { setStatus("è³‡æ–™åº«é€£ç·šï¼šè¼‰å…¥å¤±æ•—", "error"); }
    }

    // â˜… å…¨è‡ªå‹•åŒ–æ ¸å¿ƒé‚è¼¯
    function enableAutomation() {
      _client
        .channel('db-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'lesson_records' }, () => {
          fetchTeachers(); // é»åè®Šå‹•é€šå¸¸æ˜¯å–®ç­†ï¼Œç¶­æŒåˆ·æ–°
        })
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'teachers' }, () => {
          fetchTeachers(); // è€å¸«è³‡æ–™æ›´æ–°æ‰åˆ·æ–°
        })
        .subscribe();
    }

    async function switchTeacher(tid, name) {
      // 1. ç«‹å³æ›´æ–°æ•¸æ“š ID
      currentTid = tid;
      document.getElementById("main-title").textContent = `${name} Â· æœ¬é€±èª²è¡¨`;

      // 2. âš¡ å¿«é€Ÿ UI åˆ‡æ›ï¼šéæ­·æ‰€æœ‰æŒ‰éˆ•ï¼Œåªæ”¹é¡åˆ¥ï¼ˆä¸é‡ç•« HTMLï¼‰
      document.querySelectorAll(".teacher-item").forEach((btn) => {
        const isActive = String(btn.dataset.id) === String(tid);
        const headshot = btn.querySelector(".w-9"); // æŠ“é ­åƒå€
        const statusDot = btn.querySelector(".w-1\\.5"); // æŠ“ç‹€æ…‹é»

        if (isActive) {
          // é¸ä¸­ç‹€æ…‹
          btn.className = btn.className.replace(/hover:bg-gray-50|text-neutral-700/g, "") + " active bg-blue-50 text-blue-700 ring-1 ring-blue-100";
          if (headshot) headshot.className = "w-9 h-9 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 border transition-colors bg-blue-600 text-white border-blue-600";
          if (statusDot) statusDot.className = "w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse";
        } else {
          // æœªé¸ä¸­ç‹€æ…‹
          btn.classList.remove("active", "bg-blue-50", "text-blue-700", "ring-1", "ring-blue-100");
          btn.classList.add("hover:bg-gray-50", "text-neutral-700");
          if (headshot) headshot.className = "w-9 h-9 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 border transition-colors bg-gray-100 text-gray-500 border-gray-200";
          if (statusDot) statusDot.className = "w-1.5 h-1.5 rounded-full bg-green-400";
        }
      });

      // 3. è™•ç†å‚™å¿˜éŒ„èˆ‡æ’åº
      const targetTeacher = allTeachers.find(t => t.id === tid);
      const memoInput = document.getElementById("teacher-memo");
      if (memoInput) memoInput.value = (targetTeacher && targetTeacher.memo) ? targetTeacher.memo : "";

      if (targetTeacher && targetTeacher.card_order) {
        _userSortOrder = targetTeacher.card_order.split(',');
      } else {
        _userSortOrder = [];
      }

      // 4. æ‰‹æ©Ÿç‰ˆæ”¶åˆ
      if (window.innerWidth < 768) toggleSidebar();

      // 5. âš¡ åªåˆ·æ–°èª²è¡¨å…§å®¹ï¼ˆé€™æ˜¯ä¸»è¦çš„å»¶é²ä¾†æºï¼Œæ‰€ä»¥æ”¾æœ€å¾Œè·‘ï¼‰
      await refreshData();
    }

    // 4. å‚™å¿˜éŒ„è‡ªå‹•å„²å­˜åŠŸèƒ½ (æ–°å¢)
    async function handleMemoInput(text) {
      const status = document.getElementById("memo-status");
      if (status) {
        status.textContent = "è¼¸å…¥ä¸­...";
        status.classList.remove("opacity-0");
      }

      // é˜²æ‰‹éœ‡ï¼šæ¸…é™¤ä¸Šä¸€æ¬¡çš„è¨ˆæ™‚å™¨
      if (memoTimeout) clearTimeout(memoTimeout);

      // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼šåœæ­¢æ‰“å­— 0.8 ç§’å¾Œæ‰å„²å­˜
      memoTimeout = setTimeout(async () => {
        if (!currentTid) return;

        if (status) status.textContent = "å„²å­˜ä¸­...";

        // æ›´æ–°è³‡æ–™åº«
        const { error } = await _client
          .from("teachers")
          .update({ memo: text })
          .eq("id", currentTid);

        if (!error) {
          if (status) status.textContent = "å·²å„²å­˜";

          // â–¼ é—œéµä¿®æ­£ 4ï¼šå„²å­˜æˆåŠŸå¾Œï¼ŒåŒæ­¥æ›´æ–°æœ¬åœ°è®Šæ•¸ allTeachers â–¼
          // é€™æ¨£åˆ‡æ›å»åˆ¥çš„è€å¸«å†åˆ‡å›ä¾†ï¼Œè³‡æ–™æ‰æœƒæ˜¯æ–°çš„
          const localTeacher = allTeachers.find(t => t.id === currentTid);
          if (localTeacher) {
            localTeacher.memo = text;
          }

          // 2ç§’å¾Œéš±è—ç‹€æ…‹æ–‡å­—
          setTimeout(() => {
            if (status) status.classList.add("opacity-0");
          }, 2000);
        } else {
          console.error("å„²å­˜å¤±æ•—:", error); // åœ¨ Console é¡¯ç¤ºéŒ¯èª¤ä»¥ä¾¿é™¤éŒ¯
          if (status) {
            status.textContent = "å„²å­˜å¤±æ•—";
            status.classList.remove("text-yellow-600");
            status.classList.add("text-red-500");
          }
        }
      }, 800);
    }

    // 2. é‡æ–°æ•´ç†è³‡æ–™
    async function refreshData() {
      if (!currentTid) return;

      const startDate = new Date(currentBaseDate);
      const endDate = addDays(startDate, 6);

      const startStr = formatDate(startDate);
      const endStr = formatDate(endDate);

      document.getElementById("current-date-range").textContent = `${startStr} ~ ${endStr}`;
      const picker = document.getElementById("date-picker");
      if (picker) picker.value = startStr;

      setStatus("æ­£åœ¨åŒæ­¥ç´€éŒ„...");

      try {
        const { data: sData, error: sErr } = await _client
          .from("schedules")
          .select("*")
          .eq("teacher_id", currentTid)
          .eq("is_deleted", false) // â˜… æ–°å¢é€™è¡Œï¼šåªæŠ“æ²’è¢«æ¨™è¨˜åˆªé™¤çš„èª²
          .or(`target_date.is.null,and(target_date.gte.${startStr},target_date.lte.${endStr})`);
        if (sErr) throw sErr;

        const { data: rData, error: rErr } = await _client.from("lesson_records").select("*")
          .eq("teacher_id", currentTid)
          .gte("actual_date", startStr)
          .lte("actual_date", endStr);
        if (rErr) throw rErr;

        _cachedSchedule = sData || [];
        _cachedRecords = rData || [];

        // â˜… åŒæ­¥æ’åºæ¸…å–®
        let isOrderUpdated = false;
        _cachedSchedule.forEach(item => {
          const strId = String(item.id);
          if (!_userSortOrder.includes(strId)) {
            _userSortOrder.push(strId);
            isOrderUpdated = true;
          }
        });

        if (isOrderUpdated && currentTid) {
          const orderStr = _userSortOrder.join(',');

          // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šé€™è£¡ä¹ŸåŠ ä¸Š await â˜…â˜…â˜…
          await _client.from("teachers").update({ card_order: orderStr }).eq("id", currentTid);
          localStorage.setItem(`sort_order_${currentTid}`, orderStr);

          const t = allTeachers.find(t => t.id === currentTid);
          if (t) t.card_order = orderStr;
        }

        renderSchedule(_cachedSchedule, _cachedRecords, startDate);

        updateStatsUI();
      } catch (e) {
        console.error(e);
        setStatus(`é€£ç·šéŒ¯èª¤: ${e.message}`, "error");
      }
    }

    // 1. å¡ç‰‡é»ååˆ‡æ›ç‹€æ…‹é˜²å‘†
    async function toggleCourseStatus(id, currentStatus) {
      const statusCycle = { 'status-pending': 'status-present', 'status-present': 'status-leave', 'status-leave': 'status-absent', 'status-absent': 'status-pending' };
      const nextStatus = statusCycle[currentStatus] || 'status-present';
      const { error } = await _client.from("schedules").update({ color_class: nextStatus }).eq("id", id);

      if (!error) {
        await refreshData();
      } else {
        await sysAlert("ç‹€æ…‹åˆ‡æ›å¤±æ•—", "ç³»çµ±éŒ¯èª¤");
      }
    }

    // 3. ç¹ªåœ–å‡½å¼ (æ¥µè‡´ç´®å¯¦ç‰ˆï¼šå¤§å­—é«” + é›¶ç•™ç™½ + æ ¼ç·šçµ•å°è²¼åˆ)
    function renderSchedule(list, records = [], startDate) {
      const container = document.getElementById("schedule-container");
      if (!container) return;
      container.innerHTML = "";

      const slots = ["09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24"];
      const BASE_ROW_HEIGHT = 120;
      const START_HOUR = 9;
      const CARD_WIDTH = 135; // ç¨å¾®èª¿ä½ä¿åº•å¯¬åº¦
      const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
      const baseDate = startDate || currentBaseDate;

      function parseTime(tStr) {
        if (!tStr) return { h: 0, m: 0 };
        let h = parseInt(tStr.split(":")[0]);
        let m = parseInt(tStr.split(":")[1]);
        if (h === 0) h = 24;
        return { h, m };
      }

      let validItems = list.filter(item => item.start_time && item.end_time);

      validItems.sort((a, b) => {
        const indexA = _userSortOrder.indexOf(String(a.id));
        const indexB = _userSortOrder.indexOf(String(b.id));
        let weightA = indexA === -1 ? 9999 : indexA;
        let weightB = indexB === -1 ? 9999 : indexB;
        if (weightA !== weightB) return weightA - weightB;
        const aTime = parseTime(a.start_time);
        const bTime = parseTime(b.start_time);
        return (aTime.h * 60 + aTime.m) - (bTime.h * 60 + bTime.m);
      });

      // --- â˜… æ­¥é©Ÿä¸€ï¼šæ¥µè‡´ç²¾ç®—çš„ç©ºé–“æ„Ÿæ¸¬å™¨ ---
      let hourHeights = new Array(slots.length).fill(BASE_ROW_HEIGHT);
      let dayWidths = new Array(7).fill(CARD_WIDTH);

      for (let i = 0; i < 7; i++) {
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);
        const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();
        const dayItems = validItems.filter(item => item.day_of_week === dbDay);

        let maxDayW = CARD_WIDTH;
        dayItems.forEach(item => {
          // å¯¬åº¦æ„Ÿæ¸¬ï¼šé‡å° 20px å­—é«”åšç²¾ç®—ï¼Œå¤§å¹…ç¸®æ¸›ç·©è¡ (åƒ…ç•™ +35px çµ¦åœ–ç¤º)
          const nameLen = (item.course_name || "").length;
          const subjectLen = (item.subject || "").length;
          const estimatedW = (nameLen * 21) + (subjectLen * 14) + 35;
          if (estimatedW > maxDayW) maxDayW = estimatedW;

          // é«˜åº¦æ„Ÿæ¸¬ï¼šé‡å°æ”¾å¤§å¾Œçš„å­—é«”ç´¯åŠ é«˜åº¦
          const sT = parseTime(item.start_time); const eT = parseTime(item.end_time);
          const durationMins = (eT.h * 60 + eT.m) - (sT.h * 60 + sT.m);

          let contentReq = 75; // åŸºç¤é«˜åº¦ (20px å§“å + 16px æ™‚é–“)
          if (item.subject) contentReq += 24;
          contentReq += 22; // æ•™å®¤
          contentReq += 22; // é‡‘é¡
          const phoneList = (item.phone || "").split(/\s+/).filter(p => p.trim() !== "");
          contentReq += (phoneList.length * 20);

          const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          if (record && record.remark) contentReq += 52; // å‚™è¨»é«˜åº¦åŒæ­¥å¢åŠ 
          else contentReq += 10;

          const neededPerHour = (contentReq / durationMins) * 60;
          for (let h = sT.h - START_HOUR; h <= eT.h - START_HOUR && h < slots.length; h++) {
            hourHeights[h] = Math.max(hourHeights[h], neededPerHour);
          }
        });
        dayWidths[i] = Math.min(maxDayW, 300); // å…è¨±ç¨å¾®è®Šæ›´å¯¬ï¼Œä½†è¦è²¼é½Šå­—
      }

      function getDynamicTop(h, m) {
        let top = 0;
        const hIdx = h - START_HOUR;
        for (let i = 0; i < hIdx && i < slots.length; i++) top += hourHeights[i];
        if (hIdx >= 0 && hIdx < slots.length) top += (m / 60) * hourHeights[hIdx];
        return top;
      }

      // --- â˜… æ­¥é©ŸäºŒï¼šå®Œç¾æ¯”ä¾‹ GPU æ¸²æŸ“ç¹ªè£½ ---

      const timeCol = document.createElement("div");
      // ç§»é™¤äº† md:w-[90px] w-[60px] é€™äº›å›ºå®šå¯¬åº¦ class
      timeCol.className = "sticky left-0 z-[500] bg-white border-r border-[#e9e9e7] flex flex-col shrink-0";
      // å¯¬åº¦å¥—ç”¨è®Šæ•¸
      timeCol.style.width = `calc(60px * var(--z, 1))`;

      const timeHeader = document.createElement("div");
      timeHeader.className = "sticky top-0 z-[600] bg-gray-50 border-b border-[#e9e9e7] text-xs font-bold text-gray-600 flex items-center justify-center";
      // é«˜åº¦å¥—ç”¨è®Šæ•¸
      timeHeader.style.height = `calc(60px * var(--z, 1))`;
      // å…§éƒ¨æ–‡å­—ä¹Ÿé€²è¡Œç­‰æ¯”ä¾‹ç¸®æ”¾
      timeHeader.innerHTML = `<span style="display:inline-block; transform: scale(var(--z, 1)); transform-origin: center;">æ™‚é–“</span>`;
      timeCol.appendChild(timeHeader);

      slots.forEach((h, index) => {
        const cell = document.createElement("div");
        cell.className = "flex items-center justify-center text-xs font-semibold text-gray-400 border-b border-[#e9e9e7] bg-gray-50/30";
        cell.style.height = `calc(${hourHeights[index]}px * var(--z, 1))`;
        cell.innerHTML = `<span style="display:inline-block; transform: scale(var(--z, 1)); transform-origin: center;">${h}:00</span>`;
        timeCol.appendChild(cell);
      });
      container.appendChild(timeCol);

      for (let i = 0; i < 7; i++) {
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);
        const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();
        const dayItems = validItems.filter(item => item.day_of_week === dbDay);
        const currentDayUnitWidth = dayWidths[i];

        const columns = []; const cardColIndex = {};
        dayItems.forEach(item => {
          const sM = parseTime(item.start_time).h * 60 + parseTime(item.start_time).m;
          const eM = parseTime(item.end_time).h * 60 + parseTime(item.end_time).m;
          let placed = false;
          for (let col = 0; col < columns.length; col++) {
            const overlap = columns[col].some(o => {
              const osM = parseTime(o.start_time).h * 60 + parseTime(o.start_time).m;
              const oeM = parseTime(o.end_time).h * 60 + parseTime(o.end_time).m;
              return (sM < oeM && eM > osM);
            });
            if (!overlap) { columns[col].push(item); cardColIndex[item.id] = col; placed = true; break; }
          }
          if (!placed) { columns.push([item]); cardColIndex[item.id] = columns.length - 1; }
        });

        const dayCol = document.createElement("div");
        dayCol.className = "flex flex-col border-r border-[#e9e9e7] shrink-0 relative bg-white transition-all";
        dayCol.style.width = `calc(${Math.max(1, columns.length) * currentDayUnitWidth + 1}px * var(--z, 1))`;

        const header = document.createElement("div");
        header.className = "sticky top-0 z-[400] bg-gray-50 border-b border-[#e9e9e7] flex flex-col items-center justify-center overflow-hidden";
        header.style.height = `calc(60px * var(--z, 1))`;
        const isToday = formatDate(new Date()) === thisDayDateStr;
        header.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; transform: scale(var(--z, 1)); transform-origin: center;">
                  <span class="${isToday ? 'text-blue-600 font-bold' : 'text-gray-800 font-bold'}">${dayNames[thisDayDate.getDay()]}</span>
                  <span class="text-[10px] text-gray-400">${thisDayDate.getMonth() + 1}/${thisDayDate.getDate()}</span>
                </div>`;
        dayCol.appendChild(header);

        const contentLayer = document.createElement("div");
        contentLayer.className = "relative w-full";
        contentLayer.style.height = `calc(${hourHeights.reduce((a, b) => a + b, 0)}px * var(--z, 1))`;

        slots.forEach((_, index) => {
          const line = document.createElement("div");
          line.className = "border-b border-[#e9e9e7] w-full pointer-events-none";
          line.style.height = `calc(${hourHeights[index]}px * var(--z, 1))`;
          contentLayer.appendChild(line);
        });

        dayItems.forEach((item) => {
          const sT = parseTime(item.start_time); const eT = parseTime(item.end_time);
          const topPx = getDynamicTop(sT.h, sT.m);
          const heightPx = getDynamicTop(eT.h, eT.m) - topPx;
          const myIndex = cardColIndex[item.id];

          const today = new Date();
          const cardDate = new Date(thisDayDateStr);
          const currentYearMonth = today.getFullYear() * 12 + today.getMonth();
          const cardYearMonth = cardDate.getFullYear() * 12 + cardDate.getMonth();
          const monthDiff = currentYearMonth - cardYearMonth;

          const isLocked = monthDiff >= 2 && !currentUserInfo?.is_admin;

          const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          let displayStatus = record ? record.status : (item.color_class || 'status-pending');
          const remarkText = record ? record.remark : "";
          const displayRemark = remarkText ? remarkText.replace(/\n/g, ' ') : "";

          let statusBorder = 'border-l-4 border-gray-300'; let bgClass = 'bg-white';
          if (displayStatus === 'attended' || displayStatus === 'status-present') { statusBorder = 'border-l-4 border-green-500'; bgClass = 'bg-green-50'; }
          else if (displayStatus === 'leave' || displayStatus === 'status-leave') { statusBorder = 'border-l-4 border-amber-400'; bgClass = 'bg-amber-50'; }
          else if (displayStatus === 'absent' || displayStatus === 'status-absent') { statusBorder = 'border-l-4 border-red-500'; bgClass = 'bg-red-50'; }
          else if (displayStatus === 'status-practice') { statusBorder = 'border-l-4 border-blue-400'; bgClass = 'bg-blue-50'; }

          const card = document.createElement("div");
          card.className = `schedule-card absolute rounded-r-md rounded-l-sm p-2 pb-3 text-sm shadow-md flex flex-col transition-all duration-200 group box-border ${isLocked ? 'card-locked' : 'hover:shadow-xl hover:z-[70] cursor-pointer'} ${statusBorder} ${bgClass}`;
          card.dataset.id = item.id;

          if (!isLocked) {
            card.draggable = true;
            card.ondragstart = (e) => handleDragStart(e, item.id);
            card.ondragenter = (e) => {
              e.preventDefault();
              card.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'z-[80]');
            };
            card.ondragleave = () => {
              card.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'z-[80]');
            };
            card.ondragover = (e) => e.preventDefault();
            card.ondrop = (e) => {
              card.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'z-[80]');
              handleDrop(e, item.id);
            };
            card.ondragend = (e) => handleDragEnd(e);
          }

          // â˜… çµ‚æ¥µé­”æ³•ï¼š
          // 1. åº§æ¨™ (top, left) äº¤çµ¦ calc(...) æ•¸å­¸é‹ç®—ï¼Œç¢ºä¿ç²¾æº–è½é»ã€‚
          // 2. å¯¦é«”å¯¬é«˜ (width, height) ä¿æŒåŸæ¯”ä¾‹ï¼Œç¢ºä¿æ–‡å­—çµ•ä¸æ“ å£“ï¼
          // 3. åˆ©ç”¨ GPU (transform: scale) ç›´æ¥å°‡å®Œæ•´ç•«å¥½çš„å¡ç‰‡ç­‰æ¯”ä¾‹ç¸®å°ã€‚
          card.style.cssText = `
                    top: calc(${topPx}px * var(--z, 1)); 
                    left: calc(${myIndex * currentDayUnitWidth}px * var(--z, 1)); 
                    width: ${currentDayUnitWidth}px; 
                    min-height: ${heightPx}px; 
                    height: ${heightPx}px; 
                    z-index: 20; 
                    overflow: hidden;
                    transform: scale(var(--z, 1));
                    transform-origin: 0 0;
                `;

          const phoneList = (item.phone || "").split(/\s+/).filter(p => p.trim() !== "");
          const phoneHtml = phoneList.map(p => `<div class="flex items-center gap-1.5 text-[16px] text-gray-500 w-full"><i data-lucide="phone" class="w-4 h-4 text-green-500 shrink-0"></i><span class="font-mono truncate flex-1 font-bold">${p}</span></div>`).join('');

          card.innerHTML = `
            ${isLocked ? '<div class="absolute top-1 right-1 text-gray-400/40"><i data-lucide="lock" class="w-3.5 h-3.5"></i></div>' : `
              <div class="absolute top-1 right-1 flex flex-row items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] bg-white/95 backdrop-blur-sm px-1.5 py-1 rounded-full shadow-md border border-gray-200" 
                   style="pointer-events: auto;" onmousedown="event.stopPropagation();" onclick="event.stopPropagation();">
                  <button type="button" onclick="openRemarkModal('${item.id}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-yellow-600 hover:scale-110 transition-all cursor-pointer"><i data-lucide="sticky-note" class="w-4 h-4"></i></button>
                  <button type="button" onclick="openEditModal('${item.id}', '${displayStatus}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-blue-600 hover:scale-110 transition-all cursor-pointer"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                  <button type="button" onclick="copyCourse('${item.id}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-gray-500 hover:text-amber-600 hover:scale-110 transition-all cursor-pointer"><i data-lucide="copy" class="w-4 h-4"></i></button>
                  <button type="button" onclick="deleteCourse('${item.id}');" class="p-1 rounded-full text-red-500 hover:scale-110 transition-all cursor-pointer"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
            `}
            
            <div class="flex flex-col h-full min-w-0 pr-1 relative z-10" onclick="${isLocked ? '' : `toggleRecordStatus('${item.id}', '${thisDayDateStr}', '${displayStatus}')`}">
                <div class="flex items-center gap-1.5 w-full">
                    <span class="font-bold text-neutral-900 text-[20px] whitespace-nowrap">${item.course_name}</span>
                    ${item.subject ? `<span class="text-[16px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded shrink-0 font-bold">${item.subject}</span>` : ''}
                </div>
                <div class="text-[16px] text-gray-400 font-mono mt-0.5 whitespace-nowrap font-bold">${item.start_time.slice(0, 5)} - ${item.end_time.slice(0, 5)}</div>
                <div class="mt-1 flex flex-col gap-1 pointer-events-none w-full">
                    <div class="flex items-center gap-1.5 text-[16px] text-gray-600 truncate font-bold"><i data-lucide="map-pin" class="w-4 h-4 text-blue-400 shrink-0"></i><span>${item.room_no || 'ç„¡'}</span></div>
                    <div class="flex items-center gap-1.5 text-[16px] text-gray-600 truncate font-bold"><i data-lucide="coins" class="w-4 h-4 text-amber-500 shrink-0"></i><span class="font-mono truncate flex-1">$${item.amount || 0}</span></div>
                    ${phoneHtml}
                </div>
                <div class="mt-auto pt-2 pointer-events-none w-full">
                    ${displayRemark ? `<div class="flex items-center gap-1.5 p-1.5 rounded bg-red-50 border border-red-100 text-red-700 text-[16px] font-bold leading-tight"><i data-lucide="pin" class="w-4 h-4 shrink-0"></i> <span class="truncate">${displayRemark}</span></div>` : ''}
                </div>
            </div>
          `;
          contentLayer.appendChild(card);
        });
        dayCol.appendChild(contentLayer);
        container.appendChild(dayCol);
      }
      lucide.createIcons();
    }

    // --- 2. è¤‡è£½èª²ç¨‹åŠŸèƒ½ (å‡ç´šç‰ˆï¼šé è¨­å¸¶å…¥æ‰€é»æ“Šçš„æ—¥æœŸ) ---
    function copyCourse(itemId, dateStr) {
      // å…ˆæ‰“é–‹ç·¨è¼¯è¦–çª—ï¼ŒæŠŠèˆŠè³‡æ–™éƒ½å¡«é€²å»
      openEditModal(itemId, null, dateStr);

      document.querySelector("#course-modal h3").textContent = "è¤‡è£½ä¸¦æ’å…¥æ–°æ—¥æœŸ";
      editingId = null; // è®Šæˆæ–°å¢æ¨¡å¼

      // â˜… è‡ªå‹•åˆ‡æ›ç‚ºã€Œå–®æ¬¡/è‡¨æ™‚èª²ç¨‹ã€æ¨¡å¼ï¼Œä¸¦å±•é–‹æ—¥æ›†
      const tempCheckbox = document.getElementById("is_temporary");
      const dateWrapper = document.getElementById("temp-date-wrapper");
      const dateInput = document.getElementById("target_date_input");

      if (tempCheckbox) tempCheckbox.checked = true;
      if (dateWrapper) dateWrapper.classList.remove('hidden');
      if (dateInput) {
        // â˜… é—œéµä¿®æ”¹ï¼šå°‡ formatDate(new Date()) æ”¹æˆ dateStr
        // é€™æ¨£æ—¥æ›†å°±æœƒç›´æ¥é è¨­ç‚ºã€Œå¦³é»æ“Šçš„é‚£ä¸€å¤©ã€ï¼
        dateInput.value = dateStr;
      }
    }

    // --- é»åç‹€æ…‹åˆ‡æ›æ ¸å¿ƒé‚è¼¯ (å‡ç´šç‰ˆï¼šæ¨‚è§€æ›´æ–°ï¼Œé»å¤šå¿«éƒ½ä¸æ¼ç®—ï¼) ---
    async function toggleRecordStatus(scheduleId, dateStr, currentStatus) {
      let nextStatus = '';

      // 1. æ±ºå®šä¸‹ä¸€å€‹ç‹€æ…‹ (å¾ªç’°ï¼šç° -> ç¶  -> å’– -> ç´… -> ç°)
      if (!currentStatus || currentStatus === 'status-pending') {
        nextStatus = 'status-present';
      } else if (currentStatus === 'attended' || currentStatus === 'status-present') {
        nextStatus = 'status-leave';
      } else if (currentStatus === 'leave' || currentStatus === 'status-leave') {
        nextStatus = 'status-absent';
      } else {
        nextStatus = 'status-pending';
      }

      // 2. å–å¾—é€™å ‚èª²æ¯ç‰ˆçš„ã€Œé è¨­ç‹€æ…‹ã€
      const masterItem = _cachedSchedule.find(s => s.id === scheduleId);
      const masterDefault = (masterItem && masterItem.color_class) ? masterItem.color_class : 'status-pending';

      // â˜…â˜…â˜… 3. æ¨‚è§€æ›´æ–° (Optimistic UI)ï¼šç›´æ¥ç«„æ”¹æœ¬åœ°è¨˜æ†¶é«”ï¼Œä¸ç­‰è³‡æ–™åº«äº†ï¼ â˜…â˜…â˜…
      let existingRecordIndex = _cachedRecords.findIndex(r => r.schedule_id === scheduleId && r.actual_date === dateStr);

      if (nextStatus === masterDefault) {
        // å¦‚æœåˆ‡å›é è¨­ç‹€æ…‹ï¼Œå°±å¾è¨˜æ†¶é«”è£¡æŠŠé€™ç­†ç‰¹åˆ¥ç´€éŒ„åˆªæ‰
        if (existingRecordIndex !== -1) _cachedRecords.splice(existingRecordIndex, 1);
      } else {
        // å¦å‰‡ï¼Œæ›´æ–°è¨˜æ†¶é«”ï¼Œæˆ–æ˜¯å¡ä¸€ç­†æ–°çš„é€²å»
        if (existingRecordIndex !== -1) {
          _cachedRecords[existingRecordIndex].status = nextStatus;
        } else {
          _cachedRecords.push({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus, remark: "" });
        }
      }

      // â˜… ç¬é–“é‡ç•«å¡ç‰‡é¡è‰²ï¼Œä¸¦ç¬é–“æ›´æ–°å·¦ä¸Šè§’çš„æ•¸å­—ï¼(0å»¶é²)
      renderSchedule(_cachedSchedule, _cachedRecords);
      updateStatsUI();

      // 4. èƒŒæ™¯é»˜é»˜å­˜æª”
      try {
        if (nextStatus === masterDefault) {
          await _client.from("lesson_records").delete().eq("schedule_id", scheduleId).eq("actual_date", dateStr);
        } else {
          const { data: existing } = await _client.from("lesson_records").select("id").eq("schedule_id", scheduleId).eq("actual_date", dateStr).maybeSingle();
          if (existing) {
            await _client.from("lesson_records").update({ status: nextStatus }).eq("id", existing.id);
          } else {
            await _client.from("lesson_records").insert({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus });
          }
        }

        // â˜… ç›£è¦–å™¨ï¼šå¯«å…¥é»åæ—¥èªŒ (æŠŠè‹±æ–‡ç‹€æ…‹ç¿»è­¯æˆä¸­æ–‡æ¯”è¼ƒå¥½çœ‹)
        const statusZhMap = { 'status-present': 'ä¸Šèª²', 'status-leave': 'è«‹å‡', 'status-absent': 'æ› èª²', 'status-pending': 'å°šæœªé»å', 'status-practice': 'ç·´ç¿’' };
        const statusZh = statusZhMap[nextStatus] || nextStatus;

        await recordLog('ä¿®æ”¹é»å', `å°‡ [${masterItem.course_name}] åœ¨ ${dateStr} çš„ç‹€æ…‹æ”¹ç‚º [${statusZh}]`, 'lesson_records',
          { schedule_id: scheduleId, actual_date: dateStr, status: currentStatus }, // èˆŠç‹€æ…‹
          { schedule_id: scheduleId, actual_date: dateStr, status: nextStatus }     // æ–°ç‹€æ…‹
        );

      } catch (err) {
        console.error("é»åç‹€æ…‹å­˜æª”å¤±æ•—:", err);
      }
    }

    // --- å°ˆé–€è™•ç†å¡ç‰‡å±•é–‹/æ”¶åˆçš„å‡½å¼ ---
    function handleToggleExpand(btn) {
      // 1. æ‰¾åˆ°è©²æŒ‰éˆ•æ‰€å±¬çš„å¡ç‰‡
      const card = btn.closest('.absolute.rounded-md');
      if (!card) return;

      // 2. åˆ‡æ›å±•é–‹ class
      const isExpanded = card.classList.toggle('card-expanded');

      // 3. è¦–è¦ºå›é¥‹ï¼šæ—‹è½‰ç®­é ­ 180 åº¦
      if (isExpanded) {
        btn.style.transform = 'rotate(180deg)';
      } else {
        btn.style.transform = 'rotate(0deg)';
      }

      // 4. é‡æ–°è§¸ç™¼ Lucide åœ–ç¤ºæ¸²æŸ“ (ç¢ºä¿åœ–ç¤ºæ­£ç¢ºé¡¯ç¤º)
      lucide.createIcons();
    }

    // 5. è€å¸«ç®¡ç†åŠŸèƒ½
    // æ–°å¢è€å¸«èˆ‡å»ºç«‹ç™»å…¥å¸³è™Ÿ
    async function addTeacher() {
      const nameInput = document.getElementById("new-teacher-name");
      const usernameInput = document.getElementById("new-teacher-username");
      const pwdInput = document.getElementById("new-teacher-password");

      const name = nameInput.value.trim();
      // å¦‚æœæ‚¨çš„ HTML é‚„æ²’è£œä¸Šé€™å…©å€‹æ¡†ï¼Œå…ˆçµ¦å€‹ç©ºå­—ä¸²é˜²å‘†
      const username = usernameInput ? usernameInput.value.trim() : "";
      const password = pwdInput ? pwdInput.value : "";

      if (!name) return sysAlert("è«‹è¼¸å…¥è€å¸«å§“å", "è³‡æ–™ä¸é½Šå…¨");
      if (!username || !password) return sysAlert("è«‹è¨­å®šç™»å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼", "è³‡æ–™ä¸é½Šå…¨");
      if (password.length < 6) return sysAlert("ç‚ºäº†å®‰å…¨ï¼Œå¯†ç¢¼è‡³å°‘éœ€è¦ 6 ç¢¼å–”ï¼", "å¯†ç¢¼å¤ªçŸ­");

      // é…åˆç™»å…¥é é¢çš„é‚è¼¯ï¼Œè‡ªå‹•è£œä¸Šä¿¡ç®±å¾Œç¶´ (è«‹ç¢ºä¿ FAKE_DOMAIN è®Šæ•¸èˆ‡ login.html ä¸€è‡´)
      const FAKE_DOMAIN = "@munique.com"; // å¦‚æœæ‚¨æœ‰è‡ªå·±è¨­å®šçš„å¾Œç¶´ï¼Œè«‹æ”¹é€™è£¡
      const finalEmail = username.includes('@') ? username : (username + FAKE_DOMAIN);

      setStatus("æ­£åœ¨å»ºç«‹å¸³è™Ÿèˆ‡è³‡æ–™...");

      // æ­¥é©Ÿä¸€ï¼šåœ¨ Supabase Auth å»ºç«‹ç™»å…¥å¸³è™Ÿ
      const { data: authData, error: authError } = await _client.auth.signUp({
        email: finalEmail,
        password: password,
      });

      if (authError) {
        setStatus("å¸³è™Ÿå»ºç«‹å¤±æ•—", "error");
        return sysAlert("å»ºç«‹å¸³è™Ÿå¤±æ•—: " + authError.message, "ç³»çµ±éŒ¯èª¤");
      }

      // æ­¥é©ŸäºŒï¼šå¸³è™Ÿå»ºç«‹æˆåŠŸå¾Œï¼Œå°‡è€å¸«åå–®å¯«å…¥è³‡æ–™åº«
      const { data, error } = await _client.from("teachers").insert([{ name: name }]).select();

      if (error) {
        setStatus("è€å¸«åå–®æ–°å¢å¤±æ•—", "error");
        return sysAlert("æ–°å¢å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
      }

      // å¯«å…¥æ—¥èªŒ (å°‡ç™¼é…çš„å¸³è™Ÿä¹Ÿè¨˜éŒ„ä¸‹ä¾†)
      await recordLog('æ–°å¢è€å¸«', `å»ºç«‹æ–°è€å¸« [${name}] ä¸¦é…ç™¼ç™»å…¥å¸³è™Ÿ [${username}]`, 'teachers', null, data[0]);

      // æ¸…ç©ºè¼¸å…¥æ¡†
      nameInput.value = "";
      if (usernameInput) usernameInput.value = "";
      if (pwdInput) pwdInput.value = "";

      setStatus("è€å¸«èˆ‡å¸³è™Ÿæ–°å¢æˆåŠŸï¼", "success");
      await sysAlert(`å·²ç¶“æˆåŠŸç‚º ${name} å»ºç«‹å¸³è™Ÿï¼<br>ç™»å…¥å¸³è™Ÿï¼š${username}<br>ç™»å…¥å¯†ç¢¼ï¼š${password}`, "å»ºç«‹æˆåŠŸ");

      await fetchTeachers();
      await renderTeacherManageList();
    }

    // 6. è¼”åŠ©å‡½æ•¸ (åŠ å¤§ç‰ˆï¼špx-2.5, py-1, -ml-2)
    function setStatus(msg, type = "warn") {
      // å¦‚æœåªæ˜¯å¹³å¸¸åŒæ­¥ï¼Œå°±ä¸æ›´æ–°ç•«é¢ä¸Šé‚£å€‹æ¨™ç±¤ï¼Œé¿å…é–ƒçˆ
      if (msg.includes("æ­£åœ¨åŒæ­¥") || msg.includes("é€£ç·šæˆåŠŸ")) return;

      const el = document.getElementById("status-tag");
      if (!el) return;
      el.textContent = msg;

      // å®šç¾©é¡è‰²
      let colorClass = "bg-yellow-100 text-yellow-800"; // é è¨­ (é»ƒ)
      if (type === "error") colorClass = "bg-red-100 text-red-800"; // éŒ¯èª¤ (ç´…)
      if (type === "success") colorClass = "bg-green-100 text-green-800"; // æˆåŠŸ (ç¶ )

      // å¥—ç”¨æ¨£å¼ (åŒæ­¥åŠ å¤§èˆ‡å°é½Šä¿®æ­£)
      el.className = `text-[10px] md:text-xs px-2.5 py-1 rounded-md font-medium mt-0.5 -ml-2 ${colorClass}`;
    }

    // --- ç¨ç«‹çš„çµ±è¨ˆæ•¸å­—æ›´æ–°å™¨ (æ‰€è¦‹å³æ‰€å¾—ç²¾æº–ç‰ˆ) ---
    function updateStatsUI() {
      if (!_cachedSchedule) return;

      const START_HOUR = 9;

      // å·¥å…·ï¼šè™•ç†æ™‚é–“æ ¼å¼
      function parseTime(tStr) {
        if (!tStr) return { h: 0, m: 0 };
        let h = parseInt(tStr.split(":")[0]);
        let m = parseInt(tStr.split(":")[1]);
        if (h === 0) h = 24;
        return { h, m };
      }

      // 1. æŠ“å‡ºçœŸæ­£æœ‰é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„èª² (éæ¿¾æ‰æ²’æ™‚é–“æˆ–å¤ªæ—©çš„)
      let validItems = _cachedSchedule.filter(item => {
        if (!item.start_time || !item.end_time) return false;
        return parseTime(item.start_time).h >= START_HOUR;
      });

      let total = 0;
      let presentOrAbsentCount = 0;
      let leaveCount = 0;

      const baseDate = currentBaseDate;

      // 2. æ¨¡æ“¬ç•« 7 å¤©çš„å¡ç‰‡ï¼Œç²¾æº–çµç®—æ¯ä¸€å¤©æ¯ä¸€å ‚èª²çš„ã€Œæœ€çµ‚é¡è‰²ã€
      for (let i = 0; i < 7; i++) {
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);
        const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();

        // æ‰¾å‡ºé€™å¤©æ‰€æœ‰çš„èª²
        const dayItems = validItems.filter(item => item.day_of_week === dbDay);

        dayItems.forEach(item => {
          total++; // åªè¦é€™å¤©æœ‰é€™å ‚èª²ï¼Œç¸½å ‚æ•¸å°± +1

          // â˜… æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·é€™å ‚èª²ã€Œæœ€çµ‚é¡¯ç¤ºã€çš„ç‹€æ…‹
          // (å„ªå…ˆçœ‹æœ‰æ²’æœ‰ç‰¹åˆ¥çš„é»åç´€éŒ„ï¼Œæ²’æœ‰çš„è©±å°±çœ‹æ¯ç‰ˆçš„é è¨­ç‹€æ…‹)
          const record = _cachedRecords.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          const displayStatus = record ? record.status : (item.color_class || 'status-pending');

          // æ ¹æ“šæœ€çµ‚é¡¯ç¤ºç‹€æ…‹ä¾†åŠ ç¸½
          if (['attended', 'status-present', 'absent', 'status-absent'].includes(displayStatus)) {
            presentOrAbsentCount++;
          } else if (['leave', 'status-leave'].includes(displayStatus)) {
            leaveCount++;
          }
        });
      }

      // 3. è¼¸å‡ºåˆ°ç•«é¢ä¸Š (å„ªåŒ–æ¨™ç±¤é¡¯ç¤º)
      const statsTag = document.getElementById("status-tag");
      if (statsTag) {
        statsTag.textContent = `ç¸½å ‚æ•¸ï¼š${total} | å·²é»å+æ› èª²ï¼š${presentOrAbsentCount} | è«‹å‡ï¼š${leaveCount}`;
        statsTag.className = "text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-blue-50 text-blue-700 font-bold mt-0.5 -ml-2 border border-blue-100";
      }
    }

    // æ–°å¢é€™å€‹å‡½å¼ï¼Œè®“å½ˆçª—å¯ä»¥æ‰“é–‹
    function openModal() {
      document.getElementById("course-modal").classList.remove("hidden");
    }
    function closeModal() {
      editingId = null;
      document.getElementById("course-modal").classList.add("hidden");
      document.getElementById("course-form").reset();
      document.querySelector("#course-modal h3").textContent = "æ–°å¢èª²ç¨‹è³‡æ–™";
    }
    function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
    }
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
    }

    // 7. ä¿®æ”¹èˆ‡åˆªé™¤
    function openEditModal(id, status, dateStr) {
      editingId = id;
      editingDateStr = dateStr;

      const item = _cachedSchedule.find(i => i.id === id);
      if (!item) return;

      const form = document.getElementById("course-form");
      form.day_of_week.value = item.day_of_week;
      form.teacher_id.value = item.teacher_id;
      form.course_name.value = item.course_name;
      form.start_time.value = item.start_time.slice(0, 5);
      form.end_time.value = item.end_time.slice(0, 5);
      form.room_no.value = item.room_no || "";
      form.amount.value = item.amount || 0;
      form.phone.value = item.phone || "";
      form.subject.value = item.subject || "";

      const record = _cachedRecords.find(r => r.schedule_id === id && r.actual_date === dateStr);
      let displayStatus = item.color_class || 'status-pending';
      if (record) displayStatus = record.status;

      form.color_class.value = displayStatus;
      if (displayStatus === 'attended') form.color_class.value = 'status-present';
      if (displayStatus === 'leave') form.color_class.value = 'status-leave';
      if (displayStatus === 'absent') form.color_class.value = 'status-absent';

      // â˜… è™•ç†å–®æ¬¡èª²ç¨‹å‹¾é¸èˆ‡æ—¥æœŸé¡¯ç¤º
      const tempCheckbox = document.getElementById("is_temporary");
      const dateWrapper = document.getElementById("temp-date-wrapper");
      const dateInput = document.getElementById("target_date_input");

      if (tempCheckbox) {
        tempCheckbox.checked = item.is_temporary || false;
        if (dateWrapper) dateWrapper.classList.toggle('hidden', !tempCheckbox.checked);
        if (dateInput) {
          // å¦‚æœé€™å ‚èª²æœ¬ä¾†å°±æ˜¯å–®æ¬¡èª²ï¼Œå¡«å…¥å®ƒçš„æŒ‡å®šæ—¥æœŸï¼›å¦å‰‡é è¨­å¸¶å…¥ç•¶å¤©
          dateInput.value = item.target_date || dateStr || formatDate(new Date());
        }
      }

      document.querySelector("#course-modal h3").textContent = "ä¿®æ”¹å›ºå®šèª²è¡¨";
      openModal();
    }

    async function deleteCourse(id) {
      if (!(await sysConfirm("ç¢ºå®šè¦åˆªé™¤é€™å ‚èª²å—ï¼Ÿ<br><span class='text-xs text-red-500'>*è³‡æ–™å°‡æœƒä¿ç•™æ–¼å¾Œå°ï¼Œå¯éš¨æ™‚å¾©åŸ</span>", "åˆªé™¤ç¢ºèª", "danger"))) return;

      const oldData = _cachedSchedule.find(s => s.id === id);

      // â˜… æ ¸å¿ƒæ”¹è®Šï¼šä¸å†åŸ·è¡Œ .delete()ï¼Œæ”¹åŸ·è¡Œ .update() è²¼ä¸Šæ¨™ç±¤
      const { error } = await _client
        .from("schedules")
        .update({ is_deleted: true })
        .eq("id", id);

      if (!error && oldData) {
        await recordLog('åˆªé™¤èª²ç¨‹', `åˆªé™¤äº† [${oldData.course_name}] çš„èª²ç¨‹`, 'schedules', oldData, null);
        setStatus("å·²æ¨™è¨˜ç‚ºåˆªé™¤", "success");
      } else if (error) {
        await sysAlert("åˆªé™¤å¤±æ•—ï¼š" + error.message, "ç³»çµ±éŒ¯èª¤");
      }

      await refreshData();
    }

    // 8. è¡¨å–®æäº¤ (æ”¯æ´ 00:00 è·¨å¤œé‚è¼¯èˆ‡æŒ‡å®šæ—¥æœŸæ™ºæ…§æ¨ç®—)
    document.getElementById("course-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = new FormData(e.target);

      let sTime = f.get("start_time");
      let eTime = f.get("end_time");
      let checkETime = eTime === "00:00" ? "24:00" : eTime;

      if (sTime >= checkETime) {
        return sysAlert("çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“", "æ™‚é–“è¨­å®šéŒ¯èª¤");
      }

      const isTemporary = document.getElementById("is_temporary").checked;
      let finalTargetDate = null;
      let dayOfWeek = parseInt(f.get("day_of_week"));

      // â˜… ç¥ç´šé˜²å‘†ï¼šå¦‚æœå‹¾é¸äº†å–®æ¬¡èª²ç¨‹ï¼Œç›´æ¥æ‹¿å¦³é¸çš„æ—¥æœŸä¾†åæ¨æ˜ŸæœŸå¹¾ï¼
      // (é€™æ¨£å¦³å°±ä¸ç”¨ç®¡ä¸Šé¢é‚£å€‹ã€Œä¸Šèª²æ˜ŸæœŸã€çš„ä¸‹æ‹‰é¸å–®äº†)
      if (isTemporary) {
        finalTargetDate = f.get("target_date");
        if (!finalTargetDate) return sysAlert("è«‹é¸æ“‡å–®æ¬¡èª²ç¨‹çš„æ—¥æœŸï¼", "è³‡æ–™ä¸é½Šå…¨");

        const d = new Date(finalTargetDate);
        dayOfWeek = d.getDay();
        if (dayOfWeek === 0) dayOfWeek = 7; // é€±æ—¥è½‰æ›ç‚º 7
      }

      const data = {
        teacher_id: f.get("teacher_id"),
        day_of_week: dayOfWeek, // é€™è£¡å·²ç¶“æ˜¯è‡ªå‹•ç®—å¥½çš„æ­£ç¢ºæ˜ŸæœŸäº†
        course_name: f.get("course_name"),
        start_time: sTime + ":00",
        end_time: eTime + ":00",
        room_no: f.get("room_no"),
        amount: parseInt(f.get("amount")) || 0,
        phone: f.get("phone"),
        subject: f.get("subject"),
        color_class: f.get("color_class"),
        target_date: finalTargetDate,
        is_temporary: isTemporary
      };

      // â˜… ç›£è¦–å™¨ï¼šæ‹ç…§è¨˜ä¸‹ä¿®æ”¹å‰çš„æ¨£å­
      const oldData = editingId ? _cachedSchedule.find(s => s.id === editingId) : null;

      // â˜… åŠ ä¸Š .select() è®“è³‡æ–™åº«å­˜å®Œå¾Œé †ä¾¿æŠŠæ–°è³‡æ–™å‚³å›ä¾†çµ¦æˆ‘å€‘
      const res = editingId
        ? await _client.from("schedules").update(data).eq("id", editingId).select()
        : await _client.from("schedules").insert([data]).select();

      if (res.error) {
        return sysAlert("æ“ä½œå¤±æ•—: " + res.error.message, "ç³»çµ±éŒ¯èª¤");
      }

      // â˜… ç›£è¦–å™¨å‡ç´šï¼šç²¾æº–æŠ“å‡ºåˆ°åº•ã€Œæ”¹äº†å“ªäº›æ¬„ä½ã€
      const newData = res.data[0];
      let actionType = 'æ–°å¢èª²ç¨‹';
      let actionDesc = `[${newData.course_name}]ï¼šæ–°å¢äº†ä¸€å ‚èª²`;

      // å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œå•Ÿå‹•å·®ç•°æ¯”å°å¼•æ“ï¼
      if (editingId && oldData) {
        actionType = 'ä¿®æ”¹èª²ç¨‹';
        // ==========================================
        // ğŸ“ æº–å‚™å¯«å…¥æ—¥èªŒçš„ã€Œç™½è©±æ–‡ç¿»è­¯æ©Ÿã€
        // ==========================================
        let changes = [];

        // â˜… çµ‚æ¥µç‰ˆç¿»è­¯å­—å…¸ï¼šå‘Šè¨´ç³»çµ±æ‰€æœ‰æ¬„ä½å°æ‡‰çš„ä¸­æ–‡åç¨±
        const fieldMap = {
          course_name: 'å§“å',
          subject: 'ç§‘ç›®',
          phone: 'é›»è©±',
          amount: 'é‡‘é¡',
          day_of_week: 'æ˜ŸæœŸ',
          start_time: 'é–‹å§‹',
          end_time: 'çµæŸ',
          room_no: 'æ•™å®¤',
          is_temporary: 'å–®æ¬¡èª²ç¨‹',
          target_date: 'æŒ‡å®šæ—¥æœŸ'
        };
        const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };

        // è®“ç³»çµ±è‡ªå‹•å·¡è¦–å­—å…¸è£¡çš„æ¯ä¸€å€‹æ¬„ä½ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰è¢«ä¿®æ”¹
        for (const key in fieldMap) {
          let oldV = oldData[key];
          let newV = newData[key];

          // é‡å°ç‰¹æ®Šæ ¼å¼é€²è¡Œç¿»è­¯
          if (key === 'day_of_week') {
            oldV = dayMap[oldV] || oldV;
            newV = dayMap[newV] || newV;
          } else if (key === 'is_temporary') {
            oldV = oldV ? 'æ˜¯' : 'å¦';
            newV = newV ? 'æ˜¯' : 'å¦';
          } else if (key === 'start_time' || key === 'end_time') {
            oldV = oldV ? String(oldV).slice(0, 5) : '';
            newV = newV ? String(newV).slice(0, 5) : '';
          }

          // æ¸…ç†ç©ºç™½ä¸¦æŠŠ null è½‰æˆç©ºå­—ä¸²ï¼Œé˜²æ­¢èª¤åˆ¤
          let sOld = (oldV === null || oldV === undefined) ? '' : String(oldV).trim();
          let sNew = (newV === null || newV === undefined) ? '' : String(newV).trim();

          // å¦‚æœæ–°èˆŠè³‡æ–™ä¸ä¸€æ¨£ï¼Œå°±æŠŠé€™æ¢æ”¹è®Šå¯«é€²æ¸…å–®è£¡
          if (sOld !== sNew) {
            changes.push(`${fieldMap[key]}: ${sOld || 'ç„¡'} â” ${sNew || 'ç„¡'}`);
          }
        }

        // çµ„è£æœ€çµ‚çš„ç™½è©±æ–‡
        if (changes.length > 0) {
          actionDesc = `[${newData.course_name}]ï¼š${changes.join(' | ')}`;
        } else {
          actionDesc = `[${newData.course_name}]ï¼šé»æ“Šäº†å„²å­˜ (ç„¡æ¬„ä½è®Šå‹•)`;
        }
      }

      // å¯«å…¥æ—¥èªŒ
      await recordLog(actionType, actionDesc, 'schedules', oldData, newData);

      if (editingId && editingDateStr) {
        await _client.from("lesson_records")
          .update({ status: data.color_class })
          .match({ schedule_id: editingId, actual_date: editingDateStr });
      }

      closeModal();
      await refreshData();
    });

    // --- è€å¸«ç®¡ç†åŠŸèƒ½é‚è¼¯ ---

    // 1. é–‹å•Ÿç®¡ç†è¦–çª—ä¸¦è®€å–æœ€æ–°æ¸…å–®
    async function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
      await renderTeacherManageList();
      lucide.createIcons();
    }

    // 2. é—œé–‰è¦–çª—
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
      document.getElementById("new-teacher-name").value = "";
    }

    // 3. æ¸²æŸ“ç®¡ç†è¦–çª—å…§çš„è€å¸«åˆ—è¡¨ (ä¿®æ­£ç‰ˆï¼šéš±è— is_hidden çš„ç®¡ç†è€…)
    // è€å¸«ç®¡ç† (ç¾åŒ–ç‰ˆ) ---
    async function renderTeacherManageList() {
      const { data: teachers } = await _client.from("teachers").select("*").order("created_at");
      const list = document.getElementById("teacher-manage-list");
      list.innerHTML = "";

      // â˜… æ›¿æ›è¿´åœˆçš„é–‹é ­
      teachers.forEach(t => {
        // ğŸ¦¸â€â™‚ï¸ éš±å½¢æ–—ç¯· 2ï¼šåœ¨å¾Œå°åå–®å¾¹åº•éš±è— ccy (é€£ç®¡ç†å“¡ä¹Ÿçœ‹ä¸åˆ°)
        if (t.is_hidden || t.name.toLowerCase().includes('ccy')) return;

        const item = document.createElement("div");
        item.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100 group hover:border-blue-200 transition-all shadow-sm";
        item.dataset.id = t.id;

        item.innerHTML = `
          <div class="view-mode flex items-center gap-3 w-full">
            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center font-bold text-gray-500 text-xs">${t.name.charAt(0)}</div>
            <span class="text-sm font-bold text-gray-700 flex-1">${t.name}</span>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="openPermissionsModal('${t.id}')" class="p-1.5 text-gray-400 hover:text-yellow-600 rounded" title="è¨­å®šå´é‚Šæ¬„æ¬Šé™">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                </button>
                <button onclick="toggleEditMode('${t.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                <button onclick="deleteTeacher('${t.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </div>
          <div class="edit-mode hidden w-full flex items-center gap-2">
            <input type="text" value="${t.name}" class="edit-input flex-1 border rounded px-2 py-1 text-sm outline-none" onkeydown="if(event.key==='Enter') updateTeacher('${t.id}', this.value)">
            <button onclick="updateTeacher('${t.id}', this.previousElementSibling.value)" class="text-green-600"><i data-lucide="check" class="w-4 h-4"></i></button>
            <button onclick="toggleEditMode('${t.id}', false)" class="text-gray-400"><i data-lucide="x" class="w-4 h-4"></i></button>
          </div>
        `;
        list.appendChild(item);
      });
      lucide.createIcons();
    }

    // --- æ–°å¢çš„åŠŸèƒ½ï¼šåˆ‡æ›ç·¨è¼¯æ¨¡å¼ ---
    function toggleEditMode(id, showEdit = true) {
      const item = document.querySelector(`div[data-id="${id}"]`);
      if (!item) return;

      const viewMode = item.querySelector('.view-mode');
      const editMode = item.querySelector('.edit-mode');
      const input = item.querySelector('.edit-input');

      if (showEdit) {
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        input.focus(); // è‡ªå‹•èšç„¦åˆ°è¼¸å…¥æ¡†
        input.select(); // å…¨é¸æ–‡å­—æ–¹ä¾¿ä¿®æ”¹
      } else {
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
      }
    }

    // 1. ä¿®æ”¹è€å¸«åå­—é˜²å‘†
    async function updateTeacher(id, newName) {
      newName = newName.trim();
      if (!newName) return sysAlert("è€å¸«åå­—ä¸èƒ½ç‚ºç©ºï¼", "è³‡æ–™éŒ¯èª¤");

      const oldTeacher = allTeachers.find(t => t.id === id);

      setStatus("æ­£åœ¨æ›´æ–°è³‡æ–™...");
      const { error } = await _client.from("teachers").update({ name: newName }).eq("id", id);

      if (error) {
        setStatus("æ›´æ–°å¤±æ•—", "error");
        await sysAlert("æ›´æ–°å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
      } else {
        // â˜… å¯«å…¥æ—¥èªŒ
        await recordLog('ä¿®æ”¹è€å¸«', `å°‡è€å¸« [${oldTeacher?.name}] æ›´åç‚º [${newName}]`, 'teachers', oldTeacher, { ...oldTeacher, name: newName });

        setStatus("æ›´æ–°æˆåŠŸ", "success");
        if (currentTid === id) document.getElementById("main-title").textContent = `${newName} Â· æœ¬é€±èª²è¡¨`;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 2. æ–°å¢è€å¸«é˜²å‘†
    async function addTeacher() {
      const input = document.getElementById("new-teacher-name");
      const name = input.value.trim();

      if (!name) return sysAlert("è«‹è¼¸å…¥è€å¸«å§“å", "è³‡æ–™ä¸é½Šå…¨");

      setStatus("æ­£åœ¨æ–°å¢è€å¸«...");
      // åŠ ä¸Š .select() ä»¥ä¾¿ç²å–æ–°å¢å¾Œçš„ ID
      const { data, error } = await _client.from("teachers").insert([{ name }]).select();

      if (error) {
        setStatus("æ–°å¢å¤±æ•—", "error");
        await sysAlert("æ–°å¢å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
      } else {
        // â˜… å¯«å…¥æ—¥èªŒ
        await recordLog('æ–°å¢è€å¸«', `å»ºç«‹äº†ä¸€ä½æ–°è€å¸«ï¼š[${name}]`, 'teachers', null, data[0]);

        input.value = "";
        setStatus("è€å¸«æ–°å¢æˆåŠŸ", "success");
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 5. åŸ·è¡Œåˆªé™¤è€å¸« (æœƒé€£å‹•åˆªé™¤è©²è€å¸«çš„èª²è¡¨)
    async function deleteTeacher(id) {
      if (!(await sysConfirm("ç¢ºå®šè¦åˆªé™¤é€™ä½è€å¸«å—ï¼Ÿ<br><span class='text-xs text-red-500'>ç›¸é—œçš„æ‰€æœ‰èª²ç¨‹å°‡æœƒä¸€ä½µæ¶ˆå¤±ï¼</span>", "åˆªé™¤è€å¸«", "danger"))) return;

      const oldTeacher = allTeachers.find(t => t.id === id);

      setStatus("æ­£åœ¨åˆªé™¤è€å¸«...");
      const { error } = await _client.from("teachers").delete().eq("id", id);

      if (error) {
        setStatus("åˆªé™¤å¤±æ•—", "error");
        await sysAlert("åˆªé™¤å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
      } else {
        // â˜… å¯«å…¥æ—¥èªŒ
        await recordLog('åˆªé™¤è€å¸«', `åˆªé™¤äº†è€å¸«åå–®ï¼š[${oldTeacher?.name}]`, 'teachers', oldTeacher, null);

        setStatus("è€å¸«å·²åˆªé™¤", "success");
        if (currentTid === id) currentTid = null;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // --- å´é‚Šæ¬„æ§åˆ¶ ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      // åˆ‡æ› CSS class
      if (sidebar.classList.contains('-translate-x-full')) {
        // æ‰“é–‹
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        // é—œé–‰
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    // --- è–ªè³‡è¨ˆç®—èˆ‡æ’åºæ ¸å¿ƒé‚è¼¯ ---
    // å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜è¨ˆç®—å¾Œçš„è–ªè³‡è³‡æ–™
    var _salaryData = [];
    // å…¨åŸŸè®Šæ•¸ï¼šç´€éŒ„ç›®å‰çš„æ’åºç‹€æ…‹ (key: æ¬„ä½, dir: 1 ç‚ºå‡å†ª, -1 ç‚ºé™å†ª)
    let _salarySortState = { key: 'date', dir: 1 };

    // 1. æ‰“é–‹è¦–çª— (ä¿®æ­£ç‰ˆï¼šé è¨­æœ¬æœˆ + é‡ç½®ç‹€æ…‹)
    function openSalaryModal() {
      if (!currentTid) return alert("è«‹å…ˆé¸æ“‡ä¸€ä½è€å¸«");

      const now = new Date();
      // â˜… ä¿®æ”¹é‡é»ï¼šé è¨­ç‚ºã€Œæœ¬æœˆã€1è™Ÿ åˆ°ã€Œæœ¬æœˆã€æœˆåº•
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0); // ä¸‹å€‹æœˆçš„ç¬¬ 0 å¤© = æœ¬æœˆæœ€å¾Œä¸€å¤©

      document.getElementById("salary-start-date").value = formatDate(start);
      document.getElementById("salary-end-date").value = formatDate(end);

      // é‡ç½®ç‹€æ…‹
      _salaryData = [];
      document.getElementById("salary-result").classList.add("hidden");
      document.getElementById("salary-modal").classList.remove("hidden");
    }

    // â˜… æ–°å¢ï¼šè‡ªå‹•é€£å‹•çµæŸæ—¥æœŸ (ç•¶èµ·å§‹æ—¥æ”¹è®Šæ™‚è§¸ç™¼)
    function autoUpdateEndDate(dateStr) {
      if (!dateStr) return;

      // 1. è§£æä½¿ç”¨è€…é¸çš„æ—¥æœŸ
      const startDate = new Date(dateStr);

      // 2. è¨ˆç®—è©²æœˆä»½çš„æœ€å¾Œä¸€å¤©
      // åŸç†ï¼šè¨­ç‚ºè©²æœˆä»½çš„ã€Œä¸‹å€‹æœˆã€çš„ç¬¬ 0 å¤©ï¼ŒJS æœƒè‡ªå‹•è·³å›ä¸Šå€‹æœˆæœ€å¾Œä¸€å¤©
      const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);

      // 3. å¡«å…¥çµæŸæ—¥æœŸæ¬„ä½
      document.getElementById("salary-end-date").value = formatDate(endDate);
    }

    function closeSalaryModal() {
      document.getElementById("salary-modal").classList.add("hidden");
    }

    // ==========================================
    // ğŸ’° è–ªè³‡è¨ˆç®—èˆ‡æ¸²æŸ“æ ¸å¿ƒæ¨¡çµ„ (å®Œæ•´ä¿®å¾©ç‰ˆ)
    // ==========================================

    // 1. è–ªè³‡è©¦ç®—å¼•æ“ (èƒŒæ™¯ä¿ç•™å°šæœªé»åç‰ˆï¼šç‚º Excel å ±è¡¨åšæº–å‚™)
    async function calculateSalary() {
      const startStr = document.getElementById("salary-start-date").value;
      const endStr = document.getElementById("salary-end-date").value;

      if (!startStr || !endStr) return sysAlert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ", "è³‡æ–™ä¸é½Šå…¨");
      if (startStr > endStr) return sysAlert("é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ", "æ—¥æœŸéŒ¯èª¤");
      setStatus("æ­£åœ¨è¨ˆç®—è–ªè³‡...");

      try {
        const { data: sData, error: sErr } = await _client
          .from("schedules")
          .select("*")
          .eq("teacher_id", currentTid)
          .eq("is_deleted", false); // â˜… æ–°å¢é€™è¡Œï¼šä¸è¨ˆç®—å·²åˆªé™¤çš„èª²
        const { data: rData, error: rErr } = await _client.from("lesson_records").select("*").eq("teacher_id", currentTid).gte("actual_date", startStr).lte("actual_date", endStr);

        if (sErr || rErr) throw new Error("è³‡æ–™è®€å–å¤±æ•—");

        let totalSalary = 0;
        let totalCount = 0;
        _salaryData = [];

        const recordMap = new Map();
        (rData || []).forEach(r => recordMap.set(`${r.schedule_id}_${r.actual_date}`, r));

        const schedulesByDay = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [] };
        const tempSchedulesByDate = new Map();

        (sData || []).forEach(s => {
          if (s.is_temporary && s.target_date) {
            if (!tempSchedulesByDate.has(s.target_date)) tempSchedulesByDate.set(s.target_date, []);
            tempSchedulesByDate.get(s.target_date).push(s);
          } else if (s.day_of_week) {
            schedulesByDay[s.day_of_week].push(s);
          }
        });

        let loopDate = new Date(startStr);
        const endDateObj = new Date(endStr);

        while (loopDate <= endDateObj) {
          const dStr = formatDate(loopDate);
          let dayOfWeek = loopDate.getDay();
          if (dayOfWeek === 0) dayOfWeek = 7;

          const regularSchedules = schedulesByDay[dayOfWeek] || [];
          const tempSchedules = tempSchedulesByDate.get(dStr) || [];
          const daySchedules = [...regularSchedules, ...tempSchedules];

          daySchedules.forEach(s => {
            const record = recordMap.get(`${s.id}_${dStr}`);
            const status = record ? record.status : (s.color_class || 'status-pending');

            // â˜… é€™æ¬¡æˆ‘å€‘ä¸æŠŠå°šæœªé»åè¸¢æ‰äº†ï¼Œä½†æˆ‘å€‘ç¢ºä¿å®ƒä¸æœƒè¢«ç®—é€²è–ªæ°´è£¡ï¼
            const isPayable = ['attended', 'status-present', 'absent', 'status-absent'].includes(status);
            let finalAmount = (record && record.actual_amount !== null && record.actual_amount !== undefined)
              ? record.actual_amount
              : (s.amount || 0);

            if (!isPayable) finalAmount = 0; // åªè¦ä¸ç™¼è–ªï¼Œé‡‘é¡å°±æ˜¯ 0

            if (isPayable) {
              totalSalary += finalAmount;
              totalCount++;
            }

            // å…¨éƒ¨å¡é€² _salaryData é™£åˆ—è£¡å‚™ç”¨
            _salaryData.push({
              id: record ? record.id : `mock-${s.id}-${dStr}`,
              schedule_id: s.id,
              date: dStr,
              course_name: s.course_name,
              subject: s.subject,
              status: status,
              amount: finalAmount,
              isPayable: isPayable
            });
          });

          loopDate.setDate(loopDate.getDate() + 1);
        }

        document.getElementById("total-salary").textContent = `$${totalSalary.toLocaleString()}`;
        document.getElementById("total-count").textContent = `${totalCount} å ‚`;

        sortSalary('date');
        document.getElementById("salary-result").classList.remove("hidden");
        setStatus("è–ªè³‡è¨ˆç®—å®Œæˆ", "success");
      } catch (err) {
        console.error(err);
        setStatus("è¨ˆç®—å¤±æ•—", "error");
        await sysAlert("è¨ˆç®—å¤±æ•—ï¼š" + err.message, "ç³»çµ±éŒ¯èª¤");
      }
    }

    // 2. æ’åºè§¸ç™¼å™¨ (é»æ¨™é¡Œæ™‚å‘¼å«)
    function sortSalary(key) {
      if (_salarySortState.key === key) {
        _salarySortState.dir *= -1;
      } else {
        _salarySortState.key = key;
        _salarySortState.dir = 1;
        if (key === 'amount') _salarySortState.dir = -1;
      }

      _salaryData.sort((a, b) => {
        let valA, valB;
        if (key === 'date') { valA = a.date; valB = b.date; }
        else if (key === 'name') { valA = a.course_name; valB = b.course_name; }
        else if (key === 'amount') { valA = a.amount; valB = b.amount; }
        else if (key === 'status') {
          const statusRank = { 'attended': 1, 'status-present': 1, 'leave': 2, 'status-leave': 2, 'absent': 3, 'status-absent': 3 };
          valA = statusRank[a.status] || 99;
          valB = statusRank[b.status] || 99;
        }
        if (valA < valB) return -1 * _salarySortState.dir;
        if (valA > valB) return 1 * _salarySortState.dir;
        return 0;
      });

      renderSalaryTable();
    }

    // 3. æ¸²æŸ“è¡¨æ ¼ HTML (UI éæ¿¾ç‰ˆï¼šç•«é¢éš±è—å°šæœªé»åï¼Œé˜²æ­¢å¡é “)
    function renderSalaryTable() {
      const listBody = document.getElementById("salary-list");
      listBody.innerHTML = "";

      // â˜… è¦–è¦ºéæ¿¾é­”æ³•ï¼šåªæŒ‘å‡ºæœ‰ç¢ºå¯¦é»åç‹€æ…‹çš„è³‡æ–™ä¾†ç•«ç•«é¢
      const displayData = _salaryData.filter(item => item.status !== 'status-pending');
      const pendingCount = _salaryData.length - displayData.length;

      displayData.forEach(item => {
        let statusText = '', statusColor = '';
        const s = item.status;

        if (['attended', 'status-present'].includes(s)) { statusText = 'âœ… ä¸Šèª²'; statusColor = 'text-green-600 bg-green-50'; }
        else if (['leave', 'status-leave'].includes(s)) { statusText = 'â˜• è«‹å‡'; statusColor = 'text-amber-600 bg-amber-50'; }
        else if (['absent', 'status-absent'].includes(s)) { statusText = 'âŒ æ› èª²'; statusColor = 'text-red-600 bg-red-50'; }
        else if (['status-practice'].includes(s)) { statusText = 'ğŸ¹ ç·´ç¿’'; statusColor = 'text-blue-600 bg-blue-50'; }
        else { statusText = 'ç‹€æ…‹ç•°å¸¸'; statusColor = 'text-gray-400'; }

        const row = `
                <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                  <td class="p-3 font-mono text-xs">${item.date.slice(5)}</td>
                  <td class="p-3">
                    <div class="font-bold text-gray-800">${item.course_name}</div>
                    <div class="text-[10px] text-gray-400">${item.subject || ''}</div>
                  </td>
                  <td class="p-3">
                    <span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${statusText}</span>
                  </td>
                  <td class="p-3 text-right font-mono font-medium ${item.isPayable ? 'text-gray-800' : 'text-gray-300 line-through'}">
                    $${item.amount}
                  </td>
                </tr>
              `;
        listBody.innerHTML += row;
      });

      // åœ¨è¡¨æ ¼æœ€ä¸‹æ–¹é¡¯ç¤ºæº«é¦¨æç¤ºï¼Œè®“æ‚¨çŸ¥é“ç³»çµ±æœ‰å¹«æ‚¨ä¿å­˜é€™äº›è³‡æ–™
      if (pendingCount > 0) {
        listBody.innerHTML += `
                <tr>
                  <td colspan="4" class="p-4 text-center bg-gray-50/50 border-t border-gray-100">
                     <span class="text-xs font-bold text-gray-400 flex items-center justify-center gap-1">
                       <i data-lucide="eye-off" class="w-3.5 h-3.5"></i>
                       ç•«é¢å·²éš±è— ${pendingCount} å ‚ã€Œå°šæœªé»åã€èª²ç¨‹ (åŒ¯å‡º Excel æ™‚å°‡å®Œæ•´åŒ…å«)
                     </span>
                  </td>
                </tr>
              `;
      }

      if (window.lucide) lucide.createIcons();
    }

    // --- åŠŸèƒ½ Aï¼šè–ªè³‡çµç®—åŒ¯å‡º/åŒ¯å…¥ (åªæ”¹ç‹€æ…‹) ---

    // A1. åŒ¯å‡ºè–ªè³‡å ±è¡¨ (å®Œæ•´åŒ¯å‡ºï¼ŒåŒ…å«å°šæœªé»å)
    async function exportDailyReport() {
      if (_salaryData.length === 0) return sysAlert("è«‹å…ˆæŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€ç”¢ç”Ÿè³‡æ–™ï¼", "å°šæœªè¨ˆç®—");

      const exportData = _salaryData.map(item => {
        let statusText = 'æœªçŸ¥';
        if (['attended', 'status-present'].includes(item.status)) statusText = 'ä¸Šèª²';
        else if (['leave', 'status-leave'].includes(item.status)) statusText = 'è«‹å‡';
        else if (['absent', 'status-absent'].includes(item.status)) statusText = 'æ› èª²';
        else if (['status-practice'].includes(item.status)) statusText = 'å­¸ç”Ÿç·´ç¿’';
        else statusText = 'å°šæœªé»å'; // â˜… Excel æœƒå¿ å¯¦å°å‡ºå°šæœªé»å

        return {
          "ç³»çµ±ç·¨è™Ÿ(è«‹å‹¿ä¿®æ”¹)": item.schedule_id,
          "æ—¥æœŸ(è«‹å‹¿ä¿®æ”¹)": item.date,
          "å­¸ç”Ÿå§“å(è«‹å‹¿ä¿®æ”¹)": item.course_name,
          "ç‹€æ…‹": statusText,
          "å‚™è¨»": "",
          "ç•¶æ—¥é‡‘é¡": item.isPayable ? item.amount : 0
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);

      // è¨­å®šæ¬„å¯¬
      const wscols = [
        { wch: 15 }, // ID
        { wch: 12 }, // æ—¥æœŸ
        { wch: 20 }, // å­¸ç”Ÿå§“å
        { wch: 10 }, // ç‹€æ…‹
        { wch: 20 }, // å‚™è¨»
        { wch: 12 }  // é‡‘é¡
      ];
      ws['!cols'] = wscols;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "è–ªè³‡çµç®—");

      // å¯«å…¥æ—¥èªŒ
      const teacherName = document.getElementById("main-title").textContent.split(' Â· ')[0] || "è€å¸«";
      await recordLog('åŒ¯å‡ºå ±è¡¨', `ä¸‹è¼‰äº† [${teacherName}] çš„è–ªè³‡çµç®— Excel`, 'system', null, null);

      XLSX.writeFile(wb, `${teacherName}_è–ªè³‡çµç®—è¡¨.xlsx`);
    }

    // A2. åŒ¯å…¥è–ªè³‡ä¿®æ­£ (ä¿®æ­£ç‰ˆï¼šè®€å–ä¸¦æ›´æ–°é‡‘é¡)
    async function handleImportDaily(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });

          const statusMap = { 'ä¸Šèª²': 'status-present', 'è«‹å‡': 'status-leave', 'æ› èª²': 'status-absent', 'å°šæœªé»å': 'status-pending' };
          const updates = [];

          for (const row of jsonRows) {
            const sid = row["ç³»çµ±ç·¨è™Ÿ(è«‹å‹¿ä¿®æ”¹)"];
            let date = row["æ—¥æœŸ(è«‹å‹¿ä¿®æ”¹)"];
            const status = row["ç‹€æ…‹"];
            const remark = row["å‚™è¨»"];
            // â˜… è®€å–é‡‘é¡
            const amount = row["ç•¶æ—¥é‡‘é¡"];

            if (date && date.includes('/')) date = date.replace(/\//g, '-');
            if (!sid || !date) continue;

            updates.push({
              schedule_id: sid,
              teacher_id: currentTid,
              actual_date: date,
              status: statusMap[status] || 'status-pending',
              remark: remark || "",
              // â˜… å¯«å…¥é‡‘é¡ (è½‰æˆæ•´æ•¸ï¼Œå¦‚æœæ˜¯ NaN å‰‡å­˜ç‚º 0)
              actual_amount: parseInt(amount) || 0
            });
          }

          if (updates.length === 0) return alert("ç„¡æœ‰æ•ˆè³‡æ–™");
          setStatus(`æ­£åœ¨æ›´æ–° ${updates.length} ç­†ç´€éŒ„...`);

          const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });
          if (error) throw error;

          // â˜… å¯«å…¥æ—¥èªŒ
          const targetTeacherName = document.getElementById("main-title").textContent.split(' Â· ')[0] || "è©²è€å¸«";
          await recordLog('åŒ¯å…¥è³‡æ–™', `é€é Excel æ‰¹æ¬¡ä¿®æ­£äº† [${targetTeacherName}] çš„è–ªè³‡èˆ‡é»åç´€éŒ„ (å…± ${updates.length} ç­†)`, 'lesson_records', null, null);

          setStatus("è–ªè³‡èˆ‡é‡‘é¡æ›´æ–°æˆåŠŸï¼", "success");
          input.value = "";
          await calculateSalary(); // é‡æ–°è¨ˆç®—
          await refreshData();     // åˆ·æ–°èª²è¡¨

        } catch (err) {
          alert("åŒ¯å…¥å¤±æ•—: " + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- æ‰¹æ¬¡ç®¡ç†è¦–çª—æ§åˆ¶ ---
    function openBatchModal() {
      document.getElementById("batch-modal").classList.remove("hidden");
    }
    function closeBatchModal() {
      document.getElementById("batch-modal").classList.add("hidden");
    }

    // --- åŠŸèƒ½ B: æ¯ç‰ˆå…¨èƒ½åŒ¯å‡º/åŒ¯å…¥ ---

    // 1. ä¸‹è¼‰å›ºå®šèª²è¡¨æ¨¡æ¿ (æ’é™¤è‡¨æ™‚èª²)
    async function exportMasterData() {
      if (!currentTid) return alert("è«‹å…ˆé¸æ“‡è€å¸«");
      setStatus("æ­£åœ¨è§£æå›ºå®šæ¨¡æ¿...");
      const { data: courses } = await _client.from("schedules").select("*")
        .eq("teacher_id", currentTid).eq("is_temporary", false).eq("is_deleted", false);

      const exportData = courses.map(c => ({
        "å­¸ç”Ÿå§“å": c.course_name, "é–‹å§‹æ™‚é–“": c.start_time.slice(0, 5), "çµæŸæ™‚é–“": c.end_time.slice(0, 5),
        "æ˜ŸæœŸ(1-7)": c.day_of_week, "é è¨­ç‹€æ…‹": "å°šæœªé»å", "åƒ…é™å–®æ¬¡": "å¦"
      }));
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "å›ºå®šæ¨¡æ¿");
      const teacherName = document.getElementById("main-title").textContent.split(' Â· ')[0];
      XLSX.writeFile(wb, `${teacherName}_å›ºå®šèª²è¡¨æ¨¡æ¿.xlsx`);
      setStatus("åŒ¯å‡ºå®Œæˆ", "success");
    }

    // 2. æ§åˆ¶æ—¥æœŸé¸æ“‡å½ˆçª— (åŒ¯å‡º èˆ‡ ä¿®æ­£ å…±ç”¨)
    let currentDatePickerAction = '';

    function openDatePickerModal(action) {
      if (!currentTid) return sysAlert("è«‹å…ˆé¸æ“‡è€å¸«", "warning");
      currentDatePickerAction = action;
      document.getElementById('date-picker-modal').classList.remove('hidden');

      document.getElementById('date-picker-title').textContent = action === 'export' ? 'é¸æ“‡åŒ¯å‡ºå€é–“' : 'é¸æ“‡æ¬²ä¿®æ­£çš„ç´€éŒ„å€é–“';

      // è‡ªå‹•å¡«å…¥ç•¶æœˆç¬¬ä¸€å¤©èˆ‡æœ€å¾Œä¸€å¤©
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const lastDay = new Date(y, today.getMonth() + 1, 0).getDate();
      document.getElementById('export-start-date').value = `${y}-${m}-01`;
      document.getElementById('export-end-date').value = `${y}-${m}-${lastDay}`;

      document.getElementById('date-picker-confirm-btn').onclick = function () {
        if (currentDatePickerAction === 'export') executeHistoryExport();
        else executeHistoryEditLoad();
      };
      if (window.lucide) lucide.createIcons();
    }

    // --- ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½ ---

    function openPasswordModal() {
      document.getElementById("password-modal").classList.remove("hidden");
    }

    function closePasswordModal() {
      document.getElementById("password-modal").classList.add("hidden");
      document.getElementById("new-password").value = "";
    }

    // ä¿®æ”¹å¯†ç¢¼
    async function handleUpdatePassword() {
      const newPwd = document.getElementById("new-password").value;

      if (newPwd.length < 6) {
        await sysAlert("ç‚ºäº†å®‰å…¨ï¼Œå¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 ä½æ•¸å”·ï¼", "å¯†ç¢¼å¤ªçŸ­");
        return;
      }

      const { data, error } = await _client.auth.updateUser({ password: newPwd });

      if (error) {
        await sysAlert("è®Šæ›´å¤±æ•—ï¼š" + error.message, "ç³»çµ±éŒ¯èª¤");
      } else {
        // â˜… å¯«å…¥æ—¥èªŒ
        await recordLog('å®‰å…¨è¨­å®š', 'ä¿®æ”¹äº†ç™»å…¥å¯†ç¢¼', 'auth', null, null);
        await sysAlert("å¯†ç¢¼è®Šæ›´æˆåŠŸï¼<br>ä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚", "è®Šæ›´æˆåŠŸ");
        closePasswordModal();
      }
    }

    // --- è£œä¸Šç¼ºå¤±çš„å‚™è¨»åŠŸèƒ½é‚è¼¯ (å‡ç´šç‰ˆï¼šæ™ºæ…§åµæ¸¬å‚™è¨»ç¯„åœ) ---
    let remarkTargetId = null;
    let remarkTargetWeekDay = null;

    // â˜… é—œéµä¿®æ”¹ 1ï¼šå‰é¢åŠ ä¸Š asyncï¼Œå› ç‚ºæˆ‘å€‘è¦å»è³‡æ–™åº«æŸ¥ç¯„åœ
    async function openRemarkModal(id, dateStr) {
      remarkTargetId = id;
      const master = _cachedSchedule.find(s => s.id === id);
      if (master) remarkTargetWeekDay = master.day_of_week;

      const record = _cachedRecords.find(r => r.schedule_id === id && r.actual_date === dateStr);
      const currentRemark = record ? record.remark : "";

      // é è¨­æ—¥æœŸç‚ºé»æ“Šçš„ç•¶å¤©
      let detectedStart = dateStr;
      let detectedEnd = dateStr;

      // â˜… é—œéµä¿®æ”¹ 2ï¼šå¦‚æœé€™å ‚èª²ç›®å‰æœ‰å‚™è¨»ï¼Œå»è³‡æ–™åº«æ‰¾å‡ºå®ƒçš„é ­è·Ÿå°¾
      if (currentRemark) {
        setStatus("æ­£åœ¨åµæ¸¬å‚™è¨»ç¯„åœ...");

        // å°‹æ‰¾ç›¸åŒ schedule_id ä¸”å‚™è¨»å…§å®¹å®Œå…¨ä¸€æ¨£çš„æ‰€æœ‰ç´€éŒ„
        const { data, error } = await _client
          .from("lesson_records")
          .select("actual_date")
          .eq("schedule_id", id)
          .eq("remark", currentRemark)
          .order("actual_date", { ascending: true }); // ç…§æ—¥æœŸå¾å°æ’åˆ°å¤§

        if (!error && data && data.length > 0) {
          detectedStart = data[0].actual_date; // ç¬¬ä¸€ç­†å°±æ˜¯é–‹å§‹æ—¥
          detectedEnd = data[data.length - 1].actual_date; // æœ€å¾Œä¸€ç­†å°±æ˜¯çµæŸæ—¥
        }
        setStatus("å°±ç·’", "success");
      }

      // è‡ªå‹•å¡«å…¥åµæ¸¬åˆ°çš„æ—¥æœŸèˆ‡å‚™è¨»å…§å®¹
      document.getElementById("remark-start-date").value = detectedStart;
      document.getElementById("remark-end-date").value = detectedEnd;
      document.getElementById("quick-remark-input").value = currentRemark;

      document.getElementById("remark-modal").classList.remove("hidden");
    }

    function closeRemarkModal() {
      document.getElementById("remark-modal").classList.add("hidden");
    }

    // --- å¿«é€Ÿå‚™è¨»åŠŸèƒ½ (ä¿®æ­£ç‰ˆï¼šæ”¯æ´æ¸…ç©º) ---
    async function saveQuickRemark(forceClear = false) {
      if (!remarkTargetId) return;
      const text = forceClear ? "" : document.getElementById("quick-remark-input").value;
      const startStr = document.getElementById("remark-start-date").value;
      const endStr = document.getElementById("remark-end-date").value;

      if (!startStr || !endStr) {
        await sysAlert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ", "è³‡æ–™ä¸å®Œæ•´");
        return;
      }
      if (startStr > endStr) {
        await sysAlert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ", "æ—¥æœŸéŒ¯èª¤");
        return;
      }

      setStatus(forceClear ? "æ­£åœ¨æ¸…ç©ºå‚™è¨»..." : "æ­£åœ¨å„²å­˜å‚™è¨»...");
      const updates = [];
      let loopDate = new Date(startStr);
      const endDate = new Date(endStr);

      while (loopDate <= endDate) {
        let day = loopDate.getDay();
        if (day === 0) day = 7;
        if (day === remarkTargetWeekDay) {
          const dStr = formatDate(loopDate);
          const exist = _cachedRecords.find(r => r.schedule_id === remarkTargetId && r.actual_date === dStr);
          const master = _cachedSchedule.find(s => s.id === remarkTargetId);
          const status = exist ? exist.status : (master.color_class || 'status-pending');
          updates.push({ schedule_id: remarkTargetId, teacher_id: currentTid, actual_date: dStr, status: status, remark: text });
        }
        loopDate.setDate(loopDate.getDate() + 1);
      }

      if (updates.length === 0) {
        await sysAlert("ç¯„åœå…§æ²’æœ‰é€™å ‚èª²çš„æ’ç¨‹", "ç„¡æ•ˆçš„æ—¥æœŸç¯„åœ");
        setStatus("ç„¡è³‡æ–™æ›´æ–°", "warn");
        return;
      }

      const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });

      if (error) {
        await sysAlert("æ“ä½œå¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
        setStatus("æ“ä½œå¤±æ•—", "error");
      } else {
        setStatus(forceClear ? "å‚™è¨»å·²æ¸…ç©º" : "å‚™è¨»å·²æ›´æ–°", "success");
        closeRemarkModal();
        await refreshData();
        // å¯«å…¥æ—¥èªŒ
        const master = _cachedSchedule.find(s => s.id === remarkTargetId);
        const actionName = forceClear ? "æ¸…ç©ºå‚™è¨»" : "ä¿®æ”¹å‚™è¨»";
        const detailText = forceClear ? "æ¸…ç©ºäº†è©²å€é–“çš„å‚™è¨»" : `å°‡å‚™è¨»æ›´æ–°ç‚ºï¼šã€Œ${text}ã€`;
        await recordLog(actionName, `[${master?.course_name}] ${startStr} è‡³ ${endStr}ï¼š${detailText}`, 'lesson_records', null, null);
      }
    }

    function openAdminModal() {
      document.getElementById("admin-modal").classList.remove("hidden");

      // 1. åˆå§‹åŒ–æ—¥æœŸ (æœ¬æœˆ)
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);

      const startInput = document.getElementById("stat-start");
      const endInput = document.getElementById("stat-end");
      // é˜²å‘†ï¼šç¢ºä¿å…ƒç´ å­˜åœ¨æ‰è³¦å€¼ (é¿å…å ±éŒ¯)
      if (startInput) startInput.value = formatDate(start);
      if (endInput) endInput.value = formatDate(end);

      // 2. â˜… é—œéµä¿®æ­£ï¼šä¸€æ‰“é–‹è¦–çª—ï¼Œé¦¬ä¸Šè¼‰å…¥è€å¸«åå–®ï¼
      populateStatTeacherFilter();

      // 3. é è¨­æ‰“é–‹é€šè¨ŠéŒ„é ç±¤
      switchAdminTab('directory');
    }

    function closeAdminModal() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function switchAdminTab(tabName) {
      // 1. UI åˆ‡æ› (æŒ‰éˆ•è®Šè‰²)
      document.querySelectorAll('.admin-tab').forEach(b => {
        b.classList.remove('text-white', 'border-white', 'bg-neutral-700');
        b.classList.add('text-gray-300', 'border-transparent');
      });
      document.getElementById(`tab-btn-${tabName}`).classList.add('text-white', 'border-white', 'bg-neutral-700');
      document.getElementById(`tab-btn-${tabName}`).classList.remove('text-gray-300', 'border-transparent');

      // å…§å®¹åˆ‡æ›
      document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

      // 2. è³‡æ–™è¼‰å…¥
      if (tabName === 'directory') loadDirectoryData();
      if (tabName === 'teachers') renderTeacherManageList();
      // â˜… åŠ ä¸Šé€™è¡Œï¼š
      if (tabName === 'logs') loadLogs();
    }

    // --- Tab 1: é€šè¨ŠéŒ„ (çµ‚æ¥µæ¸…æ™°ç‰ˆï¼šåŠ å¤§å­—é«”èˆ‡æ„Ÿæ‡‰å€ï¼Œå®Œç¾å¹³è¡¡é–±è®€èˆ‡æ“ä½œ) ---
    function renderDirectory() {
      const keyword = document.getElementById("dir-search").value.toLowerCase();
      const listBody = document.getElementById("directory-list");
      listBody.innerHTML = "";

      const uniqueMap = new Map();
      _allSchedulesForAdmin.forEach(s => {
        const key = `${s.course_name}-${s.phone}`;
        const match = (s.course_name || "").toLowerCase().includes(keyword) ||
          (s.phone || "").includes(keyword) ||
          (s.subject || "").toLowerCase().includes(keyword);

        if (match) {
          if (!uniqueMap.has(key)) {
            uniqueMap.set(key, {
              course_name: s.course_name || "",
              phone: s.phone || "",
              subjects: new Set(),
              teachers: new Set(),
              schedule_ids: []
            });
          }
          const studentData = uniqueMap.get(key);
          if (s.subject) studentData.subjects.add(s.subject);
          if (s.teachers && s.teachers.name) studentData.teachers.add(s.teachers.name);
          studentData.schedule_ids.push(s.id);
        }
      });

      let list = Array.from(uniqueMap.values());
      list.sort((a, b) => {
        const k = _dirSortState.key;
        let valA = (k === 'name' ? a.course_name : (k === 'phone' ? a.phone : ""));
        let valB = (k === 'name' ? b.course_name : (k === 'phone' ? b.phone : ""));
        return valA.localeCompare(valB, "zh-Hant") * _dirSortState.dir;
      });

      list.forEach(student => {
        const name = student.course_name || "æœªçŸ¥";
        const phoneRaw = student.phone || "";
        const idsStr = student.schedule_ids.join(',');

        // â˜… æ ¸å¿ƒå„ªåŒ–ï¼šåŠ å¤§åŸºç¤é«˜åº¦èˆ‡å­—é«”å¤§å°
        const baseClass = "flex items-center w-full min-h-[64px] px-5 cursor-pointer transition-all active:bg-opacity-80";

        // 1. å§“åï¼šä½¿ç”¨ text-base (16px) ä¸¦åŠ æ·±é¡è‰²
        const nameHtml = `
                <div class="${baseClass} hover:bg-blue-50 text-blue-900 font-extrabold text-base" 
                     onclick="copyToClipboard('${name}', this)">
                    ${name}
                </div>`;

        // 2. é›»è©±ï¼šä½¿ç”¨ text-sm (14px) å¼·åŒ–æ•¸å­—æ˜“è®€æ€§
        const phoneList = phoneRaw.split(/\s+/).filter(p => p.trim() !== "");
        const phoneHtml = phoneList.length > 0 ? phoneList.map(p => `
                <div class="${baseClass} hover:bg-gray-100 text-gray-700 font-mono text-sm border-b border-gray-50 last:border-0"
                     onclick="copyToClipboard('${p}', this)">
                    ${p}
                </div>`).join('') : `<div class="${baseClass} text-gray-300">-</div>`;

        // 3. ç§‘ç›®ï¼šä½¿ç”¨ text-sm (14px) ä¸¦ç¨å¾®åŠ æ·±å­—é«”é¡è‰²
        const subjectsArr = Array.from(student.subjects);
        const subjectHtml = subjectsArr.length > 0 ? subjectsArr.map(s => `
                <div class="${baseClass} hover:bg-indigo-50 text-gray-800 text-sm font-medium border-b border-gray-50 last:border-0"
                     onclick="copyToClipboard('${s}', this)">
                    ${s}
                </div>`).join('') : `<div class="${baseClass} text-gray-300">-</div>`;

        // 4. è² è²¬è€å¸«ï¼šä½¿ç”¨ text-sm (14px) ä¸¦å¼·åŒ–æ¨™ç±¤å­˜åœ¨æ„Ÿ
        const teachersArr = Array.from(student.teachers);
        const teacherHtml = teachersArr.length > 0 ? teachersArr.map(t => `
                <div class="${baseClass} hover:bg-emerald-50 text-emerald-800 text-sm font-bold border-b border-gray-50 last:border-0"
                     onclick="copyToClipboard('${t}', this)">
                    ${t}
                </div>`).join('') : `<div class="${baseClass} text-gray-300">-</div>`;

        // â˜… ä¿®æ­£ï¼šçµ¦æ¯å€‹ <td> åŠ ä¸Š min-width ä¿è­·ï¼Œé˜²æ­¢æ‰‹æ©Ÿæ“ å£“
        const row = `
            <tr class="border-b border-gray-100 group hover:bg-gray-50/20 transition-colors">
                <td class="p-0 align-stretch min-w-[120px]">${nameHtml}</td>
                <td class="p-0 align-stretch min-w-[160px]">${phoneHtml}</td>
                <td class="p-0 align-stretch min-w-[140px]">${subjectHtml}</td>
                <td class="p-0 align-stretch min-w-[140px]">${teacherHtml}</td>
                <td class="p-0 align-middle text-center min-w-[100px] shrink-0 group-hover:bg-gray-50/20 transition-colors">
                    <div class="flex items-center justify-center gap-3 px-4">
                        <button onclick="openStudentScheduleModal('${name}', '${phoneRaw}')" class="p-2.5 text-gray-400 hover:text-emerald-600 active:scale-90"><i data-lucide="calendar-range" class="w-5.5 h-5.5"></i></button>
                        <button onclick="openStudentEditModal('${name}', '${phoneRaw}', '${idsStr}')" class="p-2.5 text-gray-400 hover:text-blue-600 active:scale-90"><i data-lucide="pencil" class="w-5.5 h-5.5"></i></button>
                    </div>
                </td>
            </tr>`;
        listBody.innerHTML += row;
      });
      lucide.createIcons();
    }

    // â˜… æ ¸å¿ƒè£œä¸ï¼šå¾è³‡æ–™åº«æŠ“å–é€šè¨ŠéŒ„æ‰€éœ€çš„åŸå§‹è³‡æ–™
    async function loadDirectoryData() {
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      if (!_client) return;

      console.log("æ­£åœ¨å¿«å–å­¸ç”Ÿåå–®..."); //
      setStatus("æ­£åœ¨æ›´æ–°é€šè¨ŠéŒ„...");

      const { data, error } = await _client
        .from("schedules")
        .select("*, teachers(name)")
        .eq("is_deleted", false); // â˜… æ–°å¢é€™è¡Œï¼šé€šè¨ŠéŒ„ä¹Ÿéš±è—å·²åˆªé™¤çš„èª²

      if (error) {
        console.error("è®€å–é€šè¨ŠéŒ„å¤±æ•—:", error);
        setStatus("é€šè¨ŠéŒ„è¼‰å…¥å¤±æ•—", "error");
        return;
      }

      // å°‡æŠ“åˆ°çš„è³‡æ–™å­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œä¾› renderDirectory ä½¿ç”¨
      _allSchedulesForAdmin = data || [];

      // è³‡æ–™æŠ“å®Œå¾Œï¼Œç«‹å³åŸ·è¡Œæ¸²æŸ“åŠŸèƒ½
      renderDirectory();

      setStatus("é€šè¨ŠéŒ„å·²å°±ç·’", "success");
      console.log(`æˆåŠŸè¼‰å…¥ ${_allSchedulesForAdmin.length} ç­†èª²ç¨‹è³‡æ–™ã€‚`); //
    }

    // â˜… æ ¸å¿ƒè£œä¸ï¼šè™•ç†é»æ“Šè¡¨é ­å¾Œçš„æ’åºé‚è¼¯
    function sortDirectory(key) {
      // å¦‚æœé»çš„æ˜¯åŒä¸€æ¬„ï¼Œå°±åè½‰æ–¹å‘ï¼›å¦‚æœé»ä¸åŒæ¬„ï¼Œå°±åˆ‡æ›éå»ä¸¦è¨­ç‚ºé †å‘
      if (_dirSortState.key === key) {
        _dirSortState.dir *= -1;
      } else {
        _dirSortState.key = key;
        _dirSortState.dir = 1;
      }

      // ç‹€æ…‹æ›´æ–°å¾Œï¼Œé‡æ–°ç•«ä¸€æ¬¡ç•«é¢
      renderDirectory();
    }

    let stuCurrentBaseDate = new Date(); // å­¸ç”Ÿå½ˆçª—å°ˆç”¨çš„åŸºæº–æ—¥æœŸ
    let stuCurrentName = "";
    let stuCurrentPhone = "";

    // 1. æ‰“é–‹å½ˆçª—
    function openStudentScheduleModal(name, phone) {
      stuCurrentName = name;
      stuCurrentPhone = phone;
      stuCurrentBaseDate = getMonday(new Date()); // é è¨­å›åˆ°æœ¬é€±ä¸€

      document.getElementById("stu-modal-name").textContent = `${name} Â· å€‹äººå…¨é€±èª²è¡¨`;
      document.getElementById("stu-modal-phone").textContent = phone || "ç„¡é›»è©±è³‡è¨Š";
      document.getElementById("stu-modal-initial").textContent = name.charAt(0);
      document.getElementById("student-schedule-modal").classList.remove("hidden");

      renderStudentMiniSchedule();
      lucide.createIcons();
    }

    function closeStudentScheduleModal() {
      document.getElementById("student-schedule-modal").classList.add("hidden");
    }

    // 2. åˆ‡æ›é€±æ¬¡
    function changeStudentWeek(direction) {
      stuCurrentBaseDate = addDays(stuCurrentBaseDate, direction * 7);
      renderStudentMiniSchedule();
    }

    // â˜… å­¸ç”Ÿå½ˆçª—å°ˆç”¨çš„æ—¥æœŸè·³è½‰è™•ç†
    function handleStudentDatePick(val) {
      if (!val) return;

      // é»é¸æ—¥æœŸå¾Œï¼Œç›´æ¥æŠŠè©²å­¸ç”Ÿçš„å€‹äººèª²è¡¨åŸºæº–æ—¥è¨­ç‚ºé¸å®šçš„é‚£ä¸€å¤©
      stuCurrentBaseDate = new Date(val);

      // é‡æ–°æ¸²æŸ“ç•«é¢
      renderStudentMiniSchedule();
    }

    // 3. æ ¸å¿ƒæ¸²æŸ“ (å°å‹èª²è¡¨å¼•æ“)
    // â˜… ä¿®æ­£ç‰ˆï¼šå°å‹èª²è¡¨æ¸²æŸ“å¼•æ“ (å®Œç¾åŒæ­¥ä¸»ä»‹é¢é¡è‰²)
    async function renderStudentMiniSchedule() {
      const container = document.getElementById("stu-schedule-container");
      const rangeLabel = document.getElementById("stu-modal-date-range");
      const picker = document.getElementById("stu-date-picker");
      if (!container) return;

      const startStr = formatDate(stuCurrentBaseDate);
      const endStr = formatDate(addDays(stuCurrentBaseDate, 6));
      rangeLabel.textContent = `${startStr} ~ ${endStr}`;
      if (picker) picker.value = startStr; // åŒæ­¥æ—¥æ›†é¸æ“‡å™¨çš„é è¨­å€¼

      container.innerHTML = `<div class="p-20 text-gray-400 font-bold w-full text-center">æ­£åœ¨æª¢ç´¢èª²ç¨‹ç´€éŒ„...</div>`;

      // æŠ“å–è³‡æ–™
      const { data: sData } = await _client.from("schedules").select("*, teachers(name)")
        .eq("course_name", stuCurrentName).eq("phone", stuCurrentPhone);
      const { data: rData } = await _client.from("lesson_records").select("*")
        .gte("actual_date", startStr).lte("actual_date", endStr);

      container.innerHTML = "";
      const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

      for (let i = 0; i < 7; i++) {
        const thisDate = addDays(stuCurrentBaseDate, i);
        const thisDateStr = formatDate(thisDate);
        const dayNum = thisDate.getDay() === 0 ? 7 : thisDate.getDay();

        const dayCol = document.createElement("div");
        dayCol.className = "flex flex-col w-[130px] border-r border-gray-100 shrink-0";

        const isToday = formatDate(new Date()) === thisDateStr;
        dayCol.innerHTML = `
                    <div class="p-2 text-center border-b border-gray-100 bg-gray-50/50 ${isToday ? 'bg-emerald-50 text-emerald-600' : ''}">
                        <div class="text-[10px] font-bold">${dayNames[thisDate.getDay()]}</div>
                        <div class="text-[10px] font-mono">${thisDate.getMonth() + 1}/${thisDate.getDate()}</div>
                    </div>
                    <div class="flex-1 p-1 space-y-2 min-h-[300px]" id="stu-day-${i}"></div>
                `;
        container.appendChild(dayCol);

        const dayItems = (sData || []).filter(item => item.day_of_week === dayNum);
        const dayList = dayCol.querySelector(`#stu-day-${i}`);

        dayItems.forEach(item => {
          const record = (rData || []).find(r => r.schedule_id === item.id && r.actual_date === thisDateStr);
          const status = record ? record.status : (item.color_class || 'status-pending');

          // â˜… æ ¸å¿ƒä¿®å¾©ï¼šç›´æ¥å¥—ç”¨å¤–éƒ¨ CSS class åç¨±ï¼Œç¢ºä¿é¡è‰² 100% ä¸€è‡´
          // æˆ‘å€‘æŠŠ 'attended' è½‰æ›ç‚º 'status-present' ä»¥å°æ‡‰ CSS
          let cssStatus = status;
          if (status === 'attended') cssStatus = 'status-present';
          else if (status === 'leave') cssStatus = 'status-leave';
          else if (status === 'absent') cssStatus = 'status-absent';

          const card = document.createElement("div");
          // é€™è£¡åŠ å…¥äº† ${cssStatus} ä¾†æŠ“å–æ‚¨çš„ .status-present ç­‰æ¨£å¼
          card.className = `p-2 rounded-lg border-l-4 shadow-sm text-[11px] cursor-pointer transition-all active:scale-95 ${cssStatus} bg-white`;
          card.innerHTML = `
                        <div class="font-bold truncate">${item.subject || 'ç„¡ç§‘ç›®'}</div>
                        <div class="font-mono text-[9px] mt-0.5">${item.start_time.slice(0, 5)}-${item.end_time.slice(0, 5)}</div>
                        <div class="text-[9px] mt-1 text-gray-500 flex items-center gap-1">
                            <i data-lucide="user" class="w-2.5 h-2.5"></i> ${item.teachers?.name || 'æœªçŸ¥'}
                        </div>
                    `;
          card.onclick = async () => {
            await toggleRecordStatus(item.id, thisDateStr, status);
            renderStudentMiniSchedule();
          };
          dayList.appendChild(card);
        });
      }
      lucide.createIcons();
    }

    // --- å­¸ç”Ÿè³‡æ–™ç·¨è¼¯é‚è¼¯ ---
    function openStudentEditModal(name, phone, idsStr) {
      document.getElementById("edit-student-old-name").value = name;
      document.getElementById("edit-student-name").value = name;
      document.getElementById("edit-student-phone").value = phone;
      document.getElementById("edit-student-ids").value = idsStr; // å·å·è—ä½é—œè¯çš„ ID
      document.getElementById("student-edit-modal").classList.remove("hidden");
    }

    function closeStudentEditModal() {
      document.getElementById("student-edit-modal").classList.add("hidden");
    }

    async function saveStudentProfile() {
      const idsStr = document.getElementById("edit-student-ids").value;
      const oldName = document.getElementById("edit-student-old-name").value;
      const newName = document.getElementById("edit-student-name").value.trim();
      const newPhone = document.getElementById("edit-student-phone").value.trim();

      if (!newName) return sysAlert("å§“åä¸èƒ½ç‚ºç©ºï¼", "æ ¼å¼éŒ¯èª¤");

      // æ‹†è§£ ID é™£åˆ—
      const ids = idsStr.split(',');

      setStatus("æ­£åœ¨åŒæ­¥æ›´æ–°æ‰€æœ‰é—œè¯èª²ç¨‹...");

      // â˜… ç²¾æº–å°„æ“Šï¼šåªæ›´æ–°å‰›å‰›æ”¶é›†åˆ°çš„é‚£äº›é—œè¯ ID
      const { error } = await _client.from("schedules").update({ course_name: newName, phone: newPhone }).in("id", ids);

      if (error) {
        setStatus("æ›´æ–°å¤±æ•—", "error");
        return sysAlert("æ›´æ–°å¤±æ•—ï¼š" + error.message, "ç³»çµ±éŒ¯èª¤");
      }

      // å¤©çœ¼æ—¥èªŒè¿½è¹¤
      await recordLog('ä¿®æ”¹å­¸ç”Ÿ', `åœ¨é€šè¨ŠéŒ„æ‰¹æ¬¡æ›´æ–°äº† [${oldName}] çš„åŸºæœ¬è³‡æ–™ (é€£å‹•ä¿®æ”¹äº† ${ids.length} å ‚èª²)`, 'schedules', null, null);

      setStatus("è³‡æ–™å·²åŒæ­¥æ›´æ–°ï¼", "success");
      closeStudentEditModal();

      // é‡æ–°è®€å–é€šè¨ŠéŒ„è³‡æ–™ä¸¦é‡æ–°æ¸²æŸ“ç•«é¢
      await loadDirectoryData();

      // å¦‚æœå‰›å¥½æ”¹åˆ°ç•¶å‰æ­£åœ¨çœ‹çš„è€å¸«çš„èª²è¡¨ï¼Œä¹Ÿé †ä¾¿èƒŒæ™¯åˆ·æ–°ä¸€ä¸‹ä»¥å…è³‡æ–™ä¸åŒæ­¥
      if (currentTid) refreshData();
    }

    // --- è¤‡è£½åŠŸèƒ½ (å‡ç´šç‰ˆï¼šç›´æ¥åœ¨æ ¼å­å…§é¡¯ç¤ºæç¤º) ---
    function copyToClipboard(text, element) {
      if (!text || text === '-') return;
      navigator.clipboard.writeText(text).then(() => {
        if (element) {
          element.classList.add('relative');
          const existingBadge = element.querySelector('.copy-badge');
          if (existingBadge) existingBadge.remove();
          const badge = document.createElement('div');
          badge.className = 'copy-badge absolute inset-0 flex items-center justify-center bg-neutral-800/90 text-white text-xs font-bold rounded opacity-0 transition-opacity duration-200 z-10 pointer-events-none';
          badge.innerHTML = `<span class="flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> å·²è¤‡è£½!</span>`;
          element.appendChild(badge);
          lucide.createIcons();
          requestAnimationFrame(() => badge.classList.remove('opacity-0'));
          setTimeout(() => {
            badge.classList.add('opacity-0');
            setTimeout(() => badge.remove(), 200);
          }, 800);
        }
      }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—', err);
        sysAlert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", "ç³»çµ±æç¤º");
      });
    }

    // å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ (å¦‚æœå‰é¢å·²ç¶“å®£å‘Šéï¼Œé€™è¡Œå¯ä»¥çœç•¥ï¼Œä½†å¤šå¯«ç„¡å¦¨)
    var _allStudentsCache = [];

    // --- è¼‰å…¥è€å¸«åå–®åˆ°çµ±è¨ˆé¸å–® (ä¿®æ­£ç‰ˆï¼šåŒæ™‚é è¼‰å­¸ç”Ÿè³‡æ–™) ---
    async function populateStatTeacherFilter() {
      const select = document.getElementById("stat-teacher");
      if (!select) return;

      // 1. è¼‰å…¥è€å¸«åå–®
      if (select.options.length <= 1) { // åªæœ‰ç•¶é¸å–®é‚„æ²’è¼‰å…¥éæ™‚æ‰è·‘
        console.log("æ­£åœ¨è¼‰å…¥è€å¸«åå–®...");
        const { data, error } = await _client.from("teachers").select("id, name, is_hidden").order("name");

        if (error) console.error("è€å¸«åå–®è¼‰å…¥å¤±æ•—:", error);

        if (data) {
          data.forEach(t => {
            // ğŸ¦¸â€â™‚ï¸ éš±å½¢æ–—ç¯· 4ï¼šåœ¨å ±è¡¨ä¸‹æ‹‰é¸å–®éš±è— ccy
            if (t.is_hidden || t.name.toLowerCase().includes('ccy')) return;

            const opt = document.createElement("option");
            opt.value = t.id;
            opt.textContent = t.name;
            select.appendChild(opt);
          });
        }
      }

      // 2. â˜… æ–°å¢é€™æ®µï¼šé è¼‰æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ (ç‚ºäº†çµ¦ä¸‹æ‹‰é¸å–®ç”¨)
      // æˆ‘å€‘åªéœ€è¦ Course Name (å­¸ç”Ÿå§“å) å’Œ Teacher ID (ç‚ºäº†é€£å‹•ç¯©é¸)
      console.log("æ­£åœ¨å¿«å–å­¸ç”Ÿåå–®...");
      const { data: schedules } = await _client.from("schedules").select("course_name, teacher_id");

      if (schedules) {
        _allStudentsCache = schedules; // å­˜åˆ°è¨˜æ†¶é«”

        // â˜… é—œéµï¼šè³‡æ–™æŠ“å®Œå¾Œï¼Œç«‹åˆ»å‘¼å«æ›´æ–°å‡½å¼ï¼Œå¡«æ»¿å­¸ç”Ÿé¸å–®ï¼
        if (typeof updateStudentList === 'function') {
          updateStudentList();
        }
      }
    }

    // --- çµ±è¨ˆè¨ˆç®— (å–®æ¬¡èª²ç¨‹ + è¤‡è£½ä¿å…¨ç‰ˆï¼šç¢ºä¿é è¨­é¡è‰²ä¹Ÿèƒ½è¢«è¨ˆå…¥) ---
    async function calculateStats() {
      const start = document.getElementById("stat-start").value;
      const end = document.getElementById("stat-end").value;
      const teacherId = document.getElementById("stat-teacher").value;
      const studentName = document.getElementById("stat-student").value.trim();

      if (!start || !end) return sysAlert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ", "è³‡æ–™ä¸é½Šå…¨");
      setStatus("æ­£åœ¨è§£æèª²è¡¨èˆ‡æ­·å²ç´€éŒ„...");

      // 1. æŠ“å–èª²è¡¨ (åŒ…å«æ‚¨è¤‡è£½å‡ºä¾†çš„å–®æ¬¡èª²)
      let schedQuery = _client.from("schedules").select("*").eq("is_deleted", false);
      if (teacherId !== 'all') schedQuery = schedQuery.eq("teacher_id", teacherId);
      const { data: sData } = await schedQuery;

      // 2. æŠ“å–é»åç´€éŒ„
      let recQuery = _client.from("lesson_records").select("*").gte("actual_date", start).lte("actual_date", end);
      if (teacherId !== 'all') recQuery = recQuery.eq("teacher_id", teacherId);
      const { data: rData } = await recQuery;

      const recordMap = new Map();
      (rData || []).forEach(r => recordMap.set(`${r.schedule_id}_${r.actual_date}`, r));

      const schedulesByDay = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [] };
      const tempSchedulesByDate = new Map();

      (sData || []).forEach(s => {
        if (s.is_temporary && s.target_date) {
          if (!tempSchedulesByDate.has(s.target_date)) tempSchedulesByDate.set(s.target_date, []);
          tempSchedulesByDate.get(s.target_date).push(s);
        } else if (s.day_of_week) {
          schedulesByDay[s.day_of_week].push(s);
        }
      });

      let c = { 'present': 0, 'leave': 0, 'absent': 0, 'practice': 0 };
      let total = 0;
      let loopDate = new Date(start);
      const endDateObj = new Date(end);

      while (loopDate <= endDateObj) {
        const dStr = formatDate(loopDate);
        let dayOfWeek = loopDate.getDay(); if (dayOfWeek === 0) dayOfWeek = 7;

        const daySchedules = [...(schedulesByDay[dayOfWeek] || []), ...(tempSchedulesByDate.get(dStr) || [])];

        daySchedules.forEach(s => {
          // éæ¿¾å§“å
          if (studentName && !(s.course_name || "").includes(studentName)) return;

          const record = recordMap.get(`${s.id}_${dStr}`);
          // â˜… é—œéµä¿®æ­£ï¼šå¦‚æœæœ‰ç´€éŒ„å°±çœ‹ç´€éŒ„ï¼›æ²’ç´€éŒ„å°±çœ‹ã€Œèª²è¡¨æ¯ç‰ˆã€çš„é è¨­é¡è‰²
          const status = record ? record.status : (s.color_class || 'status-pending');

          // ğŸ”ª æ’é™¤çµ•å°çš„ç°è‰² (å°šæœªé»å)
          if (status === 'status-pending') return;

          total++;
          if (['attended', 'status-present'].includes(status)) c.present++;
          else if (['leave', 'status-leave'].includes(status)) c.leave++;
          else if (['absent', 'status-absent'].includes(status)) c.absent++;
          else if (['status-practice'].includes(status)) c.practice++;
        });
        loopDate.setDate(loopDate.getDate() + 1);
      }

      // --- UI æ¸²æŸ“ (ç¶­æŒå…ˆå‰æä¾›çš„ 4 è‰²åœ–è¡¨èˆ‡è©³ç´°æ¸…å–®) ---
      renderStatsUI(c, total); // (é€™è£¡å‘¼å«æ‚¨åŸæœ¬çš„æ¸²æŸ“é‚è¼¯å³å¯)
    }

    // å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜ç›®å‰ã€Œç¬¦åˆè€å¸«æ¢ä»¶ã€çš„æ‰€æœ‰å­¸ç”Ÿ
    let _currentAvailableStudents = [];

    // --- 1. æ›´æ–°å­¸ç”Ÿè³‡æ–™ä¾†æº (ç•¶åˆ‡æ›è€å¸«æ™‚è§¸ç™¼) ---
    function updateStudentList() {
      const teacherId = document.getElementById("stat-teacher").value;
      const input = document.getElementById("stat-student");

      // æ¸…ç©ºç›®å‰çš„è¼¸å…¥
      input.value = "";
      toggleClearBtn(false);

      // 1. éæ¿¾å‡ºè©²è€å¸«çš„å­¸ç”Ÿ
      let filteredSchedules = _allStudentsCache;
      if (teacherId !== 'all') {
        filteredSchedules = _allStudentsCache.filter(s => s.teacher_id === teacherId);
      }

      // 2. æå–ä¸é‡è¤‡çš„å­¸ç”Ÿå§“å
      const uniqueNames = new Set(filteredSchedules.map(s => s.course_name));

      // 3. è½‰æˆé™£åˆ—ä¸¦æ’åº (æŒ‰ç­†ç•«)
      _currentAvailableStudents = Array.from(uniqueNames).sort((a, b) => {
        return (a || "").localeCompare(b || "", "zh-Hant");
      });

      // 4. é‡ç½®é¸å–®é¡¯ç¤º
      filterStudentList("");
    }

    // --- 2. éæ¿¾ä¸¦æ¸²æŸ“ä¸‹æ‹‰æ¸…å–® (æ‰“å­—æ™‚è§¸ç™¼) ---
    function filterStudentList(keyword) {
      const listEl = document.getElementById("student-dropdown-list");
      const clearBtn = document.getElementById("clear-student-btn");

      // æ§åˆ¶æ¸…é™¤æŒ‰éˆ•é¡¯ç¤º
      toggleClearBtn(keyword.length > 0);

      // é€™è£¡åšç°¡å–®çš„éæ¿¾
      const matches = _currentAvailableStudents.filter(name =>
        (name || "").toLowerCase().includes(keyword.toLowerCase())
      );

      listEl.innerHTML = "";

      if (matches.length === 0) {
        listEl.innerHTML = `<li class="p-3 text-sm text-gray-400 text-center">æ‰¾ä¸åˆ°ç›¸ç¬¦å­¸ç”Ÿ</li>`;
      } else {
        matches.forEach(name => {
          const li = document.createElement("li");
          li.className = "p-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-colors flex items-center gap-2";
          // è®“æœå°‹å­—è®Šç²—é«” (é¸ç”¨)
          const highlightedName = keyword ? name.replace(new RegExp(keyword, 'gi'), match => `<b class="text-blue-600">${match}</b>`) : name;

          li.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span> <span>${highlightedName}</span>`;

          // ç¶å®šé»æ“Šäº‹ä»¶
          li.onclick = () => selectStudent(name);
          listEl.appendChild(li);
        });
      }
    }

    // --- 3. é¡¯ç¤ºé¸å–® ---
    function showStudentList() {
      document.getElementById("student-dropdown-list").classList.remove("hidden");
      // å¦‚æœè¼¸å…¥æ¡†æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºå…¨éƒ¨
      const currentVal = document.getElementById("stat-student").value;
      filterStudentList(currentVal);
    }

    // --- 4. é¸æ“‡å­¸ç”Ÿ ---
    function selectStudent(name) {
      const input = document.getElementById("stat-student");
      input.value = name;
      toggleClearBtn(true);

      // éš±è—é¸å–®
      document.getElementById("student-dropdown-list").classList.add("hidden");
    }

    // --- 5. æ¸…é™¤æœå°‹ ---
    function clearStudentSearch() {
      const input = document.getElementById("stat-student");
      input.value = "";
      input.focus();
      toggleClearBtn(false);
      filterStudentList("");
    }

    function toggleClearBtn(show) {
      const btn = document.getElementById("clear-student-btn");
      if (btn) {
        if (show) btn.classList.remove("hidden");
        else btn.classList.add("hidden");
      }
    }

    // --- 6. é»æ“Šå¤–éƒ¨é—œé–‰é¸å–® (UX å„ªåŒ–) ---
    document.addEventListener('click', function (e) {
      const container = document.querySelector('#tab-content-stats .relative.group');
      const listEl = document.getElementById("student-dropdown-list");

      // å¦‚æœé»æ“Šçš„åœ°æ–¹ä¸åœ¨æœå°‹æ¡†ç¯„åœå…§ï¼Œå°±é—œé–‰é¸å–®
      if (container && !container.contains(e.target) && listEl && !listEl.classList.contains('hidden')) {
        listEl.classList.add('hidden');
      }
    });

    // --- æ¬Šé™è¨­å®šé‚è¼¯ (å´é‚Šæ¬„å¯è¦‹åå–®) ---
    let editingPermTeacherId = null;

    function openPermissionsModal(teacherId) {
      editingPermTeacherId = teacherId;
      const targetTeacher = allTeachers.find(t => t.id === teacherId);
      if (!targetTeacher) return;

      // è¨­å®šæ¨™é¡Œ
      document.getElementById('perm-modal-title').innerHTML = `<i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> è¨­å®šã€${targetTeacher.name}ã€‘çš„å¯è¦‹åå–®`;

      const listContainer = document.getElementById('perm-checkbox-list');
      listContainer.innerHTML = '';

      // å–å‡ºé€™åè€å¸«åŸæœ¬å°±è¨­å®šå¥½çš„å¯è¦‹åå–® (å¦‚æœæ˜¯ null å°±çµ¦ç©ºé™£åˆ—)
      const viewableArr = targetTeacher.viewable_teachers ? targetTeacher.viewable_teachers.split(',') : [];

      // ç”¢ç”Ÿæ‰€æœ‰è€å¸«çš„æ‰“å‹¾é¸é …
      allTeachers.forEach(t => {
        // ğŸ¦¸â€â™‚ï¸ éš±å½¢æ–—ç¯· 3ï¼šåœ¨æ¬Šé™æ‰“å‹¾é¸å–®ä¸­éš±è— ccy
        if (t.is_hidden || t.name.toLowerCase().includes('ccy')) return;

        // é è¨­è‡ªå·±ä¸€å®šçœ‹å¾—åˆ°è‡ªå·±ï¼Œæˆ–æ˜¯è¢«å‹¾é¸çš„äºº
        const isSelf = t.id === teacherId;
        const isChecked = viewableArr.includes(String(t.id)) || isSelf;

        // â˜… é—œéµé€²åŒ–ï¼šæŠŠå¤–å±¤çš„ div æ›æˆäº† labelï¼Œä¸ç”¨å¯« onclick ä¹Ÿèƒ½å…¨å€æ„Ÿæ‡‰ï¼
        const labelRow = document.createElement('label');
        // åŠ å…¥ select-none é˜²æ­¢é€£é»æ™‚åç™½æ–‡å­—
        labelRow.className = `flex items-center gap-3 p-3 rounded-lg transition-colors select-none ${isSelf ? 'bg-blue-50/50 cursor-not-allowed' : 'hover:bg-gray-50 cursor-pointer'}`;

        labelRow.innerHTML = `
            <input type="checkbox" id="perm_${t.id}" value="${t.id}" 
                   class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 ${isSelf ? 'cursor-not-allowed' : 'cursor-pointer'}" 
                   ${isChecked ? 'checked' : ''} 
                   ${isSelf ? 'disabled' : ''}>
            <div class="flex-1 flex items-center gap-2 text-sm font-bold text-gray-700">
                ${t.name}
                ${isSelf ? '<span class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">æœ¬äºº (å¼·åˆ¶é¡¯ç¤º)</span>' : ''}
            </div>
        `;

        // æŠŠé€™ä¸€è¡ŒåŠ é€²æ¸…å–®è£¡
        listContainer.appendChild(labelRow);
      });

      document.getElementById('permissions-modal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closePermissionsModal() {
      document.getElementById('permissions-modal').classList.add('hidden');
    }

    // ==========================================
    // ğŸŒŸ ç›®æ¨™äºŒï¼šä¸Šå¸è¦–è§’æ“ä½œæ—¥èªŒèˆ‡å¾©åŸç³»çµ± (çµ•å°é˜²ç¦¦ç‰ˆ)
    // ==========================================

    // 1. æ ¸å¿ƒæ©Ÿå™¨äºº (Email å­˜æª”ç‰ˆ)
    async function recordLog(actionType, description, targetTable, oldData, newData) {
      if (!currentUserInfo) return;

      // çµ‚æ¥µéš±å½¢æ–—ç¯·ï¼šå¦‚æœæ˜¯é–‹ç™¼è€…æœ¬äººæ“ä½œï¼Œä¸å¯«å…¥æ—¥èªŒ
      if (currentUserInfo.name.toLowerCase().includes('ccy')) return;

      try {
        const { error } = await _client.from('action_logs').insert([{
          // â˜… é—œéµæ”¹å‹•ï¼šå°‡ .name æ”¹ç‚º .email
          actor_name: currentUserInfo.email,
          action_type: actionType,
          description: description,
          target_table: targetTable,
          old_data: oldData || null,
          new_data: newData || null
        }]);

        if (error) console.error("ğŸš¨ å¯«å…¥æ—¥èªŒå¤±æ•—:", error.message);
      } catch (err) {
        console.error("ğŸš¨ ç™¼ç”ŸéŒ¯èª¤:", err);
      }
    }

    // 2. è®€å–ä¸¦ç•«å‡ºæ—¥èªŒç•«é¢ (Email çµ±ä¸€é¡¯ç¤º + ç©ºé–“æ¥µè‡´å£“ç¸®ç‰ˆ)
    async function loadLogs() {
      const list = document.getElementById("logs-list");
      list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i> è®€å–ä¸­...</td></tr>`;

      const tableEl = list.closest('table');
      tableEl.style.tableLayout = 'fixed';
      tableEl.style.width = '100%';

      // â˜… ç©ºé–“åˆ†é… (ç¸½è¨ˆ 100%)ï¼šæ™‚é–“(8%) / äººå“¡(18%) / å‹•ä½œ(10%) / å…§å®¹(54%) / å¾©åŸ(10%)
      const thead = tableEl.querySelector('thead');
      if (thead) {
        thead.innerHTML = `
                    <tr>
                        <th style="width: 8%;" class="p-2 text-[10px] text-gray-400 font-bold uppercase text-center">æ“ä½œæ™‚é–“</th>
                        <th style="width: 18%;" class="p-2 text-[10px] text-gray-400 font-bold uppercase text-center">æ“ä½œäººå“¡</th>
                        <th style="width: 10%;" class="p-2 text-[10px] text-gray-400 font-bold uppercase text-center">å‹•ä½œ</th>
                        <th style="width: 54%;" class="p-2 text-[10px] text-gray-400 font-bold uppercase">è©³ç´°å…§å®¹</th>
                        <th style="width: 10%;" class="p-2 text-[10px] text-gray-400 font-bold uppercase text-center">å¾©åŸ</th>
                    </tr>
                `;
      }

      const { data, error } = await _client
        .from('action_logs')
        .select('*')
        .not('actor_name', 'ilike', '%ccy%')
        .not('description', 'ilike', '%ccy%')
        .order('created_at', { ascending: false })
        .limit(100);

      if (error) {
        list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500 font-bold">è¼‰å…¥å¤±æ•—ï¼š${error.message}</td></tr>`;
        return;
      }

      list.innerHTML = "";
      data.forEach(log => {
        const d = new Date(log.created_at);
        const timeStr = `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;

        // â˜… æ™ºæ…§ç¿»è­¯å¼•æ“ï¼šå¦‚æœèˆŠè³‡æ–™å­˜çš„æ˜¯ã€Œå§“åã€ï¼Œæˆ‘å€‘åœ¨å‰ç«¯å¼·åˆ¶è½‰æˆ Email
        let displayUser = log.actor_name || 'æœªçŸ¥';
        if (displayUser === 'é®ªé­šè€å¸«') displayUser = 'tuna@moonick.music';

        let badgeColor = "border-gray-200 text-gray-400 bg-gray-50";
        const isReverted = log.action_type.includes('å·²å¾©åŸ');
        if (isReverted) { badgeColor = "border-gray-100 text-gray-300 bg-gray-50 line-through"; }
        else if (log.action_type.includes('æ–°å¢')) { badgeColor = "border-green-100 text-green-600 bg-green-50"; }
        else if (log.action_type.includes('ä¿®æ”¹') || log.action_type.includes('é»å')) { badgeColor = "border-blue-100 text-blue-600 bg-blue-50"; }
        else if (log.action_type.includes('åˆªé™¤')) { badgeColor = "border-red-100 text-red-600 bg-red-50"; }

        const undoableTypes = ['æ–°å¢èª²ç¨‹', 'åˆªé™¤èª²ç¨‹', 'ä¿®æ”¹èª²ç¨‹', 'ä¿®æ”¹é»å'];
        const canUndo = undoableTypes.includes(log.action_type);
        const opacityClass = isReverted ? "opacity-40" : "";

        const row = document.createElement("tr");
        row.className = "hover:bg-blue-50/20 transition-colors border-b border-gray-50 last:border-0";

        row.innerHTML = `
          <td class="p-2 text-[10px] font-mono text-gray-400 text-center ${opacityClass}" style="width: 8%;">${timeStr}</td>
          <td class="p-2 font-bold text-neutral-500 text-[10px] truncate text-center ${opacityClass}" style="width: 18%;" title="${displayUser}">
              ${displayUser}
          </td>
          <td class="p-2 ${opacityClass}" style="width: 10%;">
              <span class="px-1.5 py-0.5 rounded text-[9px] font-bold border ${badgeColor} block text-center truncate">${log.action_type.replace('èª²ç¨‹', '')}</span>
          </td>
          <td class="p-2 ${opacityClass}" style="width: 54%;">
              <div class="w-full overflow-hidden">${formatLogCard(log)}</div>
          </td>
          <td class="p-2 text-center ${opacityClass}" style="width: 10%;">
              ${canUndo ? `
                  <button onclick="executeUndo('${log.id}')" class="w-full py-1 bg-white border border-gray-300 text-gray-600 hover:text-amber-600 hover:border-amber-400 rounded shadow-sm text-[10px] font-bold transition-all active:scale-95 flex items-center justify-center gap-1">
                      <i data-lucide="undo-2" class="w-3 h-3"></i> å¾©åŸ
                  </button>
              ` : `<span class="text-xs text-gray-200">â€”</span>`}
          </td>
        `;
        list.appendChild(row);
      });
      if (window.lucide) lucide.createIcons();
    }

    // ==========================================
    // ğŸŒŸ ç²¾ç·»ç‰ˆå¾©åŸç³»çµ± UI æ§åˆ¶èˆ‡åŸ·è¡Œ
    // ==========================================

    var pendingUndoLogId = null;
    var pendingUndoLogData = null;

    // 3. è®€å–ä¸¦æ‰“é–‹æ¼‚äº®è¦–çª— (è»Ÿåˆªé™¤ç²¾æº–å°æ¥ç‰ˆï¼šå„ªå…ˆ 1æ¯”1 ID åŒ¹é…)
    async function executeUndo(logId) {
      setStatus("æ­£åœ¨è®€å–å¾©åŸè³‡è¨Š...");
      const { data: log, error: fetchErr } = await _client.from('action_logs').select('*').eq('id', logId).single();

      if (fetchErr || !log) {
        setStatus("è®€å–å¤±æ•—", "error");
        return sysAlert("æ‰¾ä¸åˆ°æ—¥èªŒï¼Œå¯èƒ½å·²ç¶“å¤±æ•ˆæˆ–å·²è¢«å¾©åŸéäº†ï¼", "è®€å–å¤±æ•—");
      }

      pendingUndoLogId = logId;
      pendingUndoLogData = log;

      const titleEl = document.getElementById('undo-modal-title');
      const contentEl = document.getElementById('undo-modal-content');
      const warningEl = document.getElementById('undo-modal-warning');

      const oldD = log.old_data;
      const newD = log.new_data;
      const refData = oldD || newD;

      // --- æ­¥é©Ÿ A: 1æ¯”1 ç²¾æº–æ‰¾äºº (åŒ…å«å·²è»Ÿåˆªé™¤çš„è³‡æ–™) ---
      let targetSchedule = null;
      let isFuzzyMatched = false;

      // å–å¾—é€™ç­†æ—¥èªŒç•¶åˆé—œè¯çš„ ID
      const originalScheduleId = (log.target_table === 'schedules') ? refData.id : refData.schedule_id;

      if (originalScheduleId) {
        // â˜… é—œéµï¼šç›´æ¥ç”¨ ID æ‰¾ï¼Œä¸ç®¡å®ƒæœ‰æ²’æœ‰è¢«æ¨™è¨˜åˆªé™¤ï¼Œç³»çµ±éƒ½èƒ½æ‰¾åˆ°ã€Œæœ¬å°Šã€
        const { data: exactMatch } = await _client.from('schedules').select('*').eq('id', originalScheduleId).maybeSingle();
        targetSchedule = exactMatch;
      }

      // --- æ­¥é©Ÿ B: ID çœŸçš„æ¶ˆå¤±äº† (ä¾‹å¦‚æ˜¯å¾ˆä¹…ä»¥å‰è¢«ã€Œç¡¬åˆªé™¤ã€çš„è³‡æ–™) æ‰å•Ÿå‹•æ¨¡ç³ŠåŒ¹é… ---
      if (!targetSchedule && refData && log.target_table === 'schedules') {
        setStatus("æ‰¾ä¸åˆ°åŸå§‹ IDï¼Œå˜—è©¦åŒ¹é…ç›¸ä¼¼èª²ç¨‹...");
        const { data: fuzzyMatch } = await _client.from('schedules')
          .select('*')
          .eq('teacher_id', refData.teacher_id)
          .eq('course_name', refData.course_name)
          .eq('day_of_week', refData.day_of_week)
          .eq('start_time', refData.start_time)
          .eq('is_deleted', false) // æ¨¡ç³ŠåŒ¹é…åªæ‰¾æ´»è‘—çš„èª²ï¼Œé¿å…äº‚é€£
          .maybeSingle();

        if (fuzzyMatch) {
          targetSchedule = fuzzyMatch;
          isFuzzyMatched = true;
          if (log.old_data) log.old_data.id = fuzzyMatch.id;
          if (log.new_data) log.new_data.id = fuzzyMatch.id;
        }
      }

      // --- æ­¥é©Ÿ C: è»Ÿåˆªé™¤ç‹€æ…‹æª¢æŸ¥ (æ­»äº¡é˜²è­·é–) ---
      if (targetSchedule && targetSchedule.is_deleted) {
        // å¦‚æœæ˜¯ä¿®æ”¹èª²ç¨‹/é»åï¼Œä½†æœ¬å°Šæ­£è™•æ–¼ã€Œè¢«éš±è—(è»Ÿåˆªé™¤)ã€ç‹€æ…‹
        if (log.action_type === 'ä¿®æ”¹é»å' || log.action_type === 'ä¿®æ”¹èª²ç¨‹') {
          setStatus("ç›®æ¨™å·²åˆªé™¤", "warning");
          return sysAlert(
            "é€™å ‚èª²ç›®å‰è™•æ–¼ã€Œå·²åˆªé™¤ã€ç‹€æ…‹ï¼<br><br>ğŸ‘‰ ç³»çµ±å·²é€é ID æ‰¾åˆ°è©²èª²ç¨‹ï¼Œä½†æ‚¨å¿…é ˆå…ˆ<b>å¾©åŸè©²èª²çš„ã€Œåˆªé™¤ç´€éŒ„ã€</b>ï¼Œè®“å®ƒå›åˆ°èª²è¡¨å¾Œæ‰èƒ½ç¹¼çºŒæ“ä½œã€‚",
            "ğŸ‘» èª²ç¨‹å·²éš±è—",
            "warning"
          );
        }
      } else if (!targetSchedule) {
        // é€£æ­»æ‰çš„è³‡æ–™éƒ½æ‰¾ä¸åˆ° (å¯èƒ½è¢«æ‰‹å‹•æ¸…ç†æ‰è³‡æ–™åº«äº†)
        return sysAlert("ç³»çµ±æ‰¾ä¸åˆ°é€™å ‚èª²çš„è¹¤å½±ï¼æ­¤ç­†æ—¥èªŒå·²å¤±å»ç›®æ¨™ã€‚", "ğŸ‘» ç›®æ¨™å¾¹åº•æ¶ˆå¤±", "warning");
      }

      // (å¾Œé¢çš„ä»‹é¢æ¸²æŸ“é‚è¼¯ç¶­æŒä¸è®Š...)
      let scheduleInfoHtml = '';
      const info = targetSchedule || refData;
      if (log.target_table === 'schedules' || targetSchedule) {
        const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };
        let dStr = info.is_temporary && info.target_date ? `å–®æ¬¡ ${info.target_date.slice(5)} (é€±${dayMap[info.day_of_week]})` : `å›ºå®š æ¯é€±${dayMap[info.day_of_week]}`;
        let tRange = (info.start_time && info.end_time) ? `${info.start_time.slice(0, 5)} - ${info.end_time.slice(0, 5)}` : '';
        scheduleInfoHtml = `<i data-lucide="clock" class="w-3.5 h-3.5 text-blue-400"></i> ${dStr} ${tRange}`;
      }

      const d = new Date(log.created_at);
      const actionTimeStr = `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
      const actionInfoHtml = `<div class="mt-4 pt-3 border-t border-gray-200 flex justify-between items-center text-[10px] text-gray-400 font-sans"><span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> æ“ä½œäººï¼š${log.actor_name || 'æœªçŸ¥'}</span><span class="flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> æ–¼ ${actionTimeStr} è®Šæ›´</span></div>`;

      let htmlContent = `<div class="mb-3 border-b border-blue-200 pb-2"><div class="font-bold text-blue-800 flex items-center gap-1.5 text-sm"><i data-lucide="file-edit" class="w-4 h-4"></i> ${log.description.split('ï¼š')[0]}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-start gap-1">${scheduleInfoHtml}</div></div>`;

      if (log.action_type === 'æ–°å¢èª²ç¨‹') {
        titleEl.textContent = 'ç¢ºå®šè¦ã€æ’¤éŠ·æ–°å¢ã€‘å—ï¼Ÿ';
        warningEl.innerHTML = '<i data-lucide="trash-2" class="w-3.5 h-3.5 inline mr-1"></i> åŸ·è¡Œå¾Œï¼Œé€™å ‚èª²å°‡æ¨™è¨˜ç‚ºå·²åˆªé™¤ï¼';
        htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">å‹•ä½œ</span><span class="line-through text-red-400 truncate flex-1 text-right text-sm">æ–°å¢èª²è¡¨</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1 text-sm">æ¨™è¨˜ç§»é™¤</span></div>`;
      }
      else if (log.action_type === 'åˆªé™¤èª²ç¨‹') {
        titleEl.textContent = 'ç¢ºå®šè¦ã€å¾©æ´»èª²ç¨‹ã€‘å—ï¼Ÿ';
        warningEl.innerHTML = '<i data-lucide="sparkles" class="w-3.5 h-3.5 inline mr-1"></i> åŸ·è¡Œå¾Œï¼Œé€™å ‚èª²å°‡é‡æ–°å›åˆ°èª²è¡¨ä¸Šï¼';
        htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">å‹•ä½œ</span><span class="line-through text-red-400 truncate flex-1 text-right text-sm">å·²åˆªé™¤</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1 text-sm">åŠ å›èª²è¡¨</span></div>`;
      }
      else {
        titleEl.textContent = isFuzzyMatched ? 'ç¢ºå®šè¦ã€è·¨èº«ä»½é‚„åŸç‹€æ…‹ã€‘å—ï¼Ÿ' : 'ç¢ºå®šè¦ã€é€€å›ä¿®æ”¹ã€‘å—ï¼Ÿ';
        warningEl.innerHTML = isFuzzyMatched ? '<i data-lucide="zap" class="w-3.5 h-3.5 inline mr-1 text-purple-500"></i> <b>è‡ªå‹•åŒ¹é…æˆåŠŸï¼ç³»çµ±å·²æ‰¾åˆ°ç‰¹å¾µç›¸ç¬¦çš„èª²ç¨‹ã€‚</b>' : '<i data-lucide="history" class="w-3.5 h-3.5 inline mr-1"></i> åŸ·è¡Œå¾Œï¼Œè³‡æ–™å°‡æ‹‹æ£„ç›®å‰ç‹€æ…‹ï¼Œé€€å›ç•¶æ™‚è¨­å®šï¼';

        const fieldMap = { course_name: 'å§“å', subject: 'ç§‘ç›®', phone: 'é›»è©±', amount: 'é‡‘é¡', day_of_week: 'æ˜ŸæœŸ', start_time: 'é–‹å§‹', end_time: 'çµæŸ', room_no: 'æ•™å®¤' };
        for (const k in oldD) {
          if (k !== 'id' && oldD[k] !== newD[k] && fieldMap[k]) {
            let curVal = targetSchedule[k];
            let oldVal = oldD[k];
            if (k === 'start_time' || k === 'end_time') { curVal = String(curVal).slice(0, 5); oldVal = String(oldVal).slice(0, 5); }
            htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">${fieldMap[k]}</span><span class="line-through text-red-400 truncate flex-1 text-right text-sm">${curVal || 'ç©º'}</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1 text-sm">${oldVal || 'ç©º'}</span></div>`;
          }
        }
      }

      htmlContent += actionInfoHtml;
      contentEl.innerHTML = htmlContent;
      document.getElementById('undo-modal').classList.remove('hidden');
      if (window.lucide) lucide.createIcons();
      setStatus("å°±ç·’", "success");
    }

    // ğŸ¨ é€šç”¨æ—¥èªŒç¾åŒ–å™¨ (æ™‚ç©ºåº§æ¨™å¢å¼·ç‰ˆï¼šè‡ªå‹•æ¨™è¨»èª²ç¨‹æ™‚é–“èˆ‡æ—¥æœŸ)
    function formatLogCard(log) {
      if (!log) return "";
      const desc = log.description;
      const oldD = log.old_data;
      const newD = log.new_data;
      const refData = oldD || newD;

      // --- ğŸ’¡ æ ¸å¿ƒåŠŸèƒ½ï¼šæå–é€™å ‚èª²çš„ã€Œæ™‚ç©ºåº§æ¨™ã€ ---
      let timeInfo = "";
      if (refData && log.target_table === 'schedules') {
        const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };
        const timeStr = refData.start_time ? refData.start_time.slice(0, 5) : "";

        if (refData.is_temporary && refData.target_date) {
          // å–®æ¬¡èª²ç¨‹é¡¯ç¤ºï¼š(2026-02-04 15:30)
          timeInfo = `<span class="text-amber-600 font-mono ml-1">(${refData.target_date} ${timeStr})</span>`;
        } else if (refData.day_of_week) {
          // å›ºå®šèª²ç¨‹é¡¯ç¤ºï¼š(æ¯é€±ä¸‰ 15:30)
          timeInfo = `<span class="text-blue-500 font-medium ml-1">(æ¯é€±${dayMap[refData.day_of_week]} ${timeStr})</span>`;
        }
      }

      // 1. è™•ç†ã€ä¿®æ”¹é»åã€‘æ¨¡å¼ (ç¶­æŒåŸæœ‰æ—¥æœŸé¡¯ç¤º)
      const attMatch = desc.match(/å°‡ \[(.+?)\] åœ¨ (.+?) çš„ç‹€æ…‹æ”¹ç‚º \[(.+?)\]/);
      if (attMatch) {
        const [_, name, date, status] = attMatch;
        return `
                <div class="flex flex-wrap items-center gap-1.5 py-0.5">
                    <span class="font-bold text-blue-700 text-[11px] whitespace-nowrap">${name} <span class="text-gray-400 font-normal">(${date})</span></span>
                    <div class="inline-flex items-center gap-1 bg-white border border-gray-100 px-1.5 py-0.5 rounded shadow-sm">
                        <span class="text-gray-400 text-[9px] font-bold">ç‹€æ…‹</span>
                        <i data-lucide="chevron-right" class="w-2.5 h-2.5 text-blue-300"></i>
                        <span class="font-bold text-blue-600 text-[10px]">${status}</span>
                    </div>
                </div>`;
      }

      // 2. è™•ç†ã€æ–°å¢/åˆªé™¤ã€‘æ¨¡å¼ (æ–°å¢æ™‚é–“æ¨™è¨»)
      const actionMatch = desc.match(/\[(.+?)\]ï¼šæ–°å¢äº†ä¸€å ‚èª²|åˆªé™¤äº† \[(.+?)\] çš„èª²ç¨‹/);
      if (actionMatch) {
        const isDelete = desc.includes('åˆªé™¤');
        const name = actionMatch[1] || actionMatch[2];
        const color = isDelete ? 'red' : 'green';
        return `
                <div class="flex items-center gap-2 py-0.5">
                    <span class="font-bold text-${color}-700 text-[11px]">${name} ${timeInfo}</span>
                    <span class="px-1.5 py-0.5 rounded text-[9px] font-bold border border-${color}-100 bg-${color}-50 text-${color}-600">${isDelete ? 'å·²åˆªé™¤' : 'å·²æ–°å¢'}</span>
                </div>`;
      }

      // 3. è™•ç†ã€ä¿®æ”¹èª²ç¨‹ã€‘(æ–°å¢æ™‚é–“æ¨™è¨»)
      if (desc.includes(' â” ')) {
        const parts = desc.split('ï¼š');
        const namePart = parts[0];
        const changesPart = parts.slice(1).join('ï¼š');

        let html = `<div class="flex flex-wrap items-center gap-x-2 gap-y-1.5 py-0.5">`;
        html += `<span class="font-bold text-blue-800 text-[11px]">${namePart} ${timeInfo}</span>`;

        const changes = changesPart.split(' | ');
        changes.forEach(change => {
          if (change.includes(': ')) {
            const [field, vals] = change.split(': ');
            const [oldV, newV] = vals.split(' â” ');
            html += `
                    <div class="inline-flex items-center gap-1 bg-white px-1.5 py-0.5 rounded border border-gray-100 shadow-sm">
                        <span class="text-gray-400 font-bold text-[9px]">${field.trim()}</span>
                        <span class="line-through text-red-300 text-[10px]">${oldV.trim() || 'ç©º'}</span>
                        <i data-lucide="chevron-right" class="w-2.5 h-2.5 text-blue-300"></i>
                        <span class="font-bold text-blue-600 text-[10px]">${newV.trim() || 'ç©º'}</span>
                    </div>`;
          }
        });
        html += `</div>`;
        return html;
      }

      return `<div class="text-[10px] text-gray-500 italic">${desc}</div>`;
    }

    // 4. ç¢ºå®šåŸ·è¡Œå¾©åŸ (åš´æ ¼é™¤éŒ¯ç‰ˆï¼šç¢ºå¯¦å›å ±éŒ¯èª¤ï¼Œçµ•ä¸å·å·å¯«å…¥)
    async function confirmUndo() {
      if (!pendingUndoLogData) return;
      setStatus("æ­£åœ¨å¾©åŸ...");

      const log = pendingUndoLogData;
      const logId = pendingUndoLogId;
      const type = log.action_type;
      const oldD = log.old_data;
      const newD = log.new_data;
      let undoDescHtml = "";

      try {
        if (type === 'æ–°å¢èª²ç¨‹') {
          const { error } = await _client.from('schedules').delete().eq('id', newD.id);
          if (error) throw new Error("åˆªé™¤å¤±æ•—ï¼š" + error.message);
          undoDescHtml = `<span class="font-bold">ğŸ—‘ï¸ å¾©åŸæ–°å¢</span>ï¼šå·²ç§»é™¤ <span class="line-through text-red-400 ml-1">${newD.course_name} çš„èª²è¡¨</span>`;
        }
        else if (type === 'åˆªé™¤èª²ç¨‹') {
          // â˜… æ ¸å¿ƒæ”¹è®Šï¼šä¸å†åŸ·è¡Œ .insert()ï¼Œè€Œæ˜¯æŠŠ is_deleted æ¨™ç±¤æ’•æ‰ (æ”¹å› false)
          const { error } = await _client
            .from('schedules')
            .update({ is_deleted: false })
            .eq('id', oldD.id);

          if (error) throw new Error("å¾©æ´»å¤±æ•—ï¼š" + error.message);
          undoDescHtml = `<span class="font-bold">â™»ï¸ å¾©åŸåˆªé™¤</span>ï¼šå·²æ•‘å› <span class="font-bold text-green-600 ml-1">${oldD.course_name} çš„èª²è¡¨</span>`;
        }
        else if (type === 'ä¿®æ”¹èª²ç¨‹') {
          const { data: currentRealData } = await _client.from('schedules').select('*').eq('id', oldD.id).single();

          if (!currentRealData) {
            throw new Error("èª²ç¨‹ä¸å­˜åœ¨ï¼Œè«‹å…ˆå¾©åŸã€Œåˆªé™¤èª²ç¨‹ã€ï¼");
          }

          const { error } = await _client.from('schedules').update(oldD).eq('id', oldD.id);
          if (error) throw new Error("æ›´æ–°å¤±æ•—ï¼š" + error.message);

          let changes = [];
          const fieldMap = { course_name: 'å§“å', subject: 'ç§‘ç›®', phone: 'é›»è©±', amount: 'é‡‘é¡', day_of_week: 'æ˜ŸæœŸ', start_time: 'é–‹å§‹', end_time: 'çµæŸ', room_no: 'æ•™å®¤' };
          for (const k in oldD) {
            if (k !== 'id' && oldD[k] !== newD[k] && fieldMap[k]) {
              let currentVal = currentRealData ? currentRealData[k] : newD[k];
              let oldVal = oldD[k];

              if (k === 'start_time' || k === 'end_time') {
                if (currentVal) currentVal = String(currentVal).slice(0, 5);
                if (oldVal) oldVal = String(oldVal).slice(0, 5);
              } else if (k === 'day_of_week') {
                const dMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };
                if (currentVal) currentVal = dMap[currentVal] || currentVal;
                if (oldVal) oldVal = dMap[oldVal] || oldVal;
              }

              changes.push(`
                      <div class="inline-flex items-center gap-1.5 bg-white border border-gray-100 shadow-sm px-2 py-1 rounded mt-1.5 mr-2">
                        <span class="bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded text-[10px] font-bold">${fieldMap[k]}</span>
                        <span class="line-through text-gray-400 text-xs">${currentVal || 'ç©º'}</span>
                        <i data-lucide="arrow-left" class="w-3.5 h-3.5 text-amber-500"></i>
                        <span class="font-bold text-green-600 text-xs">${oldVal || 'ç©º'}</span>
                      </div>
                    `);
            }
          }

          undoDescHtml = `<div class="font-bold text-gray-700">ğŸ•’ å¼·åˆ¶å¾©åŸä¿®æ”¹ (${oldD.course_name})</div> ${changes.join('')}`;
        }
        else if (type === 'ä¿®æ”¹é»å') {
          const statusMap = { 'attended': 'âœ… ä¸Šèª²', 'status-present': 'âœ… ä¸Šèª²', 'leave': 'â˜• è«‹å‡', 'status-leave': 'â˜• è«‹å‡', 'absent': 'âŒ æ› èª²', 'status-absent': 'âŒ æ› èª²', 'status-practice': 'ğŸ¹ ç·´ç¿’', 'status-pending': 'â¬œ å°šæœªé»å' };

          const { data: currentRecord } = await _client.from('lesson_records').select('status').eq('id', newD.id).single();
          let currentStatusStr = currentRecord ? (statusMap[currentRecord.status] || currentRecord.status) : (statusMap[newD.status] || 'å·²é»å');
          let oldStatusStr = oldD ? (statusMap[oldD.status] || 'â¬œ å°šæœªé»å') : 'â¬œ å°šæœªé»å';

          if (!oldD && newD) {
            const { error } = await _client.from('lesson_records').delete().eq('id', newD.id);
            if (error) throw new Error("é»ååˆªé™¤å¤±æ•—ï¼š" + error.message);
          } else if (oldD && newD) {
            const { error } = await _client.from('lesson_records').update(oldD).eq('id', oldD.id);
            if (error) throw new Error("é»åæ›´æ–°å¤±æ•—ï¼š" + error.message);
          }

          undoDescHtml = `<div class="font-bold text-gray-700">ğŸ•’ å¼·åˆ¶å¾©åŸé»å (${newD.course_name})</div>
                  <div class="inline-flex items-center gap-1.5 bg-white border border-gray-100 shadow-sm px-2 py-1 rounded mt-1.5">
                      <span class="bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded text-[10px] font-bold">ç‹€æ…‹</span>
                      <span class="line-through text-gray-400 text-xs">${currentStatusStr}</span>
                      <i data-lucide="arrow-left" class="w-3.5 h-3.5 text-amber-500"></i>
                      <span class="font-bold text-green-600 text-xs">${oldStatusStr}</span>
                  </div>`;
        }

        // æ¨™è¨˜ç‚ºå·²å¾©åŸ
        const { error: logErr } = await _client.from('action_logs').update({
          action_type: type + ' (å·²å¾©åŸ)'
        }).eq('id', logId);
        if (logErr) throw new Error("æ—¥èªŒç‹€æ…‹æ›´æ–°å¤±æ•—ï¼š" + logErr.message);

        if (undoDescHtml) {
          await recordLog('å¾©åŸæ“ä½œ', undoDescHtml, 'system', null, null);
        }

        document.getElementById('undo-modal').classList.add('hidden');
        setStatus("å¾©åŸæˆåŠŸ", "success");

        await loadLogs();
        if (typeof refreshData === 'function') await refreshData();
        if (typeof renderDirectory === 'function') renderDirectory();

      } catch (err) {
        console.error(err);
        // å¦‚æœé€™æ¬¡å†æœ‰ä»»ä½•å¤±æ•—ï¼Œå³ä¸‹è§’æœƒç«‹åˆ»å½ˆå‡ºè©³ç´°éŒ¯èª¤åŸå› ï¼
        await sysAlert("å¾©åŸå¤±æ•—ï¼š" + err.message, "ç³»çµ±éŒ¯èª¤");
        setStatus("å¾©åŸå¤±æ•—", "error");
      }
    }

    // 2. é—œé–‰è¦–çª—
    function closeUndoModal() {
      document.getElementById('undo-modal').classList.add('hidden');
      pendingUndoLogId = null;
      pendingUndoLogData = null;
    }

    // ==========================================
    // ğŸŒŸ å…¨åŸŸæ¥µç°¡å°è©±æ¡†æ§åˆ¶å¼•æ“
    // ==========================================
    var _sysDialogResolve = null;

    // å–ä»£åŸæœ¬çš„ confirm()
    function sysConfirm(message, title = "ç³»çµ±ç¢ºèª", type = "danger") {
      return new Promise((resolve) => {
        const modal = document.getElementById('sys-dialog-modal');

        // â˜… çµ‚æ¥µæ•‘æ´ï¼šå¦‚æœå°è©±æ¡†è¢«åŒ…åœ¨éš±è—çš„çˆ¶å±¤è£¡ï¼Œå¼·åˆ¶æŠŠå®ƒæ¬åˆ°æœ€å¤–é¢ï¼
        if (modal.parentElement !== document.body) {
          document.body.appendChild(modal);
        }

        const box = document.getElementById('sys-dialog-box');
        const titleEl = document.getElementById('sys-dialog-title');
        const msgEl = document.getElementById('sys-dialog-msg');
        const confirmBtn = document.getElementById('sys-dialog-confirm');
        const cancelBtn = document.getElementById('sys-dialog-cancel');

        // è¨­å®šæ–‡å­— (æ”¯æ´ \n æ›è¡Œ)
        titleEl.innerHTML = title;
        msgEl.innerHTML = message.replace(/\n/g, '<br>');
        cancelBtn.classList.remove('hidden');

        // æ ¹æ“šé¡å‹è¨­å®šæŒ‰éˆ•é¡è‰²
        if (type === 'danger') {
          confirmBtn.className = "px-4 py-2 text-sm bg-red-500 text-white hover:bg-red-600 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
          confirmBtn.textContent = "ç¢ºå®šåˆªé™¤";
        } else if (type === 'warning') {
          confirmBtn.className = "px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
          confirmBtn.textContent = "ç¢ºå®šåŸ·è¡Œ";
        } else {
          confirmBtn.className = "px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
          confirmBtn.textContent = "ç¢ºå®š";
        }

        _sysDialogResolve = resolve;

        // é¡¯ç¤ºå‹•ç•«
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
          modal.classList.remove('opacity-0');
          box.classList.remove('scale-95');
        });
      });
    }

    // å–ä»£åŸæœ¬çš„ alert()
    function sysAlert(message, title = "ç³»çµ±æç¤º") {
      return new Promise((resolve) => {
        const modal = document.getElementById('sys-dialog-modal');

        // â˜… çµ‚æ¥µæ•‘æ´ï¼šå¦‚æœå°è©±æ¡†è¢«åŒ…åœ¨éš±è—çš„çˆ¶å±¤è£¡ï¼Œå¼·åˆ¶æŠŠå®ƒæ¬åˆ°æœ€å¤–é¢ï¼
        if (modal.parentElement !== document.body) {
          document.body.appendChild(modal);
        }

        const box = document.getElementById('sys-dialog-box');
        document.getElementById('sys-dialog-title').innerHTML = title;
        document.getElementById('sys-dialog-msg').innerHTML = message.replace(/\n/g, '<br>');

        const confirmBtn = document.getElementById('sys-dialog-confirm');
        document.getElementById('sys-dialog-cancel').classList.add('hidden'); // éš±è—å–æ¶ˆæŒ‰éˆ•

        confirmBtn.className = "px-4 py-2 text-sm bg-neutral-800 text-white hover:bg-black rounded-lg transition-colors font-bold shadow-sm active:scale-95";
        confirmBtn.textContent = "æˆ‘çŸ¥é“äº†";

        _sysDialogResolve = resolve;

        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
          modal.classList.remove('opacity-0');
          box.classList.remove('scale-95');
        });
      });
    }

    function closeSysDialog() {
      const modal = document.getElementById('sys-dialog-modal');
      const box = document.getElementById('sys-dialog-box');
      modal.classList.add('opacity-0');
      box.classList.add('scale-95');
      setTimeout(() => {
        modal.classList.add('hidden');
        if (_sysDialogResolve) { _sysDialogResolve(false); _sysDialogResolve = null; }
      }, 200); // ç­‰å¾…å‹•ç•«æ’­å®Œ
    }

    function execSysDialog() {
      const modal = document.getElementById('sys-dialog-modal');
      const box = document.getElementById('sys-dialog-box');
      modal.classList.add('opacity-0');
      box.classList.add('scale-95');
      setTimeout(() => {
        modal.classList.add('hidden');
        if (_sysDialogResolve) { _sysDialogResolve(true); _sysDialogResolve = null; }
      }, 200);
    }

    // B2. åŒ¯å…¥åŠŸèƒ½ (å‡ç´šç‰ˆï¼šå¼·åˆ¶æ¸…ç©ºé˜²å‘†é–ï¼Œæœçµ•é‡è¤‡ç–ŠåŠ )
    async function executeMasterCopyImport(input) {
      const file = input.files[0];
      if (!file) return;
      if (!currentTid) { input.value = ""; return sysAlert("è«‹å…ˆé¸æ“‡è€å¸«"); }

      const targetTeacherName = document.getElementById("main-title").textContent.split(' Â· ')[0];

      if (!(await sysConfirm(`ç¢ºå®šè¦åŒæ­¥ <b class="text-blue-600">${targetTeacherName}</b> çš„èª²è¡¨å—ï¼Ÿ<br><br><span class="text-red-500 font-bold">âš ï¸ é€™æœƒå°‡è³‡æ–™åº«å®Œå…¨æ›¿æ›ç‚º Excel çš„å…§å®¹ï¼</span>`, "å…¨èƒ½åŒæ­¥ç¢ºèª", "danger"))) {
        input.value = ""; return;
      }

      setStatus("åŒæ­¥ä¸­...");
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

          const statusMap = { 'ä¸Šèª²': 'status-present', 'è«‹å‡': 'status-leave', 'æ› èª²': 'status-absent', 'å°šæœªé»å': 'status-pending', 'å­¸ç”Ÿç·´ç¿’': 'status-practice' };
          const newSchedules = [];

          const findVal = (row, keyword) => {
            const key = Object.keys(row).find(k => k.includes(keyword));
            return key ? row[key] : null;
          };

          for (const row of jsonRows) {
            const sName = findVal(row, "å­¸ç”Ÿå§“å");
            if (!sName) continue;

            const isTemp = String(findVal(row, "åƒ…é™å–®æ¬¡") || "å¦").trim() === "æ˜¯";
            // â˜… æ–°å¢ï¼šè®€å– Excel ä¸­çš„ä¸Šèª²æ—¥æœŸ
            let targetDate = findVal(row, "ä¸Šèª²æ—¥æœŸ");
            if (targetDate && targetDate.includes('/')) targetDate = targetDate.replace(/\//g, '-');

            // åœ¨ jsonRows.forEach è¿´åœˆä¸­
            newSchedules.push({
              teacher_id: currentTid,
              course_name: String(sName).trim(),
              phone: String(findVal(row, "é›»è©±") || ""),
              subject: String(findVal(row, "ç§‘ç›®") || ""),
              amount: parseInt(String(findVal(row, "é‡‘é¡") || "0").replace(/[^0-9]/g, '')) || 0,
              day_of_week: parseInt(findVal(row, "æ˜ŸæœŸ")) || 1,
              start_time: (String(findVal(row, "é–‹å§‹æ™‚é–“") || "09:00")).substring(0, 5) + ":00",
              end_time: (String(findVal(row, "çµæŸæ™‚é–“") || "10:00")).substring(0, 5) + ":00",
              room_no: String(findVal(row, "æ•™å®¤") || ""),
              // â˜… å¼·åˆ¶é‚è¼¯ï¼šåŒ¯å…¥å¾Œé€šé€šè®Šå›åŸå§‹ç°è‰²æ¨¡æ¿
              color_class: 'status-pending',
              is_temporary: false,
              target_date: null
            });
          }

          // â˜… çµ‚æ¥µé˜²å‘†ï¼šåš´æ ¼æª¢æŸ¥ã€Œåˆªé™¤èˆŠè³‡æ–™ã€æ˜¯å¦çœŸçš„æˆåŠŸ
          const { error: delErr } = await _client.from("schedules").delete().eq("teacher_id", currentTid);
          if (delErr) {
            throw new Error("æ¸…ç©ºèˆŠè³‡æ–™å¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥æ¬Šé™ï¼š" + delErr.message);
          }

          // å¯«å…¥ Excel çš„å…§å®¹
          const { error: insErr } = await _client.from("schedules").insert(newSchedules);
          if (insErr) throw insErr;

          // å¯«å…¥æ—¥èªŒ
          await recordLog('åŒ¯å…¥è³‡æ–™', `é€é Excel è¦†è“‹äº† [${targetTeacherName}] çš„å®Œæ•´èª²è¡¨ (å…± ${newSchedules.length} ç­†)`, 'schedules', null, null);

          setStatus("åŒæ­¥æˆåŠŸ", "success");
          input.value = "";
          closeBatchModal();
          await refreshData();
          await sysAlert(`ğŸ‰ åŒæ­¥å®Œæˆï¼ç›®å‰å…±è¨ˆ ${newSchedules.length} å ‚èª²ç¨‹ã€‚`);
        } catch (err) {
          await sysAlert("éŒ¯èª¤ï¼š" + err.message);
          setStatus("å¤±æ•—", "error");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function closeDatePickerModal() { document.getElementById('date-picker-modal').classList.add('hidden'); }
    function closeHistoryEditorModal() { document.getElementById('history-editor-modal').classList.add('hidden'); }

    // 3. åŒ¯å‡ºæ­·å²ç´€éŒ„ Excel
    async function executeHistoryExport() {
      const start = document.getElementById('export-start-date').value;
      const end = document.getElementById('export-end-date').value;
      if (!start || !end) return sysAlert("è«‹é¸æ“‡å®Œæ•´çš„æ—¥æœŸ", "warning");

      closeDatePickerModal();
      setStatus("æ­£åœ¨æŠ“å–æ­·å²ç´€éŒ„...");
      const { data } = await _client.from('lesson_records').select('actual_date, status, schedules(course_name)')
        .eq('teacher_id', currentTid).gte('actual_date', start).lte('actual_date', end).not('status', 'eq', 'status-pending');

      const cnMap = { 'status-present': 'ä¸Šèª²', 'status-leave': 'è«‹å‡', 'status-absent': 'æ› èª²', 'status-practice': 'å­¸ç”Ÿç·´ç¿’' };
      const exportData = data.map(r => ({
        "æ—¥æœŸ": r.actual_date, "å­¸ç”Ÿå§“å": r.schedules ? r.schedules.course_name : "å·²åˆªé™¤çš„èª²ç¨‹", "ç‹€æ…‹": cnMap[r.status] || r.status
      }));
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "æ­·å²é»åç´€éŒ„");
      XLSX.writeFile(wb, `${start}_è‡³_${end}_æ­·å²é»å.xlsx`);
      setStatus("æ­·å²ç´€éŒ„åŒ¯å‡ºæˆåŠŸ", "success");
    }

    // 4. è®€å–ä¸¦é¡¯ç¤ºåœ¨ç·šä¿®æ­£æ¸…å–® (å–ä»£æ—¥èªŒæœå°‹)
    async function executeHistoryEditLoad() {
      const start = document.getElementById('export-start-date').value;
      const end = document.getElementById('export-end-date').value;
      if (!start || !end) return sysAlert("è«‹é¸æ“‡å®Œæ•´çš„æ—¥æœŸ", "warning");

      closeDatePickerModal();
      closeBatchModal();
      document.getElementById('history-editor-modal').classList.remove('hidden');
      const body = document.getElementById('history-editor-body');
      body.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500"><i class="animate-spin" data-lucide="loader-2"></i> è®€å–ä¸­...</td></tr>`;
      if (window.lucide) lucide.createIcons();

      const { data } = await _client.from('lesson_records').select('*, schedules(course_name)')
        .eq('teacher_id', currentTid).gte('actual_date', start).lte('actual_date', end)
        .not('status', 'eq', 'status-pending').order('actual_date', { ascending: false });

      if (!data || data.length === 0) {
        body.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-400">æ­¤å€é–“æ²’æœ‰ä»»ä½•å·²é»åçš„ç´€éŒ„</td></tr>`;
        return;
      }

      body.innerHTML = data.map(rec => `
                <tr class="border-b border-gray-100 hover:bg-amber-50/30 transition-colors">
                    <td class="p-4 text-sm font-mono text-gray-600">${rec.actual_date}</td>
                    <td class="p-4 text-sm font-bold text-gray-800">${rec.schedules ? rec.schedules.course_name : 'å·²åˆªé™¤çš„èª²ç¨‹'}</td>
                    <td class="p-4">
                        <select onchange="updateRecordStatus('${rec.id}', this.value)" class="text-sm border border-gray-200 rounded-lg p-1.5 outline-none focus:ring-2 focus:ring-amber-500 bg-white">
                            <option value="status-present" ${rec.status === 'status-present' ? 'selected' : ''}>âœ… æ­£å¸¸ä¸Šèª²</option>
                            <option value="status-leave" ${rec.status === 'status-leave' ? 'selected' : ''}>â˜• å­¸ç”Ÿè«‹å‡</option>
                            <option value="status-absent" ${rec.status === 'status-absent' ? 'selected' : ''}>âŒ å­¸ç”Ÿæ› èª²</option>
                            <option value="status-practice" ${rec.status === 'status-practice' ? 'selected' : ''}>ğŸ¹ å­¸ç”Ÿç·´ç¿’</option>
                        </select>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="deleteRecordAction('${rec.id}')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="åˆªé™¤æ­¤ç´€éŒ„">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
      if (window.lucide) lucide.createIcons();
    }

    // 5. ä¿®æ”¹ç‹€æ…‹èˆ‡åˆªé™¤ç´€éŒ„ API
    async function updateRecordStatus(id, newStatus) {
      const { error } = await _client.from('lesson_records').update({ status: newStatus }).eq('id', id);
      if (error) sysAlert("ä¿®æ”¹å¤±æ•—", "error"); else sysAlert("ç‹€æ…‹å·²æ›´æ–°", "success");
    }

    async function deleteRecordAction(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿé€™æœƒè®“èª²è¡¨ä¸Šè©²å ‚èª²è®Šå›ç°è‰²ã€‚")) return;
      const { error } = await _client.from('lesson_records').delete().eq('id', id);
      if (error) sysAlert("åˆªé™¤å¤±æ•—", "error");
      else {
        sysAlert("ç´€éŒ„å·²åˆªé™¤", "success");
        executeHistoryEditLoad(); // åˆªé™¤å¾Œè‡ªå‹•é‡æ•´ç•«é¢
      }
    }
  </script>
</body>

</html>