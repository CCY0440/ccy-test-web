<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>幕尼克音樂(金山校區)課表</title>
  <meta name="color-scheme" content="light">
  <meta name="supported-color-schemes" content="light">
  <meta name="nightmode" content="disable">
  <meta name="force-dark-mode" content="false">
  <meta name="darkreader-lock">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="style.css" />
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[800] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[900] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> 老師名單
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="px-4 py-2">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm relative group">
        <div class="flex items-center gap-1.5 mb-2 text-yellow-700/80">
          <i data-lucide="sticky-note" class="w-3.5 h-3.5"></i>
          <span class="text-xs font-bold">備忘錄</span>
          <span id="memo-status"
            class="ml-auto text-[10px] text-yellow-600 opacity-0 transition-opacity duration-500">已儲存</span>
        </div>
        <textarea id="teacher-memo"
          class="w-full bg-transparent text-xs text-gray-700 resize-none outline-none placeholder-yellow-700/30 leading-relaxed"
          rows="4" placeholder="隨手記點什麼..." oninput="handleMemoInput(this.value)"></textarea>
      </div>
    </div>

    <div class="p-4">

      <div id="user-profile-card"
        class="flex items-center gap-3 mb-4 p-2.5 bg-white border border-gray-200 rounded-xl shadow-sm">
        <div
          class="w-9 h-9 rounded-full bg-neutral-800 text-white flex items-center justify-center font-bold text-sm shrink-0 border-2 border-gray-100 shadow-sm">
          <span id="current-user-initial">?</span>
        </div>
        <div class="flex flex-col min-w-0">
          <div class="flex items-center gap-2"> <span class="text-xs font-bold text-neutral-800 truncate leading-tight"
              id="current-user-name">載入中...</span>
            <button onclick="openPasswordModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
              <i data-lucide="settings" class="w-3 h-3"></i>
            </button>
          </div>
          <span class="text-[10px] text-neutral-500 truncate leading-tight mt-0.5 flex items-center gap-1"
            id="current-user-role">
            <i data-lucide="shield-check" class="w-3 h-3"></i> 驗證中
          </span>
        </div>
      </div>

      <button id="admin-entry-btn" onclick="openAdminModal()"
        class="hidden w-full py-2 text-xs text-gray-500 hover:text-neutral-800 border border-dashed border-gray-300 hover:border-neutral-400 rounded-lg flex items-center justify-center gap-1.5 transition-all group">
        <i data-lucide="settings-2" class="w-3.5 h-3.5 group-hover:rotate-90 transition-transform"></i>
        <span class="font-bold">管理控制台</span>
      </button>

      <button onclick="openInstructionsModal()"
        class="w-full py-2 mt-2 text-xs text-amber-600 hover:bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-medium">
        <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> 系統使用說明
      </button>

      <button onclick="handleLogout()"
        class="w-full py-2 mt-2 text-xs text-red-600 hover:bg-red-50 border border-red-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-bold">
        <i data-lucide="log-out" class="w-3.5 h-3.5"></i> 登出帳號
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">網頁版本 v1.13 正式版</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex flex-wrap items-center gap-y-3 gap-x-4 shadow-sm sticky top-0 z-30">

      <div class="flex items-center gap-3 order-1 flex-1 min-w-[150px]">
        <button onclick="toggleSidebar()"
          class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden shrink-0">
          <i data-lucide="menu"></i>
        </button>

        <div class="flex flex-col min-w-0">
          <h2 id="main-title" class="text-lg md:text-xl font-bold text-neutral-800 truncate leading-tight">
            載入中...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium mt-0.5 -ml-2">
            嘗試連線...
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 order-2 lg:order-3 shrink-0">
        <button onclick="openSalaryModal()"
          class="flex items-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-emerald-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="calculator" class="w-4 h-4"></i>
          <span>薪資試算</span>
        </button>

        <button onclick="openBatchModal()"
          class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-indigo-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="sheet" class="w-4 h-4"></i>
          <span>批次管理</span>
        </button>

        <button onclick="openModal()"
          class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="hidden md:inline">新增課程</span><span class="md:hidden">新增</span>
        </button>
      </div>

      <div
        class="flex items-center justify-between gap-3 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm order-3 w-full lg:w-auto lg:mx-4 lg:order-2 relative overflow-hidden">

        <button onclick="changeWeek(-1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>

        <div class="relative flex-1 flex justify-center items-center group px-2 min-w-[220px]">

          <span id="current-date-range"
            class="text-sm md:text-base font-bold text-neutral-800 font-mono tracking-wide text-center cursor-pointer group-hover:text-blue-600 transition-colors select-none pointer-events-none whitespace-nowrap">
            計算中...
          </span>

          <input type="date" id="date-picker"
            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
            onchange="handleDatePick(this.value)">
        </div>

        <button onclick="changeWeek(1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>

    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1000] backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl w-[95%] md:w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50">
        <div class="flex items-center gap-2 text-blue-800">
          <i data-lucide="book-open" class="w-5 h-5"></i>
          <h3 class="font-bold m-0">新增課程資料</h3>
        </div>
        <button onclick="closeModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <form id="course-form" class="flex flex-col flex-1 min-h-0">
        <div class="p-6 overflow-y-auto bg-white space-y-4">

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div>
              <label class="block text-[11px] font-bold text-gray-500 mb-1">課程名稱 ( 如:EG-1、AG-1 )</label>
              <input type="text" name="subject" placeholder="請輸入科目名稱"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">學生姓名</label>
                <input type="text" name="course_name" required placeholder="姓名"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">學生電話 (多台請用空格隔開)</label>
                <input type="tel" name="phone" placeholder="聯絡電話"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
            </div>
          </div>

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">負責老師</label>
                <select name="teacher_id" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner"></select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">上課星期</label>
                <select name="day_of_week" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                  <option value="1">週一</option>
                  <option value="2">週二</option>
                  <option value="3">週三</option>
                  <option value="4">週四</option>
                  <option value="5">週五</option>
                  <option value="6">週六</option>
                  <option value="7">週日</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">開始時間</label>
                <input type="time" name="start_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">結束時間</label>
                <input type="time" name="end_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">教室</label>
              <input type="text" name="room_no" placeholder="教室名稱"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">薪資 (NT$)</label>
              <input type="number" name="amount" min="0" max="9999999" placeholder="0"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">預設狀態</label>
              <select name="color_class"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-[11px] md:text-xs outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                <option value="status-pending" selected>⬜ 尚未點名</option>
                <option value="status-present">✅ 上課</option>
                <option value="status-leave">☕ 請假</option>
                <option value="status-absent">❌ 曠課</option>
                <option value="status-practice">🎹 學生練習</option>
              </select>
            </div>
          </div>

          <div class="mt-4 pt-4">
            <div
              class="bg-blue-50/50 border border-blue-100 rounded-xl p-4 relative overflow-hidden transition-all shadow-sm">
              <div class="flex items-center gap-2 relative z-10">
                <input type="checkbox" name="is_temporary" id="is_temporary"
                  class="w-4 h-4 cursor-pointer accent-blue-600 rounded"
                  onchange="document.getElementById('temp-date-wrapper').classList.toggle('hidden', !this.checked)">
                <label for="is_temporary" class="text-sm font-bold text-blue-800 cursor-pointer select-none">📌
                  設為「單次/臨時課程」</label>
              </div>
              <div id="temp-date-wrapper" class="hidden mt-3 relative z-10 pl-6 border-l-2 border-blue-300 ml-2">
                <label class="block text-[10px] font-bold text-blue-700 mb-1">上課日期 <span
                    class="font-normal text-blue-500">(將自動推算星期)</span></label>
                <input type="date" name="target_date" id="target_date_input"
                  class="w-full border border-blue-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-white">
              </div>
            </div>
          </div>

        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2 shrink-0">
          <button type="button" onclick="closeModal()"
            class="px-5 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
          <button type="submit"
            class="px-5 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> 儲存設定
          </button>
        </div>
      </form>

    </div>
  </div>

  <div id="permissions-modal"
    class="hidden fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 flex items-center gap-2" id="perm-modal-title">
          <i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> 設定可見名單
        </h3>
        <button type="button" onclick="closePermissionsModal()"
          class="text-gray-400 hover:text-red-500 transition-colors bg-white p-1 rounded-full shadow-sm">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="p-2 overflow-y-auto flex-1 bg-white space-y-1" id="perm-checkbox-list">
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closePermissionsModal()"
          class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded-xl transition-colors">取消</button>
        <button type="button" onclick="savePermissions()"
          class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i> 儲存設定
        </button>
      </div>
    </div>
  </div>

  <div id="undo-modal"
    class="hidden fixed inset-0 bg-black/60 z-[2000] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm overflow-hidden flex flex-col border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex items-center gap-2 bg-amber-50">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i>
        <h3 class="font-bold text-amber-800" id="undo-modal-title">確認復原操作</h3>
      </div>
      <div class="p-5 text-sm text-gray-700 bg-white">
        <div id="undo-modal-content"
          class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 text-xs font-mono shadow-inner">
        </div>
        <p class="mt-4 text-[11px] font-bold text-red-500 text-center bg-red-50 py-1.5 rounded-lg border border-red-100"
          id="undo-modal-warning">
          👉 執行後，資料將退回到修改前的狀態！
        </p>
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closeUndoModal()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
        <button type="button" onclick="confirmExecuteUndo()"
          class="px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="undo-2" class="w-4 h-4"></i> 確認復原
        </button>
      </div>
    </div>
  </div>

  <div id="instructions-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-lg p-0 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col border border-neutral-200">

      <div class="bg-neutral-50 px-6 py-4 border-b border-neutral-200 flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2 text-neutral-800">
          📅 系統使用指南 (v1.13 正式版)
        </h3>
        <button onclick="closeInstructionsModal()"
          class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-200 rounded-full transition-all">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 text-sm text-neutral-700 leading-relaxed">

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
            頂部工具列 (日期與管理)
          </h4>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
            <ul class="space-y-2 text-xs text-gray-700">
              <li class="flex items-start gap-2">
                <i data-lucide="calendar" class="w-3.5 h-3.5 mt-0.5 text-blue-500"></i>
                <span><b>日期切換：</b>點擊左右箭頭中間的日期可選起始日，左右箭頭切換週次。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="calculator" class="w-3.5 h-3.5 mt-0.5 text-emerald-600"></i>
                <span><b>薪資試算：</b>計算指定日期範圍內的總薪資與堂數，支援匯出 Excel。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="sheet" class="w-3.5 h-3.5 mt-0.5 text-indigo-600"></i>
                <span><b>批次管理：</b>下載或匯入 Excel，可快速大量修改「固定課表」設定。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="plus" class="w-3.5 h-3.5 mt-0.5 text-neutral-800"></i>
                <span><b>新增課程：</b>建立一堂新的固定課程或單次/臨時課程。</span>
              </li>
            </ul>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
            日常操作 (點名與鎖定)
          </h4>
          <div class="grid gap-3">
            <div class="bg-neutral-100 border-l-4 border-neutral-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-neutral-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="lock" class="w-3.5 h-3.5"></i> 智慧鎖定機制 (New!)
              </h5>
              <p class="text-xs text-neutral-600">
                系統將自動鎖定<b>「前兩個月以前」</b>的歷史資料。被鎖定的卡片會變淡且出現鎖頭，無法再進行點名或修改，確保薪資結算數據不被誤觸跑掉。
              </p>
              <p class="text-xs text-neutral-600">
                <b>若有特殊更改需求可與管理者聯絡!</b>
              </p>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-blue-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="mouse-pointer-2" class="w-3.5 h-3.5"></i> 點擊卡片區塊 (點名)
              </h5>
              <p class="text-xs text-blue-900/80">
                點一下切換狀態：
                <span class="font-bold text-green-700">綠(上課)</span> →
                <span class="font-bold text-amber-700">咖(請假)</span> →
                <span class="font-bold text-red-700">紅(曠課)</span> →
                <span class="font-bold text-gray-500">灰(未點名)</span>。
              </p>
            </div>

            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-orange-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="edit-3" class="w-3.5 h-3.5"></i> 卡片右上按鈕 (滑鼠移入顯示)
              </h5>
              <ul class="text-xs text-orange-900/80 list-disc pl-4 space-y-1">
                <li><b class="text-yellow-700">黃色貼紙：</b>設定「日期區間」備註，可自動偵測重複備註。</li>
                <li><b class="text-blue-700">藍色鉛筆：</b>修改本堂課在資料庫的固定母版設定。</li>
                <li><b class="text-gray-600">灰色複製：</b>快速複製資料排入指定日期 (調課神器)。</li>
                <li><b class="text-red-600">紅色垃圾桶：</b>刪除此課程的所有固定排程。</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">3</span>
            實用小芝士🧀
          </h4>
          <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-3">
            <ul class="space-y-2 text-xs text-emerald-900">
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>自動對齊：</b>拖曳卡片可自訂當日的顯示順序，系統會自動記憶妳的習慣。</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>隨手備忘錄：</b>側邊欄黃色便條紙會隨打隨存，適合紀錄特殊活動等。</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>調課最速技：</b>按下「複製(灰)」按鈕 → 選取目標日期 → 存檔即完成調課。</span>
              </li>
            </ul>
          </div>
        </section>

        <section
          class="text-sm text-gray-400 px-4 space-y-1 bg-gray-50/50 py-3 rounded-lg border border-dashed border-gray-200">
          <p class="font-bold mb-1 text-gray-500">特別提醒</p>
          <ul class="space-y-1.5 text-xs">
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>初次登入請務必更改密碼並妥善保存，後台僅能協助重設。</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>若有任何功能建議或錯誤回報，請截圖聯繫 <b class="text-gray-500">鮪魚老師</b> :D</p>
            </li>
          </ul>
        </section>

        <section class="text-center pt-2">
          <button onclick="closeInstructionsModal()"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all active:scale-95 shadow-md">
            我瞭解了
          </button>
        </section>
      </div>
    </div>
  </div>

  <div id="batch-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-md p-6 shadow-2xl border border-indigo-100">

      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2 text-indigo-800">
          <i data-lucide="sheet" class="w-5 h-5"></i> 固定課表批次管理
        </h3>
        <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="p-3 bg-indigo-50 rounded-lg text-xs text-indigo-900 leading-relaxed border border-indigo-100">
          <p class="font-bold mb-1">功能說明：</p>
          <ul class="list-disc pl-4 space-y-1">
            <li>此功能用於修改<b>「固定課表」</b>(如：漲學費、換教室、改電話)。</li>
            <li>Excel 包含所有欄位：姓名、電話、金額、科目、備註等。</li>
            <li>上傳修改後的Excel後會直接覆蓋現有的固定課表設定。</li>
          </ul>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="exportMasterData()"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="download" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">下載課表 Excel</span>
          </button>

          <button
            onclick="const fileInput = document.getElementById('import-master-input'); fileInput.value = ''; fileInput.click();"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="upload" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">上傳修改後的 Excel</span>
          </button>
        </div>

        <input type="file" id="import-master-input" accept=".xlsx, .xls" class="hidden"
          onchange="executeMasterCopyImport(this)" />
      </div>

    </div>
  </div>

  <div id="salary-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-2xl h-[85vh] p-6 shadow-2xl border border-emerald-100 flex flex-col">

      <div class="flex justify-between items-center mb-4 shrink-0">
        <h3 class="font-bold text-lg flex items-center gap-2 text-emerald-800">
          <i data-lucide="calculator" class="w-5 h-5"></i> 薪資結算報告
        </h3>
        <button onclick="closeSalaryModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 shrink-0 bg-emerald-50/50 p-3 rounded-lg border border-emerald-100">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label>
          <input type="date" id="salary-start-date" onchange="autoUpdateEndDate(this.value)"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label>
          <input type="date" id="salary-end-date"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div class="flex items-end">
          <button onclick="calculateSalary()"
            class="w-full bg-emerald-600 text-white py-1.5 rounded-lg text-sm font-bold shadow hover:bg-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 h-[34px]">
            <i data-lucide="search" class="w-4 h-4"></i> 開始計算
          </button>
        </div>
      </div>

      <div id="salary-result" class="hidden flex flex-col flex-1 min-h-0 overflow-hidden">

        <div class="flex gap-4 mb-4 shrink-0">
          <div
            class="flex-1 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="absolute -right-4 -bottom-4 opacity-20"><i data-lucide="coins" class="w-24 h-24"></i></div>
            <p class="text-emerald-100 text-xs font-bold mb-1">預估總薪資</p>
            <p class="text-3xl font-bold tracking-tight" id="total-salary">$0</p>
          </div>
          <div class="flex-1 bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-gray-500">總堂數</span>
              <span class="text-lg font-bold text-gray-800" id="total-count">0 堂</span>
            </div>
            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
              <div class="bg-emerald-500 h-full w-full"></div>
            </div>
            <div class="mt-2 text-[10px] text-gray-400">
              *僅計算「上課」與「曠課」
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-auto border border-gray-200 rounded-lg relative bg-white">
          <table class="w-full text-sm text-left min-w-max">
            <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm select-none">
              <tr>
                <th onclick="sortSalary('date')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">日期 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('name')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">學生/課程 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('status')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">狀態 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('amount')"
                  class="p-3 text-right bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center justify-end gap-1">金額 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
              </tr>
            </thead>
            <tbody id="salary-list" class="divide-y divide-gray-100 text-gray-700">
            </tbody>
          </table>
        </div>

        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-3 shrink-0">

          <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg border border-emerald-100">
            <div class="flex flex-col">
              <span class="text-xs font-bold text-emerald-800">薪資結算修正</span>
              <span class="text-[10px] text-emerald-600">僅修改對應時間的「狀態、備註與當日薪資」，並不會修改到其他時間的課表。</span>
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-daily-input" accept=".xlsx, .xls" class="hidden"
                onchange="handleImportDaily(this)" />
              <button onclick="exportDailyReport()"
                class="bg-white text-emerald-700 border border-emerald-200 text-xs font-bold px-3 py-2 rounded hover:bg-emerald-100 transition-all flex items-center gap-1">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> 匯出報表
              </button>
              <button onclick="document.getElementById('import-daily-input').click()"
                class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded shadow hover:bg-emerald-700 transition-all flex items-center gap-1">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> 匯入修正
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="password-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[90%] max-w-xs p-6 shadow-2xl border border-neutral-200">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">🔑 修改登入密碼</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-gray-400 mb-1">新密碼</label>
          <input type="password" id="new-password"
            class="w-full border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-neutral-800"
            placeholder="至少 6 位數">
        </div>
        <button onclick="handleUpdatePassword()"
          class="w-full bg-neutral-800 text-white py-2 rounded-lg font-bold hover:bg-black transition-all active:scale-95 shadow-md text-sm">
          確認變更
        </button>
        <button onclick="closePasswordModal()"
          class="w-full text-gray-400 text-xs py-1 hover:text-gray-600 transition-colors">
          取消
        </button>
      </div>
    </div>
  </div>

  <div id="remark-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1400] backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl w-80 shadow-2xl flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-yellow-100 flex justify-between items-center bg-yellow-50">
        <h3 class="font-bold text-yellow-800 flex items-center gap-2 m-0">
          <i data-lucide="sticky-note" class="w-5 h-5 text-yellow-600"></i> 設定備註
        </h3>
        <button onclick="closeRemarkModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="p-5 bg-white space-y-4 text-sm">
        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-inner">
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">開始日期</label>
            <input type="date" id="remark-start-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">結束日期</label>
            <input type="date" id="remark-end-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
        </div>
        <div>
          <textarea id="quick-remark-input"
            class="w-full bg-gray-50 focus:bg-white border border-gray-200 focus:border-yellow-400 rounded-xl p-3 text-sm outline-none resize-none text-neutral-700 shadow-inner transition-colors"
            rows="3" placeholder="例如：補課、請假..."></textarea>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between gap-2 items-center">
        <button onclick="saveQuickRemark(true)"
          class="p-2 bg-white text-red-500 border border-gray-200 hover:bg-red-50 hover:border-red-200 rounded-xl font-bold transition-all shadow-sm flex items-center justify-center group"
          title="清空此區間的備註">
          <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
        </button>
        <div class="flex gap-2">
          <button onclick="closeRemarkModal()"
            class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
          <button onclick="saveQuickRemark(false)"
            class="px-5 py-2 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600 transition-all text-sm shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> 儲存
          </button>
        </div>
      </div>

    </div>
  </div>

  <div id="admin-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1500] backdrop-blur-sm">
    <div
      class="bg-white rounded-xl w-[95%] max-w-4xl h-[90vh] shadow-2xl flex flex-col border border-neutral-200 overflow-hidden">

      <div class="bg-neutral-800 text-white flex shrink-0">
        <div class="px-6 py-4 font-bold text-lg flex items-center gap-2 border-r border-neutral-700 min-w-[200px]">
          <i data-lucide="shield-alert" class="w-5 h-5"></i> 管理控制台
        </div>
        <div class="flex flex-1 overflow-x-auto admin-tabs-scroll">
          <button onclick="switchAdminTab('directory')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-directory">
            <i data-lucide="contact" class="w-4 h-4"></i> 通訊錄
          </button>
          <button onclick="switchAdminTab('stats')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-stats">
            <i data-lucide="pie-chart" class="w-4 h-4"></i> 統計報表
          </button>
          <button onclick="switchAdminTab('teachers')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-teachers">
            <i data-lucide="users" class="w-4 h-4"></i> 老師管理
          </button>
          <button onclick="switchAdminTab('logs')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-logs">
            <i data-lucide="history" class="w-4 h-4"></i> 操作日誌
          </button>
          <button onclick="switchAdminTab('admin-info')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-admin-info">
            <i data-lucide="info" class="w-4 h-4"></i> 後台指南
          </button>
        </div>
        <button onclick="closeAdminModal()"
          class="px-6 hover:bg-neutral-700 text-gray-400 hover:text-white transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="flex-1 bg-gray-50 overflow-hidden relative">

        <div id="tab-content-directory" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div class="flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-3 mb-4 shrink-0">
            <div class="relative w-full sm:w-72">
              <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
              <input type="text" id="dir-search" oninput="renderDirectory()" placeholder="搜尋姓名、電話..."
                class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-neutral-800 shadow-sm">
            </div>
            <div
              class="text-[11px] sm:text-xs text-gray-500 bg-gray-50/80 px-2.5 py-1.5 rounded-md border border-gray-200 shadow-sm w-full sm:w-auto text-center sm:text-left">
              💡 提示：點擊任何欄位即可複製
            </div>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('name')">
                    <div class="flex items-center gap-1">學生姓名 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('phone')">
                    <div class="flex items-center gap-1">電話 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('subject')">
                    <div class="flex items-center gap-1">科目 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('teacher')">
                    <div class="flex items-center gap-1">負責老師 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 w-16 text-center whitespace-nowrap">操作</th>
                </tr>
              </thead>
              <tbody id="directory-list" class="divide-y divide-gray-100 text-neutral-700"></tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-stats" class="admin-tab-content w-full h-full flex flex-col p-6 hidden overflow-y-auto">
          <div
            class="flex flex-wrap items-end gap-3 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm shrink-0">

            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1">1. 選擇老師</label>
              <select id="stat-teacher" onchange="updateStudentList()"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none bg-white min-w-[120px] focus:ring-2 focus:ring-neutral-800">
                <option value="all">ALL</option>
              </select>
            </div>

            <div class="flex-1 min-w-[180px] relative group">
              <label class="block text-xs font-bold text-gray-500 mb-1">2. 搜尋學生</label>

              <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                <input type="text" id="stat-student" placeholder="輸入姓名搜尋..."
                  class="w-full border border-gray-300 rounded-lg pl-9 pr-8 py-1.5 text-sm outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800 transition-all"
                  oninput="filterStudentList(this.value)" onfocus="showStudentList()" autocomplete="off">

                <button id="clear-student-btn" onclick="clearStudentSearch()"
                  class="hidden absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                  <i data-lucide="x-circle" class="w-4 h-4"></i>
                </button>
              </div>

              <ul id="student-dropdown-list"
                class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto divide-y divide-gray-50">
                <li class="p-3 text-sm text-gray-400 text-center">請先選擇老師...</li>
              </ul>
            </div>

            <div><label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label><input type="date"
                id="stat-start" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label><input type="date" id="stat-end"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>

            <button onclick="calculateStats()"
              class="bg-neutral-800 text-white px-5 py-1.5 rounded-lg text-sm font-bold hover:bg-black transition-all shadow-md h-[34px] flex items-center">
              <i data-lucide="search" class="w-3.5 h-3.5 mr-1"></i> 查詢
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center min-h-[300px]">
              <h4 class="font-bold text-gray-700 mb-6 flex items-center gap-2"><i data-lucide="pie-chart"
                  class="w-4 h-4"></i> 整體狀態分佈</h4>
              <div id="stat-pie-chart" class="w-48 h-48 rounded-full shadow-inner relative"
                style="background: conic-gradient(#d1d5db 0% 100%);">
                <div
                  class="absolute inset-0 m-auto w-24 h-24 bg-white rounded-full flex items-center justify-center flex-col">
                  <span id="stat-total-lessons" class="text-xl font-bold text-neutral-800">0</span><span
                    class="text-[10px] text-gray-400">總堂數</span>
                </div>
              </div>
              <div class="mt-6 flex flex-wrap gap-4 justify-center text-xs font-bold">
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-green-500"></span> 上課 <span
                    id="label-present">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-amber-400"></span> 請假 <span
                    id="label-leave">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-red-500"></span> 曠課 <span
                    id="label-absent">0%</span></div>
                <div class="flex items-center gap-1.5">
                  <span class="w-3 h-3 rounded-full bg-gray-300"></span> 尚未點名 <span id="label-pending">0%</span>
                </div>
              </div>
            </div>
            <div class="bg-white p-0 rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col">
              <div class="p-4 bg-gray-50 border-b border-gray-200 font-bold text-gray-700">詳細數據</div>
              <div class="flex-1 overflow-y-auto p-4 space-y-3" id="stat-details">
                <p class="text-center text-gray-400 text-sm py-10">請選擇日期並開始分析...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-content-teachers"
          class="admin-tab-content w-full h-full flex flex-col md:flex-row gap-4 md:gap-6 p-4 md:p-6 hidden overflow-y-auto md:overflow-hidden bg-gray-50/50">
          <div
            class="w-full md:w-80 shrink-0 flex flex-col bg-white rounded-2xl border border-gray-200 shadow-sm p-5 h-fit">
            <div class="flex items-center gap-2 mb-5">
              <div class="w-1.5 h-4 bg-blue-600 rounded-full shrink-0"></div>
              <h4 class="font-bold text-gray-800 text-base m-0 leading-none">新增老師與帳號</h4>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1.5">老師姓名</label>
                <input type="text" id="new-teacher-name" placeholder="例：章魚老師"
                  class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none transition-all bg-gray-50 focus:bg-white shadow-inner">
              </div>

              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1.5">登入帳號 <span
                    class="text-blue-500 font-normal">(英文或數字)</span></label>
                <input type="text" id="new-teacher-username" placeholder="例：octopus"
                  class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none transition-all bg-gray-50 focus:bg-white shadow-inner">
              </div>

              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1.5">預設密碼 <span
                    class="text-blue-500 font-normal">(至少 6 碼)</span></label>
                <input type="text" id="new-teacher-password" placeholder="請設定給這位老師初始密碼"
                  class="w-full border border-gray-300 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none transition-all bg-gray-50 focus:bg-white shadow-inner">
              </div>

              <div class="pt-2">
                <button onclick="addTeacher()"
                  class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-700 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm">
                  <i data-lucide="check-circle" class="w-4 h-4"></i> 建立帳號並新增
                </button>
              </div>
            </div>
          </div>

          <div
            class="flex-1 flex flex-col bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden min-h-[500px] md:min-h-0 md:h-full">

            <div class="p-4 bg-gray-50 border-b border-gray-100 flex items-center justify-between shrink-0">
              <h4 class="font-bold text-gray-700 flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4 text-gray-400"></i> 現有老師名單
              </h4>
              <span
                class="text-[10px] text-gray-400 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">點擊卡片右側可修改或刪除</span>
            </div>

            <div class="p-4 flex-1 overflow-y-auto bg-[#fbfbfa]">
              <div id="teacher-manage-list" class="flex flex-col gap-2.5"></div>
            </div>
          </div>

        </div>

        <div id="tab-content-logs" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div
            class="flex justify-between items-center mb-4 shrink-0 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">

            <div class="flex flex-col gap-1">
              <h3 class="font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i> 系統操作軌跡
              </h3>
              <div
                class="flex items-center gap-1.5 text-[10px] text-amber-600 bg-amber-50 px-2 py-0.5 rounded-md border border-amber-100 w-fit">
                <i data-lucide="clock" class="w-3 h-3"></i>
                <span class="font-bold">系統維護：僅會保留近 3 個月紀錄</span>
              </div>
            </div>

            <button onclick="loadLogs()"
              class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition-colors flex items-center gap-1">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> 重新整理
            </button>
          </div>
          <div class="flex-1 overflow-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left min-w-max">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 whitespace-nowrap">時間</th>
                  <th class="p-4 whitespace-nowrap">操作人員</th>
                  <th class="p-4 whitespace-nowrap">動作</th>
                  <th class="p-4 min-w-[250px]">詳細內容</th>
                  <th class="p-4 whitespace-nowrap text-center">復原</th>
                </tr>
              </thead>
              <tbody id="logs-list" class="divide-y divide-gray-100 text-neutral-700">
              </tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-admin-info"
          class="admin-tab-content w-full h-full flex flex-col p-8 hidden overflow-y-auto bg-[#fbfbfa]">
          <div class="max-w-2xl mx-auto w-full space-y-10">

            <div class="flex flex-col items-center">
              <div
                class="px-3 py-1 bg-neutral-800 text-white text-[10px] font-bold rounded-full mb-3 tracking-widest uppercase">
                Admin Terminal
              </div>
              <h3 class="text-2xl font-bold text-neutral-800 tracking-tighter">管理者核心操作手冊</h3>
              <p class="text-neutral-400 text-xs mt-2 font-medium">針對後台進階功能的操作說明與維護建議。</p>
            </div>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">1</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">數據資產監控</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-blue-400 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-blue-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">通訊錄管理</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">整合所有班級學生的聯繫電話。點擊號碼區塊即可複製至剪貼簿，省去手動輸入的時間。</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-emerald-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">統計報表 (對帳核對)</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">追蹤學生出席率與堂數。適合在月底進行教學進度核對，或作為薪資發放的參考數據。</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">2</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">人事權限管理</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-yellow-500 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-blue-600 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">師資名單異動</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">支援修改顯示姓名。若老師離職，請在此執行刪除，確保系統名單的即時性。</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-yellow-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">側邊欄可見權限</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">點擊老師旁的「眼睛圖示」，可設定該老師登入後允許查閱的對象，維持側邊欄簡潔。</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">3</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">安全與自動化維護</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-amber-600 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-amber-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">操作軌跡與復原</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">紀錄所有點名與修改動作。若發生誤操作，可至日誌分頁點擊「復原」按鈕撤銷該次更動。</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-neutral-300 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">自動清理機制</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">系統每日凌晨將自動執行維護，僅保留近 3 個月之日誌紀錄，以維持數據載入效率。</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="bg-emerald-50 border border-emerald-100 rounded-2xl p-6">
              <h4 class="font-bold text-emerald-800 text-sm mb-3 flex items-center gap-2">
                <i data-lucide="zap" class="w-4 h-4 fill-emerald-500"></i> 管理者專屬芝士 🧀
              </h4>
              <ul class="text-[11px] text-emerald-900/70 space-y-2 leading-relaxed">
                <li class="flex gap-2"><span>•</span> <span><b>批量更新：</b>修改大量學費金額或教室時，直接用「批次管理」匯出 Excel 改最快。</span></li>
                <li class="flex gap-2"><span>•</span> <span><b>智慧鎖定：</b>系統會自動保護前兩個月資料，若需更動舊紀錄，請確保以管理員身分操作。</span></li>
              </ul>
            </section>

            <section class="text-xs text-gray-400 px-5 py-4 bg-white rounded-xl border border-dashed border-gray-300">
              <div class="flex items-center gap-2 mb-3 text-neutral-500 font-bold">
                <i data-lucide="shield-alert" class="w-4 h-4"></i>
                <span>開發者安全須知</span>
              </div>
              <ul class="space-y-3 text-[11px] leading-relaxed">
                <li class="flex gap-2">
                  <span class="text-neutral-400 font-bold">•</span>
                  <span>修改課程母版前，建議先核對「薪資結算」分頁是否有尚未處理的金額修正，避免未來連動計算產生數據落差。</span>
                </li>
                <li class="flex gap-2">
                  <span class="text-neutral-400 font-bold">•</span>
                  <p>本系統由 <i class="text-slate-500 font-bold not-italic">@CCY</i> 專屬開發並授予使用權予 <span
                      class="text-neutral-500 font-bold">幕尼克音樂(金山校區)</span>，開發者仍保留系統底層邏輯與數據架構之最終解釋權。</p>
                </li>
              </ul>
            </section>

            <div class="pt-4 text-center">
              <div
                class="inline-flex items-center gap-2 px-4 py-1.5 bg-white border border-neutral-200 rounded-xl shadow-sm">
                <span class="text-[10px] text-neutral-400 font-mono italic">Powered by</span>
                <span class="text-xs font-bold italic text-slate-500 tracking-widest">@CCY DEV</span>
              </div>
            </div>

          </div>
        </div>

        <div id="sys-dialog-modal"
          class="hidden fixed inset-0 bg-black/40 z-[3000] flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
          <div
            class="bg-white rounded-xl shadow-2xl w-[85%] max-w-sm overflow-hidden flex flex-col transform scale-95 transition-transform duration-200"
            id="sys-dialog-box">
            <div class="p-6">
              <h3 class="font-bold text-gray-900 text-lg mb-2 flex items-center gap-2" id="sys-dialog-title">提示</h3>
              <p class="text-sm text-gray-600 leading-relaxed" id="sys-dialog-msg">內容</p>
            </div>
            <div class="px-5 py-3 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
              <button id="sys-dialog-cancel" onclick="closeSysDialog()"
                class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-800 rounded-lg transition-colors">取消</button>
              <button id="sys-dialog-confirm" onclick="execSysDialog()"
                class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95">確定</button>
            </div>
          </div>
        </div>

        <div id="student-edit-modal"
          class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1600] backdrop-blur-sm">
          <div class="bg-white rounded-2xl w-[90%] max-w-sm p-6 shadow-2xl border border-neutral-200">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800">
              <i data-lucide="user-cog" class="w-5 h-5"></i> 修改基本資料
            </h3>
            <div
              class="mb-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-800 leading-relaxed border border-blue-100 shadow-inner">
              💡 這裡的修改會<b>一次性同步更新</b>該學生名下所有科目的姓名與電話。
            </div>
            <div class="space-y-4">
              <input type="hidden" id="edit-student-ids">
              <input type="hidden" id="edit-student-old-name">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">學生姓名</label>
                <input type="text" id="edit-student-name"
                  class="w-full border border-gray-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-gray-50 focus:bg-white transition-all">
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">聯絡電話</label>
                <input type="text" id="edit-student-phone"
                  class="w-full border border-gray-300 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-gray-50 focus:bg-white transition-all">
              </div>
              <div class="flex justify-end gap-2 pt-2">
                <button onclick="closeStudentEditModal()"
                  class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg font-bold transition-colors">取消</button>
                <button onclick="saveStudentProfile()"
                  class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center gap-1">
                  <i data-lucide="save" class="w-4 h-4"></i> 儲存變更
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="student-schedule-modal"
          class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1700] backdrop-blur-sm">
          <div
            class="bg-white rounded-2xl w-[95%] max-w-4xl h-[85vh] shadow-2xl flex flex-col overflow-hidden border border-gray-200">

            <div class="p-4 border-b border-gray-100 bg-emerald-50 flex flex-wrap justify-between items-center gap-3">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-lg shadow-sm"
                  id="stu-modal-initial"></div>
                <div>
                  <h3 class="font-bold text-emerald-900 m-0" id="stu-modal-name">學生課表</h3>
                  <p class="text-[10px] text-emerald-600 font-medium" id="stu-modal-phone"></p>
                </div>
              </div>

              <div
                class="flex items-center gap-2 bg-white rounded-xl border border-emerald-200 p-1 shadow-sm relative group">
                <button onclick="changeStudentWeek(-1)"
                  class="p-1.5 hover:bg-gray-100 rounded-lg text-emerald-600 transition-colors z-20 relative">
                  <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>

                <div
                  class="relative flex justify-center items-center px-2 min-w-[160px] cursor-pointer group-hover:bg-emerald-50 transition-colors rounded-lg">
                  <span id="stu-modal-date-range" class="text-xs font-bold text-gray-700 font-mono select-none"></span>
                  <input type="date" id="stu-date-picker"
                    class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
                    onchange="handleStudentDatePick(this.value)">
                </div>

                <button onclick="changeStudentWeek(1)"
                  class="p-1.5 hover:bg-gray-100 rounded-lg text-emerald-600 transition-colors z-20 relative">
                  <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
              </div>

              <button onclick="closeStudentScheduleModal()"
                class="text-gray-400 hover:text-red-500 bg-white p-1.5 rounded-full transition-colors border border-gray-100 shadow-sm">
                <i data-lucide="x" class="w-5 h-5"></i>
              </button>
            </div>

            <div class="flex-1 overflow-auto bg-[#fbfbfa]" id="stu-schedule-wrapper">
              <div id="stu-schedule-container" class="flex min-w-max p-4">
              </div>
            </div>

            <div class="p-3 bg-gray-50 border-t border-gray-100 text-center">
              <span class="text-[10px] text-gray-400 font-bold">💡 點擊卡片可直接點名，系統會同步更新至該老師的課表中</span>
            </div>
          </div>
        </div>

        <script src="app.js"></script>
</body>

</html>