<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¹•å°¼å…‹éŸ³æ¨‚(é‡‘å±±æ ¡å€)èª²è¡¨</title>
  <meta name="color-scheme" content="light">
  <meta name="supported-color-schemes" content="light">
  <meta name="nightmode" content="disable">
  <meta name="force-dark-mode" content="false">
  <meta name="darkreader-lock">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    * {
      font-family: "Noto Sans TC", sans-serif !important;
    }

    .schedule-card * {
      line-height: 1.15 !important;
    }

    html,
    body,
    * {
      -webkit-text-size-adjust: none !important;
      -moz-text-size-adjust: none !important;
      text-size-adjust: none !important;
    }

    /* è®“ç¶²é è¼‰å…¥å‰å…ˆéš±å½¢ï¼Œä¸¦å¢åŠ ä¸€é»å¹³æ»‘éåº¦çš„æ•ˆæœ */
    body {
      opacity: 0;
      font-family: "Noto Sans TC", sans-serif;
      transition: opacity 0.3s ease-in-out;
    }

    /* ç•¶è£ä¿®å¥½äº†ï¼ŒåŠ ä¸Šé€™å€‹ class å°±æœƒé¡¯ç¤ºå‡ºä¾† */
    body.page-ready {
      opacity: 1;
    }

    /* â˜… è§£æ±ºæ‹–æ›³æ„Ÿæ‡‰ä¸è‰¯ï¼šæ‹–æ›³æ™‚ï¼Œè®“å¡ç‰‡å…§æ‰€æœ‰å­å…ƒç´ æ»‘é¼ ç©¿é€ â˜… */
    body.is-dragging .schedule-card * {
      pointer-events: none !important;
    }

    /* --- æ–°ç‰ˆå¡ç‰‡æ¨£å¼ï¼šç™½åº• + å·¦å´è‰²æ¢ --- */

    /* ä¸Šèª²ï¼šç¶ è‰²é‚Šæ¡† + æ¥µæ·¡ç¶ åº• */
    .status-present {
      background-color: #f0fdf4 !important;
      border-left: 4px solid #22c55e !important;
      /* é¡¯çœ¼çš„å·¦é‚Šæ¢ */
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #14532d !important;
    }

    /* è«‹å‡ï¼šç¥ç€è‰²é‚Šæ¡† */
    .status-leave {
      background-color: #fffbeb !important;
      border-left: 4px solid #f59e0b !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #78350f !important;
    }

    /* æ› èª²ï¼šç´…è‰²é‚Šæ¡† */
    .status-absent {
      background-color: #fef2f2 !important;
      border-left: 4px solid #ef4444 !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #7f1d1d !important;
    }

    /* å­¸ç”Ÿç·´ç¿’ï¼šè—è‰²é‚Šæ¡† */
    .status-practice {
      background-color: #eff6ff !important;
      border-left: 4px solid #3b82f6 !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #1e3a8a !important;
    }

    /* å°šæœªé»åï¼šç°è‰²é‚Šæ¡† */
    .status-pending {
      background-color: #ffffff !important;
      border-left: 4px solid #d1d5db !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #374151 !important;
    }

    /* å´é‚Šæ¬„é¸ä¸­ç‹€æ…‹ï¼šçµ±ä¸€è‰²èª¿ç‰ˆ */
    .teacher-item.active {
      background-color: #eff6ff !important;
      /* Tailwind blue-50 */
      color: #1d4ed8 !important;
      /* Tailwind blue-700 */
      font-weight: 700 !important;
      border-right: 4px solid #2563eb !important;
      /* å¼·åˆ¶åŠ ä¸Šæ˜é¡¯çš„å³é‚Šæ¢ */
    }

    /* å±•é–‹ç‹€æ…‹çš„å¡ç‰‡æ¨£å¼ */
    .card-expanded {
      height: auto !important;
      /* è®“å…§å®¹æ±ºå®šé«˜åº¦ */
      min-height: min-content;
      z-index: 100 !important;
      /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding-bottom: 12px !important;
      /* å¢åŠ åº•éƒ¨ç·©è¡ */
    }

    /* é–å®šå¡ç‰‡çš„å¤–è§€ï¼šå¾®é€æ˜ + ç¦ç”¨é»æ“Š */
    .card-locked {
      opacity: 0.6 !important;
      pointer-events: none !important;
      /* å¾¹åº•ç¦æ­¢é»æ“Šèˆ‡ Hover æ•ˆæœ */
      filter: grayscale(20%);
    }

    /* é–å®šæ¨™ç±¤ï¼šåœ¨å¡ç‰‡å³ä¸Šè§’ç§€ä¸€å€‹å°é–é ­ */
    .lock-icon-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      padding: 2px;
    }

    /* æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶è®“éš±å½¢çš„æ—¥æ›†é»æ“Šæ„Ÿæ‡‰å€æ’æ»¿æ•´å€‹å€åŸŸ */
    #date-picker::-webkit-calendar-picker-indicator {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 0;
      /* å®Œå…¨é€æ˜ä½†å……æ»¿æ•´æ ¼ */
      z-index: 25;
    }

    #schedule-container {
      /* é€™æ˜¯è®“é ‚éƒ¨å’Œå·¦é‚Šæ™‚é–“ä¸äº‚é£„çš„åŸºç¤ */
      transform-origin: 0 0 !important;
      /* ç§»é™¤æ‰€æœ‰éæ¸¡æ•ˆæœï¼Œç¸®æ”¾å¿…é ˆ 100% å¯¦æ™‚è·Ÿéš¨æ‰‹æŒ‡ */
      transition: none !important;
      /* æ•ˆèƒ½å„ªåŒ–ï¼šå¼·åˆ¶ä½¿ç”¨é¡¯å¡æ¸²æŸ“ï¼Œæ‰¾å›çµ²æ»‘æ„Ÿ */
      will-change: transform;
    }

    /* é¡å¤–ä¿®æ­£ï¼šç¢ºä¿ç¸®æ”¾å¾Œæ ¼ç·šä¾ç„¶æ¸…æ™° */
    #schedule-wrapper {
      -webkit-overflow-scrolling: touch;
    }

    /* â˜… ç¸®æ”¾æ™‚å¼·åˆ¶é—œé–‰æ‰€æœ‰è½‰å ´å‹•ç•«ï¼Œæ‰¾å› 60fps çµ²æ»‘æ‰‹æ„Ÿ */
    body.is-pinching,
    body.is-pinching * {
      transition: none !important;
    }
  </style>
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[800] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[900] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> è€å¸«åå–®
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="px-4 py-2">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm relative group">
        <div class="flex items-center gap-1.5 mb-2 text-yellow-700/80">
          <i data-lucide="sticky-note" class="w-3.5 h-3.5"></i>
          <span class="text-xs font-bold">å‚™å¿˜éŒ„</span>
          <span id="memo-status"
            class="ml-auto text-[10px] text-yellow-600 opacity-0 transition-opacity duration-500">å·²å„²å­˜</span>
        </div>
        <textarea id="teacher-memo"
          class="w-full bg-transparent text-xs text-gray-700 resize-none outline-none placeholder-yellow-700/30 leading-relaxed"
          rows="4" placeholder="éš¨æ‰‹è¨˜é»ä»€éº¼..." oninput="handleMemoInput(this.value)"></textarea>
      </div>
    </div>

    <div class="p-4">

      <div id="user-profile-card"
        class="flex items-center gap-3 mb-4 p-2.5 bg-white border border-gray-200 rounded-xl shadow-sm">
        <div
          class="w-9 h-9 rounded-full bg-neutral-800 text-white flex items-center justify-center font-bold text-sm shrink-0 border-2 border-gray-100 shadow-sm">
          <span id="current-user-initial">?</span>
        </div>
        <div class="flex flex-col min-w-0">
          <div class="flex items-center gap-2"> <span class="text-xs font-bold text-neutral-800 truncate leading-tight"
              id="current-user-name">è¼‰å…¥ä¸­...</span>
            <button onclick="openPasswordModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
              <i data-lucide="settings" class="w-3 h-3"></i>
            </button>
          </div>
          <span class="text-[10px] text-neutral-500 truncate leading-tight mt-0.5 flex items-center gap-1"
            id="current-user-role">
            <i data-lucide="shield-check" class="w-3 h-3"></i> é©—è­‰ä¸­
          </span>
        </div>
      </div>

      <button id="admin-entry-btn" onclick="openAdminModal()"
        class="hidden w-full py-2 text-xs text-gray-500 hover:text-neutral-800 border border-dashed border-gray-300 hover:border-neutral-400 rounded-lg flex items-center justify-center gap-1.5 transition-all group">
        <i data-lucide="settings-2" class="w-3.5 h-3.5 group-hover:rotate-90 transition-transform"></i>
        <span class="font-bold">ç®¡ç†æ§åˆ¶å°</span>
      </button>

      <button onclick="openInstructionsModal()"
        class="w-full py-2 mt-2 text-xs text-amber-600 hover:bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-medium">
        <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> ç³»çµ±ä½¿ç”¨èªªæ˜
      </button>

      <button onclick="handleLogout()"
        class="w-full py-2 mt-2 text-xs text-red-600 hover:bg-red-50 border border-red-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-bold">
        <i data-lucide="log-out" class="w-3.5 h-3.5"></i> ç™»å‡ºå¸³è™Ÿ
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">ç¶²é ç‰ˆæœ¬ v1.11 æ­£å¼ç‰ˆ</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex flex-wrap items-center gap-y-3 gap-x-4 shadow-sm sticky top-0 z-30">

      <div class="flex items-center gap-3 order-1 flex-1 min-w-[150px]">
        <button onclick="toggleSidebar()"
          class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden shrink-0">
          <i data-lucide="menu"></i>
        </button>

        <div class="flex flex-col min-w-0">
          <h2 id="main-title" class="text-lg md:text-xl font-bold text-neutral-800 truncate leading-tight">
            è¼‰å…¥ä¸­...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium mt-0.5 -ml-2">
            å˜—è©¦é€£ç·š...
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 order-2 lg:order-3 shrink-0">
        <button onclick="openSalaryModal()"
          class="flex items-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-emerald-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="calculator" class="w-4 h-4"></i>
          <span>è–ªè³‡è©¦ç®—</span>
        </button>

        <button onclick="openBatchModal()"
          class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-indigo-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="sheet" class="w-4 h-4"></i>
          <span>æ‰¹æ¬¡ç®¡ç†</span>
        </button>

        <button onclick="openModal()"
          class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="hidden md:inline">æ–°å¢èª²ç¨‹</span><span class="md:hidden">æ–°å¢</span>
        </button>
      </div>

      <div
        class="flex items-center justify-between gap-3 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm order-3 w-full lg:w-auto lg:mx-4 lg:order-2 relative overflow-hidden">

        <button onclick="changeWeek(-1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>

        <div class="relative flex-1 flex justify-center items-center group px-2 min-w-[220px]">

          <span id="current-date-range"
            class="text-sm md:text-base font-bold text-neutral-800 font-mono tracking-wide text-center cursor-pointer group-hover:text-blue-600 transition-colors select-none pointer-events-none whitespace-nowrap">
            è¨ˆç®—ä¸­...
          </span>

          <input type="date" id="date-picker"
            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
            onchange="handleDatePick(this.value)">
        </div>

        <button onclick="changeWeek(1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>

    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1000] backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl w-[95%] md:w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50">
        <div class="flex items-center gap-2 text-blue-800">
          <i data-lucide="book-open" class="w-5 h-5"></i>
          <h3 class="font-bold m-0">æ–°å¢èª²ç¨‹è³‡æ–™</h3>
        </div>
        <button onclick="closeModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <form id="course-form" class="flex flex-col flex-1 min-h-0">
        <div class="p-6 overflow-y-auto bg-white space-y-4">

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div>
              <label class="block text-[11px] font-bold text-gray-500 mb-1">èª²ç¨‹åç¨± ( å¦‚:EG-1ã€AG-1 )</label>
              <input type="text" name="subject" placeholder="è«‹è¼¸å…¥ç§‘ç›®åç¨±"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">å­¸ç”Ÿå§“å</label>
                <input type="text" name="course_name" required placeholder="å§“å"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">å­¸ç”Ÿé›»è©± (å¤šå°è«‹ç”¨ç©ºæ ¼)</label>
                <input type="tel" name="phone" placeholder="è¯çµ¡é›»è©±"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
            </div>
          </div>

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">è² è²¬è€å¸«</label>
                <select name="teacher_id" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner"></select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">ä¸Šèª²æ˜ŸæœŸ</label>
                <select name="day_of_week" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                  <option value="1">é€±ä¸€</option>
                  <option value="2">é€±äºŒ</option>
                  <option value="3">é€±ä¸‰</option>
                  <option value="4">é€±å››</option>
                  <option value="5">é€±äº”</option>
                  <option value="6">é€±å…­</option>
                  <option value="7">é€±æ—¥</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                <input type="time" name="start_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                <input type="time" name="end_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">æ•™å®¤</label>
              <input type="text" name="room_no" placeholder="æ•™å®¤åç¨±"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">è–ªè³‡ (NT$)</label>
              <input type="number" name="amount" min="0" max="9999999" placeholder="0"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">é è¨­ç‹€æ…‹</label>
              <select name="color_class"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-[11px] md:text-xs outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                <option value="status-pending" selected>â¬œ å°šæœªé»å</option>
                <option value="status-present">âœ… ä¸Šèª²</option>
                <option value="status-leave">â˜• è«‹å‡</option>
                <option value="status-absent">âŒ æ› èª²</option>
                <option value="status-practice">ğŸ¹ å­¸ç”Ÿç·´ç¿’</option>
              </select>
            </div>
          </div>

          <div class="mt-4 pt-4">
            <div
              class="bg-blue-50/50 border border-blue-100 rounded-xl p-4 relative overflow-hidden transition-all shadow-sm">
              <div class="flex items-center gap-2 relative z-10">
                <input type="checkbox" name="is_temporary" id="is_temporary"
                  class="w-4 h-4 cursor-pointer accent-blue-600 rounded"
                  onchange="document.getElementById('temp-date-wrapper').classList.toggle('hidden', !this.checked)">
                <label for="is_temporary" class="text-sm font-bold text-blue-800 cursor-pointer select-none">ğŸ“Œ
                  è¨­ç‚ºã€Œå–®æ¬¡/è‡¨æ™‚èª²ç¨‹ã€</label>
              </div>
              <div id="temp-date-wrapper" class="hidden mt-3 relative z-10 pl-6 border-l-2 border-blue-300 ml-2">
                <label class="block text-[10px] font-bold text-blue-700 mb-1">ä¸Šèª²æ—¥æœŸ <span
                    class="font-normal text-blue-500">(å°‡è‡ªå‹•æ¨ç®—æ˜ŸæœŸ)</span></label>
                <input type="date" name="target_date" id="target_date_input"
                  class="w-full border border-blue-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-white">
              </div>
            </div>
          </div>

        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2 shrink-0">
          <button type="button" onclick="closeModal()"
            class="px-5 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">å–æ¶ˆ</button>
          <button type="submit"
            class="px-5 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è¨­å®š
          </button>
        </div>
      </form>

    </div>
  </div>

  <div id="permissions-modal"
    class="hidden fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 flex items-center gap-2" id="perm-modal-title">
          <i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> è¨­å®šå¯è¦‹åå–®
        </h3>
        <button type="button" onclick="closePermissionsModal()"
          class="text-gray-400 hover:text-red-500 transition-colors bg-white p-1 rounded-full shadow-sm">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="p-2 overflow-y-auto flex-1 bg-white space-y-1" id="perm-checkbox-list">
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closePermissionsModal()"
          class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded-xl transition-colors">å–æ¶ˆ</button>
        <button type="button" onclick="savePermissions()"
          class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è¨­å®š
        </button>
      </div>
    </div>
  </div>

  <div id="undo-modal"
    class="hidden fixed inset-0 bg-black/60 z-[2000] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm overflow-hidden flex flex-col border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex items-center gap-2 bg-amber-50">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i>
        <h3 class="font-bold text-amber-800" id="undo-modal-title">ç¢ºèªå¾©åŸæ“ä½œ</h3>
      </div>
      <div class="p-5 text-sm text-gray-700 bg-white">
        <div id="undo-modal-content"
          class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 text-xs font-mono shadow-inner">
        </div>
        <p class="mt-4 text-[11px] font-bold text-red-500 text-center bg-red-50 py-1.5 rounded-lg border border-red-100"
          id="undo-modal-warning">
          ğŸ‘‰ åŸ·è¡Œå¾Œï¼Œè³‡æ–™å°‡é€€å›åˆ°ä¿®æ”¹å‰çš„ç‹€æ…‹ï¼
        </p>
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closeUndoModal()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">å–æ¶ˆ</button>
        <button type="button" onclick="confirmExecuteUndo()"
          class="px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="undo-2" class="w-4 h-4"></i> ç¢ºèªå¾©åŸ
        </button>
      </div>
    </div>
  </div>

  <div id="instructions-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-lg p-0 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col border border-neutral-200">

      <div class="bg-neutral-50 px-6 py-4 border-b border-neutral-200 flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2 text-neutral-800">
          ğŸ“… ç³»çµ±ä½¿ç”¨æŒ‡å— (v1.12 æ­£å¼ç‰ˆ)
        </h3>
        <button onclick="closeInstructionsModal()"
          class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-200 rounded-full transition-all">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 text-sm text-neutral-700 leading-relaxed">

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
            é ‚éƒ¨å·¥å…·åˆ— (æ—¥æœŸèˆ‡ç®¡ç†)
          </h4>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
            <ul class="space-y-2 text-xs text-gray-700">
              <li class="flex items-start gap-2">
                <i data-lucide="calendar" class="w-3.5 h-3.5 mt-0.5 text-blue-500"></i>
                <span><b>æ—¥æœŸåˆ‡æ›ï¼š</b>é»æ“Šå·¦å³ç®­é ­ä¸­é–“çš„æ—¥æœŸå¯é¸èµ·å§‹æ—¥ï¼Œå·¦å³ç®­é ­åˆ‡æ›é€±æ¬¡ã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="calculator" class="w-3.5 h-3.5 mt-0.5 text-emerald-600"></i>
                <span><b>è–ªè³‡è©¦ç®—ï¼š</b>è¨ˆç®—æŒ‡å®šæ—¥æœŸç¯„åœå…§çš„ç¸½è–ªè³‡èˆ‡å ‚æ•¸ï¼Œæ”¯æ´åŒ¯å‡º Excelã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="sheet" class="w-3.5 h-3.5 mt-0.5 text-indigo-600"></i>
                <span><b>æ‰¹æ¬¡ç®¡ç†ï¼š</b>ä¸‹è¼‰æˆ–åŒ¯å…¥ Excelï¼Œå¯å¿«é€Ÿå¤§é‡ä¿®æ”¹ã€Œå›ºå®šèª²è¡¨ã€è¨­å®šã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="plus" class="w-3.5 h-3.5 mt-0.5 text-neutral-800"></i>
                <span><b>æ–°å¢èª²ç¨‹ï¼š</b>å»ºç«‹ä¸€å ‚æ–°çš„å›ºå®šèª²ç¨‹æˆ–å–®æ¬¡/è‡¨æ™‚èª²ç¨‹ã€‚</span>
              </li>
            </ul>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
            æ—¥å¸¸æ“ä½œ (é»åèˆ‡é–å®š)
          </h4>
          <div class="grid gap-3">
            <div class="bg-neutral-100 border-l-4 border-neutral-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-neutral-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="lock" class="w-3.5 h-3.5"></i> æ™ºæ…§é–å®šæ©Ÿåˆ¶ (New!)
              </h5>
              <p class="text-xs text-neutral-600">
                ç³»çµ±å°‡è‡ªå‹•é–å®š<b>ã€Œå‰å…©å€‹æœˆä»¥å‰ã€</b>çš„æ­·å²è³‡æ–™ã€‚è¢«é–å®šçš„å¡ç‰‡æœƒè®Šæ·¡ä¸”å‡ºç¾é–é ­ï¼Œç„¡æ³•å†é€²è¡Œé»åæˆ–ä¿®æ”¹ï¼Œç¢ºä¿è–ªè³‡çµç®—æ•¸æ“šä¸è¢«èª¤è§¸è·‘æ‰ã€‚
              </p>
              <p class="text-xs text-neutral-600">
                <b>è‹¥æœ‰ç‰¹æ®Šæ›´æ”¹éœ€æ±‚å¯èˆ‡ç®¡ç†è€…è¯çµ¡!</b>
              </p>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-blue-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="mouse-pointer-2" class="w-3.5 h-3.5"></i> é»æ“Šå¡ç‰‡å€å¡Š (é»å)
              </h5>
              <p class="text-xs text-blue-900/80">
                é»ä¸€ä¸‹åˆ‡æ›ç‹€æ…‹ï¼š
                <span class="font-bold text-green-700">ç¶ (ä¸Šèª²)</span> â†’
                <span class="font-bold text-amber-700">å’–(è«‹å‡)</span> â†’
                <span class="font-bold text-red-700">ç´…(æ› èª²)</span> â†’
                <span class="font-bold text-gray-500">ç°(æœªé»å)</span>ã€‚
              </p>
            </div>

            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-orange-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="edit-3" class="w-3.5 h-3.5"></i> å¡ç‰‡å³ä¸ŠæŒ‰éˆ• (æ»‘é¼ ç§»å…¥é¡¯ç¤º)
              </h5>
              <ul class="text-xs text-orange-900/80 list-disc pl-4 space-y-1">
                <li><b class="text-yellow-700">é»ƒè‰²è²¼ç´™ï¼š</b>è¨­å®šã€Œæ—¥æœŸå€é–“ã€å‚™è¨»ï¼Œå¯è‡ªå‹•åµæ¸¬é‡è¤‡å‚™è¨»ã€‚</li>
                <li><b class="text-blue-700">è—è‰²é‰›ç­†ï¼š</b>ä¿®æ”¹æœ¬å ‚èª²åœ¨è³‡æ–™åº«çš„å›ºå®šæ¯ç‰ˆè¨­å®šã€‚</li>
                <li><b class="text-gray-600">ç°è‰²è¤‡è£½ï¼š</b>å¿«é€Ÿè¤‡è£½è³‡æ–™æ’å…¥æŒ‡å®šæ—¥æœŸ (èª¿èª²ç¥å™¨)ã€‚</li>
                <li><b class="text-red-600">ç´…è‰²åƒåœ¾æ¡¶ï¼š</b>åˆªé™¤æ­¤èª²ç¨‹çš„æ‰€æœ‰å›ºå®šæ’ç¨‹ã€‚</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">3</span>
            å¯¦ç”¨å°èŠå£«ğŸ§€
          </h4>
          <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-3">
            <ul class="space-y-2 text-xs text-emerald-900">
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>è‡ªå‹•å°é½Šï¼š</b>æ‹–æ›³å¡ç‰‡å¯è‡ªè¨‚ç•¶æ—¥çš„é¡¯ç¤ºé †åºï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜æ†¶å¦³çš„ç¿’æ…£ã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>éš¨æ‰‹å‚™å¿˜éŒ„ï¼š</b>å´é‚Šæ¬„é»ƒè‰²ä¾¿æ¢ç´™æœƒéš¨æ‰“éš¨å­˜ï¼Œé©åˆç´€éŒ„ç‰¹æ®Šæ´»å‹•ç­‰ã€‚</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>èª¿èª²æœ€é€ŸæŠ€ï¼š</b>æŒ‰ä¸‹ã€Œè¤‡è£½(ç°)ã€æŒ‰éˆ• â†’ é¸å–ç›®æ¨™æ—¥æœŸ â†’ å­˜æª”å³å®Œæˆèª¿èª²ã€‚</span>
              </li>
            </ul>
          </div>
        </section>

        <section
          class="text-sm text-gray-400 px-4 space-y-1 bg-gray-50/50 py-3 rounded-lg border border-dashed border-gray-200">
          <p class="font-bold mb-1 text-gray-500">ç‰¹åˆ¥æé†’</p>
          <ul class="space-y-1.5 text-xs">
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>åˆæ¬¡ç™»å…¥è«‹å‹™å¿…æ›´æ”¹å¯†ç¢¼ä¸¦å¦¥å–„ä¿å­˜ï¼Œå¾Œå°åƒ…èƒ½å”åŠ©é‡è¨­ã€‚</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>è‹¥æœ‰ä»»ä½•åŠŸèƒ½å»ºè­°æˆ–éŒ¯èª¤å›å ±ï¼Œè«‹æˆªåœ–è¯ç¹« <b class="text-gray-500">é®ªé­šè€å¸«</b> :D</p>
            </li>
          </ul>
        </section>

        <section class="text-center pt-2">
          <button onclick="closeInstructionsModal()"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all active:scale-95 shadow-md">
            æˆ‘ç­è§£äº†
          </button>
        </section>
      </div>
    </div>
  </div>

  <div id="batch-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-md p-6 shadow-2xl border border-indigo-100">

      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2 text-indigo-800">
          <i data-lucide="sheet" class="w-5 h-5"></i> å›ºå®šèª²è¡¨æ‰¹æ¬¡ç®¡ç†
        </h3>
        <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="p-3 bg-indigo-50 rounded-lg text-xs text-indigo-900 leading-relaxed border border-indigo-100">
          <p class="font-bold mb-1">åŠŸèƒ½èªªæ˜ï¼š</p>
          <ul class="list-disc pl-4 space-y-1">
            <li>æ­¤åŠŸèƒ½ç”¨æ–¼ä¿®æ”¹<b>ã€Œå›ºå®šèª²è¡¨ã€</b>(å¦‚ï¼šæ¼²å­¸è²»ã€æ›æ•™å®¤ã€æ”¹é›»è©±)ã€‚</li>
            <li>Excel åŒ…å«æ‰€æœ‰æ¬„ä½ï¼šå§“åã€é›»è©±ã€é‡‘é¡ã€ç§‘ç›®ã€å‚™è¨»ç­‰ã€‚</li>
            <li>ä¸Šå‚³ä¿®æ”¹å¾Œçš„Excelå¾Œæœƒç›´æ¥è¦†è“‹ç¾æœ‰çš„å›ºå®šèª²è¡¨è¨­å®šã€‚</li>
          </ul>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="exportMasterData()"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="download" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">ä¸‹è¼‰èª²è¡¨ Excel</span>
          </button>

          <button
            onclick="const fileInput = document.getElementById('import-master-input'); fileInput.value = ''; fileInput.click();"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="upload" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">ä¸Šå‚³ä¿®æ”¹å¾Œçš„ Excel</span>
          </button>
        </div>

        <input type="file" id="import-master-input" accept=".xlsx, .xls" class="hidden"
          onchange="executeMasterCopyImport(this)" />
      </div>

    </div>
  </div>

  <div id="salary-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-2xl h-[85vh] p-6 shadow-2xl border border-emerald-100 flex flex-col">

      <div class="flex justify-between items-center mb-4 shrink-0">
        <h3 class="font-bold text-lg flex items-center gap-2 text-emerald-800">
          <i data-lucide="calculator" class="w-5 h-5"></i> è–ªè³‡çµç®—å ±å‘Š
        </h3>
        <button onclick="closeSalaryModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 shrink-0 bg-emerald-50/50 p-3 rounded-lg border border-emerald-100">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label>
          <input type="date" id="salary-start-date" onchange="autoUpdateEndDate(this.value)"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ—¥æœŸ</label>
          <input type="date" id="salary-end-date"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div class="flex items-end">
          <button onclick="calculateSalary()"
            class="w-full bg-emerald-600 text-white py-1.5 rounded-lg text-sm font-bold shadow hover:bg-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 h-[34px]">
            <i data-lucide="search" class="w-4 h-4"></i> é–‹å§‹è¨ˆç®—
          </button>
        </div>
      </div>

      <div id="salary-result" class="hidden flex flex-col flex-1 min-h-0 overflow-hidden">

        <div class="flex gap-4 mb-4 shrink-0">
          <div
            class="flex-1 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="absolute -right-4 -bottom-4 opacity-20"><i data-lucide="coins" class="w-24 h-24"></i></div>
            <p class="text-emerald-100 text-xs font-bold mb-1">é ä¼°ç¸½è–ªè³‡</p>
            <p class="text-3xl font-bold tracking-tight" id="total-salary">$0</p>
          </div>
          <div class="flex-1 bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-gray-500">ç¸½å ‚æ•¸</span>
              <span class="text-lg font-bold text-gray-800" id="total-count">0 å ‚</span>
            </div>
            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
              <div class="bg-emerald-500 h-full w-full"></div>
            </div>
            <div class="mt-2 text-[10px] text-gray-400">
              *åƒ…è¨ˆç®—ã€Œä¸Šèª²ã€èˆ‡ã€Œæ› èª²ã€
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto border border-gray-200 rounded-lg relative bg-white">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm select-none">
              <tr>
                <th onclick="sortSalary('date')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">æ—¥æœŸ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('name')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">å­¸ç”Ÿ/èª²ç¨‹ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('status')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">ç‹€æ…‹ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('amount')"
                  class="p-3 text-right bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center justify-end gap-1">é‡‘é¡ <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
              </tr>
            </thead>
            <tbody id="salary-list" class="divide-y divide-gray-100 text-gray-700">
            </tbody>
          </table>
        </div>

        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-3 shrink-0">

          <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg border border-emerald-100">
            <div class="flex flex-col">
              <span class="text-xs font-bold text-emerald-800">è–ªè³‡çµç®—ä¿®æ­£</span>
              <span class="text-[10px] text-emerald-600">åƒ…ä¿®æ”¹å°æ‡‰æ™‚é–“çš„ã€Œç‹€æ…‹ã€å‚™è¨»èˆ‡ç•¶æ—¥è–ªè³‡ã€ï¼Œä¸¦ä¸æœƒä¿®æ”¹åˆ°å…¶ä»–æ™‚é–“çš„èª²è¡¨ã€‚</span>
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-daily-input" accept=".xlsx, .xls" class="hidden"
                onchange="handleImportDaily(this)" />
              <button onclick="exportDailyReport()"
                class="bg-white text-emerald-700 border border-emerald-200 text-xs font-bold px-3 py-2 rounded hover:bg-emerald-100 transition-all flex items-center gap-1">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> åŒ¯å‡ºå ±è¡¨
              </button>
              <button onclick="document.getElementById('import-daily-input').click()"
                class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded shadow hover:bg-emerald-700 transition-all flex items-center gap-1">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> åŒ¯å…¥ä¿®æ­£
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="password-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[90%] max-w-xs p-6 shadow-2xl border border-neutral-200">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ”‘ ä¿®æ”¹ç™»å…¥å¯†ç¢¼</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-gray-400 mb-1">æ–°å¯†ç¢¼</label>
          <input type="password" id="new-password"
            class="w-full border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-neutral-800"
            placeholder="è‡³å°‘ 6 ä½æ•¸">
        </div>
        <button onclick="handleUpdatePassword()"
          class="w-full bg-neutral-800 text-white py-2 rounded-lg font-bold hover:bg-black transition-all active:scale-95 shadow-md text-sm">
          ç¢ºèªè®Šæ›´
        </button>
        <button onclick="closePasswordModal()"
          class="w-full text-gray-400 text-xs py-1 hover:text-gray-600 transition-colors">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <div id="remark-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1400] backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl w-80 shadow-2xl flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-yellow-100 flex justify-between items-center bg-yellow-50">
        <h3 class="font-bold text-yellow-800 flex items-center gap-2 m-0">
          <i data-lucide="sticky-note" class="w-5 h-5 text-yellow-600"></i> è¨­å®šå‚™è¨»
        </h3>
        <button onclick="closeRemarkModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="p-5 bg-white space-y-4 text-sm">
        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-inner">
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="remark-start-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">çµæŸæ—¥æœŸ</label>
            <input type="date" id="remark-end-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
        </div>
        <div>
          <textarea id="quick-remark-input"
            class="w-full bg-gray-50 focus:bg-white border border-gray-200 focus:border-yellow-400 rounded-xl p-3 text-sm outline-none resize-none text-neutral-700 shadow-inner transition-colors"
            rows="3" placeholder="ä¾‹å¦‚ï¼šè£œèª²ã€è«‹å‡..."></textarea>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between gap-2 items-center">
        <button onclick="saveQuickRemark(true)"
          class="p-2 bg-white text-red-500 border border-gray-200 hover:bg-red-50 hover:border-red-200 rounded-xl font-bold transition-all shadow-sm flex items-center justify-center group"
          title="æ¸…ç©ºæ­¤å€é–“çš„å‚™è¨»">
          <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
        </button>
        <div class="flex gap-2">
          <button onclick="closeRemarkModal()"
            class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">å–æ¶ˆ</button>
          <button onclick="saveQuickRemark(false)"
            class="px-5 py-2 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600 transition-all text-sm shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜
          </button>
        </div>
      </div>

    </div>
  </div>

  <div id="admin-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1500] backdrop-blur-sm">
    <div
      class="bg-white rounded-xl w-[95%] max-w-4xl h-[90vh] shadow-2xl flex flex-col border border-neutral-200 overflow-hidden">

      <div class="bg-neutral-800 text-white flex shrink-0">
        <div class="px-6 py-4 font-bold text-lg flex items-center gap-2 border-r border-neutral-700 min-w-[200px]">
          <i data-lucide="shield-alert" class="w-5 h-5"></i> ç®¡ç†æ§åˆ¶å°
        </div>
        <div class="flex flex-1 overflow-x-auto">
          <button onclick="switchAdminTab('directory')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-directory">
            <i data-lucide="contact" class="w-4 h-4"></i> é€šè¨ŠéŒ„
          </button>
          <button onclick="switchAdminTab('stats')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-stats">
            <i data-lucide="pie-chart" class="w-4 h-4"></i> çµ±è¨ˆå ±è¡¨
          </button>
          <button onclick="switchAdminTab('teachers')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-teachers">
            <i data-lucide="users" class="w-4 h-4"></i> è€å¸«ç®¡ç†
          </button>
          <button onclick="switchAdminTab('logs')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-logs">
            <i data-lucide="history" class="w-4 h-4"></i> æ“ä½œæ—¥èªŒ
          </button>
          <button onclick="switchAdminTab('admin-info')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-admin-info">
            <i data-lucide="info" class="w-4 h-4"></i> å¾Œå°æŒ‡å—
          </button>
        </div>
        <button onclick="closeAdminModal()"
          class="px-6 hover:bg-neutral-700 text-gray-400 hover:text-white transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="flex-1 bg-gray-50 overflow-hidden relative">

        <div id="tab-content-directory" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div class="flex justify-between items-center mb-4 shrink-0">
            <div class="relative w-72">
              <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
              <input type="text" id="dir-search" oninput="renderDirectory()" placeholder="æœå°‹å§“åã€é›»è©±..."
                class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-neutral-800">
            </div>
            <div class="text-xs text-gray-500">æç¤ºï¼šé»æ“Šä»»ä½•æ¬„ä½å³å¯è¤‡è£½</div>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('name')">
                    <div class="flex items-center gap-1">å­¸ç”Ÿå§“å <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('phone')">
                    <div class="flex items-center gap-1">é›»è©± <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('subject')">
                    <div class="flex items-center gap-1">ç§‘ç›® <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('teacher')">
                    <div class="flex items-center gap-1">è² è²¬è€å¸« <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                </tr>
              </thead>
              <tbody id="directory-list" class="divide-y divide-gray-100 text-neutral-700"></tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-stats" class="admin-tab-content w-full h-full flex flex-col p-6 hidden overflow-y-auto">
          <div
            class="flex flex-wrap items-end gap-3 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm shrink-0">

            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1">1. é¸æ“‡è€å¸«</label>
              <select id="stat-teacher" onchange="updateStudentList()"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none bg-white min-w-[120px] focus:ring-2 focus:ring-neutral-800">
                <option value="all">ALL</option>
              </select>
            </div>

            <div class="flex-1 min-w-[180px] relative group">
              <label class="block text-xs font-bold text-gray-500 mb-1">2. æœå°‹å­¸ç”Ÿ</label>

              <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                <input type="text" id="stat-student" placeholder="è¼¸å…¥å§“åæœå°‹..."
                  class="w-full border border-gray-300 rounded-lg pl-9 pr-8 py-1.5 text-sm outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800 transition-all"
                  oninput="filterStudentList(this.value)" onfocus="showStudentList()" autocomplete="off">

                <button id="clear-student-btn" onclick="clearStudentSearch()"
                  class="hidden absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                  <i data-lucide="x-circle" class="w-4 h-4"></i>
                </button>
              </div>

              <ul id="student-dropdown-list"
                class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto divide-y divide-gray-50">
                <li class="p-3 text-sm text-gray-400 text-center">è«‹å…ˆé¸æ“‡è€å¸«...</li>
              </ul>
            </div>

            <div><label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date"
                id="stat-start" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ—¥æœŸ</label><input type="date" id="stat-end"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>

            <button onclick="calculateStats()"
              class="bg-neutral-800 text-white px-5 py-1.5 rounded-lg text-sm font-bold hover:bg-black transition-all shadow-md h-[34px] flex items-center">
              <i data-lucide="search" class="w-3.5 h-3.5 mr-1"></i> æŸ¥è©¢
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center min-h-[300px]">
              <h4 class="font-bold text-gray-700 mb-6 flex items-center gap-2"><i data-lucide="pie-chart"
                  class="w-4 h-4"></i> æ•´é«”ç‹€æ…‹åˆ†ä½ˆ</h4>
              <div id="stat-pie-chart" class="w-48 h-48 rounded-full shadow-inner relative"
                style="background: conic-gradient(#d1d5db 0% 100%);">
                <div
                  class="absolute inset-0 m-auto w-24 h-24 bg-white rounded-full flex items-center justify-center flex-col">
                  <span id="stat-total-lessons" class="text-xl font-bold text-neutral-800">0</span><span
                    class="text-[10px] text-gray-400">ç¸½å ‚æ•¸</span>
                </div>
              </div>
              <div class="mt-6 flex flex-wrap gap-4 justify-center text-xs font-bold">
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-green-500"></span> ä¸Šèª² <span
                    id="label-present">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-amber-400"></span> è«‹å‡ <span
                    id="label-leave">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-red-500"></span> æ› èª² <span
                    id="label-absent">0%</span></div>
                <div class="flex items-center gap-1.5">
                  <span class="w-3 h-3 rounded-full bg-gray-300"></span> å°šæœªé»å <span id="label-pending">0%</span>
                </div>
              </div>
            </div>
            <div class="bg-white p-0 rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col">
              <div class="p-4 bg-gray-50 border-b border-gray-200 font-bold text-gray-700">è©³ç´°æ•¸æ“š</div>
              <div class="flex-1 overflow-y-auto p-4 space-y-3" id="stat-details">
                <p class="text-center text-gray-400 text-sm py-10">è«‹é¸æ“‡æ—¥æœŸä¸¦é–‹å§‹åˆ†æ...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-content-teachers" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div class="flex gap-2 mb-4 shrink-0 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
            <input type="text" id="new-teacher-name" placeholder="è¼¸å…¥æ–°è€å¸«å§“å..."
              class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-100" />
            <button onclick="addTeacher()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition-all flex items-center gap-1">
              <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢è€å¸«
            </button>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm p-4">
            <div id="teacher-manage-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
          </div>
        </div>

        <div id="tab-content-logs" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div
            class="flex justify-between items-center mb-4 shrink-0 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">

            <div class="flex flex-col gap-1">
              <h3 class="font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i> ç³»çµ±æ“ä½œè»Œè·¡
              </h3>
              <div
                class="flex items-center gap-1.5 text-[10px] text-amber-600 bg-amber-50 px-2 py-0.5 rounded-md border border-amber-100 w-fit">
                <i data-lucide="clock" class="w-3 h-3"></i>
                <span class="font-bold">ç³»çµ±ç¶­è­·ï¼šåƒ…æœƒä¿ç•™è¿‘ 3 å€‹æœˆç´€éŒ„</span>
              </div>
            </div>

            <button onclick="loadLogs()"
              class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition-colors flex items-center gap-1">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> é‡æ–°æ•´ç†
            </button>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 whitespace-nowrap">æ™‚é–“</th>
                  <th class="p-4 whitespace-nowrap">æ“ä½œäººå“¡</th>
                  <th class="p-4 whitespace-nowrap">å‹•ä½œ</th>
                  <th class="p-4 min-w-[250px]">è©³ç´°å…§å®¹</th>
                  <th class="p-4 whitespace-nowrap text-center">å¾©åŸ</th>
                </tr>
              </thead>
              <tbody id="logs-list" class="divide-y divide-gray-100 text-neutral-700">
              </tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-admin-info"
          class="admin-tab-content w-full h-full flex flex-col p-8 hidden overflow-y-auto bg-[#fbfbfa]">
          <div class="max-w-2xl mx-auto w-full space-y-10">

            <div class="flex flex-col items-center">
              <div
                class="px-3 py-1 bg-neutral-800 text-white text-[10px] font-bold rounded-full mb-3 tracking-widest uppercase">
                Admin Terminal
              </div>
              <h3 class="text-2xl font-bold text-neutral-800 tracking-tighter">ç®¡ç†è€…æ ¸å¿ƒæ“ä½œæ‰‹å†Š</h3>
              <p class="text-neutral-400 text-xs mt-2 font-medium">é‡å°å¾Œå°é€²éšåŠŸèƒ½çš„æ“ä½œèªªæ˜èˆ‡ç¶­è­·å»ºè­°ã€‚</p>
            </div>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">1</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">æ•¸æ“šè³‡ç”¢ç›£æ§</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-blue-400 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-blue-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">é€šè¨ŠéŒ„ç®¡ç†</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">æ•´åˆæ‰€æœ‰ç­ç´šå­¸ç”Ÿçš„è¯ç¹«é›»è©±ã€‚é»æ“Šè™Ÿç¢¼å€å¡Šå³å¯è¤‡è£½è‡³å‰ªè²¼ç°¿ï¼Œçœå»æ‰‹å‹•è¼¸å…¥çš„æ™‚é–“ã€‚</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-emerald-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">çµ±è¨ˆå ±è¡¨ (å°å¸³æ ¸å°)</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">è¿½è¹¤å­¸ç”Ÿå‡ºå¸­ç‡èˆ‡å ‚æ•¸ã€‚é©åˆåœ¨æœˆåº•é€²è¡Œæ•™å­¸é€²åº¦æ ¸å°ï¼Œæˆ–ä½œç‚ºè–ªè³‡ç™¼æ”¾çš„åƒè€ƒæ•¸æ“šã€‚</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">2</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">äººäº‹æ¬Šé™ç®¡ç†</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-yellow-500 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-blue-600 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">å¸«è³‡åå–®ç•°å‹•</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">æ”¯æ´ä¿®æ”¹é¡¯ç¤ºå§“åã€‚è‹¥è€å¸«é›¢è·ï¼Œè«‹åœ¨æ­¤åŸ·è¡Œåˆªé™¤ï¼Œç¢ºä¿ç³»çµ±åå–®çš„å³æ™‚æ€§ã€‚</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-yellow-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">å´é‚Šæ¬„å¯è¦‹æ¬Šé™</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">é»æ“Šè€å¸«æ—çš„ã€Œçœ¼ç›åœ–ç¤ºã€ï¼Œå¯è¨­å®šè©²è€å¸«ç™»å…¥å¾Œå…è¨±æŸ¥é–±çš„å°è±¡ï¼Œç¶­æŒå´é‚Šæ¬„ç°¡æ½”ã€‚</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="group">
              <div class="flex items-center gap-3 mb-4">
                <span
                  class="w-8 h-8 rounded-lg bg-neutral-900 text-white flex items-center justify-center font-mono text-sm shadow-lg">3</span>
                <h4 class="font-bold text-neutral-800 text-lg tracking-tight">å®‰å…¨èˆ‡è‡ªå‹•åŒ–ç¶­è­·</h4>
              </div>
              <div
                class="bg-white border border-neutral-200 rounded-2xl p-6 shadow-sm group-hover:border-amber-600 transition-all">
                <div class="space-y-6">
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-amber-500 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">æ“ä½œè»Œè·¡èˆ‡å¾©åŸ</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">ç´€éŒ„æ‰€æœ‰é»åèˆ‡ä¿®æ”¹å‹•ä½œã€‚è‹¥ç™¼ç”Ÿèª¤æ“ä½œï¼Œå¯è‡³æ—¥èªŒåˆ†é é»æ“Šã€Œå¾©åŸã€æŒ‰éˆ•æ’¤éŠ·è©²æ¬¡æ›´å‹•ã€‚</p>
                    </div>
                  </div>
                  <div class="flex gap-4">
                    <div class="w-1 h-auto bg-neutral-300 rounded-full"></div>
                    <div>
                      <p class="text-sm font-bold text-neutral-800 mb-1">è‡ªå‹•æ¸…ç†æ©Ÿåˆ¶</p>
                      <p class="text-xs text-neutral-500 leading-relaxed">ç³»çµ±æ¯æ—¥å‡Œæ™¨å°‡è‡ªå‹•åŸ·è¡Œç¶­è­·ï¼Œåƒ…ä¿ç•™è¿‘ 3 å€‹æœˆä¹‹æ—¥èªŒç´€éŒ„ï¼Œä»¥ç¶­æŒæ•¸æ“šè¼‰å…¥æ•ˆç‡ã€‚</p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="bg-emerald-50 border border-emerald-100 rounded-2xl p-6">
              <h4 class="font-bold text-emerald-800 text-sm mb-3 flex items-center gap-2">
                <i data-lucide="zap" class="w-4 h-4 fill-emerald-500"></i> ç®¡ç†è€…å°ˆå±¬èŠå£« ğŸ§€
              </h4>
              <ul class="text-[11px] text-emerald-900/70 space-y-2 leading-relaxed">
                <li class="flex gap-2"><span>â€¢</span> <span><b>æ‰¹é‡æ›´æ–°ï¼š</b>ä¿®æ”¹å¤§é‡å­¸è²»é‡‘é¡æˆ–æ•™å®¤æ™‚ï¼Œç›´æ¥ç”¨ã€Œæ‰¹æ¬¡ç®¡ç†ã€åŒ¯å‡º Excel æ”¹æœ€å¿«ã€‚</span></li>
                <li class="flex gap-2"><span>â€¢</span> <span><b>æ™ºæ…§é–å®šï¼š</b>ç³»çµ±æœƒè‡ªå‹•ä¿è­·å‰å…©å€‹æœˆè³‡æ–™ï¼Œè‹¥éœ€æ›´å‹•èˆŠç´€éŒ„ï¼Œè«‹ç¢ºä¿ä»¥ç®¡ç†å“¡èº«åˆ†æ“ä½œã€‚</span></li>
              </ul>
            </section>

            <section class="text-xs text-gray-400 px-5 py-4 bg-white rounded-xl border border-dashed border-gray-300">
              <div class="flex items-center gap-2 mb-3 text-neutral-500 font-bold">
                <i data-lucide="shield-alert" class="w-4 h-4"></i>
                <span>é–‹ç™¼è€…å®‰å…¨é ˆçŸ¥</span>
              </div>
              <ul class="space-y-3 text-[11px] leading-relaxed">
                <li class="flex gap-2">
                  <span class="text-neutral-400 font-bold">â€¢</span>
                  <span>ä¿®æ”¹èª²ç¨‹æ¯ç‰ˆå‰ï¼Œå»ºè­°å…ˆæ ¸å°ã€Œè–ªè³‡çµç®—ã€åˆ†é æ˜¯å¦æœ‰å°šæœªè™•ç†çš„é‡‘é¡ä¿®æ­£ï¼Œé¿å…æœªä¾†é€£å‹•è¨ˆç®—ç”¢ç”Ÿæ•¸æ“šè½å·®ã€‚</span>
                </li>
                <li class="flex gap-2">
                  <span class="text-neutral-400 font-bold">â€¢</span>
                  <p>æœ¬ç³»çµ±ç”± <i class="text-slate-500 font-bold not-italic">@CCY</i> å°ˆå±¬é–‹ç™¼ä¸¦æˆäºˆä½¿ç”¨æ¬Šäºˆ <span
                      class="text-neutral-500 font-bold">å¹•å°¼å…‹éŸ³æ¨‚(é‡‘å±±æ ¡å€)</span>ï¼Œé–‹ç™¼è€…ä»ä¿ç•™ç³»çµ±åº•å±¤é‚è¼¯èˆ‡æ•¸æ“šæ¶æ§‹ä¹‹æœ€çµ‚è§£é‡‹æ¬Šã€‚</p>
                </li>
              </ul>
            </section>

            <div class="pt-4 text-center">
              <div
                class="inline-flex items-center gap-2 px-4 py-1.5 bg-white border border-neutral-200 rounded-xl shadow-sm">
                <span class="text-[10px] text-neutral-400 font-mono italic">Powered by</span>
                <span class="text-xs font-bold italic text-slate-500 tracking-widest">@CCY DEV</span>
              </div>
            </div>

          </div>
        </div>

        <div id="sys-dialog-modal"
          class="hidden fixed inset-0 bg-black/40 z-[3000] flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
          <div
            class="bg-white rounded-xl shadow-2xl w-[85%] max-w-sm overflow-hidden flex flex-col transform scale-95 transition-transform duration-200"
            id="sys-dialog-box">
            <div class="p-6">
              <h3 class="font-bold text-gray-900 text-lg mb-2 flex items-center gap-2" id="sys-dialog-title">æç¤º</h3>
              <p class="text-sm text-gray-600 leading-relaxed" id="sys-dialog-msg">å…§å®¹</p>
            </div>
            <div class="px-5 py-3 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
              <button id="sys-dialog-cancel" onclick="closeSysDialog()"
                class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-800 rounded-lg transition-colors">å–æ¶ˆ</button>
              <button id="sys-dialog-confirm" onclick="execSysDialog()"
                class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95">ç¢ºå®š</button>
            </div>
          </div>
        </div>

        <script>
          const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co";
          const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP";
          const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

          // â˜… å…¨åŸŸè®Šæ•¸ï¼šå­˜ç›®å‰ç™»å…¥è€…æ˜¯èª° â˜…
          let currentUserInfo = null;

          let currentTid = null;
          let editingId = null;
          let editingCurrentStatus = null;
          let editingDateStr = null;
          // --- æ–°å¢å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†æš«å­˜è³‡æ–™èˆ‡æ’åº ---
          let _cachedSchedule = []; // æš«å­˜èª²è¡¨è³‡æ–™
          let _cachedRecords = [];  // æš«å­˜ç´€éŒ„è³‡æ–™
          let _userSortOrder = [];  // è¨˜ä½ä½¿ç”¨è€…æ’å¥½çš„å¡ç‰‡é †åº (å­˜ ID)

          // --- ä½¿ç”¨èªªæ˜å½ˆçª—æ§åˆ¶ ---
          function openInstructionsModal() {
            // é–‹å•Ÿæ™‚è‡ªå‹•æ”¶èµ·æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„
            if (window.innerWidth < 768) {
              toggleSidebar();
            }
            document.getElementById("instructions-modal").classList.remove("hidden");
          }

          function closeInstructionsModal() {
            document.getElementById("instructions-modal").classList.add("hidden");
          }

          // --- æ‹–æ›³æ’åºåŠŸèƒ½æ ¸å¿ƒ (çµ²æ»‘å‹•ç•«ç‰ˆ) ---
          // 1. é–‹å§‹æ‹–æ›³
          function handleDragStart(e, id) {
            e.dataTransfer.setData("text/plain", id);
            e.dataTransfer.effectAllowed = "move";
            e.target.style.opacity = '0.4';

            // â˜… é—œéµæ–°å¢ï¼šå‘Šè¨´æ•´å€‹ç¶²é ã€Œç¾åœ¨é€²å…¥æ‹–æ›³æ¨¡å¼äº†ï¼ã€è§¸ç™¼ CSS å¹½éˆç‹€æ…‹
            document.body.classList.add('is-dragging');
          }

          // 2. æ‹–æ›³çµæŸ
          function handleDragEnd(e) {
            e.target.style.opacity = '1';

            // â˜… é—œéµæ–°å¢ï¼šè§£é™¤æ‹–æ›³æ¨¡å¼ï¼ŒæŒ‰éˆ•èˆ‡æ–‡å­—æ¢å¾©æ­£å¸¸
            document.body.classList.remove('is-dragging');

            // ç¢ºä¿æ¸…é™¤æ‰€æœ‰æ®˜ç•™çš„æ‹–æ›³æç¤ºæ¨£å¼
            document.querySelectorAll('.schedule-card').forEach(c => {
              c.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'opacity-60', 'z-50');
            });
          }

          function handleDrop(e, targetId) {
            e.preventDefault();
            e.stopPropagation();

            const sourceId = String(e.dataTransfer.getData("text/plain"));
            const tId = String(targetId);

            if (sourceId === tId) return;

            const fromIndex = _userSortOrder.indexOf(sourceId);
            const toIndex = _userSortOrder.indexOf(tId);

            if (fromIndex > -1 && toIndex > -1) {
              _userSortOrder.splice(fromIndex, 1);
              _userSortOrder.splice(toIndex, 0, sourceId);

              // èƒŒæ™¯å„²å­˜è³‡æ–™åº« (ä¸å¡ä½ç•«é¢å‹•ç•«)
              if (currentTid) {
                const orderStr = _userSortOrder.join(',');
                localStorage.setItem(`sort_order_${currentTid}`, orderStr);
                _client.from("teachers").update({ card_order: orderStr }).eq("id", currentTid)
                  .then(({ error }) => {
                    if (!error) setStatus("é †åºå·²æ°¸ä¹…å„²å­˜", "success");
                  });
                const t = allTeachers.find(t => t.id === currentTid);
                if (t) t.card_order = orderStr;
              }

              // â˜… å‹•ç•« Step 1: ç´€éŒ„é‡ç¹ªå‰çš„ã€ŒèˆŠä½ç½®ã€
              const oldPositions = new Map();
              document.querySelectorAll('.schedule-card').forEach(card => {
                oldPositions.set(card.dataset.id, card.getBoundingClientRect());
              });

              // é‡æ–°ç¹ªè£½æ–°é †åºçš„å¡ç‰‡
              renderSchedule(_cachedSchedule, _cachedRecords);

              // â˜… å‹•ç•« Step 2: è¨ˆç®—ä½ç§»ï¼Œæ’­æ”¾æ»‘å‹•èˆ‡ç¶ è‰²ç™¼å…‰ç‰¹æ•ˆ
              requestAnimationFrame(() => {
                document.querySelectorAll('.schedule-card').forEach(card => {
                  const id = card.dataset.id;

                  // 1. æ»‘å‹•å‹•ç•« (FLIP)
                  if (oldPositions.has(id)) {
                    const oldPos = oldPositions.get(id);
                    const newPos = card.getBoundingClientRect();
                    const dx = oldPos.left - newPos.left;
                    const dy = oldPos.top - newPos.top;

                    if (dx !== 0 || dy !== 0) {
                      card.style.transition = 'none';
                      card.style.transform = `translate(${dx}px, ${dy}px)`;
                      card.style.zIndex = '100'; // å‹•ç•«æœŸé–“æ‹‰åˆ°æœ€ä¸Šå±¤

                      requestAnimationFrame(() => {
                        card.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                        card.style.transform = 'translate(0, 0)';
                        setTimeout(() => {
                          card.style.transition = '';
                          card.style.transform = '';
                          card.style.zIndex = '';
                        }, 400);
                      });
                    }
                  }
                });
              });
            }
          }

          // --- ç©æœ¨ä¸€ï¼šæ—¥æœŸæ§åˆ¶æ ¸å¿ƒ ---
          // 1. è¨­å®šç›®å‰é¸æ“‡çš„æ—¥æœŸ (é è¨­ä»Šå¤©)
          let currentBaseDate = new Date();

          // 2. å·¥å…·ï¼šå–å¾—æœ¬é€±ä¸€çš„æ—¥æœŸ (é€™æ¨£æˆ‘å€‘æ‰çŸ¥é“é€™é€±æ˜¯å¾å“ªå¤©é–‹å§‹)
          function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
              diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
          }

          // 3. å·¥å…·ï¼šåŠ æ¸›å¤©æ•¸ (ç”¨ä¾†åˆ‡æ›ä¸Šä¸€é€±ã€ä¸‹ä¸€é€±)
          function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
          }

          // 4. å·¥å…·ï¼šæŠŠæ—¥æœŸè®Šå­—ä¸² (ä¿®æ­£ç‰ˆï¼šä½¿ç”¨ç•¶åœ°æ™‚é–“ï¼Œè§£æ±ºæ—©æ™¨æ—¥æœŸè·‘æ‰çš„å•é¡Œ)
          function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          }

          // 5. åˆ‡æ›é€±æ¬¡çš„åŠŸèƒ½
          function changeWeek(direction) {
            // direction: -1 ä»£è¡¨ä¸Šä¸€é€±ï¼Œ 1 ä»£è¡¨ä¸‹ä¸€é€±
            currentBaseDate = addDays(currentBaseDate, direction * 7);

            // åˆ‡æ›å¾Œï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ (é€™æ¨£ç•«é¢æ‰æœƒè®Š)
            refreshData();
          }

          // 1. è™•ç†æ—¥æ›†é¸æ“‡ (æ»¾å‹•å¼ï¼šé¸å“ªå¤©ï¼Œå“ªå¤©å°±æ˜¯èµ·é»)
          function handleDatePick(val) {
            if (!val) return;
            // ç›´æ¥æŠŠ currentBaseDate è¨­ç‚ºä½¿ç”¨è€…é¸çš„é‚£ä¸€å¤© (ä¸æ‰¾ç¦®æ‹œä¸€äº†)
            currentBaseDate = new Date(val);
            refreshData();
          }

          // â–¼ é—œéµä¿®æ­£ 1ï¼šå®£å‘Šå…¨åŸŸè®Šæ•¸ä¾†å­˜è€å¸«è³‡æ–™ â–¼
          let allTeachers = [];
          let memoTimeout = null;

          window.onload = async () => {
            // A. æª¢æŸ¥ç™»å…¥
            const { data: { session } } = await _client.auth.getSession();
            if (!session) {
              window.location.href = "login.html";
              return;
            }

            // B. æŠ“è³‡æ–™ (é€™è£¡æœƒä¸€è·¯ç­‰å¾…èª²è¡¨ç•«å®Œ)
            await fetchUserProfile(session.user.email);
            await fetchTeachers();
            enableAutomation(); // å•Ÿå‹•è‡ªå‹•åŒ–å¼•æ“

            // C. åœ–ç¤ºæ¸²æŸ“
            lucide.createIcons();

            // â˜…â˜…â˜… çµ‚æ¥µä¿®æ­£ï¼šçµ¦ç€è¦½å™¨ 100ms çš„ç·©è¡æ™‚é–“ä¾†ã€Œåˆ·æ²¹æ¼†ã€ â˜…â˜…â˜…
            setTimeout(() => {
              document.body.classList.add("page-ready");
            }, 550);
          };

          // --- çµ‚æ¥µæ‰‹æ©Ÿç‰ˆï¼šGPU åŠ é€Ÿ + é›¶æ¼‚ç§» ç¸®æ”¾å¼•æ“ ---
          let currentScale = 1;
          let startScale = 1;
          let startDist = 0;
          let startTouchX = 0;
          let startTouchY = 0;
          let startScrollX = 0;
          let startScrollY = 0;
          let isPinching = false;
          let ticking = false;

          const wrapper = document.getElementById('schedule-wrapper');
          const container = document.getElementById('schedule-container');

          if (wrapper) wrapper.style.backgroundColor = '#ffffff';

          if (wrapper && container) {
            wrapper.addEventListener('touchstart', (e) => {
              if (e.touches.length === 2) {
                isPinching = true;
                // æš«æ™‚é—œé–‰ Body å‹•ç•«ï¼Œæå‡æ•ˆèƒ½
                document.body.classList.add('is-pinching');

                const rect = wrapper.getBoundingClientRect();
                // 1. ç´€éŒ„è§¸ç¢°ç¬é–“çš„åŸå§‹åº§æ¨™èˆ‡æ²å‹•ä½ç½® (å”¯è®€ä¸€æ¬¡)
                startScrollX = wrapper.scrollLeft;
                startScrollY = wrapper.scrollTop;

                startDist = Math.hypot(
                  e.touches[0].clientX - e.touches[1].clientX,
                  e.touches[0].clientY - e.touches[1].clientY
                );

                startTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                startTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                startScale = currentScale;
              }
            }, { passive: false });

            wrapper.addEventListener('touchmove', (e) => {
              if (isPinching && e.touches.length === 2) {
                e.preventDefault();
                if (ticking) return;
                ticking = true;

                window.requestAnimationFrame(() => {
                  const currentDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                  );

                  // 2. è¨ˆç®—æ–°ç¸®æ”¾å€ç‡ (0.3 ~ 2.0)
                  let newScale = startScale * (currentDist / startDist);
                  newScale = Math.min(Math.max(newScale, 0.3), 2.0);

                  if (newScale !== currentScale) {
                    const rect = wrapper.getBoundingClientRect();
                    const currentTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                    const currentTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;

                    // 3. â˜… æ ¸å¿ƒé­”æ³•ï¼šGPU ç¸®æ”¾èˆ‡å®¹å™¨è£œå„Ÿ â˜…
                    container.style.transform = `scale(${newScale})`;

                    // è£œå„Ÿå®¹å™¨å¤§å°ï¼Œç¢ºä¿ sticky å…ƒç´ ä¸äº‚é£„
                    container.style.width = `${100 / newScale}%`;
                    container.style.height = `${100 / newScale}%`;

                    // 4. æ²å‹•ä½ç½®æ•¸å­¸è£œå„Ÿ (è®“ç¸®æ”¾ä¸­å¿ƒè·Ÿéš¨æ‰‹æŒ‡)
                    const ratio = newScale / startScale;
                    wrapper.scrollLeft = (startScrollX + startTouchX) * ratio - currentTouchX;
                    wrapper.scrollTop = (startScrollY + startTouchY) * ratio - currentTouchY;

                    currentScale = newScale;
                  }
                  ticking = false;
                });
              }
            }, { passive: false });

            const stopPinching = (e) => {
              if (e.touches.length < 2) {
                isPinching = false;
                startDist = 0;
                ticking = false;
                document.body.classList.remove('is-pinching');
              }
            };

            wrapper.addEventListener('touchend', stopPinching);
            wrapper.addEventListener('touchcancel', stopPinching);
          }

          // 1. ç™»å…¥æª¢æŸ¥èˆ‡ç¨±è™Ÿé¡¯ç¤ºå„ªåŒ– (Ccy å°ˆå±¬ç¨±è™Ÿ + è€å¸«é¡¯ç¤º Email)
          async function fetchUserProfile(email) {
            const { data, error } = await _client.from("teachers").select("*").eq("email", email).maybeSingle();

            if (error || !data) {
              await sysAlert("éŒ¯èª¤ï¼šæ‚¨çš„å¸³è™Ÿæœªç¶å®šæ•™å¸«è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ï¼", "ç™»å…¥å¤±æ•—");
              await _client.auth.signOut();
              window.location.href = "login.html";
              return;
            }

            currentUserInfo = data;
            const initialEl = document.getElementById("current-user-initial");
            const nameEl = document.getElementById("current-user-name");
            const roleEl = document.getElementById("current-user-role");

            if (initialEl && nameEl && roleEl) {
              initialEl.textContent = data.name.charAt(0);
              nameEl.textContent = data.name;

              if (data.is_admin) {
                // å¦‚æœæ˜¯ Ccy ä¸”ç‚ºç®¡ç†å“¡ï¼Œé¡¯ç¤ºã€Œç³»çµ±é–‹ç™¼è€…ã€
                const isDev = data.name === "Ccy";
                const roleTitle = isDev ? "ç³»çµ±é–‹ç™¼è€…" : "ç³»çµ±ç®¡ç†å“¡";
                const roleIcon = isDev ? "code" : "shield-alert";

                roleEl.innerHTML = `<i data-lucide="${roleIcon}" class="w-3 h-3 text-amber-500"></i> ${roleTitle}`;
                roleEl.classList.add("text-amber-600");
              } else {
                // â˜… é—œéµä¿®æ”¹ï¼šå°‡ä¸€èˆ¬çš„ã€Œæˆèª²æ•™å¸«ã€æ”¹æˆé¡¯ç¤ºä½¿ç”¨è€…çš„ Email
                // ä¸¦æŠŠåœ–ç¤ºæ›æˆä¿¡å° (mail)
                roleEl.innerHTML = `<i data-lucide="mail" class="w-3 h-3"></i> ${data.email}`;
                roleEl.classList.remove("text-amber-600");
              }

              // é‡æ–°æ¸²æŸ“åœ–ç¤º
              lucide.createIcons();
            }
          }

          // 2. å„²å­˜æ¬Šé™é˜²å‘†
          async function savePermissions() {
            const checkboxes = document.querySelectorAll('#perm-checkbox-list input[type="checkbox"]:checked:not(:disabled)');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            if (!selectedIds.includes(String(editingPermTeacherId))) {
              selectedIds.push(String(editingPermTeacherId));
            }
            const idsString = selectedIds.join(',');
            const res = await _client.from('teachers').update({ viewable_teachers: idsString }).eq('id', editingPermTeacherId);

            if (res.error) {
              await sysAlert('å„²å­˜å¤±æ•—ï¼š' + res.error.message, "ç³»çµ±éŒ¯èª¤");
            } else {
              const t = allTeachers.find(t => t.id === editingPermTeacherId);
              if (t) t.viewable_teachers = idsString;
              setStatus('æ¬Šé™åå–®å·²æˆåŠŸå„²å­˜ï¼', 'success');
              closePermissionsModal();
            }
          }

          // ç™»å‡ºå‡½å¼
          async function handleLogout() {
            if (!(await sysConfirm("æ‚¨ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ", "ç™»å‡ºç¢ºèª", "info"))) return;
            await _client.auth.signOut();
            window.location.href = "login.html";
          }

          // 2. ç²å–è€å¸«åˆ—è¡¨ (åŒæ­¥ä¿®å¾©ä¸‹æ‹‰é¸å–®ç‰ˆ)
          async function fetchTeachers() {
            setStatus("æ­£åœ¨åŒæ­¥æœ€æ–°å‹•æ…‹...", "loading");
            try {
              const { data: teachers, error: tErr } = await _client.from("teachers").select("*").order("created_at");
              if (tErr) throw tErr;

              allTeachers = teachers;
              const menu = document.getElementById("teacher-menu");
              if (!menu) return;
              menu.innerHTML = "";

              // â˜… é—œéµä¿®æ­£ï¼šåŒæ™‚å¡«å¯«ã€Œæ–°å¢èª²ç¨‹ã€å½ˆçª—è£¡çš„è€å¸«é¸å–® â˜…
              const teacherSelect = document.querySelector('select[name="teacher_id"]');
              if (teacherSelect) teacherSelect.innerHTML = "";

              function getRelativeTime(dateStr) {
                if (!dateStr) return "ç„¡ç´€éŒ„";
                const now = new Date(); const past = new Date(dateStr);
                const diffMins = Math.floor((now - past) / (1000 * 60));
                if (diffMins < 1) return "å‰›å‰›";
                if (diffMins < 60) return `${diffMins} åˆ†é˜å‰`;
                if (diffMins < 1440) return `${Math.floor(diffMins / 60)} å°æ™‚å‰`;
                return `${Math.floor(diffMins / 1440)} å¤©å‰`;
              }

              const viewableIds = currentUserInfo.viewable_teachers ? currentUserInfo.viewable_teachers.split(',') : [];
              const visibleTeachers = teachers.filter(t => {
                if (t.is_hidden) return false;
                if (currentUserInfo.is_admin) return true;
                return String(t.id) === String(currentUserInfo.id) || viewableIds.includes(String(t.id));
              });

              visibleTeachers.forEach((t, index) => {
                const btn = document.createElement("button");
                btn.dataset.id = t.id;
                const isActive = String(currentTid) === String(t.id);
                btn.className = `teacher-item w-full flex items-center gap-2 py-2.5 px-2 rounded-lg text-left transition-all duration-200 ${isActive ? "active bg-blue-50 text-blue-700 ring-1 ring-blue-100" : "hover:bg-gray-50 text-neutral-700"}`;
                btn.onclick = () => switchTeacher(t.id, t.name);

                btn.innerHTML = `
              <div class="w-9 h-9 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 border transition-colors ${isActive ? "bg-blue-600 text-white border-blue-600" : "bg-gray-100 text-gray-500 border-gray-200"}">${t.name.charAt(0)}</div>
              <div class="flex flex-col min-w-0">
                <span class="font-bold text-sm truncate">${t.name}</span>
                <span class="text-[10px] leading-tight mt-0.5 flex items-center gap-1 ${isActive ? "text-blue-500" : "text-gray-400"}">
                  <span class="w-1.5 h-1.5 rounded-full ${isActive ? "bg-blue-500 animate-pulse" : "bg-green-400"}"></span>
                  ${getRelativeTime(t.updated_at || t.created_at)}ç·¨è¼¯
                </span>
              </div>
          `;
                menu.appendChild(btn);

                // â˜… åŒæ­¥å¡«å¯«é¸å–® â˜…
                if (teacherSelect) {
                  const opt = document.createElement("option");
                  opt.value = t.id; opt.textContent = t.name;
                  if (String(t.id) === String(currentTid)) opt.selected = true;
                  teacherSelect.appendChild(opt);
                }
                if (!currentTid && index === 0) switchTeacher(t.id, t.name);
              });

              const adminEntryBtn = document.getElementById("admin-entry-btn");
              if (adminEntryBtn && currentUserInfo) adminEntryBtn.classList.toggle("hidden", !currentUserInfo.is_admin);

              lucide.createIcons();
              setStatus("è³‡æ–™åº«é€£ç·šï¼šé€£ç·šæˆåŠŸ", "success");
            } catch (err) { setStatus("è³‡æ–™åº«é€£ç·šï¼šè¼‰å…¥å¤±æ•—", "error"); }
          }

          // â˜… å…¨è‡ªå‹•åŒ–æ ¸å¿ƒé‚è¼¯
          function enableAutomation() {
            _client
              .channel('db-changes')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'lesson_records' }, () => {
                fetchTeachers(); // é»åè®Šå‹•é€šå¸¸æ˜¯å–®ç­†ï¼Œç¶­æŒåˆ·æ–°
              })
              .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'teachers' }, () => {
                fetchTeachers(); // è€å¸«è³‡æ–™æ›´æ–°æ‰åˆ·æ–°
              })
              .subscribe();
          }

          async function switchTeacher(tid, name) {
            // 1. ç«‹å³æ›´æ–°æ•¸æ“š ID
            currentTid = tid;
            document.getElementById("main-title").textContent = `${name} Â· æœ¬é€±èª²è¡¨`;

            // 2. âš¡ å¿«é€Ÿ UI åˆ‡æ›ï¼šéæ­·æ‰€æœ‰æŒ‰éˆ•ï¼Œåªæ”¹é¡åˆ¥ï¼ˆä¸é‡ç•« HTMLï¼‰
            document.querySelectorAll(".teacher-item").forEach((btn) => {
              const isActive = String(btn.dataset.id) === String(tid);
              const headshot = btn.querySelector(".w-9"); // æŠ“é ­åƒå€
              const statusDot = btn.querySelector(".w-1\\.5"); // æŠ“ç‹€æ…‹é»

              if (isActive) {
                // é¸ä¸­ç‹€æ…‹
                btn.className = btn.className.replace(/hover:bg-gray-50|text-neutral-700/g, "") + " active bg-blue-50 text-blue-700 ring-1 ring-blue-100";
                if (headshot) headshot.className = "w-9 h-9 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 border transition-colors bg-blue-600 text-white border-blue-600";
                if (statusDot) statusDot.className = "w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse";
              } else {
                // æœªé¸ä¸­ç‹€æ…‹
                btn.classList.remove("active", "bg-blue-50", "text-blue-700", "ring-1", "ring-blue-100");
                btn.classList.add("hover:bg-gray-50", "text-neutral-700");
                if (headshot) headshot.className = "w-9 h-9 rounded-lg flex items-center justify-center text-xs font-bold shrink-0 border transition-colors bg-gray-100 text-gray-500 border-gray-200";
                if (statusDot) statusDot.className = "w-1.5 h-1.5 rounded-full bg-green-400";
              }
            });

            // 3. è™•ç†å‚™å¿˜éŒ„èˆ‡æ’åº
            const targetTeacher = allTeachers.find(t => t.id === tid);
            const memoInput = document.getElementById("teacher-memo");
            if (memoInput) memoInput.value = (targetTeacher && targetTeacher.memo) ? targetTeacher.memo : "";

            if (targetTeacher && targetTeacher.card_order) {
              _userSortOrder = targetTeacher.card_order.split(',');
            } else {
              _userSortOrder = [];
            }

            // 4. æ‰‹æ©Ÿç‰ˆæ”¶åˆ
            if (window.innerWidth < 768) toggleSidebar();

            // 5. âš¡ åªåˆ·æ–°èª²è¡¨å…§å®¹ï¼ˆé€™æ˜¯ä¸»è¦çš„å»¶é²ä¾†æºï¼Œæ‰€ä»¥æ”¾æœ€å¾Œè·‘ï¼‰
            await refreshData();
          }

          // 4. å‚™å¿˜éŒ„è‡ªå‹•å„²å­˜åŠŸèƒ½ (æ–°å¢)
          async function handleMemoInput(text) {
            const status = document.getElementById("memo-status");
            if (status) {
              status.textContent = "è¼¸å…¥ä¸­...";
              status.classList.remove("opacity-0");
            }

            // é˜²æ‰‹éœ‡ï¼šæ¸…é™¤ä¸Šä¸€æ¬¡çš„è¨ˆæ™‚å™¨
            if (memoTimeout) clearTimeout(memoTimeout);

            // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼šåœæ­¢æ‰“å­— 0.8 ç§’å¾Œæ‰å„²å­˜
            memoTimeout = setTimeout(async () => {
              if (!currentTid) return;

              if (status) status.textContent = "å„²å­˜ä¸­...";

              // æ›´æ–°è³‡æ–™åº«
              const { error } = await _client
                .from("teachers")
                .update({ memo: text })
                .eq("id", currentTid);

              if (!error) {
                if (status) status.textContent = "å·²å„²å­˜";

                // â–¼ é—œéµä¿®æ­£ 4ï¼šå„²å­˜æˆåŠŸå¾Œï¼ŒåŒæ­¥æ›´æ–°æœ¬åœ°è®Šæ•¸ allTeachers â–¼
                // é€™æ¨£åˆ‡æ›å»åˆ¥çš„è€å¸«å†åˆ‡å›ä¾†ï¼Œè³‡æ–™æ‰æœƒæ˜¯æ–°çš„
                const localTeacher = allTeachers.find(t => t.id === currentTid);
                if (localTeacher) {
                  localTeacher.memo = text;
                }

                // 2ç§’å¾Œéš±è—ç‹€æ…‹æ–‡å­—
                setTimeout(() => {
                  if (status) status.classList.add("opacity-0");
                }, 2000);
              } else {
                console.error("å„²å­˜å¤±æ•—:", error); // åœ¨ Console é¡¯ç¤ºéŒ¯èª¤ä»¥ä¾¿é™¤éŒ¯
                if (status) {
                  status.textContent = "å„²å­˜å¤±æ•—";
                  status.classList.remove("text-yellow-600");
                  status.classList.add("text-red-500");
                }
              }
            }, 800);
          }

          // 2. é‡æ–°æ•´ç†è³‡æ–™
          async function refreshData() {
            if (!currentTid) return;

            const startDate = new Date(currentBaseDate);
            const endDate = addDays(startDate, 6);

            const startStr = formatDate(startDate);
            const endStr = formatDate(endDate);

            document.getElementById("current-date-range").textContent = `${startStr} ~ ${endStr}`;
            const picker = document.getElementById("date-picker");
            if (picker) picker.value = startStr;

            setStatus("æ­£åœ¨åŒæ­¥ç´€éŒ„...");

            try {
              const { data: sData, error: sErr } = await _client
                .from("schedules")
                .select("*")
                .eq("teacher_id", currentTid)
                .or(`target_date.is.null,and(target_date.gte.${startStr},target_date.lte.${endStr})`);
              if (sErr) throw sErr;

              const { data: rData, error: rErr } = await _client.from("lesson_records").select("*")
                .eq("teacher_id", currentTid)
                .gte("actual_date", startStr)
                .lte("actual_date", endStr);
              if (rErr) throw rErr;

              _cachedSchedule = sData || [];
              _cachedRecords = rData || [];

              // â˜… åŒæ­¥æ’åºæ¸…å–®
              let isOrderUpdated = false;
              _cachedSchedule.forEach(item => {
                const strId = String(item.id);
                if (!_userSortOrder.includes(strId)) {
                  _userSortOrder.push(strId);
                  isOrderUpdated = true;
                }
              });

              if (isOrderUpdated && currentTid) {
                const orderStr = _userSortOrder.join(',');

                // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šé€™è£¡ä¹ŸåŠ ä¸Š await â˜…â˜…â˜…
                await _client.from("teachers").update({ card_order: orderStr }).eq("id", currentTid);
                localStorage.setItem(`sort_order_${currentTid}`, orderStr);

                const t = allTeachers.find(t => t.id === currentTid);
                if (t) t.card_order = orderStr;
              }

              renderSchedule(_cachedSchedule, _cachedRecords, startDate);

              updateStatsUI();
            } catch (e) {
              console.error(e);
              setStatus(`é€£ç·šéŒ¯èª¤: ${e.message}`, "error");
            }
          }

          // 1. å¡ç‰‡é»ååˆ‡æ›ç‹€æ…‹é˜²å‘†
          async function toggleCourseStatus(id, currentStatus) {
            const statusCycle = { 'status-pending': 'status-present', 'status-present': 'status-leave', 'status-leave': 'status-absent', 'status-absent': 'status-pending' };
            const nextStatus = statusCycle[currentStatus] || 'status-present';
            const { error } = await _client.from("schedules").update({ color_class: nextStatus }).eq("id", id);

            if (!error) {
              await refreshData();
            } else {
              await sysAlert("ç‹€æ…‹åˆ‡æ›å¤±æ•—", "ç³»çµ±éŒ¯èª¤");
            }
          }

          // 3. ç¹ªåœ–å‡½å¼ (æ¥µè‡´ç´®å¯¦ç‰ˆï¼šå¤§å­—é«” + é›¶ç•™ç™½ + æ ¼ç·šçµ•å°è²¼åˆ)
          function renderSchedule(list, records = [], startDate) {
            const container = document.getElementById("schedule-container");
            if (!container) return;
            container.innerHTML = "";

            const slots = ["09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24"];
            const BASE_ROW_HEIGHT = 120;
            const START_HOUR = 9;
            const CARD_WIDTH = 135; // ç¨å¾®èª¿ä½ä¿åº•å¯¬åº¦
            const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
            const baseDate = startDate || currentBaseDate;

            function parseTime(tStr) {
              if (!tStr) return { h: 0, m: 0 };
              let h = parseInt(tStr.split(":")[0]);
              let m = parseInt(tStr.split(":")[1]);
              if (h === 0) h = 24;
              return { h, m };
            }

            let validItems = list.filter(item => item.start_time && item.end_time);

            validItems.sort((a, b) => {
              const indexA = _userSortOrder.indexOf(String(a.id));
              const indexB = _userSortOrder.indexOf(String(b.id));
              let weightA = indexA === -1 ? 9999 : indexA;
              let weightB = indexB === -1 ? 9999 : indexB;
              if (weightA !== weightB) return weightA - weightB;
              const aTime = parseTime(a.start_time);
              const bTime = parseTime(b.start_time);
              return (aTime.h * 60 + aTime.m) - (bTime.h * 60 + bTime.m);
            });

            // --- â˜… æ­¥é©Ÿä¸€ï¼šæ¥µè‡´ç²¾ç®—çš„ç©ºé–“æ„Ÿæ¸¬å™¨ ---
            let hourHeights = new Array(slots.length).fill(BASE_ROW_HEIGHT);
            let dayWidths = new Array(7).fill(CARD_WIDTH);

            for (let i = 0; i < 7; i++) {
              const thisDayDate = addDays(baseDate, i);
              const thisDayDateStr = formatDate(thisDayDate);
              const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();
              const dayItems = validItems.filter(item => item.day_of_week === dbDay);

              let maxDayW = CARD_WIDTH;
              dayItems.forEach(item => {
                // å¯¬åº¦æ„Ÿæ¸¬ï¼šé‡å° 20px å­—é«”åšç²¾ç®—ï¼Œå¤§å¹…ç¸®æ¸›ç·©è¡ (åƒ…ç•™ +35px çµ¦åœ–ç¤º)
                const nameLen = (item.course_name || "").length;
                const subjectLen = (item.subject || "").length;
                const estimatedW = (nameLen * 21) + (subjectLen * 14) + 35;
                if (estimatedW > maxDayW) maxDayW = estimatedW;

                // é«˜åº¦æ„Ÿæ¸¬ï¼šé‡å°æ”¾å¤§å¾Œçš„å­—é«”ç´¯åŠ é«˜åº¦
                const sT = parseTime(item.start_time); const eT = parseTime(item.end_time);
                const durationMins = (eT.h * 60 + eT.m) - (sT.h * 60 + sT.m);

                let contentReq = 75; // åŸºç¤é«˜åº¦ (20px å§“å + 16px æ™‚é–“)
                if (item.subject) contentReq += 24;
                contentReq += 22; // æ•™å®¤
                contentReq += 22; // é‡‘é¡
                const phoneList = (item.phone || "").split(/\s+/).filter(p => p.trim() !== "");
                contentReq += (phoneList.length * 20);

                const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
                if (record && record.remark) contentReq += 52; // å‚™è¨»é«˜åº¦åŒæ­¥å¢åŠ 
                else contentReq += 10;

                const neededPerHour = (contentReq / durationMins) * 60;
                for (let h = sT.h - START_HOUR; h <= eT.h - START_HOUR && h < slots.length; h++) {
                  hourHeights[h] = Math.max(hourHeights[h], neededPerHour);
                }
              });
              dayWidths[i] = Math.min(maxDayW, 300); // å…è¨±ç¨å¾®è®Šæ›´å¯¬ï¼Œä½†è¦è²¼é½Šå­—
            }

            function getDynamicTop(h, m) {
              let top = 0;
              const hIdx = h - START_HOUR;
              for (let i = 0; i < hIdx && i < slots.length; i++) top += hourHeights[i];
              if (hIdx >= 0 && hIdx < slots.length) top += (m / 60) * hourHeights[hIdx];
              return top;
            }

            // --- â˜… æ­¥é©ŸäºŒï¼šå®Œç¾æ¯”ä¾‹ GPU æ¸²æŸ“ç¹ªè£½ ---

            const timeCol = document.createElement("div");
            // ç§»é™¤äº† md:w-[90px] w-[60px] é€™äº›å›ºå®šå¯¬åº¦ class
            timeCol.className = "sticky left-0 z-[500] bg-white border-r border-[#e9e9e7] flex flex-col shrink-0";
            // å¯¬åº¦å¥—ç”¨è®Šæ•¸
            timeCol.style.width = `calc(60px * var(--z, 1))`;

            const timeHeader = document.createElement("div");
            timeHeader.className = "sticky top-0 z-[600] bg-gray-50 border-b border-[#e9e9e7] text-xs font-bold text-gray-600 flex items-center justify-center";
            // é«˜åº¦å¥—ç”¨è®Šæ•¸
            timeHeader.style.height = `calc(60px * var(--z, 1))`;
            // å…§éƒ¨æ–‡å­—ä¹Ÿé€²è¡Œç­‰æ¯”ä¾‹ç¸®æ”¾
            timeHeader.innerHTML = `<span style="display:inline-block; transform: scale(var(--z, 1)); transform-origin: center;">æ™‚é–“</span>`;
            timeCol.appendChild(timeHeader);

            slots.forEach((h, index) => {
              const cell = document.createElement("div");
              cell.className = "flex items-center justify-center text-xs font-semibold text-gray-400 border-b border-[#e9e9e7] bg-gray-50/30";
              cell.style.height = `calc(${hourHeights[index]}px * var(--z, 1))`;
              cell.innerHTML = `<span style="display:inline-block; transform: scale(var(--z, 1)); transform-origin: center;">${h}:00</span>`;
              timeCol.appendChild(cell);
            });
            container.appendChild(timeCol);

            for (let i = 0; i < 7; i++) {
              const thisDayDate = addDays(baseDate, i);
              const thisDayDateStr = formatDate(thisDayDate);
              const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();
              const dayItems = validItems.filter(item => item.day_of_week === dbDay);
              const currentDayUnitWidth = dayWidths[i];

              const columns = []; const cardColIndex = {};
              dayItems.forEach(item => {
                const sM = parseTime(item.start_time).h * 60 + parseTime(item.start_time).m;
                const eM = parseTime(item.end_time).h * 60 + parseTime(item.end_time).m;
                let placed = false;
                for (let col = 0; col < columns.length; col++) {
                  const overlap = columns[col].some(o => {
                    const osM = parseTime(o.start_time).h * 60 + parseTime(o.start_time).m;
                    const oeM = parseTime(o.end_time).h * 60 + parseTime(o.end_time).m;
                    return (sM < oeM && eM > osM);
                  });
                  if (!overlap) { columns[col].push(item); cardColIndex[item.id] = col; placed = true; break; }
                }
                if (!placed) { columns.push([item]); cardColIndex[item.id] = columns.length - 1; }
              });

              const dayCol = document.createElement("div");
              dayCol.className = "flex flex-col border-r border-[#e9e9e7] shrink-0 relative bg-white transition-all";
              dayCol.style.width = `calc(${Math.max(1, columns.length) * currentDayUnitWidth + 1}px * var(--z, 1))`;

              const header = document.createElement("div");
              header.className = "sticky top-0 z-[400] bg-gray-50 border-b border-[#e9e9e7] flex flex-col items-center justify-center overflow-hidden";
              header.style.height = `calc(60px * var(--z, 1))`;
              const isToday = formatDate(new Date()) === thisDayDateStr;
              header.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; transform: scale(var(--z, 1)); transform-origin: center;">
                  <span class="${isToday ? 'text-blue-600 font-bold' : 'text-gray-800 font-bold'}">${dayNames[thisDayDate.getDay()]}</span>
                  <span class="text-[10px] text-gray-400">${thisDayDate.getMonth() + 1}/${thisDayDate.getDate()}</span>
                </div>`;
              dayCol.appendChild(header);

              const contentLayer = document.createElement("div");
              contentLayer.className = "relative w-full";
              contentLayer.style.height = `calc(${hourHeights.reduce((a, b) => a + b, 0)}px * var(--z, 1))`;

              slots.forEach((_, index) => {
                const line = document.createElement("div");
                line.className = "border-b border-[#e9e9e7] w-full pointer-events-none";
                line.style.height = `calc(${hourHeights[index]}px * var(--z, 1))`;
                contentLayer.appendChild(line);
              });

              dayItems.forEach((item) => {
                const sT = parseTime(item.start_time); const eT = parseTime(item.end_time);
                const topPx = getDynamicTop(sT.h, sT.m);
                const heightPx = getDynamicTop(eT.h, eT.m) - topPx;
                const myIndex = cardColIndex[item.id];

                const today = new Date();
                const cardDate = new Date(thisDayDateStr);
                const currentYearMonth = today.getFullYear() * 12 + today.getMonth();
                const cardYearMonth = cardDate.getFullYear() * 12 + cardDate.getMonth();
                const monthDiff = currentYearMonth - cardYearMonth;

                const isLocked = monthDiff >= 2 && !currentUserInfo?.is_admin;

                const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
                let displayStatus = record ? record.status : (item.color_class || 'status-pending');
                const remarkText = record ? record.remark : "";
                const displayRemark = remarkText ? remarkText.replace(/\n/g, ' ') : "";

                let statusBorder = 'border-l-4 border-gray-300'; let bgClass = 'bg-white';
                if (displayStatus === 'attended' || displayStatus === 'status-present') { statusBorder = 'border-l-4 border-green-500'; bgClass = 'bg-green-50'; }
                else if (displayStatus === 'leave' || displayStatus === 'status-leave') { statusBorder = 'border-l-4 border-amber-400'; bgClass = 'bg-amber-50'; }
                else if (displayStatus === 'absent' || displayStatus === 'status-absent') { statusBorder = 'border-l-4 border-red-500'; bgClass = 'bg-red-50'; }
                else if (displayStatus === 'status-practice') { statusBorder = 'border-l-4 border-blue-400'; bgClass = 'bg-blue-50'; }

                const card = document.createElement("div");
                card.className = `schedule-card absolute rounded-r-md rounded-l-sm p-2 pb-3 text-sm shadow-md flex flex-col transition-all duration-200 group box-border ${isLocked ? 'card-locked' : 'hover:shadow-xl hover:z-[70] cursor-pointer'} ${statusBorder} ${bgClass}`;
                card.dataset.id = item.id;

                if (!isLocked) {
                  card.draggable = true;
                  card.ondragstart = (e) => handleDragStart(e, item.id);
                  card.ondragenter = (e) => {
                    e.preventDefault();
                    card.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'z-[80]');
                  };
                  card.ondragleave = () => {
                    card.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'z-[80]');
                  };
                  card.ondragover = (e) => e.preventDefault();
                  card.ondrop = (e) => {
                    card.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'z-[80]');
                    handleDrop(e, item.id);
                  };
                  card.ondragend = (e) => handleDragEnd(e);
                }

                // â˜… çµ‚æ¥µé­”æ³•ï¼š
                // 1. åº§æ¨™ (top, left) äº¤çµ¦ calc(...) æ•¸å­¸é‹ç®—ï¼Œç¢ºä¿ç²¾æº–è½é»ã€‚
                // 2. å¯¦é«”å¯¬é«˜ (width, height) ä¿æŒåŸæ¯”ä¾‹ï¼Œç¢ºä¿æ–‡å­—çµ•ä¸æ“ å£“ï¼
                // 3. åˆ©ç”¨ GPU (transform: scale) ç›´æ¥å°‡å®Œæ•´ç•«å¥½çš„å¡ç‰‡ç­‰æ¯”ä¾‹ç¸®å°ã€‚
                card.style.cssText = `
                    top: ${topPx}px; 
                    left: ${myIndex * currentDayUnitWidth}px; 
                    width: ${currentDayUnitWidth}px; 
                    min-height: ${heightPx}px; 
                    height: ${heightPx}px; 
                    z-index: 20; 
                    overflow: hidden;
                    transform: scale(var(--z, 1));
                    transform-origin: 0 0;
                `;

                const phoneList = (item.phone || "").split(/\s+/).filter(p => p.trim() !== "");
                const phoneHtml = phoneList.map(p => `<div class="flex items-center gap-1.5 text-[16px] text-gray-500 w-full"><i data-lucide="phone" class="w-4 h-4 text-green-500 shrink-0"></i><span class="font-mono truncate flex-1 font-bold">${p}</span></div>`).join('');

                card.innerHTML = `
            ${isLocked ? '<div class="absolute top-1 right-1 text-gray-400/40"><i data-lucide="lock" class="w-3.5 h-3.5"></i></div>' : `
              <div class="absolute top-1 right-1 flex flex-row items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] bg-white/95 backdrop-blur-sm px-1.5 py-1 rounded-full shadow-md border border-gray-200" 
                   style="pointer-events: auto;" onmousedown="event.stopPropagation();" onclick="event.stopPropagation();">
                  <button type="button" onclick="openRemarkModal('${item.id}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-yellow-600 hover:scale-110 transition-all cursor-pointer"><i data-lucide="sticky-note" class="w-4 h-4"></i></button>
                  <button type="button" onclick="openEditModal('${item.id}', '${displayStatus}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-blue-600 hover:scale-110 transition-all cursor-pointer"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                  <button type="button" onclick="copyCourse('${item.id}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-gray-500 hover:text-amber-600 hover:scale-110 transition-all cursor-pointer"><i data-lucide="copy" class="w-4 h-4"></i></button>
                  <button type="button" onclick="deleteCourse('${item.id}');" class="p-1 rounded-full text-red-500 hover:scale-110 transition-all cursor-pointer"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
            `}
            
            <div class="flex flex-col h-full min-w-0 pr-1 relative z-10" onclick="${isLocked ? '' : `toggleRecordStatus('${item.id}', '${thisDayDateStr}', '${displayStatus}')`}">
                <div class="flex items-center gap-1.5 w-full">
                    <span class="font-bold text-neutral-900 text-[20px] whitespace-nowrap">${item.course_name}</span>
                    ${item.subject ? `<span class="text-[16px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded shrink-0 font-bold">${item.subject}</span>` : ''}
                </div>
                <div class="text-[16px] text-gray-400 font-mono mt-0.5 whitespace-nowrap font-bold">${item.start_time.slice(0, 5)} - ${item.end_time.slice(0, 5)}</div>
                <div class="mt-1 flex flex-col gap-1 pointer-events-none w-full">
                    <div class="flex items-center gap-1.5 text-[16px] text-gray-600 truncate font-bold"><i data-lucide="map-pin" class="w-4 h-4 text-blue-400 shrink-0"></i><span>${item.room_no || 'ç„¡'}</span></div>
                    <div class="flex items-center gap-1.5 text-[16px] text-gray-600 truncate font-bold"><i data-lucide="coins" class="w-4 h-4 text-amber-500 shrink-0"></i><span class="font-mono truncate flex-1">$${item.amount || 0}</span></div>
                    ${phoneHtml}
                </div>
                <div class="mt-auto pt-2 pointer-events-none w-full">
                    ${displayRemark ? `<div class="flex items-center gap-1.5 p-1.5 rounded bg-red-50 border border-red-100 text-red-700 text-[16px] font-bold leading-tight"><i data-lucide="pin" class="w-4 h-4 shrink-0"></i> <span class="truncate">${displayRemark}</span></div>` : ''}
                </div>
            </div>
          `;
                contentLayer.appendChild(card);
              });
              dayCol.appendChild(contentLayer);
              container.appendChild(dayCol);
            }
            lucide.createIcons();
          }

          // --- 2. è¤‡è£½èª²ç¨‹åŠŸèƒ½ (å‡ç´šç‰ˆï¼šé è¨­å¸¶å…¥æ‰€é»æ“Šçš„æ—¥æœŸ) ---
          function copyCourse(itemId, dateStr) {
            // å…ˆæ‰“é–‹ç·¨è¼¯è¦–çª—ï¼ŒæŠŠèˆŠè³‡æ–™éƒ½å¡«é€²å»
            openEditModal(itemId, null, dateStr);

            document.querySelector("#course-modal h3").textContent = "è¤‡è£½ä¸¦æ’å…¥æ–°æ—¥æœŸ";
            editingId = null; // è®Šæˆæ–°å¢æ¨¡å¼

            // â˜… è‡ªå‹•åˆ‡æ›ç‚ºã€Œå–®æ¬¡/è‡¨æ™‚èª²ç¨‹ã€æ¨¡å¼ï¼Œä¸¦å±•é–‹æ—¥æ›†
            const tempCheckbox = document.getElementById("is_temporary");
            const dateWrapper = document.getElementById("temp-date-wrapper");
            const dateInput = document.getElementById("target_date_input");

            if (tempCheckbox) tempCheckbox.checked = true;
            if (dateWrapper) dateWrapper.classList.remove('hidden');
            if (dateInput) {
              // â˜… é—œéµä¿®æ”¹ï¼šå°‡ formatDate(new Date()) æ”¹æˆ dateStr
              // é€™æ¨£æ—¥æ›†å°±æœƒç›´æ¥é è¨­ç‚ºã€Œå¦³é»æ“Šçš„é‚£ä¸€å¤©ã€ï¼
              dateInput.value = dateStr;
            }
          }

          // --- é»åç‹€æ…‹åˆ‡æ›æ ¸å¿ƒé‚è¼¯ (å‡ç´šç‰ˆï¼šæ¨‚è§€æ›´æ–°ï¼Œé»å¤šå¿«éƒ½ä¸æ¼ç®—ï¼) ---
          async function toggleRecordStatus(scheduleId, dateStr, currentStatus) {
            let nextStatus = '';

            // 1. æ±ºå®šä¸‹ä¸€å€‹ç‹€æ…‹ (å¾ªç’°ï¼šç° -> ç¶  -> å’– -> ç´… -> ç°)
            if (!currentStatus || currentStatus === 'status-pending') {
              nextStatus = 'status-present';
            } else if (currentStatus === 'attended' || currentStatus === 'status-present') {
              nextStatus = 'status-leave';
            } else if (currentStatus === 'leave' || currentStatus === 'status-leave') {
              nextStatus = 'status-absent';
            } else {
              nextStatus = 'status-pending';
            }

            // 2. å–å¾—é€™å ‚èª²æ¯ç‰ˆçš„ã€Œé è¨­ç‹€æ…‹ã€
            const masterItem = _cachedSchedule.find(s => s.id === scheduleId);
            const masterDefault = (masterItem && masterItem.color_class) ? masterItem.color_class : 'status-pending';

            // â˜…â˜…â˜… 3. æ¨‚è§€æ›´æ–° (Optimistic UI)ï¼šç›´æ¥ç«„æ”¹æœ¬åœ°è¨˜æ†¶é«”ï¼Œä¸ç­‰è³‡æ–™åº«äº†ï¼ â˜…â˜…â˜…
            let existingRecordIndex = _cachedRecords.findIndex(r => r.schedule_id === scheduleId && r.actual_date === dateStr);

            if (nextStatus === masterDefault) {
              // å¦‚æœåˆ‡å›é è¨­ç‹€æ…‹ï¼Œå°±å¾è¨˜æ†¶é«”è£¡æŠŠé€™ç­†ç‰¹åˆ¥ç´€éŒ„åˆªæ‰
              if (existingRecordIndex !== -1) _cachedRecords.splice(existingRecordIndex, 1);
            } else {
              // å¦å‰‡ï¼Œæ›´æ–°è¨˜æ†¶é«”ï¼Œæˆ–æ˜¯å¡ä¸€ç­†æ–°çš„é€²å»
              if (existingRecordIndex !== -1) {
                _cachedRecords[existingRecordIndex].status = nextStatus;
              } else {
                _cachedRecords.push({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus, remark: "" });
              }
            }

            // â˜… ç¬é–“é‡ç•«å¡ç‰‡é¡è‰²ï¼Œä¸¦ç¬é–“æ›´æ–°å·¦ä¸Šè§’çš„æ•¸å­—ï¼(0å»¶é²)
            renderSchedule(_cachedSchedule, _cachedRecords);
            updateStatsUI();

            // 4. èƒŒæ™¯é»˜é»˜å­˜æª”
            try {
              if (nextStatus === masterDefault) {
                await _client.from("lesson_records").delete().eq("schedule_id", scheduleId).eq("actual_date", dateStr);
              } else {
                const { data: existing } = await _client.from("lesson_records").select("id").eq("schedule_id", scheduleId).eq("actual_date", dateStr).maybeSingle();
                if (existing) {
                  await _client.from("lesson_records").update({ status: nextStatus }).eq("id", existing.id);
                } else {
                  await _client.from("lesson_records").insert({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus });
                }
              }

              // â˜… ç›£è¦–å™¨ï¼šå¯«å…¥é»åæ—¥èªŒ (æŠŠè‹±æ–‡ç‹€æ…‹ç¿»è­¯æˆä¸­æ–‡æ¯”è¼ƒå¥½çœ‹)
              const statusZhMap = { 'status-present': 'ä¸Šèª²', 'status-leave': 'è«‹å‡', 'status-absent': 'æ› èª²', 'status-pending': 'å°šæœªé»å', 'status-practice': 'ç·´ç¿’' };
              const statusZh = statusZhMap[nextStatus] || nextStatus;

              await recordLog('ä¿®æ”¹é»å', `å°‡ [${masterItem.course_name}] åœ¨ ${dateStr} çš„ç‹€æ…‹æ”¹ç‚º [${statusZh}]`, 'lesson_records',
                { schedule_id: scheduleId, actual_date: dateStr, status: currentStatus }, // èˆŠç‹€æ…‹
                { schedule_id: scheduleId, actual_date: dateStr, status: nextStatus }     // æ–°ç‹€æ…‹
              );

            } catch (err) {
              console.error("é»åç‹€æ…‹å­˜æª”å¤±æ•—:", err);
            }
          }

          // --- å°ˆé–€è™•ç†å¡ç‰‡å±•é–‹/æ”¶åˆçš„å‡½å¼ ---
          function handleToggleExpand(btn) {
            // 1. æ‰¾åˆ°è©²æŒ‰éˆ•æ‰€å±¬çš„å¡ç‰‡
            const card = btn.closest('.absolute.rounded-md');
            if (!card) return;

            // 2. åˆ‡æ›å±•é–‹ class
            const isExpanded = card.classList.toggle('card-expanded');

            // 3. è¦–è¦ºå›é¥‹ï¼šæ—‹è½‰ç®­é ­ 180 åº¦
            if (isExpanded) {
              btn.style.transform = 'rotate(180deg)';
            } else {
              btn.style.transform = 'rotate(0deg)';
            }

            // 4. é‡æ–°è§¸ç™¼ Lucide åœ–ç¤ºæ¸²æŸ“ (ç¢ºä¿åœ–ç¤ºæ­£ç¢ºé¡¯ç¤º)
            lucide.createIcons();
          }

          // 5. è€å¸«ç®¡ç†åŠŸèƒ½
          async function addTeacher() {
            const name = document.getElementById("new-teacher-name").value.trim();
            if (!name) return;
            const { error } = await _client.from("teachers").insert([{ name }]);
            if (error) alert("æ–°å¢å¤±æ•—");
            document.getElementById("new-teacher-name").value = "";
            await fetchTeachers();
          }

          // 6. è¼”åŠ©å‡½æ•¸ (åŠ å¤§ç‰ˆï¼špx-2.5, py-1, -ml-2)
          function setStatus(msg, type = "warn") {
            // å¦‚æœåªæ˜¯å¹³å¸¸åŒæ­¥ï¼Œå°±ä¸æ›´æ–°ç•«é¢ä¸Šé‚£å€‹æ¨™ç±¤ï¼Œé¿å…é–ƒçˆ
            if (msg.includes("æ­£åœ¨åŒæ­¥") || msg.includes("é€£ç·šæˆåŠŸ")) return;

            const el = document.getElementById("status-tag");
            if (!el) return;
            el.textContent = msg;

            // å®šç¾©é¡è‰²
            let colorClass = "bg-yellow-100 text-yellow-800"; // é è¨­ (é»ƒ)
            if (type === "error") colorClass = "bg-red-100 text-red-800"; // éŒ¯èª¤ (ç´…)
            if (type === "success") colorClass = "bg-green-100 text-green-800"; // æˆåŠŸ (ç¶ )

            // å¥—ç”¨æ¨£å¼ (åŒæ­¥åŠ å¤§èˆ‡å°é½Šä¿®æ­£)
            el.className = `text-[10px] md:text-xs px-2.5 py-1 rounded-md font-medium mt-0.5 -ml-2 ${colorClass}`;
          }

          // --- ç¨ç«‹çš„çµ±è¨ˆæ•¸å­—æ›´æ–°å™¨ (æ‰€è¦‹å³æ‰€å¾—ç²¾æº–ç‰ˆ) ---
          function updateStatsUI() {
            if (!_cachedSchedule) return;

            const START_HOUR = 9;

            // å·¥å…·ï¼šè™•ç†æ™‚é–“æ ¼å¼
            function parseTime(tStr) {
              if (!tStr) return { h: 0, m: 0 };
              let h = parseInt(tStr.split(":")[0]);
              let m = parseInt(tStr.split(":")[1]);
              if (h === 0) h = 24;
              return { h, m };
            }

            // 1. æŠ“å‡ºçœŸæ­£æœ‰é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„èª² (éæ¿¾æ‰æ²’æ™‚é–“æˆ–å¤ªæ—©çš„)
            let validItems = _cachedSchedule.filter(item => {
              if (!item.start_time || !item.end_time) return false;
              return parseTime(item.start_time).h >= START_HOUR;
            });

            let total = 0;
            let presentOrAbsentCount = 0;
            let leaveCount = 0;

            const baseDate = currentBaseDate;

            // 2. æ¨¡æ“¬ç•« 7 å¤©çš„å¡ç‰‡ï¼Œç²¾æº–çµç®—æ¯ä¸€å¤©æ¯ä¸€å ‚èª²çš„ã€Œæœ€çµ‚é¡è‰²ã€
            for (let i = 0; i < 7; i++) {
              const thisDayDate = addDays(baseDate, i);
              const thisDayDateStr = formatDate(thisDayDate);
              const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();

              // æ‰¾å‡ºé€™å¤©æ‰€æœ‰çš„èª²
              const dayItems = validItems.filter(item => item.day_of_week === dbDay);

              dayItems.forEach(item => {
                total++; // åªè¦é€™å¤©æœ‰é€™å ‚èª²ï¼Œç¸½å ‚æ•¸å°± +1

                // â˜… æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·é€™å ‚èª²ã€Œæœ€çµ‚é¡¯ç¤ºã€çš„ç‹€æ…‹
                // (å„ªå…ˆçœ‹æœ‰æ²’æœ‰ç‰¹åˆ¥çš„é»åç´€éŒ„ï¼Œæ²’æœ‰çš„è©±å°±çœ‹æ¯ç‰ˆçš„é è¨­ç‹€æ…‹)
                const record = _cachedRecords.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
                const displayStatus = record ? record.status : (item.color_class || 'status-pending');

                // æ ¹æ“šæœ€çµ‚é¡¯ç¤ºç‹€æ…‹ä¾†åŠ ç¸½
                if (['attended', 'status-present', 'absent', 'status-absent'].includes(displayStatus)) {
                  presentOrAbsentCount++;
                } else if (['leave', 'status-leave'].includes(displayStatus)) {
                  leaveCount++;
                }
              });
            }

            // 3. è¼¸å‡ºåˆ°ç•«é¢ä¸Š (å„ªåŒ–æ¨™ç±¤é¡¯ç¤º)
            const statsTag = document.getElementById("status-tag");
            if (statsTag) {
              statsTag.textContent = `ç¸½å ‚æ•¸ï¼š${total} | å·²é»å+æ› èª²ï¼š${presentOrAbsentCount} | è«‹å‡ï¼š${leaveCount}`;
              statsTag.className = "text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-blue-50 text-blue-700 font-bold mt-0.5 -ml-2 border border-blue-100";
            }
          }

          // æ–°å¢é€™å€‹å‡½å¼ï¼Œè®“å½ˆçª—å¯ä»¥æ‰“é–‹
          function openModal() {
            document.getElementById("course-modal").classList.remove("hidden");
          }
          function closeModal() {
            editingId = null;
            document.getElementById("course-modal").classList.add("hidden");
            document.getElementById("course-form").reset();
            document.querySelector("#course-modal h3").textContent = "æ–°å¢èª²ç¨‹è³‡æ–™";
          }
          function openTeacherModal() {
            document.getElementById("teacher-modal").classList.remove("hidden");
          }
          function closeTeacherModal() {
            document.getElementById("teacher-modal").classList.add("hidden");
          }

          // 7. ä¿®æ”¹èˆ‡åˆªé™¤
          function openEditModal(id, status, dateStr) {
            editingId = id;
            editingDateStr = dateStr;

            const item = _cachedSchedule.find(i => i.id === id);
            if (!item) return;

            const form = document.getElementById("course-form");
            form.day_of_week.value = item.day_of_week;
            form.teacher_id.value = item.teacher_id;
            form.course_name.value = item.course_name;
            form.start_time.value = item.start_time.slice(0, 5);
            form.end_time.value = item.end_time.slice(0, 5);
            form.room_no.value = item.room_no || "";
            form.amount.value = item.amount || 0;
            form.phone.value = item.phone || "";
            form.subject.value = item.subject || "";

            const record = _cachedRecords.find(r => r.schedule_id === id && r.actual_date === dateStr);
            let displayStatus = item.color_class || 'status-pending';
            if (record) displayStatus = record.status;

            form.color_class.value = displayStatus;
            if (displayStatus === 'attended') form.color_class.value = 'status-present';
            if (displayStatus === 'leave') form.color_class.value = 'status-leave';
            if (displayStatus === 'absent') form.color_class.value = 'status-absent';

            // â˜… è™•ç†å–®æ¬¡èª²ç¨‹å‹¾é¸èˆ‡æ—¥æœŸé¡¯ç¤º
            const tempCheckbox = document.getElementById("is_temporary");
            const dateWrapper = document.getElementById("temp-date-wrapper");
            const dateInput = document.getElementById("target_date_input");

            if (tempCheckbox) {
              tempCheckbox.checked = item.is_temporary || false;
              if (dateWrapper) dateWrapper.classList.toggle('hidden', !tempCheckbox.checked);
              if (dateInput) {
                // å¦‚æœé€™å ‚èª²æœ¬ä¾†å°±æ˜¯å–®æ¬¡èª²ï¼Œå¡«å…¥å®ƒçš„æŒ‡å®šæ—¥æœŸï¼›å¦å‰‡é è¨­å¸¶å…¥ç•¶å¤©
                dateInput.value = item.target_date || dateStr || formatDate(new Date());
              }
            }

            document.querySelector("#course-modal h3").textContent = "ä¿®æ”¹å›ºå®šèª²è¡¨";
            openModal();
          }

          async function deleteCourse(id) {
            // æ³¨æ„ï¼šå‰é¢ä¸€å®šè¦åŠ  await å–”ï¼
            if (!(await sysConfirm("ç¢ºå®šè¦åˆªé™¤é€™å ‚èª²å—ï¼Ÿ<br><span class='text-xs text-red-500'>*æ­¤æ“ä½œå°‡æœƒè¨˜éŒ„åœ¨ç³»çµ±æ—¥èªŒä¸­</span>", "åˆªé™¤ç¢ºèª", "danger"))) return;

            // â˜… ç›£è¦–å™¨ï¼šå…ˆå·å·è¨˜ä½æ­»è€…çš„é•·ç›¸ (ç‚ºäº†ä¹‹å¾Œèƒ½å¾©æ´»ä»–)
            const oldData = _cachedSchedule.find(s => s.id === id);

            const { error } = await _client.from("schedules").delete().eq("id", id);

            if (!error && oldData) {
              // â˜… ç›£è¦–å™¨ï¼šå¯«å…¥æ—¥èªŒ
              await recordLog('åˆªé™¤èª²ç¨‹', `åˆªé™¤äº† [${oldData.course_name}] çš„èª²ç¨‹`, 'schedules', oldData, null);
            }

            await refreshData();
          }

          // 8. è¡¨å–®æäº¤ (æ”¯æ´ 00:00 è·¨å¤œé‚è¼¯èˆ‡æŒ‡å®šæ—¥æœŸæ™ºæ…§æ¨ç®—)
          document.getElementById("course-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);

            let sTime = f.get("start_time");
            let eTime = f.get("end_time");
            let checkETime = eTime === "00:00" ? "24:00" : eTime;

            if (sTime >= checkETime) {
              return sysAlert("çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“", "æ™‚é–“è¨­å®šéŒ¯èª¤");
            }

            const isTemporary = document.getElementById("is_temporary").checked;
            let finalTargetDate = null;
            let dayOfWeek = parseInt(f.get("day_of_week"));

            // â˜… ç¥ç´šé˜²å‘†ï¼šå¦‚æœå‹¾é¸äº†å–®æ¬¡èª²ç¨‹ï¼Œç›´æ¥æ‹¿å¦³é¸çš„æ—¥æœŸä¾†åæ¨æ˜ŸæœŸå¹¾ï¼
            // (é€™æ¨£å¦³å°±ä¸ç”¨ç®¡ä¸Šé¢é‚£å€‹ã€Œä¸Šèª²æ˜ŸæœŸã€çš„ä¸‹æ‹‰é¸å–®äº†)
            if (isTemporary) {
              finalTargetDate = f.get("target_date");
              if (!finalTargetDate) return sysAlert("è«‹é¸æ“‡å–®æ¬¡èª²ç¨‹çš„æ—¥æœŸï¼", "è³‡æ–™ä¸é½Šå…¨");

              const d = new Date(finalTargetDate);
              dayOfWeek = d.getDay();
              if (dayOfWeek === 0) dayOfWeek = 7; // é€±æ—¥è½‰æ›ç‚º 7
            }

            const data = {
              teacher_id: f.get("teacher_id"),
              day_of_week: dayOfWeek, // é€™è£¡å·²ç¶“æ˜¯è‡ªå‹•ç®—å¥½çš„æ­£ç¢ºæ˜ŸæœŸäº†
              course_name: f.get("course_name"),
              start_time: sTime + ":00",
              end_time: eTime + ":00",
              room_no: f.get("room_no"),
              amount: parseInt(f.get("amount")) || 0,
              phone: f.get("phone"),
              subject: f.get("subject"),
              color_class: f.get("color_class"),
              target_date: finalTargetDate,
              is_temporary: isTemporary
            };

            // â˜… ç›£è¦–å™¨ï¼šæ‹ç…§è¨˜ä¸‹ä¿®æ”¹å‰çš„æ¨£å­
            const oldData = editingId ? _cachedSchedule.find(s => s.id === editingId) : null;

            // â˜… åŠ ä¸Š .select() è®“è³‡æ–™åº«å­˜å®Œå¾Œé †ä¾¿æŠŠæ–°è³‡æ–™å‚³å›ä¾†çµ¦æˆ‘å€‘
            const res = editingId
              ? await _client.from("schedules").update(data).eq("id", editingId).select()
              : await _client.from("schedules").insert([data]).select();

            if (res.error) {
              return sysAlert("æ“ä½œå¤±æ•—: " + res.error.message, "ç³»çµ±éŒ¯èª¤");
            }

            // â˜… ç›£è¦–å™¨å‡ç´šï¼šç²¾æº–æŠ“å‡ºåˆ°åº•ã€Œæ”¹äº†å“ªäº›æ¬„ä½ã€
            const newData = res.data[0];
            let actionType = 'æ–°å¢èª²ç¨‹';
            let actionDesc = `[${newData.course_name}]ï¼šæ–°å¢äº†ä¸€å ‚èª²`;

            // å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œå•Ÿå‹•å·®ç•°æ¯”å°å¼•æ“ï¼
            if (editingId && oldData) {
              actionType = 'ä¿®æ”¹èª²ç¨‹';
              let changes = [];

              // å®šç¾©æˆ‘å€‘è¦æª¢æŸ¥çš„æ¬„ä½ï¼Œä»¥åŠå®ƒå€‘çš„ä¸­æ–‡åç¨±
              const fieldMap = {
                course_name: 'å§“å', phone: 'é›»è©±', subject: 'ç§‘ç›®', amount: 'é‡‘é¡',
                day_of_week: 'æ˜ŸæœŸ', start_time: 'é–‹å§‹æ™‚é–“', end_time: 'çµæŸæ™‚é–“',
                room_no: 'æ•™å®¤', is_temporary: 'å–®æ¬¡å±¬æ€§'
              };
              const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };

              for (let key in fieldMap) {
                let oldV = oldData[key];
                let newV = newData[key];

                // é‡å°ç‰¹æ®Šæ ¼å¼é€²è¡Œç¿»è­¯ (ä¾‹å¦‚æ˜ŸæœŸ 1 è¦è®Šæˆ æ˜ŸæœŸä¸€)
                if (key === 'day_of_week') {
                  oldV = dayMap[oldV] || oldV; newV = dayMap[newV] || newV;
                } else if (key === 'is_temporary') {
                  oldV = oldV ? 'æ˜¯' : 'å¦'; newV = newV ? 'æ˜¯' : 'å¦';
                } else if (key === 'start_time' || key === 'end_time') {
                  oldV = oldV ? String(oldV).slice(0, 5) : ''; newV = newV ? String(newV).slice(0, 5) : '';
                }

                // æ¸…ç†ç©ºç™½ä¸¦æŠŠ null è½‰æˆç©ºå­—ä¸²ï¼Œé˜²æ­¢èª¤åˆ¤
                let sOld = (oldV === null || oldV === undefined) ? '' : String(oldV).trim();
                let sNew = (newV === null || newV === undefined) ? '' : String(newV).trim();

                // å¦‚æœä¸ä¸€æ¨£ï¼Œå°±æŠŠé€™æ¢æ”¹è®Šå¯«é€²æ¸…å–®è£¡
                if (sOld !== sNew) {
                  changes.push(`${fieldMap[key]}: ${sOld || 'ç„¡'} â” ${sNew || 'ç„¡'}`);
                }
              }

              // çµ„è£æœ€çµ‚çš„ç™½è©±æ–‡
              if (changes.length > 0) {
                // æŠŠæ‰€æœ‰æ”¹è®Šç”¨ | ä¸²èµ·ä¾†
                actionDesc = `[${newData.course_name}]ï¼š${changes.join(' | ')}`;
              } else {
                actionDesc = `[${newData.course_name}]ï¼šé»æ“Šäº†å„²å­˜ (ç„¡æ¬„ä½è®Šå‹•)`;
              }
            }

            // å¯«å…¥æ—¥èªŒ
            await recordLog(actionType, actionDesc, 'schedules', oldData, newData);

            if (editingId && editingDateStr) {
              await _client.from("lesson_records")
                .update({ status: data.color_class })
                .match({ schedule_id: editingId, actual_date: editingDateStr });
            }

            closeModal();
            await refreshData();
          });

          // --- è€å¸«ç®¡ç†åŠŸèƒ½é‚è¼¯ ---

          // 1. é–‹å•Ÿç®¡ç†è¦–çª—ä¸¦è®€å–æœ€æ–°æ¸…å–®
          async function openTeacherModal() {
            document.getElementById("teacher-modal").classList.remove("hidden");
            await renderTeacherManageList();
            lucide.createIcons();
          }

          // 2. é—œé–‰è¦–çª—
          function closeTeacherModal() {
            document.getElementById("teacher-modal").classList.add("hidden");
            document.getElementById("new-teacher-name").value = "";
          }

          // 3. æ¸²æŸ“ç®¡ç†è¦–çª—å…§çš„è€å¸«åˆ—è¡¨ (ä¿®æ­£ç‰ˆï¼šéš±è— is_hidden çš„ç®¡ç†è€…)
          // è€å¸«ç®¡ç† (ç¾åŒ–ç‰ˆ) ---
          async function renderTeacherManageList() {
            const { data: teachers } = await _client.from("teachers").select("*").order("created_at");
            const list = document.getElementById("teacher-manage-list");
            list.innerHTML = "";

            teachers.forEach(t => {
              if (t.is_hidden) return; // éš±è—ç®¡ç†å“¡è‡ªå·±
              const item = document.createElement("div");
              item.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100 group hover:border-blue-200 transition-all shadow-sm";
              item.dataset.id = t.id;

              item.innerHTML = `
          <div class="view-mode flex items-center gap-3 w-full">
            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center font-bold text-gray-500 text-xs">${t.name.charAt(0)}</div>
            <span class="text-sm font-bold text-gray-700 flex-1">${t.name}</span>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="openPermissionsModal('${t.id}')" class="p-1.5 text-gray-400 hover:text-yellow-600 rounded" title="è¨­å®šå´é‚Šæ¬„æ¬Šé™">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                </button>
                <button onclick="toggleEditMode('${t.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                <button onclick="deleteTeacher('${t.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </div>
          <div class="edit-mode hidden w-full flex items-center gap-2">
            <input type="text" value="${t.name}" class="edit-input flex-1 border rounded px-2 py-1 text-sm outline-none" onkeydown="if(event.key==='Enter') updateTeacher('${t.id}', this.value)">
            <button onclick="updateTeacher('${t.id}', this.previousElementSibling.value)" class="text-green-600"><i data-lucide="check" class="w-4 h-4"></i></button>
            <button onclick="toggleEditMode('${t.id}', false)" class="text-gray-400"><i data-lucide="x" class="w-4 h-4"></i></button>
          </div>
        `;
              list.appendChild(item);
            });
            lucide.createIcons();
          }

          // --- æ–°å¢çš„åŠŸèƒ½ï¼šåˆ‡æ›ç·¨è¼¯æ¨¡å¼ ---
          function toggleEditMode(id, showEdit = true) {
            const item = document.querySelector(`div[data-id="${id}"]`);
            if (!item) return;

            const viewMode = item.querySelector('.view-mode');
            const editMode = item.querySelector('.edit-mode');
            const input = item.querySelector('.edit-input');

            if (showEdit) {
              viewMode.classList.add('hidden');
              editMode.classList.remove('hidden');
              input.focus(); // è‡ªå‹•èšç„¦åˆ°è¼¸å…¥æ¡†
              input.select(); // å…¨é¸æ–‡å­—æ–¹ä¾¿ä¿®æ”¹
            } else {
              viewMode.classList.remove('hidden');
              editMode.classList.add('hidden');
            }
          }

          // 1. ä¿®æ”¹è€å¸«åå­—é˜²å‘†
          async function updateTeacher(id, newName) {
            newName = newName.trim();
            if (!newName) return sysAlert("è€å¸«åå­—ä¸èƒ½ç‚ºç©ºï¼", "è³‡æ–™éŒ¯èª¤");

            setStatus("æ­£åœ¨æ›´æ–°è³‡æ–™...");
            const { error } = await _client.from("teachers").update({ name: newName }).eq("id", id);

            if (error) {
              setStatus("æ›´æ–°å¤±æ•—", "error");
              await sysAlert("æ›´æ–°å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
            } else {
              setStatus("æ›´æ–°æˆåŠŸ", "success");
              if (currentTid === id) document.getElementById("main-title").textContent = `${newName} Â· æœ¬é€±èª²è¡¨`;
              await fetchTeachers();
              await renderTeacherManageList();
            }
          }

          // 2. æ–°å¢è€å¸«é˜²å‘†
          async function addTeacher() {
            const input = document.getElementById("new-teacher-name");
            const name = input.value.trim();

            if (!name) return sysAlert("è«‹è¼¸å…¥è€å¸«å§“å", "è³‡æ–™ä¸é½Šå…¨");

            setStatus("æ­£åœ¨æ–°å¢è€å¸«...");
            const { error } = await _client.from("teachers").insert([{ name }]);

            if (error) {
              setStatus("æ–°å¢å¤±æ•—", "error");
              await sysAlert("æ–°å¢å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
            } else {
              input.value = "";
              setStatus("è€å¸«æ–°å¢æˆåŠŸ", "success");
              await fetchTeachers();
              await renderTeacherManageList();
            }
          }

          // 5. åŸ·è¡Œåˆªé™¤è€å¸« (æœƒé€£å‹•åˆªé™¤è©²è€å¸«çš„èª²è¡¨)
          async function deleteTeacher(id) {
            if (!(await sysConfirm("ç¢ºå®šè¦åˆªé™¤é€™ä½è€å¸«å—ï¼Ÿ<br><span class='text-xs text-red-500'>ç›¸é—œçš„æ‰€æœ‰èª²ç¨‹å°‡æœƒä¸€ä½µæ¶ˆå¤±ï¼</span>", "åˆªé™¤è€å¸«", "danger"))) return;

            setStatus("æ­£åœ¨åˆªé™¤è€å¸«...");
            const { error } = await _client.from("teachers").delete().eq("id", id);

            if (error) {
              setStatus("åˆªé™¤å¤±æ•—", "error");
              await sysAlert("åˆªé™¤å¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
            } else {
              setStatus("è€å¸«å·²åˆªé™¤", "success");
              // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸å–çš„è€å¸«ï¼Œé‡ç½® ID é¿å…é¡¯ç¤ºéŒ¯èª¤
              if (currentTid === id) currentTid = null;
              await fetchTeachers();
              await renderTeacherManageList();
            }
          }

          // --- å´é‚Šæ¬„æ§åˆ¶ ---
          function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            // åˆ‡æ› CSS class
            if (sidebar.classList.contains('-translate-x-full')) {
              // æ‰“é–‹
              sidebar.classList.remove('-translate-x-full');
              overlay.classList.remove('hidden');
            } else {
              // é—œé–‰
              sidebar.classList.add('-translate-x-full');
              overlay.classList.add('hidden');
            }
          }

          // --- è–ªè³‡è¨ˆç®—èˆ‡æ’åºæ ¸å¿ƒé‚è¼¯ ---
          // å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜è¨ˆç®—å¾Œçš„è–ªè³‡è³‡æ–™
          let _salaryData = [];
          // å…¨åŸŸè®Šæ•¸ï¼šç´€éŒ„ç›®å‰çš„æ’åºç‹€æ…‹ (key: æ¬„ä½, dir: 1 ç‚ºå‡å†ª, -1 ç‚ºé™å†ª)
          let _salarySortState = { key: 'date', dir: 1 };

          // 1. æ‰“é–‹è¦–çª— (ä¿®æ­£ç‰ˆï¼šé è¨­æœ¬æœˆ + é‡ç½®ç‹€æ…‹)
          function openSalaryModal() {
            if (!currentTid) return alert("è«‹å…ˆé¸æ“‡ä¸€ä½è€å¸«");

            const now = new Date();
            // â˜… ä¿®æ”¹é‡é»ï¼šé è¨­ç‚ºã€Œæœ¬æœˆã€1è™Ÿ åˆ°ã€Œæœ¬æœˆã€æœˆåº•
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0); // ä¸‹å€‹æœˆçš„ç¬¬ 0 å¤© = æœ¬æœˆæœ€å¾Œä¸€å¤©

            document.getElementById("salary-start-date").value = formatDate(start);
            document.getElementById("salary-end-date").value = formatDate(end);

            // é‡ç½®ç‹€æ…‹
            _salaryData = [];
            document.getElementById("salary-result").classList.add("hidden");
            document.getElementById("salary-modal").classList.remove("hidden");
          }

          // â˜… æ–°å¢ï¼šè‡ªå‹•é€£å‹•çµæŸæ—¥æœŸ (ç•¶èµ·å§‹æ—¥æ”¹è®Šæ™‚è§¸ç™¼)
          function autoUpdateEndDate(dateStr) {
            if (!dateStr) return;

            // 1. è§£æä½¿ç”¨è€…é¸çš„æ—¥æœŸ
            const startDate = new Date(dateStr);

            // 2. è¨ˆç®—è©²æœˆä»½çš„æœ€å¾Œä¸€å¤©
            // åŸç†ï¼šè¨­ç‚ºè©²æœˆä»½çš„ã€Œä¸‹å€‹æœˆã€çš„ç¬¬ 0 å¤©ï¼ŒJS æœƒè‡ªå‹•è·³å›ä¸Šå€‹æœˆæœ€å¾Œä¸€å¤©
            const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);

            // 3. å¡«å…¥çµæŸæ—¥æœŸæ¬„ä½
            document.getElementById("salary-end-date").value = formatDate(endDate);
          }

          function closeSalaryModal() {
            document.getElementById("salary-modal").classList.add("hidden");
          }

          // 2. åŸ·è¡Œè¨ˆç®— (ä¿®æ­£ç‰ˆï¼šæ”¯æ´ç•¶å¤©é‡‘é¡è¦†å¯«)
          async function calculateSalary() {
            const startStr = document.getElementById("salary-start-date").value;
            const endStr = document.getElementById("salary-end-date").value;

            if (!startStr || !endStr) return sysAlert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ", "è³‡æ–™ä¸é½Šå…¨");
            setStatus("æ­£åœ¨è¨ˆç®—è–ªè³‡...");

            try {
              const { data: records, error: rErr } = await _client.from("lesson_records")
                .select("*, schedules(course_name, amount, subject)").eq("teacher_id", currentTid).gte("actual_date", startStr).lte("actual_date", endStr);
              if (rErr) throw rErr;

              let totalSalary = 0; let totalCount = 0;
              _salaryData = records.map(r => {
                const isPayable = ['attended', 'status-present', 'absent', 'status-absent'].includes(r.status);
                const courseInfo = r.schedules || { course_name: '(æœªçŸ¥èª²ç¨‹)', amount: 0, subject: '' };
                let finalAmount = (r.actual_amount !== null && r.actual_amount !== undefined) ? r.actual_amount : (courseInfo.amount || 0);
                if (!isPayable) finalAmount = 0;
                if (isPayable) { totalSalary += finalAmount; totalCount++; }
                return { id: r.id, schedule_id: r.schedule_id, date: r.actual_date, course_name: courseInfo.course_name, subject: courseInfo.subject, status: r.status, amount: finalAmount, isPayable: isPayable };
              });

              document.getElementById("total-salary").textContent = `$${totalSalary.toLocaleString()}`;
              document.getElementById("total-count").textContent = `${totalCount} å ‚`;
              sortSalary('date');
              document.getElementById("salary-result").classList.remove("hidden");
              setStatus("è–ªè³‡è¨ˆç®—å®Œæˆ", "success");
            } catch (err) {
              console.error(err);
              setStatus("è¨ˆç®—å¤±æ•—", "error");
              await sysAlert("è¨ˆç®—å¤±æ•—ï¼š" + err.message, "ç³»çµ±éŒ¯èª¤");
            }
          }

          // 3. æ’åºè§¸ç™¼å™¨ (é»æ¨™é¡Œæ™‚å‘¼å«)
          function sortSalary(key) {
            // å¦‚æœé»æ“ŠåŒä¸€å€‹æ¬„ä½ï¼Œå°±åè½‰æ–¹å‘ï¼›å¦å‰‡é è¨­å‡å†ª
            if (_salarySortState.key === key) {
              _salarySortState.dir *= -1;
            } else {
              _salarySortState.key = key;
              _salarySortState.dir = 1; // é è¨­å‡å†ª (æ—¥æœŸå¾å°åˆ°å¤§)
              if (key === 'amount') _salarySortState.dir = -1; // é‡‘é¡é è¨­å¾å¤§åˆ°å°æ¯”è¼ƒç›´è¦º
            }

            // åŸ·è¡Œæ’åº
            _salaryData.sort((a, b) => {
              let valA, valB;

              if (key === 'date') {
                valA = a.date; valB = b.date;
              } else if (key === 'name') {
                valA = a.course_name; valB = b.course_name;
              } else if (key === 'amount') {
                valA = a.amount; valB = b.amount;
              } else if (key === 'status') {
                // ç‹€æ…‹è‡ªå®šç¾©æ¬Šé‡ï¼šä¸Šèª² > è«‹å‡ > æ› èª² > å…¶ä»–
                const statusRank = {
                  'attended': 1, 'status-present': 1,
                  'leave': 2, 'status-leave': 2,
                  'absent': 3, 'status-absent': 3
                };
                valA = statusRank[a.status] || 99;
                valB = statusRank[b.status] || 99;
              }

              if (valA < valB) return -1 * _salarySortState.dir;
              if (valA > valB) return 1 * _salarySortState.dir;
              return 0;
            });

            // é‡æ–°ç•«è¡¨æ ¼
            renderSalaryTable();
          }

          // 4. æ¸²æŸ“è¡¨æ ¼ HTML (ç´”ç²¹è² è²¬ç•«ç•«é¢)
          function renderSalaryTable() {
            const listBody = document.getElementById("salary-list");
            listBody.innerHTML = "";

            _salaryData.forEach(item => {
              // ç‹€æ…‹é¡¯ç¤ºæ–‡å­—èˆ‡é¡è‰²
              let statusText = '', statusColor = '';
              const s = item.status;

              if (['attended', 'status-present'].includes(s)) { statusText = 'âœ… ä¸Šèª²'; statusColor = 'text-green-600 bg-green-50'; }
              else if (['leave', 'status-leave'].includes(s)) { statusText = 'â˜• è«‹å‡'; statusColor = 'text-amber-600 bg-amber-50'; }
              else if (['absent', 'status-absent'].includes(s)) { statusText = 'âŒ æ› èª²'; statusColor = 'text-red-600 bg-red-50'; }
              else { statusText = 'å°šæœªé»å'; statusColor = 'text-gray-400'; }

              const row = `
          <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
            <td class="p-3 font-mono text-xs">${item.date.slice(5)}</td>
            <td class="p-3">
              <div class="font-bold text-gray-800">${item.course_name}</div>
              <div class="text-[10px] text-gray-400">${item.subject || ''}</div>
            </td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${statusText}</span>
            </td>
            <td class="p-3 text-right font-mono font-medium ${item.isPayable ? 'text-gray-800' : 'text-gray-300 line-through'}">
              $${item.amount}
            </td>
          </tr>
        `;
              listBody.innerHTML += row;
            });
          }

          // --- åŠŸèƒ½ Aï¼šè–ªè³‡çµç®—åŒ¯å‡º/åŒ¯å…¥ (åªæ”¹ç‹€æ…‹) ---

          // A1. åŒ¯å‡ºè–ªè³‡å ±è¡¨ (ä¿®æ­£ç‰ˆï¼šæ¨™ç¤ºå§“åä¸å¯ä¿®æ”¹)
          function exportDailyReport() {
            if (_salaryData.length === 0) return sysAlert("è«‹å…ˆæŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€ç”¢ç”Ÿè³‡æ–™ï¼", "å°šæœªè¨ˆç®—");

            const exportData = _salaryData.map(item => {
              let statusText = 'æœªçŸ¥';
              if (['attended', 'status-present'].includes(item.status)) statusText = 'ä¸Šèª²';
              else if (['leave', 'status-leave'].includes(item.status)) statusText = 'è«‹å‡';
              else if (['absent', 'status-absent'].includes(item.status)) statusText = 'æ› èª²';
              else statusText = 'å°šæœªé»å';

              return {
                "ç³»çµ±ç·¨è™Ÿ(è«‹å‹¿ä¿®æ”¹)": item.schedule_id,
                "æ—¥æœŸ(è«‹å‹¿ä¿®æ”¹)": item.date,
                "å­¸ç”Ÿå§“å(è«‹å‹¿ä¿®æ”¹)": item.course_name,
                "ç‹€æ…‹": statusText,
                "å‚™è¨»": "",
                "ç•¶æ—¥é‡‘é¡": item.isPayable ? item.amount : 0
              };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);

            // è¨­å®šæ¬„å¯¬
            const wscols = [
              { wch: 15 }, // ID
              { wch: 12 }, // æ—¥æœŸ
              { wch: 20 }, // å­¸ç”Ÿå§“å (ç¨å¾®åŠ å¯¬ä¸€é»ï¼Œå› ç‚ºæ¨™é¡Œè®Šé•·äº†)
              { wch: 10 }, // ç‹€æ…‹
              { wch: 20 }, // å‚™è¨»
              { wch: 12 }  // é‡‘é¡
            ];
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è–ªè³‡çµç®—");
            const teacherName = document.getElementById("main-title").textContent.split(' Â· ')[0] || "è€å¸«";
            XLSX.writeFile(wb, `${teacherName}_è–ªè³‡çµç®—è¡¨.xlsx`);
          }

          // A2. åŒ¯å…¥è–ªè³‡ä¿®æ­£ (ä¿®æ­£ç‰ˆï¼šè®€å–ä¸¦æ›´æ–°é‡‘é¡)
          async function handleImportDaily(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });

                const statusMap = { 'ä¸Šèª²': 'status-present', 'è«‹å‡': 'status-leave', 'æ› èª²': 'status-absent', 'å°šæœªé»å': 'status-pending' };
                const updates = [];

                for (const row of jsonRows) {
                  const sid = row["ç³»çµ±ç·¨è™Ÿ(è«‹å‹¿ä¿®æ”¹)"];
                  let date = row["æ—¥æœŸ(è«‹å‹¿ä¿®æ”¹)"];
                  const status = row["ç‹€æ…‹"];
                  const remark = row["å‚™è¨»"];
                  // â˜… è®€å–é‡‘é¡
                  const amount = row["ç•¶æ—¥é‡‘é¡"];

                  if (date && date.includes('/')) date = date.replace(/\//g, '-');
                  if (!sid || !date) continue;

                  updates.push({
                    schedule_id: sid,
                    teacher_id: currentTid,
                    actual_date: date,
                    status: statusMap[status] || 'status-pending',
                    remark: remark || "",
                    // â˜… å¯«å…¥é‡‘é¡ (è½‰æˆæ•´æ•¸ï¼Œå¦‚æœæ˜¯ NaN å‰‡å­˜ç‚º 0)
                    actual_amount: parseInt(amount) || 0
                  });
                }

                if (updates.length === 0) return alert("ç„¡æœ‰æ•ˆè³‡æ–™");
                setStatus(`æ­£åœ¨æ›´æ–° ${updates.length} ç­†ç´€éŒ„...`);

                const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });

                if (error) throw error;

                setStatus("è–ªè³‡èˆ‡é‡‘é¡æ›´æ–°æˆåŠŸï¼", "success");
                input.value = "";
                await calculateSalary(); // é‡æ–°è¨ˆç®—
                await refreshData();     // åˆ·æ–°èª²è¡¨

              } catch (err) {
                alert("åŒ¯å…¥å¤±æ•—: " + err.message);
              }
            };
            reader.readAsArrayBuffer(file);
          }

          // --- æ‰¹æ¬¡ç®¡ç†è¦–çª—æ§åˆ¶ ---
          function openBatchModal() {
            document.getElementById("batch-modal").classList.remove("hidden");
          }
          function closeBatchModal() {
            document.getElementById("batch-modal").classList.add("hidden");
          }

          // --- åŠŸèƒ½ B: æ¯ç‰ˆå…¨èƒ½åŒ¯å‡º/åŒ¯å…¥ ---

          // B1. åŒ¯å‡ºæ‰€æœ‰æ¬„ä½ (ç§»é™¤å¸¸é§å‚™è¨»ç‰ˆ)
          async function exportMasterData() {
            if (!currentTid) return alert("è«‹å…ˆé¸æ“‡è€å¸«");
            setStatus("æ­£åœ¨ç”¢ç”Ÿå®Œæ•´èª²è¡¨æª”...");

            const { data: courses } = await _client
              .from("schedules")
              .select("*")
              .eq("teacher_id", currentTid);

            if (!courses || courses.length === 0) return alert("è©²è€å¸«æ²’æœ‰èª²ç¨‹è³‡æ–™");

            const reverseStatusMap = {
              'status-present': 'ä¸Šèª²', 'status-leave': 'è«‹å‡', 'status-absent': 'æ› èª²',
              'status-practice': 'å­¸ç”Ÿç·´ç¿’', 'status-pending': 'å°šæœªé»å'
            };

            const exportData = courses.map(c => ({
              "å­¸ç”Ÿå§“å": c.course_name,
              "é›»è©±": c.phone || "",
              "ç§‘ç›®": c.subject || "",
              "é‡‘é¡": c.amount || 0,
              "æ˜ŸæœŸ(1-7)": c.day_of_week,
              "é–‹å§‹æ™‚é–“": c.start_time ? c.start_time.slice(0, 5) : "09:00",
              "çµæŸæ™‚é–“": c.end_time ? c.end_time.slice(0, 5) : "10:00",
              "æ•™å®¤": c.room_no || "",
              "é è¨­ç‹€æ…‹": reverseStatusMap[c.color_class] || "å°šæœªé»å",
              // â˜… å¢åŠ æ­¤ç›´æ¬„ï¼Œè®“æ‚¨å¯ä»¥åœ¨ Excel è£¡æ‰‹å‹•å°‡ã€Œæ˜¯ã€æ”¹æˆã€Œå¦ã€
              "åƒ…é™å–®å‘¨(æ˜¯/å¦)": c.is_temporary ? "æ˜¯" : "å¦"
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "èª²è¡¨ç®¡ç†");
            const teacherName = document.getElementById("main-title").textContent.split(' Â· ')[0];
            XLSX.writeFile(wb, `${teacherName}_å®Œæ•´èª²è¡¨ç®¡ç†.xlsx`);
          }

          // B2. åŒ¯å…¥åŠŸèƒ½ (çµ‚æ¥µæŠ“èŸ²è¿½è¹¤ç‰ˆ)
          async function handleImportMaster(input) {
            try {
              alert("ã€æª¢æŸ¥é» 1ã€‘æˆåŠŸå•Ÿå‹•å‡½å¼ï¼Œæº–å‚™æª¢æŸ¥è€å¸«èº«åˆ†ï¼");

              const file = input.files[0];
              if (!file) return;

              if (!currentTid) {
                alert("ã€çµ‚æ­¢ã€‘å·¦å´æ²’æœ‰é¸æ“‡è€å¸«ï¼");
                input.value = "";
                return;
              }

              const targetTeacherName = document.getElementById("main-title").textContent.split(' Â· ')[0] || "è©²è€å¸«";
              alert(`ã€æª¢æŸ¥é» 2ã€‘ç¢ºèªå°è±¡æ˜¯ï¼š${targetTeacherName}ã€‚æº–å‚™å‘¼å«ç¢ºèªè¦–çª—...`);

              // é€™è£¡æœƒå‘¼å«å¦³çš„é»ƒè‰²ç¢ºèªè¦–çª—
              const confirmRes = await sysConfirm(`ç¢ºå®šè¦æŠŠ Excel å…§å®¹å…¨éƒ¨è¤‡è£½çµ¦ <b class="text-blue-600">${targetTeacherName}</b> å—ï¼Ÿ`, "æ•´æ‰¹è¤‡è£½ç¢ºèª", "warning");

              if (!confirmRes) {
                input.value = "";
                return;
              }

              alert("ã€æª¢æŸ¥é» 3ã€‘ç¢ºèªå®Œç•¢ï¼æº–å‚™è®€å– Excel æª”æ¡ˆ...");

              const reader = new FileReader();
              reader.onload = async (e) => {
                try {
                  alert("ã€æª¢æŸ¥é» 4ã€‘Excel æª”æ¡ˆè®€å–æˆåŠŸï¼Œæº–å‚™é–‹å§‹æ‰¾å­—ï¼");

                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, { type: 'array' });

                  let jsonRows = [];
                  for (const sheetName of workbook.SheetNames) {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false });
                    if (rows.length > 0) {
                      jsonRows = rows;
                      break;
                    }
                  }

                  if (jsonRows.length === 0) {
                    alert("ã€å¤±æ•—ã€‘é€™ä»½ Excel è£¡é¢å¥½åƒæ˜¯ç©ºçš„ï¼Ÿ");
                    input.value = ""; return;
                  }

                  const updates = [];
                  const statusMap = { 'ä¸Šèª²': 'status-present', 'è«‹å‡': 'status-leave', 'æ› èª²': 'status-absent', 'å°šæœªé»å': 'status-pending', 'å­¸ç”Ÿç·´ç¿’': 'status-practice' };

                  const findVal = (row, keyword) => {
                    const key = Object.keys(row).find(k => k.replace(/\s+/g, '').includes(keyword));
                    return key ? row[key] : null;
                  };

                  for (const row of jsonRows) {
                    const sName = findVal(row, "å­¸ç”Ÿå§“å");
                    if (!sName) continue;

                    const formatTime = (t) => {
                      if (!t) return "09:00:00";
                      let time = String(t).trim();
                      // å¦‚æœåªæœ‰ HH:MMï¼Œè‡ªå‹•è£œä¸Š :00
                      const parts = time.split(':');
                      const h = parts[0].padStart(2, '0');
                      const m = (parts[1] || "00").padStart(2, '0');
                      return `${h}:${m}:00`;
                    };

                    updates.push({
                      teacher_id: currentTid,
                      course_name: String(sName).trim(),
                      phone: String(findVal(row, "é›»è©±") || ""),
                      subject: String(findVal(row, "ç§‘ç›®") || ""),
                      amount: parseInt(findVal(row, "é‡‘é¡")) || 0,
                      day_of_week: parseInt(findVal(row, "æ˜ŸæœŸ")) || 1,
                      start_time: formatTime(findVal(row, "é–‹å§‹æ™‚é–“")),
                      end_time: formatTime(findVal(row, "çµæŸæ™‚é–“")),
                      room_no: String(findVal(row, "æ•™å®¤") || ""),
                      color_class: statusMap[findVal(row, "é è¨­ç‹€æ…‹")] || 'status-pending',
                      is_temporary: String(findVal(row, "åƒ…é™æœ¬é€±")) === "æ˜¯"
                    });
                  }

                  alert(`ã€æª¢æŸ¥é» 5ã€‘è§£æå®Œæˆï¼å…±æ‰¾åˆ° ${updates.length} ç­†æœ‰æ•ˆèª²ç¨‹ã€‚æº–å‚™å­˜å…¥è³‡æ–™åº«...`);

                  if (updates.length === 0) {
                    const headers = Object.keys(jsonRows[0]).join(', ');
                    alert(`ã€å¤±æ•—ã€‘Excelæœ‰è³‡æ–™ï¼Œä½†æ‰¾ä¸åˆ°ã€Œå­¸ç”Ÿå§“åã€ï¼\næˆ‘çœ‹åˆ°çš„æ¨™é¡Œæœ‰ï¼š\n${headers}`);
                    input.value = ""; return;
                  }

                  const { error } = await _client.from("schedules").insert(updates);

                  if (error) throw error;

                  alert(`ã€æª¢æŸ¥é» 6ã€‘ğŸ‰ å¤§åŠŸå‘Šæˆï¼æˆåŠŸå¯«å…¥è³‡æ–™åº«ï¼`);
                  input.value = "";
                  closeBatchModal();
                  await refreshData();

                } catch (err) {
                  alert("ã€è‡´å‘½éŒ¯èª¤ (è§£æå­˜æª”æ™‚)ã€‘\n" + err.message);
                  input.value = "";
                }
              };
              reader.readAsArrayBuffer(file);

            } catch (err) {
              alert("ã€è‡´å‘½éŒ¯èª¤ (ä¸€é–‹å§‹)ã€‘\n" + err.message);
              input.value = "";
            }
          }

          // --- ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½ ---

          function openPasswordModal() {
            document.getElementById("password-modal").classList.remove("hidden");
          }

          function closePasswordModal() {
            document.getElementById("password-modal").classList.add("hidden");
            document.getElementById("new-password").value = "";
          }

          async function handleUpdatePassword() {
            const newPwd = document.getElementById("new-password").value;

            if (newPwd.length < 6) {
              await sysAlert("ç‚ºäº†å®‰å…¨ï¼Œå¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 ä½æ•¸å”·ï¼", "å¯†ç¢¼å¤ªçŸ­");
              return;
            }

            const { data, error } = await _client.auth.updateUser({ password: newPwd });

            if (error) {
              await sysAlert("è®Šæ›´å¤±æ•—ï¼š" + error.message, "ç³»çµ±éŒ¯èª¤");
            } else {
              await sysAlert("å¯†ç¢¼è®Šæ›´æˆåŠŸï¼<br>ä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚", "è®Šæ›´æˆåŠŸ");
              closePasswordModal();
            }
          }

          // --- è£œä¸Šç¼ºå¤±çš„å‚™è¨»åŠŸèƒ½é‚è¼¯ (å‡ç´šç‰ˆï¼šæ™ºæ…§åµæ¸¬å‚™è¨»ç¯„åœ) ---
          let remarkTargetId = null;
          let remarkTargetWeekDay = null;

          // â˜… é—œéµä¿®æ”¹ 1ï¼šå‰é¢åŠ ä¸Š asyncï¼Œå› ç‚ºæˆ‘å€‘è¦å»è³‡æ–™åº«æŸ¥ç¯„åœ
          async function openRemarkModal(id, dateStr) {
            remarkTargetId = id;
            const master = _cachedSchedule.find(s => s.id === id);
            if (master) remarkTargetWeekDay = master.day_of_week;

            const record = _cachedRecords.find(r => r.schedule_id === id && r.actual_date === dateStr);
            const currentRemark = record ? record.remark : "";

            // é è¨­æ—¥æœŸç‚ºé»æ“Šçš„ç•¶å¤©
            let detectedStart = dateStr;
            let detectedEnd = dateStr;

            // â˜… é—œéµä¿®æ”¹ 2ï¼šå¦‚æœé€™å ‚èª²ç›®å‰æœ‰å‚™è¨»ï¼Œå»è³‡æ–™åº«æ‰¾å‡ºå®ƒçš„é ­è·Ÿå°¾
            if (currentRemark) {
              setStatus("æ­£åœ¨åµæ¸¬å‚™è¨»ç¯„åœ...");

              // å°‹æ‰¾ç›¸åŒ schedule_id ä¸”å‚™è¨»å…§å®¹å®Œå…¨ä¸€æ¨£çš„æ‰€æœ‰ç´€éŒ„
              const { data, error } = await _client
                .from("lesson_records")
                .select("actual_date")
                .eq("schedule_id", id)
                .eq("remark", currentRemark)
                .order("actual_date", { ascending: true }); // ç…§æ—¥æœŸå¾å°æ’åˆ°å¤§

              if (!error && data && data.length > 0) {
                detectedStart = data[0].actual_date; // ç¬¬ä¸€ç­†å°±æ˜¯é–‹å§‹æ—¥
                detectedEnd = data[data.length - 1].actual_date; // æœ€å¾Œä¸€ç­†å°±æ˜¯çµæŸæ—¥
              }
              setStatus("å°±ç·’", "success");
            }

            // è‡ªå‹•å¡«å…¥åµæ¸¬åˆ°çš„æ—¥æœŸèˆ‡å‚™è¨»å…§å®¹
            document.getElementById("remark-start-date").value = detectedStart;
            document.getElementById("remark-end-date").value = detectedEnd;
            document.getElementById("quick-remark-input").value = currentRemark;

            document.getElementById("remark-modal").classList.remove("hidden");
          }

          function closeRemarkModal() {
            document.getElementById("remark-modal").classList.add("hidden");
          }

          // --- å¿«é€Ÿå‚™è¨»åŠŸèƒ½ (ä¿®æ­£ç‰ˆï¼šæ”¯æ´æ¸…ç©º) ---
          async function saveQuickRemark(forceClear = false) {
            if (!remarkTargetId) return;
            const text = forceClear ? "" : document.getElementById("quick-remark-input").value;
            const startStr = document.getElementById("remark-start-date").value;
            const endStr = document.getElementById("remark-end-date").value;

            if (!startStr || !endStr) {
              await sysAlert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ", "è³‡æ–™ä¸å®Œæ•´");
              return;
            }
            if (startStr > endStr) {
              await sysAlert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ", "æ—¥æœŸéŒ¯èª¤");
              return;
            }

            setStatus(forceClear ? "æ­£åœ¨æ¸…ç©ºå‚™è¨»..." : "æ­£åœ¨å„²å­˜å‚™è¨»...");
            const updates = [];
            let loopDate = new Date(startStr);
            const endDate = new Date(endStr);

            while (loopDate <= endDate) {
              let day = loopDate.getDay();
              if (day === 0) day = 7;
              if (day === remarkTargetWeekDay) {
                const dStr = formatDate(loopDate);
                const exist = _cachedRecords.find(r => r.schedule_id === remarkTargetId && r.actual_date === dStr);
                const master = _cachedSchedule.find(s => s.id === remarkTargetId);
                const status = exist ? exist.status : (master.color_class || 'status-pending');
                updates.push({ schedule_id: remarkTargetId, teacher_id: currentTid, actual_date: dStr, status: status, remark: text });
              }
              loopDate.setDate(loopDate.getDate() + 1);
            }

            if (updates.length === 0) {
              await sysAlert("ç¯„åœå…§æ²’æœ‰é€™å ‚èª²çš„æ’ç¨‹", "ç„¡æ•ˆçš„æ—¥æœŸç¯„åœ");
              setStatus("ç„¡è³‡æ–™æ›´æ–°", "warn");
              return;
            }

            const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });

            if (error) {
              await sysAlert("æ“ä½œå¤±æ•—: " + error.message, "ç³»çµ±éŒ¯èª¤");
              setStatus("æ“ä½œå¤±æ•—", "error");
            } else {
              setStatus(forceClear ? "å‚™è¨»å·²æ¸…ç©º" : "å‚™è¨»å·²æ›´æ–°", "success");
              closeRemarkModal();
              await refreshData();
            }
          }

          // --- è¶…ç´šç®¡ç†å“¡æ§åˆ¶å°é‚è¼¯ ---
          let _allSchedulesForAdmin = [];

          function openAdminModal() {
            document.getElementById("admin-modal").classList.remove("hidden");

            // 1. åˆå§‹åŒ–æ—¥æœŸ (æœ¬æœˆ)
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            const startInput = document.getElementById("stat-start");
            const endInput = document.getElementById("stat-end");
            // é˜²å‘†ï¼šç¢ºä¿å…ƒç´ å­˜åœ¨æ‰è³¦å€¼ (é¿å…å ±éŒ¯)
            if (startInput) startInput.value = formatDate(start);
            if (endInput) endInput.value = formatDate(end);

            // 2. â˜… é—œéµä¿®æ­£ï¼šä¸€æ‰“é–‹è¦–çª—ï¼Œé¦¬ä¸Šè¼‰å…¥è€å¸«åå–®ï¼
            populateStatTeacherFilter();

            // 3. é è¨­æ‰“é–‹é€šè¨ŠéŒ„é ç±¤
            switchAdminTab('directory');
          }

          function closeAdminModal() {
            document.getElementById("admin-modal").classList.add("hidden");
          }

          function switchAdminTab(tabName) {
            // 1. UI åˆ‡æ› (æŒ‰éˆ•è®Šè‰²)
            document.querySelectorAll('.admin-tab').forEach(b => {
              b.classList.remove('text-white', 'border-white', 'bg-neutral-700');
              b.classList.add('text-gray-300', 'border-transparent');
            });
            document.getElementById(`tab-btn-${tabName}`).classList.add('text-white', 'border-white', 'bg-neutral-700');
            document.getElementById(`tab-btn-${tabName}`).classList.remove('text-gray-300', 'border-transparent');

            // å…§å®¹åˆ‡æ›
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

            // 2. è³‡æ–™è¼‰å…¥
            if (tabName === 'directory') loadDirectoryData();
            if (tabName === 'teachers') renderTeacherManageList();
            // â˜… åŠ ä¸Šé€™è¡Œï¼š
            if (tabName === 'logs') loadLogs();
          }

          // --- Tab 1: é€šè¨ŠéŒ„ ---
          async function loadDirectoryData() {
            setStatus("å»ºç«‹é€šè¨ŠéŒ„...");
            const { data, error } = await _client.from("schedules").select("*, teachers(name)");
            if (error) return;
            _allSchedulesForAdmin = data;
            renderDirectory();
            setStatus("å°±ç·’", "success");
          }

          // --- é€šè¨ŠéŒ„æ’åºç‹€æ…‹ ---
          let _dirSortState = { key: 'name', dir: 1 }; // é è¨­ä¾å§“åå‡å†ª

          function sortDirectory(key) {
            if (_dirSortState.key === key) {
              _dirSortState.dir *= -1; // åŒæ¬„ä½é»å…©æ¬¡ -> åè½‰é †åº
            } else {
              _dirSortState.key = key;
              _dirSortState.dir = 1;   // æ–°æ¬„ä½ -> é è¨­å‡å†ª
            }
            renderDirectory(); // é‡æ–°æ•´ç†ç•«é¢
          }

          // --- Tab 1: é€šè¨ŠéŒ„ (çµ‚æ¥µç‰ˆï¼šæ”¯æ´å¤šé›»è©±ç¨ç«‹é»æ“Šè¤‡è£½) ---
          function renderDirectory() {
            const keyword = document.getElementById("dir-search").value.toLowerCase();
            const listBody = document.getElementById("directory-list");
            listBody.innerHTML = "";

            // 1. éæ¿¾èˆ‡å»é‡
            const uniqueMap = new Map();
            _allSchedulesForAdmin.forEach(s => {
              const key = `${s.course_name}-${s.phone}`;
              const match = (s.course_name || "").toLowerCase().includes(keyword) ||
                (s.phone || "").includes(keyword) ||
                (s.subject || "").toLowerCase().includes(keyword);

              if (match && !uniqueMap.has(key)) uniqueMap.set(key, s);
            });

            // 2. æ’åº
            let list = Array.from(uniqueMap.values());
            list.sort((a, b) => {
              let valA = "", valB = "";
              const k = _dirSortState.key;
              if (k === 'name') { valA = a.course_name || ""; valB = b.course_name || ""; }
              else if (k === 'phone') { valA = a.phone || ""; valB = b.phone || ""; }
              else if (k === 'subject') { valA = a.subject || ""; valB = b.subject || ""; }
              else if (k === 'teacher') { valA = a.teachers?.name || ""; valB = b.teachers?.name || ""; }
              return valA.localeCompare(valB, "zh-Hant") * _dirSortState.dir;
            });

            // 3. æ¸²æŸ“
            list.forEach(s => {
              const teacherName = s.teachers ? s.teachers.name : "æœªçŸ¥";
              const name = s.course_name || "";
              const subject = s.subject || "-";
              const tName = teacherName || "";

              // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šå°‡æ¯ä¸€æ”¯é›»è©±åŒ…è£æˆç¨ç«‹ã€å¯é»æ“Šçš„å€å¡Š â˜…â˜…â˜…
              const phoneRaw = s.phone || "";
              const phoneList = phoneRaw.split(/\s+/).filter(p => p.trim() !== "");

              let phoneHtml = "-";
              if (phoneList.length > 0) {
                // ç‚ºæ¯å€‹é›»è©±è™Ÿç¢¼åŠ ä¸Šç¨ç«‹çš„ onclick äº‹ä»¶èˆ‡ hover æ•ˆæœ
                phoneHtml = phoneList.map(p => `
                <div class="cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-colors py-1 px-2 -mx-2 rounded"
                     onclick="copyToClipboard('${p}', this)" title="è¤‡è£½æ­¤é›»è©±">
                    ${p}
                </div>
            `).join('');
              }

              const row = `
                <tr class="border-b border-gray-100 transition-colors">
                    <td class="p-4 font-bold text-neutral-800 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 align-top" 
                        onclick="copyToClipboard('${name}', this)" title="è¤‡è£½å§“å">${name}</td>
                    
                    <td class="p-4 font-mono text-gray-600 align-top">
                        ${phoneHtml}
                    </td>
                    
                    <td class="p-4 text-gray-600 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 align-top" 
                        onclick="copyToClipboard('${subject}', this)" title="è¤‡è£½ç§‘ç›®">${subject}</td>
                    
                    <td class="p-4 text-xs text-gray-500 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 align-top"
                        onclick="copyToClipboard('${tName}', this)" title="è¤‡è£½è€å¸«">
                        <span class="bg-gray-100 px-2 py-1 rounded-full pointer-events-none">${tName}</span>
                    </td>
                </tr>`;
              listBody.innerHTML += row;
            });
            lucide.createIcons();
          }

          // --- è¤‡è£½åŠŸèƒ½ (å‡ç´šç‰ˆï¼šç›´æ¥åœ¨æ ¼å­å…§é¡¯ç¤ºæç¤º) ---
          function copyToClipboard(text, element) {
            if (!text || text === '-') return;
            navigator.clipboard.writeText(text).then(() => {
              if (element) {
                element.classList.add('relative');
                const existingBadge = element.querySelector('.copy-badge');
                if (existingBadge) existingBadge.remove();
                const badge = document.createElement('div');
                badge.className = 'copy-badge absolute inset-0 flex items-center justify-center bg-neutral-800/90 text-white text-xs font-bold rounded opacity-0 transition-opacity duration-200 z-10 pointer-events-none';
                badge.innerHTML = `<span class="flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> å·²è¤‡è£½!</span>`;
                element.appendChild(badge);
                lucide.createIcons();
                requestAnimationFrame(() => badge.classList.remove('opacity-0'));
                setTimeout(() => {
                  badge.classList.add('opacity-0');
                  setTimeout(() => badge.remove(), 200);
                }, 800);
              }
            }).catch(err => {
              console.error('è¤‡è£½å¤±æ•—', err);
              sysAlert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", "ç³»çµ±æç¤º");
            });
          }

          // å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ (å¦‚æœå‰é¢å·²ç¶“å®£å‘Šéï¼Œé€™è¡Œå¯ä»¥çœç•¥ï¼Œä½†å¤šå¯«ç„¡å¦¨)
          let _allStudentsCache = [];

          // --- è¼‰å…¥è€å¸«åå–®åˆ°çµ±è¨ˆé¸å–® (ä¿®æ­£ç‰ˆï¼šåŒæ™‚é è¼‰å­¸ç”Ÿè³‡æ–™) ---
          async function populateStatTeacherFilter() {
            const select = document.getElementById("stat-teacher");
            if (!select) return;

            // 1. è¼‰å…¥è€å¸«åå–®
            if (select.options.length <= 1) { // åªæœ‰ç•¶é¸å–®é‚„æ²’è¼‰å…¥éæ™‚æ‰è·‘
              console.log("æ­£åœ¨è¼‰å…¥è€å¸«åå–®...");
              const { data, error } = await _client.from("teachers").select("id, name, is_hidden").order("name");

              if (error) console.error("è€å¸«åå–®è¼‰å…¥å¤±æ•—:", error);

              if (data) {
                data.forEach(t => {
                  if (t.is_hidden) return; // éš±è—ç®¡ç†å“¡
                  const opt = document.createElement("option");
                  opt.value = t.id;
                  opt.textContent = t.name;
                  select.appendChild(opt);
                });
              }
            }

            // 2. â˜… æ–°å¢é€™æ®µï¼šé è¼‰æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ (ç‚ºäº†çµ¦ä¸‹æ‹‰é¸å–®ç”¨)
            // æˆ‘å€‘åªéœ€è¦ Course Name (å­¸ç”Ÿå§“å) å’Œ Teacher ID (ç‚ºäº†é€£å‹•ç¯©é¸)
            console.log("æ­£åœ¨å¿«å–å­¸ç”Ÿåå–®...");
            const { data: schedules } = await _client.from("schedules").select("course_name, teacher_id");

            if (schedules) {
              _allStudentsCache = schedules; // å­˜åˆ°è¨˜æ†¶é«”

              // â˜… é—œéµï¼šè³‡æ–™æŠ“å®Œå¾Œï¼Œç«‹åˆ»å‘¼å«æ›´æ–°å‡½å¼ï¼Œå¡«æ»¿å­¸ç”Ÿé¸å–®ï¼
              if (typeof updateStudentList === 'function') {
                updateStudentList();
              }
            }
          }

          // --- 2. çµ±è¨ˆè¨ˆç®— (ç¶­æŒä¸è®Šï¼Œåªè¦ç¢ºèªé‚è¼¯é‚„åœ¨å³å¯) ---
          async function calculateStats() {
            const start = document.getElementById("stat-start").value;
            const end = document.getElementById("stat-end").value;
            const teacherId = document.getElementById("stat-teacher").value;
            const studentName = document.getElementById("stat-student").value.trim();

            if (!start || !end) return sysAlert("è«‹é¸æ“‡æ—¥æœŸç¯„åœ", "è³‡æ–™ä¸é½Šå…¨");
            setStatus("æ­£åœ¨åˆ†ææ•¸æ“š...");

            let query = _client.from("lesson_records").select("status, teacher_id, schedules(course_name)").gte("actual_date", start).lte("actual_date", end);
            if (teacherId !== 'all') query = query.eq("teacher_id", teacherId);

            const { data, error } = await query;
            if (error) return sysAlert("åˆ†æå¤±æ•—", "ç³»çµ±éŒ¯èª¤");

            let filteredData = data;
            if (studentName) filteredData = data.filter(r => (r.schedules ? r.schedules.course_name : "") === studentName);

            const total = filteredData.length;
            if (total === 0) {
              document.getElementById("stat-details").innerHTML = `<p class="text-center text-gray-400 text-sm py-10">æ­¤ç¯„åœå…§æ²’æœ‰ä»»ä½•ç´€éŒ„</p>`;
              return;
            }

            let c = { 'present': 0, 'leave': 0, 'absent': 0, 'pending': 0 };
            filteredData.forEach(r => {
              if (['attended', 'status-present'].includes(r.status)) c.present++;
              else if (['leave', 'status-leave'].includes(r.status)) c.leave++;
              else if (['absent', 'status-absent'].includes(r.status)) c.absent++;
              else c.pending++;
            });

            const p1 = (c.present / total) * 100, p2 = p1 + (c.leave / total) * 100, p3 = p2 + (c.absent / total) * 100;
            document.getElementById("stat-pie-chart").style.background = `conic-gradient(#22c55e 0% ${p1}%, #fbbf24 ${p1}% ${p2}%, #ef4444 ${p2}% ${p3}%, #d1d5db ${p3}% 100%)`;
            document.getElementById("stat-total-lessons").textContent = total;
            document.getElementById("label-present").textContent = Math.round((c.present / total) * 100) + "%";
            document.getElementById("label-leave").textContent = Math.round((c.leave / total) * 100) + "%";
            document.getElementById("label-absent").textContent = Math.round((c.absent / total) * 100) + "%";

            document.getElementById("stat-details").innerHTML = `
        <div class="flex justify-between p-2 bg-green-50 rounded border border-green-100"><span class="text-green-800 font-bold">âœ… æ­£å¸¸ä¸Šèª²</span><span class="font-mono font-bold">${c.present}</span></div>
        <div class="flex justify-between p-2 bg-amber-50 rounded border border-amber-100"><span class="text-amber-800 font-bold">â˜• è«‹å‡</span><span class="font-mono font-bold">${c.leave}</span></div>
        <div class="flex justify-between p-2 bg-red-50 rounded border border-red-100"><span class="text-red-800 font-bold">âŒ æ› èª²</span><span class="font-mono font-bold">${c.absent}</span></div>
        <div class="flex justify-between p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-600 font-bold">â¬œ å°šæœªé»å</span><span class="font-mono font-bold">${c.pending}</span></div>
      `;
            setStatus(`åˆ†æå®Œæˆï¼šå…± ${total} ç­†`, "success");
          }

          // å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜ç›®å‰ã€Œç¬¦åˆè€å¸«æ¢ä»¶ã€çš„æ‰€æœ‰å­¸ç”Ÿ
          let _currentAvailableStudents = [];

          // --- 1. æ›´æ–°å­¸ç”Ÿè³‡æ–™ä¾†æº (ç•¶åˆ‡æ›è€å¸«æ™‚è§¸ç™¼) ---
          function updateStudentList() {
            const teacherId = document.getElementById("stat-teacher").value;
            const input = document.getElementById("stat-student");

            // æ¸…ç©ºç›®å‰çš„è¼¸å…¥
            input.value = "";
            toggleClearBtn(false);

            // 1. éæ¿¾å‡ºè©²è€å¸«çš„å­¸ç”Ÿ
            let filteredSchedules = _allStudentsCache;
            if (teacherId !== 'all') {
              filteredSchedules = _allStudentsCache.filter(s => s.teacher_id === teacherId);
            }

            // 2. æå–ä¸é‡è¤‡çš„å­¸ç”Ÿå§“å
            const uniqueNames = new Set(filteredSchedules.map(s => s.course_name));

            // 3. è½‰æˆé™£åˆ—ä¸¦æ’åº (æŒ‰ç­†ç•«)
            _currentAvailableStudents = Array.from(uniqueNames).sort((a, b) => {
              return (a || "").localeCompare(b || "", "zh-Hant");
            });

            // 4. é‡ç½®é¸å–®é¡¯ç¤º
            filterStudentList("");
          }

          // --- 2. éæ¿¾ä¸¦æ¸²æŸ“ä¸‹æ‹‰æ¸…å–® (æ‰“å­—æ™‚è§¸ç™¼) ---
          function filterStudentList(keyword) {
            const listEl = document.getElementById("student-dropdown-list");
            const clearBtn = document.getElementById("clear-student-btn");

            // æ§åˆ¶æ¸…é™¤æŒ‰éˆ•é¡¯ç¤º
            toggleClearBtn(keyword.length > 0);

            // é€™è£¡åšç°¡å–®çš„éæ¿¾
            const matches = _currentAvailableStudents.filter(name =>
              (name || "").toLowerCase().includes(keyword.toLowerCase())
            );

            listEl.innerHTML = "";

            if (matches.length === 0) {
              listEl.innerHTML = `<li class="p-3 text-sm text-gray-400 text-center">æ‰¾ä¸åˆ°ç›¸ç¬¦å­¸ç”Ÿ</li>`;
            } else {
              matches.forEach(name => {
                const li = document.createElement("li");
                li.className = "p-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-colors flex items-center gap-2";
                // è®“æœå°‹å­—è®Šç²—é«” (é¸ç”¨)
                const highlightedName = keyword ? name.replace(new RegExp(keyword, 'gi'), match => `<b class="text-blue-600">${match}</b>`) : name;

                li.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span> <span>${highlightedName}</span>`;

                // ç¶å®šé»æ“Šäº‹ä»¶
                li.onclick = () => selectStudent(name);
                listEl.appendChild(li);
              });
            }
          }

          // --- 3. é¡¯ç¤ºé¸å–® ---
          function showStudentList() {
            document.getElementById("student-dropdown-list").classList.remove("hidden");
            // å¦‚æœè¼¸å…¥æ¡†æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºå…¨éƒ¨
            const currentVal = document.getElementById("stat-student").value;
            filterStudentList(currentVal);
          }

          // --- 4. é¸æ“‡å­¸ç”Ÿ ---
          function selectStudent(name) {
            const input = document.getElementById("stat-student");
            input.value = name;
            toggleClearBtn(true);

            // éš±è—é¸å–®
            document.getElementById("student-dropdown-list").classList.add("hidden");
          }

          // --- 5. æ¸…é™¤æœå°‹ ---
          function clearStudentSearch() {
            const input = document.getElementById("stat-student");
            input.value = "";
            input.focus();
            toggleClearBtn(false);
            filterStudentList("");
          }

          function toggleClearBtn(show) {
            const btn = document.getElementById("clear-student-btn");
            if (btn) {
              if (show) btn.classList.remove("hidden");
              else btn.classList.add("hidden");
            }
          }

          // --- 6. é»æ“Šå¤–éƒ¨é—œé–‰é¸å–® (UX å„ªåŒ–) ---
          document.addEventListener('click', function (e) {
            const container = document.querySelector('#tab-content-stats .relative.group');
            const listEl = document.getElementById("student-dropdown-list");

            // å¦‚æœé»æ“Šçš„åœ°æ–¹ä¸åœ¨æœå°‹æ¡†ç¯„åœå…§ï¼Œå°±é—œé–‰é¸å–®
            if (container && !container.contains(e.target) && listEl && !listEl.classList.contains('hidden')) {
              listEl.classList.add('hidden');
            }
          });

          // --- æ¬Šé™è¨­å®šé‚è¼¯ (å´é‚Šæ¬„å¯è¦‹åå–®) ---
          let editingPermTeacherId = null;

          function openPermissionsModal(teacherId) {
            editingPermTeacherId = teacherId;
            const targetTeacher = allTeachers.find(t => t.id === teacherId);
            if (!targetTeacher) return;

            // è¨­å®šæ¨™é¡Œ
            document.getElementById('perm-modal-title').innerHTML = `<i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> è¨­å®šã€${targetTeacher.name}ã€‘çš„å¯è¦‹åå–®`;

            const listContainer = document.getElementById('perm-checkbox-list');
            listContainer.innerHTML = '';

            // å–å‡ºé€™åè€å¸«åŸæœ¬å°±è¨­å®šå¥½çš„å¯è¦‹åå–® (å¦‚æœæ˜¯ null å°±çµ¦ç©ºé™£åˆ—)
            const viewableArr = targetTeacher.viewable_teachers ? targetTeacher.viewable_teachers.split(',') : [];

            // ç”¢ç”Ÿæ‰€æœ‰è€å¸«çš„æ‰“å‹¾é¸é …
            allTeachers.forEach(t => {
              // éš±è—ç®¡ç†å“¡ (ä¸Šä¸€å‹•åŠ çš„)
              if (t.is_hidden) return;

              // é è¨­è‡ªå·±ä¸€å®šçœ‹å¾—åˆ°è‡ªå·±ï¼Œæˆ–æ˜¯è¢«å‹¾é¸çš„äºº
              const isSelf = t.id === teacherId;
              const isChecked = viewableArr.includes(String(t.id)) || isSelf;

              // â˜… é—œéµé€²åŒ–ï¼šæŠŠå¤–å±¤çš„ div æ›æˆäº† labelï¼Œä¸ç”¨å¯« onclick ä¹Ÿèƒ½å…¨å€æ„Ÿæ‡‰ï¼
              const labelRow = document.createElement('label');
              // åŠ å…¥ select-none é˜²æ­¢é€£é»æ™‚åç™½æ–‡å­—
              labelRow.className = `flex items-center gap-3 p-3 rounded-lg transition-colors select-none ${isSelf ? 'bg-blue-50/50 cursor-not-allowed' : 'hover:bg-gray-50 cursor-pointer'}`;

              labelRow.innerHTML = `
            <input type="checkbox" id="perm_${t.id}" value="${t.id}" 
                   class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 ${isSelf ? 'cursor-not-allowed' : 'cursor-pointer'}" 
                   ${isChecked ? 'checked' : ''} 
                   ${isSelf ? 'disabled' : ''}>
            <div class="flex-1 flex items-center gap-2 text-sm font-bold text-gray-700">
                ${t.name}
                ${isSelf ? '<span class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">æœ¬äºº (å¼·åˆ¶é¡¯ç¤º)</span>' : ''}
            </div>
        `;

              // æŠŠé€™ä¸€è¡ŒåŠ é€²æ¸…å–®è£¡
              listContainer.appendChild(labelRow);
            });

            document.getElementById('permissions-modal').classList.remove('hidden');
            lucide.createIcons();
          }

          function closePermissionsModal() {
            document.getElementById('permissions-modal').classList.add('hidden');
          }

          // ==========================================
          // ğŸŒŸ ç›®æ¨™äºŒï¼šä¸Šå¸è¦–è§’æ“ä½œæ—¥èªŒèˆ‡å¾©åŸç³»çµ± (çµ•å°é˜²ç¦¦ç‰ˆ)
          // ==========================================

          // 1. æ ¸å¿ƒæ©Ÿå™¨äºº (å¢åŠ éš±å½¢æ–—ç¯·)
          async function recordLog(actionType, description, targetTable, oldData, newData) {
            if (!currentUserInfo) return;

            // â˜… éš±å½¢æ–—ç¯·ï¼šå¦‚æœæ˜¯é–‹ç™¼è€…å¸³è™Ÿ (Ccy)ï¼Œå°±ç›´æ¥ç•¶ä½œæ²’çœ‹åˆ°ï¼Œä¸å­˜å…¥è³‡æ–™åº«ï¼
            // (åŠ ä¸Šè½‰å°å¯« toLowerCase() é¿å…å¤§å°å¯«æ‰“éŒ¯)
            if (currentUserInfo.name.toLowerCase() === 'Ccy') return;

            try {
              const { error } = await _client.from('action_logs').insert([{
                actor_name: currentUserInfo.name,
                action_type: actionType,
                description: description,
                target_table: targetTable,
                old_data: oldData || null,
                new_data: newData || null
              }]);

              if (error) {
                console.error("ğŸš¨ Supabase å¯«å…¥æ—¥èªŒå¤±æ•—:", error.message);
              }
            } catch (err) {
              console.error("ğŸš¨ å¯«å…¥æ—¥èªŒç™¼ç”Ÿä¾‹å¤–éŒ¯èª¤:", err);
            }
          }

          // 2. è®€å–ä¸¦ç•«å‡ºæ—¥èªŒç•«é¢ (éš±è—é–‹ç™¼è€…æ­·å²ç´€éŒ„)
          async function loadLogs() {
            const list = document.getElementById("logs-list");
            list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i> è®€å–å¤©çœ¼ä¸­...</td></tr>`;
            lucide.createIcons();

            // â˜… åŠ ä¸Š .neq('actor_name', 'Ccy')ï¼ŒæŠŠ ccy çš„ç´€éŒ„ç›´æ¥æ’é™¤åœ¨ç•«é¢å¤–ï¼
            const { data, error } = await _client
              .from('action_logs')
              .select('*')
              .neq('actor_name', 'Ccy')
              .order('created_at', { ascending: false })
              .limit(100);

            if (error) {
              list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500 font-bold">è¼‰å…¥å¤±æ•—ï¼š${error.message}</td></tr>`;
              return;
            }

            if (!data || data.length === 0) {
              list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">ç›®å‰æ²’æœ‰ä»»ä½•æ“ä½œç´€éŒ„</td></tr>`;
              return;
            }

            list.innerHTML = "";
            data.forEach(log => {
              const d = new Date(log.created_at);
              const timeStr = `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;

              // ä½¿ç”¨å®‰å…¨çš„é€šç”¨é¡è‰²ï¼Œé¿å… Tailwind CDN æ¼æŠ“
              let badgeColor = "border-gray-200 text-gray-600 bg-gray-50";
              if (log.action_type.includes('æ–°å¢')) badgeColor = "border-green-200 text-green-700 bg-green-50";
              if (log.action_type.includes('ä¿®æ”¹') || log.action_type.includes('é»å')) badgeColor = "border-blue-200 text-blue-700 bg-blue-50";
              if (log.action_type.includes('åˆªé™¤')) badgeColor = "border-red-200 text-red-700 bg-red-50";

              const canUndo = log.old_data && (log.action_type.includes('ä¿®æ”¹') || log.action_type.includes('åˆªé™¤') || log.action_type.includes('é»å'));

              const row = document.createElement("tr");
              row.className = "hover:bg-blue-50/50 transition-colors";
              row.innerHTML = `
          <td class="p-4 text-xs font-mono text-gray-500 whitespace-nowrap">${timeStr}</td>
          <td class="p-4 font-bold text-neutral-800 whitespace-nowrap">${log.actor_name || 'æœªçŸ¥'}</td>
          <td class="p-4 whitespace-nowrap"><span class="px-2 py-1 rounded text-[10px] font-bold border ${badgeColor}">${log.action_type}</span></td>
          <td class="p-4 text-xs text-gray-700 leading-relaxed">${log.description}</td>
          <td class="p-4 text-center whitespace-nowrap">
              ${canUndo ? `
                  <button onclick="executeUndo('${log.id}')" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 hover:text-amber-600 hover:border-amber-400 hover:bg-amber-50 rounded shadow-sm text-xs font-bold transition-all active:scale-95 flex items-center justify-center gap-1 mx-auto">
                      <i data-lucide="undo-2" class="w-3.5 h-3.5"></i> å¾©åŸ
                  </button>
              ` : `<span class="text-xs text-gray-300">-</span>`}
          </td>
        `;
              list.appendChild(row);
            });
            lucide.createIcons();
          }

          // ==========================================
          // ğŸŒŸ ç²¾ç·»ç‰ˆå¾©åŸç³»çµ± UI æ§åˆ¶èˆ‡åŸ·è¡Œ
          // ==========================================

          // æš«å­˜è¦å¾©åŸçš„æ—¥èªŒè³‡æ–™
          let pendingUndoLogId = null;
          let pendingUndoLogData = null;

          // 1. è®€å–ä¸¦æ‰“é–‹æ¼‚äº®è¦–çª— (çµ‚æ¥µç‰ˆï¼šåŠ ä¸Šèª²ç¨‹åŸæ™‚æ®µèˆ‡æ“ä½œäººæ™‚é–“)
          async function executeUndo(logId) {
            setStatus("æ­£åœ¨è®€å–å¾©åŸè³‡è¨Š...");
            const { data: log, error: fetchErr } = await _client.from('action_logs').select('*').eq('id', logId).single();

            if (fetchErr || !log) {
              setStatus("è®€å–å¤±æ•—", "error");
              return sysAlert("æ‰¾ä¸åˆ°æ—¥èªŒï¼Œå¯èƒ½å·²ç¶“å¤±æ•ˆæˆ–å·²è¢«å¾©åŸéäº†ï¼", "è®€å–å¤±æ•—");
            }

            // ... å¾Œé¢çš„ UI æ¸²æŸ“ä¿æŒåŸæ¨£
            pendingUndoLogId = logId;
            pendingUndoLogData = log;
            const titleEl = document.getElementById('undo-modal-title');
            const contentEl = document.getElementById('undo-modal-content');
            const warningEl = document.getElementById('undo-modal-warning');

            let scheduleInfoHtml = '';
            const refData = log.old_data || log.new_data;
            if (refData) {
              if (log.target_table === 'schedules') {
                const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };
                let dStr = refData.is_temporary && refData.target_date ? `å–®æ¬¡ ${refData.target_date.slice(5)} (é€±${dayMap[refData.day_of_week]})` : `å›ºå®š æ¯é€±${dayMap[refData.day_of_week]}`;
                let tRange = (refData.start_time && refData.end_time) ? `${refData.start_time.slice(0, 5)} - ${refData.end_time.slice(0, 5)}` : '';
                scheduleInfoHtml = `<i data-lucide="clock" class="w-3.5 h-3.5 text-blue-400"></i> ${dStr} ${tRange}`;
              } else if (log.target_table === 'lesson_records') {
                scheduleInfoHtml = `<i data-lucide="calendar" class="w-3.5 h-3.5 text-blue-400"></i> é»åæ—¥æœŸï¼š${refData.actual_date}`;
              }
            }

            const d = new Date(log.created_at);
            const actionTimeStr = `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            const actionInfoHtml = `
        <div class="mt-3 pt-2 border-t border-gray-200 flex justify-between items-center text-[10px] text-gray-400 font-sans">
            <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> æ“ä½œäººï¼š${log.actor_name || 'æœªçŸ¥'}</span>
            <span class="flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> æ–¼ ${actionTimeStr} è®Šæ›´</span>
        </div>
      `;

            if (log.action_type === 'æ–°å¢èª²ç¨‹') {
              titleEl.textContent = 'ç¢ºå®šè¦ã€æ’¤éŠ·æ–°å¢ã€‘å—ï¼Ÿ';
              contentEl.innerHTML = `<div class="text-gray-800 font-bold text-center pt-2">${log.description}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-center gap-1">${scheduleInfoHtml}</div>${actionInfoHtml}`;
              warningEl.innerHTML = '<i data-lucide="trash-2" class="w-3.5 h-3.5 inline mr-1"></i> åŸ·è¡Œå¾Œï¼Œé€™å ‚èª²å°‡å¾èª²è¡¨ä¸­å¾¹åº•åˆªé™¤ï¼';
            }
            else if (log.action_type === 'åˆªé™¤èª²ç¨‹') {
              titleEl.textContent = 'ç¢ºå®šè¦ã€å¾©æ´»èª²ç¨‹ã€‘å—ï¼Ÿ';
              contentEl.innerHTML = `<div class="text-gray-800 font-bold text-center pt-2">${log.description}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-center gap-1">${scheduleInfoHtml}</div>${actionInfoHtml}`;
              warningEl.innerHTML = '<i data-lucide="sparkles" class="w-3.5 h-3.5 inline mr-1"></i> åŸ·è¡Œå¾Œï¼Œé€™å ‚èª²å°‡é‡æ–°å›åˆ°èª²è¡¨ä¸Šï¼';
            }
            else {
              titleEl.textContent = 'ç¢ºå®šè¦ã€é€€å›ä¿®æ”¹ã€‘å—ï¼Ÿ';
              warningEl.innerHTML = '<i data-lucide="history" class="w-3.5 h-3.5 inline mr-1"></i> åŸ·è¡Œå¾Œï¼Œè³‡æ–™å°‡æ‹‹æ£„ç´…å­—ï¼Œé€€å›ç¶ è‰²ç‹€æ…‹ï¼';
              let htmlContent = '';
              const parts = log.description.split('ï¼š');
              if (parts.length > 1) {
                const namePart = parts[0];
                const changesPart = parts.slice(1).join('ï¼š');
                htmlContent += `<div class="mb-3 border-b border-blue-200 pb-2"><div class="font-bold text-blue-800 flex items-center gap-1.5 text-sm"><i data-lucide="file-edit" class="w-4 h-4"></i> ${namePart}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-start gap-1">${scheduleInfoHtml}</div></div>`;
                const changes = changesPart.split(' | ');
                changes.forEach(change => {
                  const cParts = change.split(': ');
                  if (cParts.length > 1) {
                    const field = cParts[0];
                    const vals = cParts.slice(1).join(': ').split(' â” ');
                    if (vals.length === 2) {
                      htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">${field}</span><span class="line-through text-red-400 truncate flex-1 text-right" title="å³å°‡æ‹‹æ£„çš„æ–°è³‡æ–™">${vals[1]}</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1" title="å³å°‡é‚„åŸçš„èˆŠè³‡æ–™">${vals[0]}</span></div>`;
                    } else { htmlContent += `<div>${change}</div>`; }
                  } else {
                    const ptParts = change.split(' â” ');
                    if (ptParts.length === 2) {
                      htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">ç‹€æ…‹</span><span class="line-through text-red-400 truncate flex-1 text-right" title="å³å°‡æ‹‹æ£„çš„æ–°ç‹€æ…‹">${ptParts[1]}</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1" title="å³å°‡é‚„åŸçš„èˆŠç‹€æ…‹">${ptParts[0]}</span></div>`;
                    } else { htmlContent += `<div>${change}</div>`; }
                  }
                });
              } else {
                htmlContent = `<div class="py-2 text-center font-bold text-gray-800">${log.description}</div><div class="text-[11px] text-gray-500 font-medium mt-1 flex items-center justify-center gap-1">${scheduleInfoHtml}</div>`;
              }
              htmlContent += actionInfoHtml;
              contentEl.innerHTML = htmlContent;
            }
            document.getElementById('undo-modal').classList.remove('hidden');
            lucide.createIcons();
            setStatus("å°±ç·’", "success");
          }

          // 2. é—œé–‰è¦–çª—
          function closeUndoModal() {
            document.getElementById('undo-modal').classList.add('hidden');
            pendingUndoLogId = null;
            pendingUndoLogData = null;
          }

          // 3. æŒ‰ä¸‹æŒ‰éˆ•ï¼ŒçœŸæ­£åŸ·è¡Œæ™‚å…‰å€’æµï¼
          async function confirmExecuteUndo() {
            const logId = pendingUndoLogId;
            const log = pendingUndoLogData;
            if (!logId || !log) return;

            closeUndoModal();
            setStatus("æ­£åœ¨é‚„åŸè³‡æ–™...");

            try {
              if (log.action_type === 'æ–°å¢èª²ç¨‹') {
                await _client.from(log.target_table).delete().eq('id', log.new_data.id);
              }
              else if (log.action_type === 'åˆªé™¤èª²ç¨‹') {
                await _client.from(log.target_table).insert([log.old_data]);
              }
              else if (log.action_type === 'ä¿®æ”¹èª²ç¨‹') {
                await _client.from(log.target_table).update(log.old_data).eq('id', log.old_data.id);
              }
              else if (log.action_type === 'ä¿®æ”¹é»å') {
                const oldStatus = log.old_data.status;
                const master = _cachedSchedule.find(s => String(s.id) === String(log.old_data.schedule_id));
                const defaultStatus = master ? (master.color_class || 'status-pending') : 'status-pending';

                if (oldStatus === defaultStatus || oldStatus === 'status-pending') {
                  await _client.from('lesson_records').delete().eq('schedule_id', log.old_data.schedule_id).eq('actual_date', log.old_data.actual_date);
                } else {
                  await _client.from('lesson_records').upsert([{
                    schedule_id: log.old_data.schedule_id,
                    teacher_id: currentTid,
                    actual_date: log.old_data.actual_date,
                    status: oldStatus
                  }], { onConflict: 'schedule_id,actual_date' });
                }
              }
              await _client.from('action_logs').delete().eq('id', logId);
              setStatus("æ™‚å…‰å€’æµæˆåŠŸï¼", "success");
              await refreshData();
              loadLogs();
            } catch (err) {
              await sysAlert("å¾©åŸå¤±æ•—: " + err.message, "ç³»çµ±éŒ¯èª¤");
            }
          }

          // ==========================================
          // ğŸŒŸ å…¨åŸŸæ¥µç°¡å°è©±æ¡†æ§åˆ¶å¼•æ“
          // ==========================================
          let _sysDialogResolve = null;

          // å–ä»£åŸæœ¬çš„ confirm()
          function sysConfirm(message, title = "ç³»çµ±ç¢ºèª", type = "danger") {
            return new Promise((resolve) => {
              const modal = document.getElementById('sys-dialog-modal');

              // â˜… çµ‚æ¥µæ•‘æ´ï¼šå¦‚æœå°è©±æ¡†è¢«åŒ…åœ¨éš±è—çš„çˆ¶å±¤è£¡ï¼Œå¼·åˆ¶æŠŠå®ƒæ¬åˆ°æœ€å¤–é¢ï¼
              if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
              }

              const box = document.getElementById('sys-dialog-box');
              const titleEl = document.getElementById('sys-dialog-title');
              const msgEl = document.getElementById('sys-dialog-msg');
              const confirmBtn = document.getElementById('sys-dialog-confirm');
              const cancelBtn = document.getElementById('sys-dialog-cancel');

              // è¨­å®šæ–‡å­— (æ”¯æ´ \n æ›è¡Œ)
              titleEl.innerHTML = title;
              msgEl.innerHTML = message.replace(/\n/g, '<br>');
              cancelBtn.classList.remove('hidden');

              // æ ¹æ“šé¡å‹è¨­å®šæŒ‰éˆ•é¡è‰²
              if (type === 'danger') {
                confirmBtn.className = "px-4 py-2 text-sm bg-red-500 text-white hover:bg-red-600 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
                confirmBtn.textContent = "ç¢ºå®šåˆªé™¤";
              } else if (type === 'warning') {
                confirmBtn.className = "px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
                confirmBtn.textContent = "ç¢ºå®šåŸ·è¡Œ";
              } else {
                confirmBtn.className = "px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
                confirmBtn.textContent = "ç¢ºå®š";
              }

              _sysDialogResolve = resolve;

              // é¡¯ç¤ºå‹•ç•«
              modal.classList.remove('hidden');
              requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                box.classList.remove('scale-95');
              });
            });
          }

          // å–ä»£åŸæœ¬çš„ alert()
          function sysAlert(message, title = "ç³»çµ±æç¤º") {
            return new Promise((resolve) => {
              const modal = document.getElementById('sys-dialog-modal');

              // â˜… çµ‚æ¥µæ•‘æ´ï¼šå¦‚æœå°è©±æ¡†è¢«åŒ…åœ¨éš±è—çš„çˆ¶å±¤è£¡ï¼Œå¼·åˆ¶æŠŠå®ƒæ¬åˆ°æœ€å¤–é¢ï¼
              if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
              }

              const box = document.getElementById('sys-dialog-box');
              document.getElementById('sys-dialog-title').innerHTML = title;
              document.getElementById('sys-dialog-msg').innerHTML = message.replace(/\n/g, '<br>');

              const confirmBtn = document.getElementById('sys-dialog-confirm');
              document.getElementById('sys-dialog-cancel').classList.add('hidden'); // éš±è—å–æ¶ˆæŒ‰éˆ•

              confirmBtn.className = "px-4 py-2 text-sm bg-neutral-800 text-white hover:bg-black rounded-lg transition-colors font-bold shadow-sm active:scale-95";
              confirmBtn.textContent = "æˆ‘çŸ¥é“äº†";

              _sysDialogResolve = resolve;

              modal.classList.remove('hidden');
              requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                box.classList.remove('scale-95');
              });
            });
          }

          function closeSysDialog() {
            const modal = document.getElementById('sys-dialog-modal');
            const box = document.getElementById('sys-dialog-box');
            modal.classList.add('opacity-0');
            box.classList.add('scale-95');
            setTimeout(() => {
              modal.classList.add('hidden');
              if (_sysDialogResolve) { _sysDialogResolve(false); _sysDialogResolve = null; }
            }, 200); // ç­‰å¾…å‹•ç•«æ’­å®Œ
          }

          function execSysDialog() {
            const modal = document.getElementById('sys-dialog-modal');
            const box = document.getElementById('sys-dialog-box');
            modal.classList.add('opacity-0');
            box.classList.add('scale-95');
            setTimeout(() => {
              modal.classList.add('hidden');
              if (_sysDialogResolve) { _sysDialogResolve(true); _sysDialogResolve = null; }
            }, 200);
          }

          async function executeMasterCopyImport(input) {
            const file = input.files[0];
            if (!file) return;
            if (!currentTid) { input.value = ""; return sysAlert("è«‹å…ˆé¸æ“‡è€å¸«"); }

            const targetTeacherName = document.getElementById("main-title").textContent.split(' Â· ')[0];

            if (!(await sysConfirm(`ç¢ºå®šè¦åŒæ­¥ <b class="text-blue-600">${targetTeacherName}</b> çš„èª²è¡¨å—ï¼Ÿ<br><br><span class="text-red-500 font-bold">âš ï¸ é€™æœƒå°‡è³‡æ–™åº«å®Œå…¨æ›¿æ›ç‚º Excel çš„å…§å®¹ï¼</span>`, "å…¨èƒ½åŒæ­¥ç¢ºèª", "danger"))) {
              input.value = ""; return;
            }

            setStatus("åŒæ­¥ä¸­...");
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                const statusMap = { 'ä¸Šèª²': 'status-present', 'è«‹å‡': 'status-leave', 'æ› èª²': 'status-absent', 'å°šæœªé»å': 'status-pending', 'å­¸ç”Ÿç·´ç¿’': 'status-practice' };
                const newSchedules = [];

                const findVal = (row, keyword) => {
                  const key = Object.keys(row).find(k => k.includes(keyword));
                  return key ? row[key] : null;
                };

                for (const row of jsonRows) {
                  const sName = findVal(row, "å­¸ç”Ÿå§“å");
                  if (!sName) continue;

                  // â˜… æ ¸å¿ƒé‚è¼¯ï¼šè®€å– Excel ä¸­çš„ã€Œæ˜¯/å¦ã€ä¸¦è½‰å›è³‡æ–™åº«ç”¨çš„ true/false
                  const isTemp = String(findVal(row, "åƒ…é™å–®å‘¨") || "å¦").trim() === "æ˜¯";

                  newSchedules.push({
                    teacher_id: currentTid,
                    course_name: String(sName).trim(),
                    phone: String(findVal(row, "é›»è©±") || ""),
                    subject: String(findVal(row, "ç§‘ç›®") || ""),
                    amount: parseInt(String(findVal(row, "é‡‘é¡") || "0").replace(/[^0-9]/g, '')) || 0,
                    day_of_week: parseInt(findVal(row, "æ˜ŸæœŸ")) || 1,
                    start_time: (String(findVal(row, "é–‹å§‹æ™‚é–“") || "09:00")).substring(0, 5) + ":00",
                    end_time: (String(findVal(row, "çµæŸæ™‚é–“") || "10:00")).substring(0, 5) + ":00",
                    room_no: String(findVal(row, "æ•™å®¤") || ""),
                    color_class: statusMap[findVal(row, "é è¨­ç‹€æ…‹")] || 'status-pending',
                    is_temporary: isTemp
                  });
                }

                // 1. åŸ·è¡Œæ¸…ç©ºè©²è€å¸«çš„æ‰€æœ‰è³‡æ–™
                await _client.from("schedules").delete().eq("teacher_id", currentTid);

                // 2. å¯«å…¥ Excel çš„å…§å®¹
                const { error } = await _client.from("schedules").insert(newSchedules);
                if (error) throw error;

                setStatus("åŒæ­¥æˆåŠŸ", "success");
                input.value = "";
                closeBatchModal();
                await refreshData();
                await sysAlert(`ğŸ‰ åŒæ­¥å®Œæˆï¼ç›®å‰å…±è¨ˆ ${newSchedules.length} å ‚èª²ç¨‹ã€‚`);
              } catch (err) {
                sysAlert("éŒ¯èª¤ï¼š" + err.message);
                setStatus("å¤±æ•—", "error");
              }
            };
            reader.readAsArrayBuffer(file);
          }
        </script>
</body>

</html>