<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>幕尼克音樂(金山校區)課表</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
    }

    /* 上課：草本綠 (調高飽和，邊框加深) */
    .status-present {
      background-color: #dcedc8 !important;
      /* 更有感的綠色 */
      border: 1.5px solid #9ccc65 !important;
      color: #33691e !important;
    }

    /* 請假：溫潤木棕 (增加暖度，明顯區分) */
    .status-leave {
      background-color: #f0e4d7 !important;
      /* 帶有奶茶感的背景 */
      border: 1.5px solid #bcaaa4 !important;
      color: #5d4037 !important;
    }

    /* 曠課：煙燻粉紅 (降低亮度但增加色彩濃度) */
    .status-absent {
      background-color: #ffdad9 !important;
      /* 明顯的粉紅背景 */
      border: 1.5px solid #ef9a9a !important;
      color: #c62828 !important;
    }

    /* 學生練習：海洋藍 (清爽、獨立) */
    .status-practice {
      background-color: #e0f2fe !important;
      /* 很淡的藍 */
      border: 1.5px solid #7dd3fc !important;
      /* 天空藍邊框 */
      color: #0c4a6e !important;
      /* 深藍文字 */
    }

    /* 預設/尚未點名：冷灰色 (低調、等待中) */
    .status-pending {
      background-color: #f3f4f6 !important;
      border: 1.5px solid #d1d5db !important;
      color: #4b5563 !important;
    }

    /* 側邊欄選中狀態：加深背景色 */
    .teacher-item.active {
      background-color: #e2e8f0 !important;
      /* Slate-200 (比原本的灰色深) */
      color: #0f172a !important;
      /* 深藍黑色文字 */
      font-weight: 700 !important;
      /* 加粗文字 */
      border-right: 4px solid #3b82f6;
      /* (選用) 右邊加一條藍色線條增加識別度 */
    }

    /* 展開狀態的卡片樣式 */
    .card-expanded {
      height: auto !important;
      /* 讓內容決定高度 */
      min-height: min-content;
      z-index: 100 !important;
      /* 確保在最上層 */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding-bottom: 12px !important;
      /* 增加底部緩衝 */
    }

    /* 核心修正：強制讓隱形的日曆點擊感應區撐滿整個區域 */
    #date-picker::-webkit-calendar-picker-indicator {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 0;
      /* 完全透明但充滿整格 */
      z-index: 25;
    }

    @media (max-width: 768px) {

      /* 讓手機版的時間軸窄一點點，留更多空間給課表 */
      #schedule-container>div:first-child {
        width: 60px !important;
      }
    }
  </style>
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[800] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[900] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> 老師名單
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="px-4 py-2">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm relative group">
        <div class="flex items-center gap-1.5 mb-2 text-yellow-700/80">
          <i data-lucide="sticky-note" class="w-3.5 h-3.5"></i>
          <span class="text-xs font-bold">備忘錄</span>
          <span id="memo-status"
            class="ml-auto text-[10px] text-yellow-600 opacity-0 transition-opacity duration-500">已儲存</span>
        </div>
        <textarea id="teacher-memo"
          class="w-full bg-transparent text-xs text-gray-700 resize-none outline-none placeholder-yellow-700/30 leading-relaxed"
          rows="4" placeholder="隨手記點什麼..." oninput="handleMemoInput(this.value)"></textarea>
      </div>
    </div>

    <div class="p-4">
      <button onclick="openTeacherModal()"
        class="w-full py-2 text-xs text-gray-500 hover:text-blue-600 border border-dashed rounded-lg flex items-center justify-center gap-1 transition-colors">
        <i data-lucide="settings-2" class="w-3 h-3"></i> 管理老師名單
      </button>

      <button onclick="openInstructionsModal()"
        class="w-full py-2 mt-2 text-xs text-amber-600 hover:bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-medium">
        <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> 系統使用說明
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">網頁版本 v1.36</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex flex-wrap lg:flex-nowrap items-center gap-y-3 gap-x-4 shadow-sm sticky top-0 z-30">

      <div class="flex items-center gap-3 order-1 flex-1 min-w-[150px]">
        <button onclick="toggleSidebar()"
          class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden shrink-0">
          <i data-lucide="menu"></i>
        </button>

        <div class="flex flex-col min-w-0">
          <h2 id="main-title" class="text-lg md:text-xl font-bold text-neutral-800 truncate leading-tight">
            載入中...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium mt-0.5 -ml-2">
            嘗試連線...
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 order-2 lg:order-3 shrink-0">
        <button onclick="openSalaryModal()"
          class="flex items-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-emerald-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="calculator" class="w-4 h-4"></i>
          <span>薪資試算</span>
        </button>

        <button onclick="openBatchModal()"
          class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-indigo-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="sheet" class="w-4 h-4"></i>
          <span>批次管理</span>
        </button>

        <button onclick="freezeTeacherHistory()"
          class="flex items-center gap-2 bg-amber-50 text-amber-700 border border-amber-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-amber-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="archive" class="w-4 h-4"></i>
          <span>凍結歷史</span>
        </button>

        <button onclick="openModal()"
          class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="hidden md:inline">新增課程</span><span class="md:hidden">新增</span>
        </button>
      </div>

      <div
        class="flex items-center justify-between gap-3 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm order-3 w-full lg:w-auto lg:mx-4 lg:order-2 relative overflow-hidden">

        <button onclick="changeWeek(-1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>

        <div class="relative flex-1 flex justify-center items-center group px-2">

          <span id="current-date-range"
            class="text-sm md:text-base font-bold text-neutral-800 font-mono tracking-wide text-center cursor-pointer group-hover:text-blue-600 transition-colors select-none pointer-events-none">
            計算中...
          </span>

          <input type="date" id="date-picker"
            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
            onchange="handleDatePick(this.value)">
        </div>

        <button onclick="changeWeek(1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>

    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1000] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] md:w-full max-w-md p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold">新增課程資料</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="course-form" class="space-y-4">
        <div class="space-y-3 pb-2 border-b border-gray-100">
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">課程名稱 ( 如:EG-1、AG-1 )</label>
            <input type="text" name="subject" placeholder="請輸入科目名稱"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">學生姓名</label>
              <input type="text" name="course_name" required placeholder="姓名"
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">學生電話</label>
              <input type="tel" name="phone" placeholder="聯絡電話"
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
          </div>
        </div>

        <div class="space-y-3 pb-2 border-b border-gray-100">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">負責老師</label>
              <select name="teacher_id" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none"></select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">上課星期</label>
              <select name="day_of_week" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none">
                <option value="1">週一</option>
                <option value="2">週二</option>
                <option value="3">週三</option>
                <option value="4">週四</option>
                <option value="5">週五</option>
                <option value="6">週六</option>
                <option value="7">週日</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">開始時間</label>
              <input type="time" name="start_time" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">結束時間</label>
              <input type="time" name="end_time" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">教室</label>
            <input type="text" name="room_no" placeholder="教室名稱"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">薪資 (NT$)</label>
            <input type="number" name="amount" min="0" placeholder="0"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">課程狀態</label>
            <select name="color_class"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none">
              <option value="status-pending" selected>⬜ 尚未點名 (灰)</option>
              <option value="status-present">✅ 上課 (綠)</option>
              <option value="status-leave">☕ 請假 (咖)</option>
              <option value="status-absent">❌ 曠課 (紅)</option>
              <option value="status-practice">🎹 學生練習 (藍)</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-4 gap-4 mt-4 pt-4 border-t border-gray-100">

          <div class="col-span-3 relative">
            <div class="flex justify-between items-center mb-1">
              <label class="text-xs font-bold text-gray-400">備註內容</label>
              <div class="flex items-center gap-1.5 cursor-pointer group">
                <input type="checkbox" name="is_persistent" id="is_persistent"
                  class="w-3.5 h-3.5 rounded border-gray-300 cursor-pointer text-blue-600 focus:ring-0">
                <label for="is_persistent"
                  class="text-[10px] text-gray-400 font-medium cursor-pointer group-hover:text-blue-600 transition-colors select-none">
                  設為常駐 (每週顯示)
                </label>
              </div>
            </div>
            <textarea name="record_remark" placeholder="例如：會考請假、補課..."
              class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-100 outline-none resize-none h-[72px]"
              rows="2"></textarea>
          </div>

          <div class="col-span-1 flex flex-col h-full">
            <label class="block text-xs font-bold text-gray-400 mb-1 text-center whitespace-nowrap">課程性質</label>

            <div
              class="flex flex-col items-center justify-center bg-gray-50 border border-dashed border-gray-300 rounded-lg h-[72px] w-full px-2 hover:bg-gray-100 transition-colors cursor-pointer group relative">

              <input type="checkbox" name="is_temporary" id="is_temporary"
                class="w-5 h-5 rounded border-gray-300 cursor-pointer accent-blue-600 z-10">
              <label for="is_temporary"
                class="text-[11px] font-bold text-neutral-500 mt-1 cursor-pointer group-hover:text-blue-600 z-10 whitespace-nowrap">僅限本週</label>

              <div class="absolute inset-0" onclick="document.getElementById('is_temporary').click()"></div>
            </div>
          </div>
        </div>

        <p class="text-[10px] text-amber-600 mt-2 flex items-center gap-1 italic">
          <i data-lucide="alert-circle" class="w-3 h-3"></i> 備註內容與單次設定不會連動到未來課表。
        </p>

        <div class="pt-4">
          <button type="submit"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> 儲存課程資料
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="teacher-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1000] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-80 p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold">老師名單管理</h3>
        <button onclick="closeTeacherModal()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex gap-2 mb-4">
        <input type="text" id="new-teacher-name" placeholder="姓名"
          class="flex-1 border rounded-lg px-2 py-1 text-sm outline-none" />
        <button onclick="addTeacher()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
          新增
        </button>
      </div>
      <div id="teacher-manage-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
    </div>
  </div>

  <div id="instructions-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-lg p-0 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col border border-neutral-200">

      <div class="bg-neutral-50 px-6 py-4 border-b border-neutral-200 flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2 text-neutral-800">
          📅 系統使用說明 (v1.36版本)
        </h3>
        <button onclick="closeInstructionsModal()"
          class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-200 rounded-full transition-all">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 text-sm text-neutral-700 leading-relaxed">

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-700 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
            變更「點名」or「編輯固定課表」
          </h4>
          <div class="grid gap-3">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-blue-800 mb-1 flex items-center gap-1"><i data-lucide="mouse-pointer-2"
                  class="w-3.5 h-3.5"></i> 點名 (點擊卡片)</h5>
              <p class="text-xs text-blue-900/80">• 僅影響「這一天」。適用於點名、感冒請假、曠課或臨時補課。</p>
            </div>
            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-orange-800 mb-1 flex items-center gap-1"><i data-lucide="edit-3"
                  class="w-3.5 h-3.5"></i> 編輯固定課表 (卡片右上角筆頭)</h5>
              <p class="text-xs text-orange-900/80">• 會影響「未來每一週」。適用於更換上課時段、永久更換教室等。</p>
            </div>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-700 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
            凍結歷史 (保護歷史紀錄)
          </h4>

          <ul class="space-y-3 mt-3">

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-neutral-400 shrink-0 mt-2"></span>
              <p class="text-neutral-700">
                <b class="text-neutral-900">功能：</b>將過去的課程凍結，防止因修改固定課表而導致舊紀錄遺失。
              </p>
            </li>

            <li class="list-none">
              <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                <ul class="space-y-1">
                  <li class="flex gap-2.5 items-start">
                    <span class="w-1 h-1 rounded-full bg-amber-500 shrink-0 mt-2"></span>
                    <div>
                      <p class="font-bold text-amber-800 text-sm">簡單小情境模擬：</p>
                      <p class="text-xs text-amber-900/70">
                        當長假學生準備回歸課堂時，能快速凍結<b>長假時期的日期</b>，凍結後再改動後續學生的課程。
                      </p>
                    </div>
                  </li>
                  <li class="flex gap-2.5 items-start">
                    <span class="w-1 h-1 rounded-full bg-amber-500 shrink-0 mt-2"></span>
                    <div>
                      <p class="font-bold text-amber-800 text-sm">快速跳轉小技巧：</p>
                      <p class="text-xs text-amber-900/70">
                        點擊「設定上月」按鈕，每點一次日期就會<b>往回推一個月</b>，方便您快速凍結好幾個月前的資料！
                      </p>
                    </div>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-700 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">3</span>
            備註功能
          </h4>
          <ul class="space-y-3 mt-3">
            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-neutral-400 shrink-0 mt-2"></span>
              <p class="text-neutral-700"><b class="text-neutral-900">不勾選設為常駐：</b>這則備註只會出現在「今天」，適合記錄「當天感冒請假的學生」等。</p>
            </li>
            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-neutral-400 shrink-0 mt-2"></span>
              <p class="text-neutral-700"><b
                  class="text-neutral-900">勾選設為常駐：</b>這則備註會出現在「未來每一週」，適合記錄「長假、出國、準備考試」等長期請假的學生。</p>
            </li>
          </ul>
        </section>

        <hr class="border-gray-100">

        <section class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
          <h4 class="font-bold text-indigo-800 mb-3 flex items-center gap-2">
            <i data-lucide="sparkles" class="w-4 h-4"></i> 效率捷徑
          </h4>

          <ul class="space-y-3">

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">快速切換起始日期</p>
                <p class="text-xs text-indigo-800/70">點擊畫面正上方的「日期範圍」，即可彈出日曆選擇您想顯示的第一天。</p>
              </div>
            </li>

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">查看完整課程資訊</p>
                <p class="text-xs text-indigo-800/70">點擊卡片右上角的「向下箭頭」可展開卡片，查看電話、薪資與教室。</p>
              </div>
            </li>

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">快速複製課程</p>
                <p class="text-xs text-indigo-800/70">點擊卡片右上角的「複製圖示」，系統會自動帶入該課程的學生姓名與電話，適合處理調課或補課。</p>
              </div>
            </li>

            <li class="flex gap-2.5 items-start">
              <span class="w-1 h-1 rounded-full bg-indigo-500 shrink-0 mt-2"></span>
              <div>
                <p class="font-bold text-indigo-900 text-sm">新增特殊/臨時教室</p>
                <p class="text-xs text-indigo-800/70">新增課程時勾選「僅限本週」，資料就不會出現在其他週次，適合有調課、新增臨時單週課程或預約制教室。</p>
              </div>
            </li>
          </ul>
        </section>

        <section
          class="text-sm text-gray-400 px-4 space-y-1 bg-gray-50/50 py-3 rounded-lg border border-dashed border-gray-200">
          <p class="font-bold mb-1 text-gray-500">特別提醒</p>
          <ul class="space-y-1.5">
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-2"></span>
              <p>若使用過程有任何錯誤訊息，請為設計師保留錯誤資訊，謝謝。</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-2"></span>
              <p>有任何相關的修改建議請聯繫 <b class="text-gray-500">鮪魚老師</b> :)</p>
            </li>
          </ul>
        </section>

        <section class="text-center space-y-3 pt-2">
          <button onclick="closeInstructionsModal()"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all active:scale-95 shadow-md">
            我瞭解了
          </button>
        </section>

      </div>
    </div>
  </div>

  <div id="freeze-date-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1200] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-80 p-6 shadow-2xl border border-amber-100">
      <h3 class="font-bold mb-4 flex items-center gap-2 text-amber-800">
        <i data-lucide="archive" class="w-4 h-4"></i> 自訂凍結範圍
      </h3>

      <div class="flex gap-2 mb-4">
        <button onclick="quickSetFreezeDates('current')"
          class="flex-1 py-1.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-md hover:bg-amber-100 hover:text-amber-700 transition-colors">設定本月</button>
        <button onclick="quickSetFreezeDates('last')"
          class="flex-1 py-1.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-md hover:bg-amber-100 hover:text-amber-700 transition-colors">設定上月</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-400 mb-1">起始日期 (From)</label>
          <input type="date" id="freeze-start-date"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-100" />
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-400 mb-1">結束日期 (To)</label>
          <input type="date" id="freeze-end-date"
            class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-100" />
        </div>

        <div class="pt-2">
          <button onclick="executeFreeze()"
            class="w-full bg-amber-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-md hover:bg-amber-700 transition-all active:scale-95">
            確認並執行凍結
          </button>
          <button onclick="closeFreezeModal()" class="w-full text-gray-400 text-xs py-2 mt-1 hover:text-gray-600">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="batch-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-md p-6 shadow-2xl border border-indigo-100">

      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2 text-indigo-800">
          <i data-lucide="sheet" class="w-5 h-5"></i> 固定課表批次管理
        </h3>
        <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="p-3 bg-indigo-50 rounded-lg text-xs text-indigo-900 leading-relaxed border border-indigo-100">
          <p class="font-bold mb-1">功能說明：</p>
          <ul class="list-disc pl-4 space-y-1">
            <li>此功能用於修改<b>「固定課表」</b>(如：漲學費、換教室、改電話)。</li>
            <li>Excel 包含所有欄位：姓名、電話、金額、科目、備註等。</li>
            <li>上傳修改後的Excel後會直接覆蓋現有的固定課表設定。</li>
          </ul>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="exportMasterData()"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="download" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">下載課表 Excel</span>
          </button>

          <button onclick="document.getElementById('import-master-input').click()"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="upload" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">上傳修改後的 Excel</span>
          </button>
        </div>

        <input type="file" id="import-master-input" accept=".xlsx, .xls" class="hidden"
          onchange="handleImportMaster(this)" />
      </div>

    </div>
  </div>

  <div id="salary-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-2xl h-[85vh] p-6 shadow-2xl border border-emerald-100 flex flex-col">

      <div class="flex justify-between items-center mb-4 shrink-0">
        <h3 class="font-bold text-lg flex items-center gap-2 text-emerald-800">
          <i data-lucide="calculator" class="w-5 h-5"></i> 薪資結算報告
        </h3>
        <button onclick="closeSalaryModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 shrink-0 bg-emerald-50/50 p-3 rounded-lg border border-emerald-100">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label>
          <input type="date" id="salary-start-date"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label>
          <input type="date" id="salary-end-date"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div class="flex items-end">
          <button onclick="calculateSalary()"
            class="w-full bg-emerald-600 text-white py-1.5 rounded-lg text-sm font-bold shadow hover:bg-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 h-[34px]">
            <i data-lucide="search" class="w-4 h-4"></i> 開始計算
          </button>
        </div>
      </div>

      <div id="salary-result" class="hidden flex flex-col flex-1 min-h-0 overflow-hidden">

        <div class="flex gap-4 mb-4 shrink-0">
          <div
            class="flex-1 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="absolute -right-4 -bottom-4 opacity-20"><i data-lucide="coins" class="w-24 h-24"></i></div>
            <p class="text-emerald-100 text-xs font-bold mb-1">預估總薪資</p>
            <p class="text-3xl font-bold tracking-tight" id="total-salary">$0</p>
          </div>
          <div class="flex-1 bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-gray-500">總堂數</span>
              <span class="text-lg font-bold text-gray-800" id="total-count">0 堂</span>
            </div>
            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
              <div class="bg-emerald-500 h-full w-full"></div>
            </div>
            <div class="mt-2 text-[10px] text-gray-400">
              *僅計算「上課」與「曠課」
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto border border-gray-200 rounded-lg relative bg-white">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm select-none">
              <tr>
                <th onclick="sortSalary('date')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">日期 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('name')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">學生/課程 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('status')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">狀態 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('amount')"
                  class="p-3 text-right bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center justify-end gap-1">金額 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
              </tr>
            </thead>
            <tbody id="salary-list" class="divide-y divide-gray-100 text-gray-700">
            </tbody>
          </table>
        </div>

        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-3 shrink-0">

          <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg border border-emerald-100">
            <div class="flex flex-col">
              <span class="text-xs font-bold text-emerald-800">薪資結算修正</span>
              <span class="text-[10px] text-emerald-600">僅修改對應時間的「狀態、備註與當日薪資」，並不會修改到其他時間的課表。</span>
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-daily-input" accept=".xlsx, .xls" class="hidden"
                onchange="handleImportDaily(this)" />
              <button onclick="exportDailyReport()"
                class="bg-white text-emerald-700 border border-emerald-200 text-xs font-bold px-3 py-2 rounded hover:bg-emerald-100 transition-all flex items-center gap-1">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> 匯出報表
              </button>
              <button onclick="document.getElementById('import-daily-input').click()"
                class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded shadow hover:bg-emerald-700 transition-all flex items-center gap-1">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> 匯入修正
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co"; // 請確認您的 URL
    const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP"; // 請確認您的 KEY
    const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentTid = null;
    let editingId = null;
    let editingCurrentStatus = null;
    let editingDateStr = null;
    // --- 新增全域變數：用來暫存資料與排序 ---
    let _cachedSchedule = []; // 暫存課表資料
    let _cachedRecords = [];  // 暫存紀錄資料
    let _userSortOrder = [];  // 記住使用者排好的卡片順序 (存 ID)

    // --- 使用說明彈窗控制 ---
    function openInstructionsModal() {
      // 開啟時自動收起手機版側邊欄
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
      document.getElementById("instructions-modal").classList.remove("hidden");
    }

    function closeInstructionsModal() {
      document.getElementById("instructions-modal").classList.add("hidden");
    }

    // --- 拖曳排序功能核心 ---

    // 1. 開始拖曳
    function handleDragStart(e, id) {
      e.dataTransfer.setData("text/plain", id);
      e.dataTransfer.effectAllowed = "move";
      // 讓被拖的卡片稍微變透明，增加視覺回饋
      e.target.style.opacity = '0.4';
    }

    // 2. 拖曳結束 (不管有沒有成功放下，都要把透明度改回來)
    function handleDragEnd(e) {
      e.target.style.opacity = '1';
    }

    // 3. 放下卡片 (交換順序)
    function handleDrop(e, targetId) {
      e.preventDefault();
      e.stopPropagation();

      const sourceId = e.dataTransfer.getData("text/plain");
      if (sourceId === targetId) return; // 自己丟自己，不做事

      // 調整陣列順序
      const fromIndex = _userSortOrder.indexOf(sourceId);
      const toIndex = _userSortOrder.indexOf(targetId);

      if (fromIndex > -1 && toIndex > -1) {
        // 把原本的那張拿出來
        _userSortOrder.splice(fromIndex, 1);
        // 插隊到新目標的位置
        _userSortOrder.splice(toIndex, 0, sourceId);

        // ★ 重新繪圖！這樣畫面才會變
        renderSchedule(_cachedSchedule, _cachedRecords);
      }
    }

    // --- 積木一：日期控制核心 ---
    // 1. 設定目前選擇的日期 (預設今天)
    let currentBaseDate = new Date();

    // 2. 工具：取得本週一的日期 (這樣我們才知道這週是從哪天開始)
    function getMonday(d) {
      d = new Date(d);
      var day = d.getDay(),
        diff = d.getDate() - day + (day == 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    // 3. 工具：加減天數 (用來切換上一週、下一週)
    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // 4. 工具：把日期變字串 (修正版：使用當地時間，解決早晨日期跑掉的問題)
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // 5. 切換週次的功能
    function changeWeek(direction) {
      // direction: -1 代表上一週， 1 代表下一週
      currentBaseDate = addDays(currentBaseDate, direction * 7);

      // 切換後，重新載入資料 (這樣畫面才會變)
      refreshData();
    }

    // 1. 處理日曆選擇 (滾動式：選哪天，哪天就是起點)
    function handleDatePick(val) {
      if (!val) return;
      // 直接把 currentBaseDate 設為使用者選的那一天 (不找禮拜一了)
      currentBaseDate = new Date(val);
      refreshData();
    }

    // ▼ 關鍵修正 1：宣告全域變數來存老師資料 ▼
    let allTeachers = [];
    let memoTimeout = null;

    // 1. 初始化頁面
    window.onload = async () => {
      await fetchTeachers();
      lucide.createIcons();
    };

    // 2. 獲取老師列表 (修正版)
    async function fetchTeachers() {
      // 這裡一定要把 memo 欄位也選出來 (select * 會包含 memo)
      const { data, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");

      if (error) return setStatus("載入老師失敗", "error");

      // ▼ 關鍵修正 2：把抓下來的資料存到全域變數 allTeachers ▼
      allTeachers = data;

      const menu = document.getElementById("teacher-menu");
      const select = document.querySelector('select[name="teacher_id"]');
      const manageList = document.getElementById("teacher-manage-list");

      menu.innerHTML = "";
      select.innerHTML = "";
      manageList.innerHTML = "";

      data.forEach((t, index) => {
        // A. 側邊欄按鈕 (瘦身版)
        const btn = document.createElement("button");
        btn.dataset.id = t.id;

        // 修改重點 1: p-3 改成 py-1.5 px-2 (上下變窄，左右適中)，gap-3 改成 gap-2 (間距變小)
        btn.className = `teacher-item w-full flex items-center gap-2 py-1.5 px-2 rounded-lg text-left transition-all hover:bg-gray-100 ${currentTid === t.id ? "active bg-gray-100" : ""}`;

        btn.onclick = () => switchTeacher(t.id, t.name);

        // 修改重點 2: 頭像框從 w-8 h-8 改成 w-6 h-6 (變小)，Icon 加上 class="w-3.5 h-3.5" (變精緻)
        btn.innerHTML = `
            <span class="w-6 h-6 rounded bg-gray-100 flex items-center justify-center text-gray-500 shrink-0">
                <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </span>
            <span class="font-medium text-sm truncate">${t.name}</span>
        `;
        menu.appendChild(btn);

        // B. 表單下拉選單
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;

        // C. 管理清單
        manageList.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm"><span>${t.name}</span><button onclick="deleteTeacher('${t.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>`;

        // 預設選中第一位
        if (!currentTid && index === 0) switchTeacher(t.id, t.name);
      });
      lucide.createIcons();
    }

    async function switchTeacher(tid, name) {
      currentTid = tid;
      document.getElementById("main-title").textContent = `${name} · 本週課表`;

      // ▼ 關鍵修改 2：處理按鈕變色邏輯 ▼
      // 1. 先移除所有按鈕的 active 狀態
      document.querySelectorAll(".teacher-item").forEach((btn) => {
        btn.classList.remove("active"); // 移除 CSS 定義的深色樣式
        btn.classList.remove("bg-gray-100"); // 移除原本可能殘留的淺色背景
      });

      // 2. 找到現在點擊的這位老師的按鈕，加上 active
      const activeBtn = document.querySelector(`.teacher-item[data-id="${tid}"]`);
      if (activeBtn) {
        activeBtn.classList.add("active");
      }
      // ▲ 修改結束 ▲


      // --- 下面維持您原本的備忘錄與資料讀取邏輯 ---
      const targetTeacher = allTeachers.find(t => t.id === tid);
      const memoInput = document.getElementById("teacher-memo");
      if (memoInput) {
        memoInput.value = (targetTeacher && targetTeacher.memo) ? targetTeacher.memo : "";
      }

      if (window.innerWidth < 768) {
        toggleSidebar();
      }

      await refreshData();
    }

    // 4. 備忘錄自動儲存功能 (新增)
    async function handleMemoInput(text) {
      const status = document.getElementById("memo-status");
      if (status) {
        status.textContent = "輸入中...";
        status.classList.remove("opacity-0");
      }

      // 防手震：清除上一次的計時器
      if (memoTimeout) clearTimeout(memoTimeout);

      // 設定新的計時器：停止打字 0.8 秒後才儲存
      memoTimeout = setTimeout(async () => {
        if (!currentTid) return;

        if (status) status.textContent = "儲存中...";

        // 更新資料庫
        const { error } = await _client
          .from("teachers")
          .update({ memo: text })
          .eq("id", currentTid);

        if (!error) {
          if (status) status.textContent = "已儲存";

          // ▼ 關鍵修正 4：儲存成功後，同步更新本地變數 allTeachers ▼
          // 這樣切換去別的老師再切回來，資料才會是新的
          const localTeacher = allTeachers.find(t => t.id === currentTid);
          if (localTeacher) {
            localTeacher.memo = text;
          }

          // 2秒後隱藏狀態文字
          setTimeout(() => {
            if (status) status.classList.add("opacity-0");
          }, 2000);
        } else {
          console.error("儲存失敗:", error); // 在 Console 顯示錯誤以便除錯
          if (status) {
            status.textContent = "儲存失敗";
            status.classList.remove("text-yellow-600");
            status.classList.add("text-red-500");
          }
        }
      }, 800);
    }

    // 2. 重新整理資料 (修改版：以 currentBaseDate 為起點，往後推 7 天)
    async function refreshData() {
      if (!currentTid) return;

      // --- 修改重點開始 ---
      // 原本：const monday = getMonday(currentBaseDate);
      // 現在：直接用 currentBaseDate 當作開始日
      const startDate = new Date(currentBaseDate);
      const endDate = addDays(startDate, 6); // 往後推 6 天 (共 7 天)

      const startStr = formatDate(startDate);
      const endStr = formatDate(endDate);
      // --- 修改重點結束 ---

      document.getElementById("current-date-range").textContent = `${startStr} ~ ${endStr}`;

      // 同步隱藏日曆的值
      const picker = document.getElementById("date-picker");
      if (picker) picker.value = startStr;

      setStatus("正在同步紀錄...");

      try {
        // A. 抓母版 (邏輯不變：只要日期有重疊或是常駐的都抓)
        const { data: sData, error: sErr } = await _client
          .from("schedules")
          .select("*")
          .eq("teacher_id", currentTid)
          .or(`target_date.is.null,and(target_date.gte.${startStr},target_date.lte.${endStr})`);
        if (sErr) throw sErr;

        // B. 抓日記 (抓這 7 天的紀錄)
        const { data: rData, error: rErr } = await _client.from("lesson_records").select("*")
          .eq("teacher_id", currentTid)
          .gte("actual_date", startStr)
          .lte("actual_date", endStr);
        if (rErr) throw rErr;

        _cachedSchedule = sData || [];
        _cachedRecords = rData || [];

        // C. 執行繪圖 (把 startDate 傳進去，因為繪圖需要知道第一天是誰)
        renderSchedule(_cachedSchedule, _cachedRecords, startDate);

        // ... (下方的計算統計邏輯維持不變) ...
        const total = _cachedSchedule.length;
        const attendedOrAbsent = _cachedRecords.filter(r =>
          ['attended', 'status-present', 'absent', 'status-absent'].includes(r.status)
        ).length;
        const onLeave = _cachedRecords.filter(r =>
          ['leave', 'status-leave'].includes(r.status)
        ).length;
        setStatus(`總堂數：${total} | 已點名+曠課：${attendedOrAbsent} | 請假：${onLeave}`, "success");

      } catch (e) {
        console.error(e);
        setStatus(`連線錯誤: ${e.message}`, "error");
      }
    }

    // --- 新增：快速切換課程狀態 ---
    async function toggleCourseStatus(id, currentStatus) {
      // 定義狀態循環順序：灰 -> 綠 -> 咖 -> 紅 -> 灰
      const statusCycle = {
        'status-pending': 'status-present', // 灰 -> 綠 (點名)
        'status-present': 'status-leave',   // 綠 -> 咖 (請假)
        'status-leave': 'status-absent',    // 咖 -> 紅 (曠課)
        'status-absent': 'status-pending'   // 紅 -> 灰 (重置)
      };

      // 如果目前的狀態不在循環中 (例如舊資料)，預設轉為綠色
      const nextStatus = statusCycle[currentStatus] || 'status-present';

      // 更新資料庫
      const { error } = await _client
        .from("schedules")
        .update({ color_class: nextStatus })
        .eq("id", id);

      if (!error) {
        // 更新成功後，重新讀取資料以刷新畫面
        await refreshData();
      } else {
        alert("狀態切換失敗");
      }
    }

    // 3. 繪圖函式 (修改版：接收 startDate，動態產生 7 個欄位)
    function renderSchedule(list, records = [], startDate) {
      const container = document.getElementById("schedule-container");
      if (!container) return;
      container.innerHTML = "";

      const slots = ["09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
      const ROW_HEIGHT = 120;
      const HEADER_HEIGHT = 60;
      const START_HOUR = 9;
      const CARD_WIDTH = 140;
      const MIN_COL_WIDTH = CARD_WIDTH;
      // 定義星期名稱對照表 (0=週日, 1=週一...)
      const dayNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];

      // 1. 建立左側時間軸
      const timeCol = document.createElement("div");
      // 修改重點：提高 z-index 到 500 (高於課表卡片)，確保橫向捲動時固定在最左邊
      timeCol.className = "sticky left-0 z-[500] bg-white border-r border-[#e9e9e7] flex flex-col shrink-0";
      timeCol.style.width = "90px";

      const timeHeader = document.createElement("div");
      // 修改重點：
      // 1. z-[600]：它是「角落之王」，必須高於所有人，才不會在捲動時消失
      // 2. 移除 border-r：因為外層 timeCol 已經有 border-r 了，裡面再加會導致 1px 的對齊斷層
      timeHeader.className = "sticky top-0 z-[600] bg-gray-50 border-b border-[#e9e9e7] text-sm font-bold text-gray-600 flex items-center justify-center leading-tight box-border";
      timeHeader.style.height = `${HEADER_HEIGHT}px`;
      timeHeader.textContent = "時間";
      timeCol.appendChild(timeHeader);
      slots.forEach(h => {
        const cell = document.createElement("div");
        cell.className = "flex items-center justify-center text-sm font-semibold text-gray-500 border-b border-[#e9e9e7] bg-gray-50/50";
        cell.style.height = `${ROW_HEIGHT}px`;
        cell.textContent = `${h}:00`;
        timeCol.appendChild(cell);
      });
      container.appendChild(timeCol);

      // --- 修改重點：動態產生 7 天 ---
      // 如果沒有傳入 startDate，就用全域的 (防呆)
      const baseDate = startDate || currentBaseDate;

      // 迴圈跑 0~6 (代表第1天到第7天)
      for (let i = 0; i < 7; i++) {
        // 計算這一欄的日期
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);

        // 取得這一天是星期幾 (0~6)
        const jsDay = thisDayDate.getDay();

        // 轉換成資料庫的 day_of_week (1=週一... 7=週日)
        // JS的週日是0，我們要轉成7
        const dbDay = jsDay === 0 ? 7 : jsDay;

        // 篩選出屬於「這一天 (dbDay)」的課程
        const dayItems = list.filter(item => item.day_of_week === dbDay);

        // --- 以下繪製邏輯跟原本幾乎一樣，只是變數來源變了 ---

        // 計算重疊寬度
        let maxConcurrent = 0;
        if (dayItems.length > 0) {
          dayItems.forEach(item => {
            const [checkH] = item.start_time.split(":").map(Number);
            if (checkH < START_HOUR) return;
            const [sH, sM] = item.start_time.split(":").map(Number);
            const [eH, eM] = item.end_time.split(":").map(Number);
            const sMin = (sH - START_HOUR) * 60 + sM;
            const eMin = (eH - START_HOUR) * 60 + eM;
            const overlaps = dayItems.filter(other => {
              const [osH] = other.start_time.split(":").map(Number);
              if (osH < START_HOUR) return false;
              const [otherSH, otherSM] = other.start_time.split(":").map(Number);
              const [otherEH, otherEM] = other.end_time.split(":").map(Number);
              const oStart = (otherSH - START_HOUR) * 60 + otherSM;
              const oEnd = (otherEH - START_HOUR) * 60 + otherEM;
              return sMin < oEnd && eMin > oStart;
            });
            if (overlaps.length > maxConcurrent) maxConcurrent = overlaps.length;
          });
        }
        if (maxConcurrent === 0) maxConcurrent = 1;
        const colWidth = Math.max(MIN_COL_WIDTH, maxConcurrent * CARD_WIDTH) + 0.75;

        const dayCol = document.createElement("div");
        // 修改重點：border-r 依然保留在容器上，這就是標題和格子能「完美連線」的關鍵
        dayCol.className = "flex flex-col border-r border-[#e9e9e7] shrink-0 relative bg-white";
        dayCol.style.width = `${colWidth}px`;

        // Header 顯示：上面是「週X」，下面是「日期」
        const header = document.createElement("div");
        // 修改重點：
        // 1. z-[400]：確保它會乖乖待在「時間」標題的下面
        // 2. 移除 border-r：讓它直接使用父容器 dayCol 的邊框，達成妳要的「收到裡面」完美對齊感
        header.className = "sticky top-0 z-[400] bg-gray-50 border-b border-[#e9e9e7] text-lg font-bold text-gray-800 flex flex-col items-center justify-center leading-tight box-border w-full";
        header.style.height = `${HEADER_HEIGHT}px`;

        const dateDisplay = `${thisDayDate.getMonth() + 1}/${thisDayDate.getDate()}`;

        // 妳想保留的週二藍色高亮
        const isToday = formatDate(new Date()) === thisDayDateStr;
        const colorClass = isToday ? "text-blue-600" : "text-gray-800";

        header.innerHTML = `
            <span class="${colorClass}">${dayNames[jsDay]}</span>
            <span class="text-[11px] text-gray-400 font-mono font-normal">${dateDisplay}</span>
        `;
        dayCol.appendChild(header);

        const contentLayer = document.createElement("div");
        contentLayer.className = "relative w-full";
        contentLayer.style.height = `${slots.length * ROW_HEIGHT}px`;

        slots.forEach(() => {
          const line = document.createElement("div");
          line.className = "border-b border-[#e9e9e7] w-full";
          line.style.height = `${ROW_HEIGHT}px`;
          contentLayer.appendChild(line);
        });

        // 繪製卡片
        dayItems.forEach((item) => {
          // ... (卡片內部繪製邏輯完全不用動，直接複製原本的即可) ...
          const [sH, sM] = item.start_time.split(":").map(Number);
          const [eH, eM] = item.end_time.split(":").map(Number);
          if (sH < START_HOUR) return;

          const startMin = (sH - START_HOUR) * 60 + sM;
          const endMin = (eH - START_HOUR) * 60 + eM;
          const topPx = (startMin / 60) * ROW_HEIGHT;
          const heightPx = ((endMin - startMin) / 60) * ROW_HEIGHT;

          // 排序計算 (維持不變)
          const overlaps = dayItems.filter(other => {
            const [osH] = other.start_time.split(":").map(Number);
            if (osH < START_HOUR) return false;
            const [otherSH, otherSM] = other.start_time.split(":").map(Number);
            const [otherEH, otherEM] = other.end_time.split(":").map(Number);
            const oStart = (otherSH - START_HOUR) * 60 + otherSM;
            const oEnd = (otherEH - START_HOUR) * 60 + otherEM;
            return startMin < oEnd && endMin > oStart;
          });

          if (typeof _userSortOrder !== 'undefined') {
            [item, ...overlaps].forEach(i => {
              if (!_userSortOrder.includes(i.id)) _userSortOrder.push(i.id);
            });
            var sortedGroup = [item, ...overlaps].sort((a, b) => _userSortOrder.indexOf(a.id) - _userSortOrder.indexOf(b.id));
            var orderIndex = sortedGroup.findIndex(i => i.id === item.id);
          } else {
            var orderIndex = 0;
          }
          const leftPx = orderIndex * CARD_WIDTH;

          // 狀態與顏色 (維持不變)
          const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          let displayStatus = item.color_class || 'status-pending';
          if (record) displayStatus = record.status;

          const statusMap = {
            'attended': 'status-present', 'status-present': 'status-present',
            'leave': 'status-leave', 'status-leave': 'status-leave',
            'absent': 'status-absent', 'status-absent': 'status-absent',
            'status-practice': 'status-practice', 'status-pending': 'status-pending'
          };
          let finalColorClass = statusMap[displayStatus] || 'status-pending';

          let btnIcon = 'circle-dashed';
          let btnColor = 'text-neutral-800';
          switch (finalColorClass) {
            case 'status-present': btnIcon = 'check-circle-2'; btnColor = 'text-green-600'; break;
            case 'status-leave': btnIcon = 'coffee'; btnColor = 'text-amber-700'; break;
            case 'status-absent': btnIcon = 'x-circle'; btnColor = 'text-red-500'; break;
            case 'status-practice': btnIcon = 'headphones'; btnColor = 'text-blue-500'; break;
            default: btnIcon = 'circle-dashed'; btnColor = 'text-neutral-800'; break;
          }

          const remarkText = (record && record.remark) ? record.remark : (item.remark || "");
          const showPin = remarkText !== "";

          // 建立卡片 DOM (維持不變)
          const card = document.createElement("div");
          // ... 樣式省略，請保持原本的 ...
          card.className = `absolute rounded-md p-2 text-sm ${finalColorClass} border-l-4 border-white shadow-sm flex flex-col transition-all duration-300 group box-border overflow-hidden hover:brightness-95 hover:z-50`;
          card.style.cssText = `top: ${topPx}px; height: ${heightPx + 1}px; left: ${leftPx}px; width: ${CARD_WIDTH}px; z-index: 20;`;

          card.draggable = true;
          card.ondragstart = (e) => handleDragStart(e, item.id);
          card.ondragend = (e) => handleDragEnd(e);
          card.ondragover = (e) => e.preventDefault();
          card.ondrop = (e) => handleDrop(e, item.id);

          const rawPhone = item.phone || '';
          const noteMatch = rawPhone.match(/\((.*?)\)/);
          const phoneNote = noteMatch ? noteMatch[1] : "";
          const phoneMain = rawPhone.replace(/\(.*?\)/, "").replace(/\D/g, "");

          card.innerHTML = `
            <div class="absolute top-1 right-1 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-[60]" onclick="event.stopPropagation()">
                <button type="button" onclick="openEditModal('${item.id}', '${displayStatus}', '${thisDayDateStr}')" 
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-blue-600 shadow-sm border border-gray-100 cursor-pointer">
                    <i data-lucide="edit-3" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>

                <button type="button" onclick="copyCourse('${item.id}', '${thisDayDateStr}')" 
                        title="複製此課程資料"
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-amber-600 shadow-sm border border-gray-100 cursor-pointer">
                    <i data-lucide="copy" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>

                <button type="button" onclick="deleteCourse('${item.id}')" 
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-red-600 shadow-sm border border-gray-100 cursor-pointer">
                    <i data-lucide="trash-2" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>
                
                <button type="button" onclick="handleToggleExpand(this)" 
                        class="p-1 bg-white/95 rounded text-neutral-800 hover:text-blue-600 shadow-sm border border-gray-100 transition-transform duration-300 cursor-pointer">
                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 pointer-events-none"></i>
                </button>
            </div>

            <div class="flex flex-col h-full min-w-0 pr-8 cursor-pointer" 
                 onclick="toggleRecordStatus('${item.id}', '${thisDayDateStr}', '${displayStatus}')">
                
                <div class="flex items-center gap-1.5 mb-1.5 shrink-0 pointer-events-none">
                    <i data-lucide="${btnIcon}" class="w-4 h-4 ${btnColor}"></i>
                    <div class="font-bold text-sm text-neutral-800 truncate leading-tight">${item.course_name || '未命名'}</div>
                </div>

                <div class="mt-0.5 text-[10px] text-red-600 font-bold bg-white/60 px-1 rounded flex items-center gap-1 w-fit pointer-events-none ${showPin ? 'block' : 'hidden'}">
                    <i data-lucide="pin" class="w-2.5 h-2.5"></i> ${remarkText}
                </div>

                <div class="flex flex-col gap-y-2 flex-1 min-h-0 overflow-hidden relative mt-1 pointer-events-none">
                    <div class="w-full flex items-start gap-1 ${phoneMain ? 'flex' : 'hidden'}">
                        <i data-lucide="phone" class="w-3.5 h-3.5 text-neutral-800"></i>
                        <div class="flex flex-col min-w-0 leading-tight">
                            <span class="text-sm text-neutral-800 font-medium truncate">${phoneMain}</span>
                            <span class="text-sm text-neutral-800 truncate ${phoneNote ? 'block' : 'hidden'}">${phoneNote}</span>
                        </div>
                    </div>
                    <div class="w-full flex items-center gap-1"><i data-lucide="music" class="w-3.5 h-3.5 text-neutral-800"></i><span class="text-sm text-neutral-800 truncate">${item.subject || ''}</span></div>
                    <div class="w-full flex items-center gap-1 ${item.room_no ? 'flex' : 'hidden'}"><i data-lucide="map-pin" class="w-3.5 h-3.5 text-neutral-800"></i><span class="text-sm text-neutral-800 truncate">${item.room_no}</span></div>
                </div>
                <div class="mt-auto pt-2 shrink-0 pb-0.5 pointer-events-none">
                    <div class="text-sm font-mono text-neutral-800 bg-white border border-black/10 rounded px-2 py-0.5 inline-block whitespace-nowrap shadow-sm">
                        ${item.start_time.slice(0, 5)}-${item.end_time.slice(0, 5)}
                    </div>
                </div>
            </div>`;
          // ... 
          contentLayer.appendChild(card);
        });

        dayCol.appendChild(contentLayer);
        container.appendChild(dayCol);
      }
      lucide.createIcons();
    }

    // 課程複製功能：把現有課程資料填入表單，作為「新增」的範本
    function copyCourse(itemId, dateStr) {
      // 1. 先用原本的編輯模式把資料填滿表單
      openEditModal(itemId, null, dateStr);

      // 2. 關鍵修正：將標題改為「複製並新增課程」
      document.querySelector("#course-modal h3").textContent = "複製並新增課程";

      // 3. 核心關鍵：將 editingId 設為空！
      // 這樣當妳按下「儲存」按鈕時，系統會執行 insert 而不是 update
      editingId = null;

      // 4. 自動勾選「僅限本週」
      // 因為會用到複製功能，通常是為了處理某一次的「調課」或「補課」
      const tempCheckbox = document.getElementById("is_temporary");
      if (tempCheckbox) tempCheckbox.checked = true;

      // 提示使用者
      console.log("已載入課程範本，修改時間後即可儲存為新課程。");
    }

    async function toggleRecordStatus(scheduleId, dateStr, currentStatus) {
      let nextStatus = '';
      let action = 'save';

      // 簡化後的循環：灰 -> 綠 -> 咖 -> 紅 -> 刪除(回到灰)
      if (!currentStatus || currentStatus === 'status-pending') {
        nextStatus = 'attended'; // 變綠色
      } else if (currentStatus === 'attended' || currentStatus === 'status-present') {
        nextStatus = 'leave';    // 變咖啡色
      } else if (currentStatus === 'leave' || currentStatus === 'status-leave') {
        nextStatus = 'absent';   // 變紅色
      } else {
        action = 'delete';       // 移除紀錄 (回到灰色)
      }

      try {
        if (action === 'delete') {
          await _client.from("lesson_records").delete().eq("schedule_id", scheduleId).eq("actual_date", dateStr);
        } else {
          const { data: existing } = await _client.from("lesson_records").select("id").eq("schedule_id", scheduleId).eq("actual_date", dateStr).maybeSingle();
          if (existing) {
            await _client.from("lesson_records").update({ status: nextStatus }).eq("id", existing.id);
          } else {
            await _client.from("lesson_records").insert({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus });
          }
        }
        setTimeout(() => { refreshData(); }, 150);
      } catch (err) {
        console.error("點名失敗:", err);
      }
    }

    // --- 專門處理卡片展開/收合的函式 ---
    function handleToggleExpand(btn) {
      // 1. 找到該按鈕所屬的卡片
      const card = btn.closest('.absolute.rounded-md');
      if (!card) return;

      // 2. 切換展開 class
      const isExpanded = card.classList.toggle('card-expanded');

      // 3. 視覺回饋：旋轉箭頭 180 度
      if (isExpanded) {
        btn.style.transform = 'rotate(180deg)';
      } else {
        btn.style.transform = 'rotate(0deg)';
      }

      // 4. 重新觸發 Lucide 圖示渲染 (確保圖示正確顯示)
      lucide.createIcons();
    }

    // 5. 老師管理功能
    async function addTeacher() {
      const name = document.getElementById("new-teacher-name").value.trim();
      if (!name) return;
      const { error } = await _client.from("teachers").insert([{ name }]);
      if (error) alert("新增失敗");
      document.getElementById("new-teacher-name").value = "";
      await fetchTeachers();
    }

    async function deleteTeacher(id) {
      if (!confirm("確定刪除老師嗎？相關課程也會一併刪除。")) return;
      await _client.from("teachers").delete().eq("id", id);
      if (currentTid === id) currentTid = null;
      await fetchTeachers();
    }

    // 6. 輔助函數 (加大版：px-2.5, py-1, -ml-2)
    function setStatus(msg, type = "warn") {
      const el = document.getElementById("status-tag");
      el.textContent = `資料庫連線狀態：${msg}`;

      // 定義顏色
      let colorClass = "bg-yellow-100 text-yellow-800"; // 預設 (黃)
      if (type === "error") colorClass = "bg-red-100 text-red-800"; // 錯誤 (紅)
      if (type === "success") colorClass = "bg-green-100 text-green-800"; // 成功 (綠)

      // 套用樣式 (同步加大與對齊修正)
      el.className = `text-[10px] md:text-xs px-2.5 py-1 rounded-md font-medium mt-0.5 -ml-2 ${colorClass}`;
    }
    // 新增這個函式，讓彈窗可以打開
    function openModal() {
      document.getElementById("course-modal").classList.remove("hidden");
    }
    function closeModal() {
      editingId = null;
      document.getElementById("course-modal").classList.add("hidden");
      document.getElementById("course-form").reset();
      document.querySelector("#course-modal h3").textContent = "新增課程資料";
    }
    function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
    }
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
    }

    // 7. 修改與刪除
    // 修改後：第一個參數接收 itemId (字串)，而不是 item (物件)
    function openEditModal(itemId, currentStatus, dateStr) {
      editingId = itemId;
      editingDateStr = dateStr;

      // ▼ 關鍵：用 ID 去全域變數 _cachedSchedule 找資料，避免 HTML 傳送錯誤 ▼
      const item = _cachedSchedule.find(i => i.id === itemId);
      if (!item) return alert("錯誤：找不到該課程資料");

      document.querySelector("#course-modal h3").textContent = "修改課程資料";
      const form = document.getElementById("course-form");

      // 填入資料
      form.day_of_week.value = item.day_of_week;
      form.teacher_id.value = item.teacher_id;
      form.course_name.value = item.course_name;
      form.start_time.value = item.start_time.slice(0, 5);
      form.end_time.value = item.end_time.slice(0, 5);
      form.room_no.value = item.room_no || "";
      form.amount.value = item.amount || 0;
      form.phone.value = item.phone || "";
      form.subject.value = item.subject || "";

      // ▼ 讀取備註邏輯更新 ▼
      // 優先找「日記 (record)」的備註，如果沒有，就找「母版 (item)」的常駐備註
      const record = _cachedRecords.find(r => r.schedule_id === item.id && r.actual_date === dateStr);

      if (record && record.remark) {
        // 如果今天有寫日記，就顯示日記的內容，且「常駐」不打勾 (因為這是特例)
        form.record_remark.value = record.remark;
        form.is_persistent.checked = false;
      } else {
        // 如果今天沒日記，就顯示母版的常駐內容，並把「常駐」打勾
        form.record_remark.value = item.remark || "";
        form.is_persistent.checked = !!item.remark; // 有內容就自動勾選
      }

      // 處理狀態顏色對照
      const reverseMap = {
        'attended': 'status-present', 'status-present': 'status-present',
        'leave': 'status-leave', 'status-leave': 'status-leave',
        'absent': 'status-absent', 'status-absent': 'status-absent',
        'practice': 'status-practice', 'status-practice': 'status-practice'
      };
      const statusValue = currentStatus || item.color_class || 'status-pending';
      form.color_class.value = reverseMap[statusValue] || 'status-pending';

      openModal();
    }

    async function deleteCourse(id) {
      if (!confirm("確定要刪除嗎？")) return;
      await _client.from("schedules").delete().eq("id", id);
      await refreshData();
    }

    // 8. 表單提交 (修正版：同步儲存 is_temporary 欄位)
    document
      .getElementById("course-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);

        if (f.get("start_time") >= f.get("end_time")) return alert("時間錯誤！");

        const isTemporary = document.getElementById("is_temporary").checked; // 抓取勾選狀態
        const monday = getMonday(currentBaseDate);
        const targetDate = isTemporary ? formatDate(addDays(monday, parseInt(f.get("day_of_week")) - 1)) : null;

        const scheduleData = {
          teacher_id: f.get("teacher_id"),
          day_of_week: parseInt(f.get("day_of_week")),
          course_name: f.get("course_name"),
          start_time: f.get("start_time") + ":00",
          end_time: f.get("end_time") + ":00",
          room_no: f.get("room_no"),
          amount: parseInt(f.get("amount")) || 0,
          phone: f.get("phone"),
          subject: f.get("subject"),
          color_class: f.get("color_class"),
          target_date: targetDate,

          // ★★★ 新增這行：把是否為臨時課程的狀態存入資料庫 ★★★
          is_temporary: isTemporary,

          // 處理常駐備註
          remark: f.get("is_persistent") === "on" ? f.get("record_remark") : ""
        };
        // ▼ 新增：處理常駐備註 ▼
        const isPersistent = f.get("is_persistent") === "on"; // 檢查是否勾選
        const remarkContent = f.get("record_remark");

        // 如果勾選「常駐」，就把備註存進 scheduleData (母版)
        if (isPersistent) {
          scheduleData.remark = remarkContent;
        } else {
          // 如果沒勾選，母版的備註要設為 null (或是保持原樣？這裡建議設為 null 代表取消常駐)
          // 但為了安全，我們先設為空字串，代表「移除常駐」
          scheduleData.remark = "";
        }

        // 1. 存母版 (Schedules)
        console.log("Saving schedule...");
        const res = editingId
          ? await _client.from("schedules").update(scheduleData).eq("id", editingId)
          : await _client.from("schedules").insert([scheduleData]);

        if (res.error) return alert("操作失敗: " + res.error.message);

        // 2. 存日記 (Lesson Records)
        // 如果「沒有」勾選常駐，代表這是一次性的，我們才存進日記
        // 或者：為了保險起見，我們「總是」把當天的狀態存進日記，確保歷史正確
        if (editingId && editingDateStr) {
          console.log("Upserting record...");
          await _client.from("lesson_records").upsert({
            schedule_id: editingId,
            teacher_id: f.get("teacher_id"),
            actual_date: editingDateStr,
            status: f.get("color_class"),
            remark: remarkContent || "" // 這裡不管是不是常駐，都把當下的文字寫入今天的日記，作為快照
          }, { onConflict: 'schedule_id,actual_date' });
        }

        // 3. 刷新
        closeModal();
        await refreshData();
      });

    // --- 老師管理功能邏輯 ---

    // 1. 開啟管理視窗並讀取最新清單
    async function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
      await renderTeacherManageList();
      lucide.createIcons();
    }

    // 2. 關閉視窗
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
      document.getElementById("new-teacher-name").value = "";
    }

    // 3. 渲染管理視窗內的老師列表 (支援編輯模式)
    async function renderTeacherManageList() {
      const { data: teachers, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");
      if (error) return;

      const manageList = document.getElementById("teacher-manage-list");
      manageList.innerHTML = "";

      teachers.forEach((t) => {
        const item = document.createElement("div");
        // 加上 group 讓按鈕在 hover 時顯示
        item.className = "flex justify-between items-center p-2.5 bg-gray-50 rounded-lg border border-gray-100 group transition-all hover:bg-white hover:shadow-sm";

        // 使用 data-id 屬性方便後續操作
        item.dataset.id = t.id;

        // 這裡我們準備兩種狀態的 HTML：
        // 1. 顯示狀態 (預設)
        // 2. 編輯狀態 (預設隱藏)
        item.innerHTML = `
      <div class="view-mode flex items-center justify-between w-full">
        <span class="text-sm font-medium text-neutral-700 select-none cursor-pointer" onclick="toggleEditMode('${t.id}')" title="點擊修改">${t.name}</span>
        <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
          <button onclick="toggleEditMode('${t.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition-colors" title="修改">
            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
          </button>
          <button onclick="deleteTeacher('${t.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded-md hover:bg-red-50 transition-colors" title="刪除">
            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
          </button>
        </div>
      </div>

      <div class="edit-mode hidden w-full flex items-center gap-2">
        <input type="text" value="${t.name}" 
          class="edit-input flex-1 border border-blue-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100"
          onkeydown="if(event.key === 'Enter') updateTeacher('${t.id}', this.value)"
        />
        <button onclick="updateTeacher('${t.id}', this.previousElementSibling.value)" class="p-1 text-green-600 hover:bg-green-100 rounded">
          <i data-lucide="check" class="w-4 h-4"></i>
        </button>
        <button onclick="toggleEditMode('${t.id}', false)" class="p-1 text-gray-400 hover:bg-gray-100 rounded">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
    `;
        manageList.appendChild(item);
      });
      lucide.createIcons();
    }

    // --- 新增的功能：切換編輯模式 ---
    function toggleEditMode(id, showEdit = true) {
      const item = document.querySelector(`div[data-id="${id}"]`);
      if (!item) return;

      const viewMode = item.querySelector('.view-mode');
      const editMode = item.querySelector('.edit-mode');
      const input = item.querySelector('.edit-input');

      if (showEdit) {
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        input.focus(); // 自動聚焦到輸入框
        input.select(); // 全選文字方便修改
      } else {
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
      }
    }

    // --- 新增的功能：執行更新老師名字 ---
    async function updateTeacher(id, newName) {
      newName = newName.trim();
      if (!newName) return alert("老師名字不能為空！");

      setStatus("正在更新資料...");

      // 1. 更新資料庫
      const { error } = await _client
        .from("teachers")
        .update({ name: newName })
        .eq("id", id);

      if (error) {
        setStatus("更新失敗", "error");
        alert("更新失敗: " + error.message);
      } else {
        setStatus("更新成功", "success");

        // 2. 如果目前正好選中這位老師，要同步更新標題
        if (currentTid === id) {
          document.getElementById("main-title").textContent = `${newName} · 本週課表`;
        }

        // 3. 重新整理列表與側邊欄
        await fetchTeachers(); // 更新側邊欄
        await renderTeacherManageList(); // 更新管理列表 (會自動切回顯示模式)
      }
    }

    // 4. 執行新增老師到資料庫
    async function addTeacher() {
      const input = document.getElementById("new-teacher-name");
      const name = input.value.trim();

      if (!name) return alert("請輸入老師姓名");

      setStatus("正在新增老師...");
      const { error } = await _client.from("teachers").insert([{ name }]);

      if (error) {
        setStatus("新增失敗", "error");
        alert("新增失敗: " + error.message);
      } else {
        input.value = "";
        setStatus("老師新增成功", "success");
        // 關鍵：新增完後要同時更新側邊欄與管理清單
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 5. 執行刪除老師 (會連動刪除該老師的課表)
    async function deleteTeacher(id) {
      if (!confirm("確定要刪除這位老師嗎？相關的所有課程將會一併消失！"))
        return;

      setStatus("正在刪除老師...");
      const { error } = await _client.from("teachers").delete().eq("id", id);

      if (error) {
        setStatus("刪除失敗", "error");
        alert("刪除失敗: " + error.message);
      } else {
        setStatus("老師已刪除", "success");
        // 如果刪除的是當前選取的老師，重置 ID 避免顯示錯誤
        if (currentTid === id) currentTid = null;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // --- 側邊欄控制 ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      // 切換 CSS class
      if (sidebar.classList.contains('-translate-x-full')) {
        // 打開
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        // 關閉
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    // 1. 打開選擇視窗 (預設顯示本月)
    function freezeTeacherHistory() {
      if (!currentTid) return alert("請先選擇一位老師");
      // 預設先幫妳填好「本月」的範圍
      quickSetFreezeDates('current');
      document.getElementById("freeze-date-modal").classList.remove("hidden");
    }

    // 2. 快速設定日期的核心邏輯 (升級版：支援連續點擊跳轉)
    function quickSetFreezeDates(type) {
      // 取得目前輸入框中顯示的起始日期
      const currentInputVal = document.getElementById("freeze-start-date").value;

      // 如果輸入框有值就用它當基準，沒有就用今天
      let baseDate = currentInputVal ? new Date(currentInputVal) : new Date();
      let start, end;

      if (type === 'current') {
        // 【設定本月】：固定回到「今天」所屬的月份
        const now = new Date();
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      } else {
        // 【設定上月】：從目前顯示的日期再往回推一個月
        // 抓取目前顯示月份的 1 號，並減去 1 個月
        start = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, 1);
        // 設定為該月最後一天
        end = new Date(baseDate.getFullYear(), baseDate.getMonth(), 0);
      }

      // 更新輸入框
      document.getElementById("freeze-start-date").value = formatDate(start);
      document.getElementById("freeze-end-date").value = formatDate(end);
    }

    // 2.5. 關閉視窗
    function closeFreezeModal() {
      document.getElementById("freeze-date-modal").classList.add("hidden");
    }

    // 3. 執行凍結 (讀取輸入框的值)
    async function executeFreeze() {
      const startStr = document.getElementById("freeze-start-date").value;
      const endStr = document.getElementById("freeze-end-date").value;
      const teacherName = document.getElementById("main-title").textContent.split(' · ')[0];

      if (!startStr || !endStr) return alert("請完整選擇日期範圍！");

      const startDate = new Date(startStr);
      const endDate = new Date(endStr);
      if (startDate > endDate) return alert("起始日期不能晚於結束日期唷！");

      if (!confirm(`確定要保留「${teacherName}」老師\n從 ${startStr} 到 ${endStr} 的紀錄嗎？`)) return;

      closeFreezeModal();
      setStatus(`正在保護 ${startStr} ~ ${endStr} 的歷史紀錄...`);

      const recordsToInsert = [];
      _cachedSchedule.forEach(course => {
        let checkDate = new Date(startDate);
        while (checkDate <= endDate) {
          let dayOfWeek = checkDate.getDay();
          if (dayOfWeek === 0) dayOfWeek = 7;
          if (dayOfWeek === course.day_of_week) {
            recordsToInsert.push({
              schedule_id: course.id,
              teacher_id: currentTid,
              actual_date: formatDate(checkDate),
              status: course.color_class || 'status-pending',
              remark: course.remark || "系統自動補檔"
            });
          }
          checkDate.setDate(checkDate.getDate() + 1);
        }
      });

      if (recordsToInsert.length === 0) return setStatus("範圍內沒有需要補檔的課程", "success");

      const { error } = await _client.from("lesson_records").upsert(recordsToInsert, {
        onConflict: 'schedule_id,actual_date', ignoreDuplicates: true
      });

      if (error) {
        setStatus("存檔失敗", "error");
      } else {
        setStatus(`成功！已補滿 ${recordsToInsert.length} 個歷史空缺。`, "success");
        await refreshData();
      }
    }

    // --- 薪資計算與排序核心邏輯 ---

    // 全域變數：暫存計算後的薪資資料
    let _salaryData = [];
    // 全域變數：紀錄目前的排序狀態 (key: 欄位, dir: 1 為升冪, -1 為降冪)
    let _salarySortState = { key: 'date', dir: 1 };

    // 1. 打開視窗 (預設上個月)
    function openSalaryModal() {
      if (!currentTid) return alert("請先選擇一位老師");

      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const end = new Date(now.getFullYear(), now.getMonth(), 0);

      document.getElementById("salary-start-date").value = formatDate(start);
      document.getElementById("salary-end-date").value = formatDate(end);

      // 重置狀態
      _salaryData = [];
      document.getElementById("salary-result").classList.add("hidden");
      document.getElementById("salary-modal").classList.remove("hidden");
    }

    function closeSalaryModal() {
      document.getElementById("salary-modal").classList.add("hidden");
    }

    // 2. 執行計算 (修正版：支援當天金額覆寫)
    async function calculateSalary() {
      const startStr = document.getElementById("salary-start-date").value;
      const endStr = document.getElementById("salary-end-date").value;

      if (!startStr || !endStr) return alert("請選擇日期範圍");

      setStatus("正在計算薪資...");

      try {
        // A. 撈取資料 (記得 lesson_records 裡要有 actual_amount 欄位)
        const { data: records, error: rErr } = await _client
          .from("lesson_records")
          .select("*, schedules(course_name, amount, subject)")
          .eq("teacher_id", currentTid)
          .gte("actual_date", startStr)
          .lte("actual_date", endStr);

        if (rErr) throw rErr;

        // B. 整理資料到記憶體
        let totalSalary = 0;
        let totalCount = 0;

        _salaryData = records.map(r => {
          const isPayable = ['attended', 'status-present', 'absent', 'status-absent'].includes(r.status);
          const courseInfo = r.schedules || { course_name: '(未知課程)', amount: 0, subject: '' };

          // ★★★ 關鍵邏輯：金額判定 ★★★
          // 1. 先看「日記」有沒有特別記一筆錢 (r.actual_amount)
          // 2. 如果沒有 (是 null)，就用「母版」的錢 (courseInfo.amount)
          let finalAmount = 0;
          if (r.actual_amount !== null && r.actual_amount !== undefined) {
            finalAmount = r.actual_amount;
          } else {
            finalAmount = courseInfo.amount || 0;
          }

          // 如果是不支薪的狀態 (如請假)，強制歸零
          // (除非妳希望請假也能手動填金額，那就要把這行拿掉)
          if (!isPayable) finalAmount = 0;

          if (isPayable) {
            totalSalary += finalAmount;
            totalCount++;
          }

          return {
            id: r.id,
            schedule_id: r.schedule_id,
            date: r.actual_date,
            course_name: courseInfo.course_name,
            subject: courseInfo.subject,
            status: r.status,
            amount: finalAmount, // 這裡存的是最終決定的金額
            isPayable: isPayable
          };
        });

        // C. 更新總數面板
        document.getElementById("total-salary").textContent = `$${totalSalary.toLocaleString()}`;
        document.getElementById("total-count").textContent = `${totalCount} 堂`;

        // D. 排序並渲染
        sortSalary('date');

        document.getElementById("salary-result").classList.remove("hidden");
        setStatus("薪資計算完成", "success");

      } catch (err) {
        console.error(err);
        setStatus("計算失敗", "error");
        alert("計算失敗：" + err.message);
      }
    }

    // 3. 排序觸發器 (點標題時呼叫)
    function sortSalary(key) {
      // 如果點擊同一個欄位，就反轉方向；否則預設升冪
      if (_salarySortState.key === key) {
        _salarySortState.dir *= -1;
      } else {
        _salarySortState.key = key;
        _salarySortState.dir = 1; // 預設升冪 (日期從小到大)
        if (key === 'amount') _salarySortState.dir = -1; // 金額預設從大到小比較直覺
      }

      // 執行排序
      _salaryData.sort((a, b) => {
        let valA, valB;

        if (key === 'date') {
          valA = a.date; valB = b.date;
        } else if (key === 'name') {
          valA = a.course_name; valB = b.course_name;
        } else if (key === 'amount') {
          valA = a.amount; valB = b.amount;
        } else if (key === 'status') {
          // 狀態自定義權重：上課 > 請假 > 曠課 > 其他
          const statusRank = {
            'attended': 1, 'status-present': 1,
            'leave': 2, 'status-leave': 2,
            'absent': 3, 'status-absent': 3
          };
          valA = statusRank[a.status] || 99;
          valB = statusRank[b.status] || 99;
        }

        if (valA < valB) return -1 * _salarySortState.dir;
        if (valA > valB) return 1 * _salarySortState.dir;
        return 0;
      });

      // 重新畫表格
      renderSalaryTable();
    }

    // 4. 渲染表格 HTML (純粹負責畫畫面)
    function renderSalaryTable() {
      const listBody = document.getElementById("salary-list");
      listBody.innerHTML = "";

      _salaryData.forEach(item => {
        // 狀態顯示文字與顏色
        let statusText = '', statusColor = '';
        const s = item.status;

        if (['attended', 'status-present'].includes(s)) { statusText = '✅ 上課'; statusColor = 'text-green-600 bg-green-50'; }
        else if (['leave', 'status-leave'].includes(s)) { statusText = '☕ 請假'; statusColor = 'text-amber-600 bg-amber-50'; }
        else if (['absent', 'status-absent'].includes(s)) { statusText = '❌ 曠課'; statusColor = 'text-red-600 bg-red-50'; }
        else { statusText = '尚未點名'; statusColor = 'text-gray-400'; }

        const row = `
          <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
            <td class="p-3 font-mono text-xs">${item.date.slice(5)}</td>
            <td class="p-3">
              <div class="font-bold text-gray-800">${item.course_name}</div>
              <div class="text-[10px] text-gray-400">${item.subject || ''}</div>
            </td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${statusText}</span>
            </td>
            <td class="p-3 text-right font-mono font-medium ${item.isPayable ? 'text-gray-800' : 'text-gray-300 line-through'}">
              $${item.amount}
            </td>
          </tr>
        `;
        listBody.innerHTML += row;
      });
    }

    // --- 功能 A：薪資結算匯出/匯入 (只改狀態) ---

    // A1. 匯出薪資報表 (修正版：標示姓名不可修改)
    function exportDailyReport() {
      if (_salaryData.length === 0) return alert("請先按「開始計算」產生資料！");

      const exportData = _salaryData.map(item => {
        let statusText = '未知';
        if (['attended', 'status-present'].includes(item.status)) statusText = '上課';
        else if (['leave', 'status-leave'].includes(item.status)) statusText = '請假';
        else if (['absent', 'status-absent'].includes(item.status)) statusText = '曠課';
        else statusText = '尚未點名';

        return {
          "系統編號(請勿修改)": item.schedule_id,
          "日期(請勿修改)": item.date,
          "學生姓名(請勿修改)": item.course_name,
          "狀態": statusText,
          "備註": "",
          "當日金額": item.isPayable ? item.amount : 0
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);

      // 設定欄寬
      const wscols = [
        { wch: 15 }, // ID
        { wch: 12 }, // 日期
        { wch: 20 }, // 學生姓名 (稍微加寬一點，因為標題變長了)
        { wch: 10 }, // 狀態
        { wch: 20 }, // 備註
        { wch: 12 }  // 金額
      ];
      ws['!cols'] = wscols;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "薪資結算");
      const teacherName = document.getElementById("main-title").textContent.split(' · ')[0] || "老師";
      XLSX.writeFile(wb, `${teacherName}_薪資結算表.xlsx`);
    }

    // A2. 匯入薪資修正 (修正版：讀取並更新金額)
    async function handleImportDaily(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });

          const statusMap = { '上課': 'status-present', '請假': 'status-leave', '曠課': 'status-absent', '尚未點名': 'status-pending' };
          const updates = [];

          for (const row of jsonRows) {
            const sid = row["系統編號(請勿修改)"];
            let date = row["日期(請勿修改)"];
            const status = row["狀態"];
            const remark = row["備註"];
            // ★ 讀取金額
            const amount = row["當日金額"];

            if (date && date.includes('/')) date = date.replace(/\//g, '-');
            if (!sid || !date) continue;

            updates.push({
              schedule_id: sid,
              teacher_id: currentTid,
              actual_date: date,
              status: statusMap[status] || 'status-pending',
              remark: remark || "",
              // ★ 寫入金額 (轉成整數，如果是 NaN 則存為 0)
              actual_amount: parseInt(amount) || 0
            });
          }

          if (updates.length === 0) return alert("無有效資料");
          setStatus(`正在更新 ${updates.length} 筆紀錄...`);

          const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });

          if (error) throw error;

          setStatus("薪資與金額更新成功！", "success");
          input.value = "";
          await calculateSalary(); // 重新計算
          await refreshData();     // 刷新課表

        } catch (err) {
          alert("匯入失敗: " + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- 批次管理視窗控制 ---
    function openBatchModal() {
      document.getElementById("batch-modal").classList.remove("hidden");
    }
    function closeBatchModal() {
      document.getElementById("batch-modal").classList.add("hidden");
    }

    // --- 功能 B: 母版全能匯出/匯入 ---

    // B1. 匯出所有欄位
    async function exportMasterData() {
      if (!currentTid) return alert("請先選擇老師");
      setStatus("正在下載完整課表...");

      const { data: courses } = await _client
        .from("schedules")
        .select("*")
        .eq("teacher_id", currentTid);

      if (!courses || courses.length === 0) return alert("該老師沒有課程資料");

      // 定義狀態中文對照
      const reverseStatusMap = {
        'status-present': '上課',
        'status-leave': '請假',
        'status-absent': '曠課',
        'status-practice': '學生練習',
        'status-pending': '尚未點名'
      };

      const exportData = courses.map(c => ({
        "課程編號(請勿修改)": c.id,
        "學生姓名": c.course_name,
        "電話": c.phone || "",
        "科目": c.subject || "",
        "金額": c.amount || 0,
        "星期(1-7)": c.day_of_week,
        "開始時間": c.start_time.slice(0, 5),
        "結束時間": c.end_time.slice(0, 5),
        "教室": c.room_no || "",
        "預設狀態": reverseStatusMap[c.color_class] || "尚未點名",
        "常駐備註": c.remark || "",
        "僅限本週(是/否)": c.is_temporary ? "是" : "否"
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      // 設定欄寬，讓 Excel 看起來舒服
      ws['!cols'] = [
        { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 8 },
        { wch: 8 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
        { wch: 10 }, { wch: 20 }, { wch: 10 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "完整課表母版");

      const teacherName = document.getElementById("main-title").textContent.split(' · ')[0] || "老師";
      XLSX.writeFile(wb, `${teacherName}_完整課表設定.xlsx`);
      setStatus("下載完成，請用 Excel 開啟編輯。", "success");
    }

    // B2. 匯入全能更新
    async function handleImportMaster(input) {
      const file = input.files[0];
      if (!file) return;

      if (!confirm("⚠️ 確定要匯入並覆蓋嗎？\n這會更新所有「固定課表」的設定 (包含電話、備註等)。")) {
        input.value = "";
        return;
      }

      setStatus("正在讀取 Excel...");
      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });

          // 定義狀態對照
          const statusMap = {
            '上課': 'status-present', '請假': 'status-leave',
            '曠課': 'status-absent', '尚未點名': 'status-pending',
            '學生練習': 'status-practice'
          };

          const updates = [];

          for (const row of jsonRows) {
            const id = row["課程編號(請勿修改)"];
            if (!id) continue;

            updates.push({
              id: id,
              course_name: row["學生姓名"],
              phone: row["電話"] || "",
              subject: row["科目"] || "",
              amount: parseInt(row["金額"]) || 0,
              day_of_week: parseInt(row["星期(1-7)"]),
              start_time: row["開始時間"],
              end_time: row["結束時間"],
              room_no: row["教室"] || "",
              color_class: statusMap[row["預設狀態"]] || 'status-pending',
              remark: row["常駐備註"] || "",
              is_temporary: row["僅限本週(是/否)"] === "是" // 轉換 "是" -> true
            });
          }

          if (updates.length === 0) return alert("無有效資料，請確認 Excel 格式。");

          setStatus(`正在更新 ${updates.length} 筆課程資料...`);

          const { error } = await _client.from("schedules").upsert(updates, { onConflict: 'id' });

          if (error) throw error;

          setStatus("母版資料全欄位更新成功！", "success");
          input.value = "";
          closeBatchModal();
          await refreshData(); // 刷新畫面

        } catch (err) {
          console.error(err);
          alert("匯入失敗: " + err.message);
          setStatus("匯入發生錯誤", "error");
        }
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>

</html>