<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多老師課表管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
    }

    /* 上課：草本綠 (調高飽和，邊框加深) */
    .status-present {
      background-color: #dcedc8 !important;
      /* 更有感的綠色 */
      border: 1.5px solid #9ccc65 !important;
      color: #33691e !important;
    }

    /* 請假：溫潤木棕 (增加暖度，明顯區分) */
    .status-leave {
      background-color: #f0e4d7 !important;
      /* 帶有奶茶感的背景 */
      border: 1.5px solid #bcaaa4 !important;
      color: #5d4037 !important;
    }

    /* 曠課：煙燻粉紅 (降低亮度但增加色彩濃度) */
    .status-absent {
      background-color: #ffdad9 !important;
      /* 明顯的粉紅背景 */
      border: 1.5px solid #ef9a9a !important;
      color: #c62828 !important;
    }

    .teacher-item.active {
      background-color: #f3f4f6;
    }

    @media (max-width: 768px) {

      /* 讓手機版的時間軸窄一點點，留更多空間給課表 */
      #schedule-container>div:first-child {
        width: 60px !important;
      }
    }
  </style>
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[90] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[100] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> 老師名單
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="p-4"> <button onclick="openTeacherModal()"
        class="w-full py-2 text-xs text-gray-500 hover:text-blue-600 border border-dashed rounded-lg flex items-center justify-center gap-1 transition-colors">
        <i data-lucide="settings-2" class="w-3 h-3"></i> 管理老師名單
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">網頁版本 v1.2</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-4 px-6 flex justify-between items-center shadow-sm sticky top-0 z-30">
      <div class="flex items-center gap-3">
        <button onclick="toggleSidebar()" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden">
          <i data-lucide="menu"></i>
        </button>
        <div class="flex flex-col">
          <h2 id="main-title"
            class="text-lg md:text-xl font-bold text-neutral-800 truncate max-w-[150px] md:max-w-none">
            載入中...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 font-medium inline-block w-fit mt-1">
            連線狀態：嘗試中...
          </div>
        </div>
      </div>

      <button onclick="openModal()"
        class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
        <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden md:inline">新增課程</span><span
          class="md:hidden">新增</span>
      </button>
    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[60] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] md:w-full max-w-md p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold">新增課程資料</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="course-form" class="space-y-4">
        <div class="space-y-3 pb-2 border-b border-gray-100">
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">課程名稱 (如: 鋼琴、小提琴)</label>
            <input type="text" name="subject" placeholder="請輸入科目名稱"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">學生姓名</label>
              <input type="text" name="course_name" required placeholder="姓名"
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">學生電話</label>
              <input type="tel" name="phone" placeholder="聯絡電話"
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
          </div>
        </div>

        <div class="space-y-3 pb-2 border-b border-gray-100">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">負責老師</label>
              <select name="teacher_id" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none"></select>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">上課星期</label>
              <select name="day_of_week" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none">
                <option value="1">週一</option>
                <option value="2">週二</option>
                <option value="3">週三</option>
                <option value="4">週四</option>
                <option value="5">週五</option>
                <option value="6">週六</option>
                <option value="7">週日</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">開始時間</label>
              <input type="time" name="start_time" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-1">結束時間</label>
              <input type="time" name="end_time" required
                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
            </div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">教室</label>
            <input type="text" name="room_no" placeholder="編號"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">薪資 (NT$)</label>
            <input type="number" name="amount" min="0" placeholder="0"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none" />
          </div>
          <div class="col-span-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">課程狀態</label>
            <select name="color_class"
              class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-blue-100 outline-none">
              <option value="status-present" selected>✅ 上課 (綠)</option>
              <option value="status-leave">☕ 請假 (咖)</option>
              <option value="status-absent">❌ 曠課 (紅)</option>
            </select>
          </div>
        </div>

        <div class="pt-4">
          <button type="submit"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> 儲存課程資料
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="teacher-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[70] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-80 p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold">老師名單管理</h3>
        <button onclick="closeTeacherModal()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex gap-2 mb-4">
        <input type="text" id="new-teacher-name" placeholder="姓名"
          class="flex-1 border rounded-lg px-2 py-1 text-sm outline-none" />
        <button onclick="addTeacher()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
          新增
        </button>
      </div>
      <div id="teacher-manage-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co";
    const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP";
    const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentTid = null; // 現在儲存的是 UUID
    let editingId = null;

    // 1. 初始化頁面
    window.onload = async () => {
      await fetchTeachers();
      lucide.createIcons();
    };

    // 2. 獲取老師列表
    async function fetchTeachers() {
      const { data, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");
      if (error) return setStatus("載入老師失敗", "error");

      const menu = document.getElementById("teacher-menu");
      const select = document.querySelector('select[name="teacher_id"]');
      const manageList = document.getElementById("teacher-manage-list");

      menu.innerHTML = "";
      select.innerHTML = "";
      manageList.innerHTML = "";

      data.forEach((t, index) => {
        // A. 側邊欄按鈕
        const btn = document.createElement("button");
        btn.className = `teacher-item w-full flex items-center gap-3 p-3 rounded-xl text-left transition-all hover:bg-gray-100 ${currentTid === t.id ? "active bg-gray-100" : ""}`;
        btn.onclick = () => switchTeacher(t.id, t.name);
        btn.innerHTML = `<span class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-gray-500"><i data-lucide="user"></i></span><span class="font-medium text-sm">${t.name}</span>`;
        menu.appendChild(btn);

        // B. 表單下拉選單
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;

        // C. 管理清單
        manageList.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm"><span>${t.name}</span><button onclick="deleteTeacher('${t.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>`;

        // 預設選中第一位
        if (!currentTid && index === 0) switchTeacher(t.id, t.name);
      });
      lucide.createIcons();
    }

    async function switchTeacher(tid, name) {
      currentTid = tid;
      document.getElementById("main-title").textContent =
        `${name} · 本週課表`;
      // 更新按鈕樣式
      document
        .querySelectorAll(".teacher-item")
        .forEach((btn) => btn.classList.remove("active", "bg-gray-100"));
      await refreshData();
    }

    // 3. 獲取課表資料
    async function refreshData() {
      if (!currentTid) return;
      setStatus("讀取中...");
      try {
        const { data, error } = await _client
          .from("schedules")
          .select("*")
          .eq("teacher_id", currentTid);
        if (error) throw error;
        renderSchedule(data || []);
        setStatus(`已同步 (${data.length} 筆資料)`, "success");
      } catch (e) {
        setStatus(`錯誤: ${e.message}`, "error");
      }
    }

    function renderSchedule(list) {
      const container = document.getElementById("schedule-container");
      container.innerHTML = "";

      const slots = ["09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];

      // --- 參數設定 ---
      const ROW_HEIGHT = 120;
      const HEADER_HEIGHT = 60;
      const START_HOUR = 9;
      const CARD_WIDTH = 140; // 卡片寬度

      // 關鍵修改：最小欄位寬度直接等於卡片寬度，不留白
      const MIN_COL_WIDTH = CARD_WIDTH;

      // --- 1. 建立左側「時間軸」 ---
      const timeCol = document.createElement("div");
      timeCol.className = "sticky left-0 z-50 bg-white border-r border-[#e9e9e7] flex flex-col shrink-0 shadow-sm";
      timeCol.style.width = "90px";

      const timeHeader = document.createElement("div");
      timeHeader.className = "sticky top-0 z-50 bg-gray-50 border-b border-[#e9e9e7] text-sm font-bold text-gray-600 flex items-center justify-center";
      timeHeader.style.height = `${HEADER_HEIGHT}px`;
      timeHeader.textContent = "時間";
      timeCol.appendChild(timeHeader);

      // 左側時間格子
      slots.forEach(h => {
        const cell = document.createElement("div");

        // 修改重點：
        // 1. items-start -> items-center (垂直置中)
        // 2. 移除 pt-2 (不需要上方留白了)
        cell.className = "flex items-center justify-center text-sm font-semibold text-gray-500 border-b border-[#e9e9e7] bg-gray-50/50";

        cell.style.height = `${ROW_HEIGHT}px`;
        cell.textContent = `${h}:00`;
        timeCol.appendChild(cell);
      });
      container.appendChild(timeCol);

      // --- 2. 準備資料 ---
      const dayGroups = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [] };
      const dayNames = ["週一", "週二", "週三", "週四", "週五", "週六", "週日"];
      list.forEach(item => {
        if (item.start_time && item.end_time) dayGroups[item.day_of_week].push(item);
      });

      // --- 3. 建立每一天的欄位 ---
      for (let day = 1; day <= 7; day++) {
        const dayItems = dayGroups[day];

        // A. 計算當天最大並排數
        let maxConcurrent = 0;
        if (dayItems.length > 0) {
          dayItems.forEach(item => {
            const [sH, sM] = item.start_time.split(":").map(Number);
            const [eH, eM] = item.end_time.split(":").map(Number);
            const sMin = (sH - START_HOUR) * 60 + sM;
            const eMin = (eH - START_HOUR) * 60 + eM;

            const overlaps = dayItems.filter(other => {
              const [osH, osM] = other.start_time.split(":").map(Number);
              const [oeH, oeM] = other.end_time.split(":").map(Number);
              const osMin = (osH - START_HOUR) * 60 + osM;
              const oeMin = (oeH - START_HOUR) * 60 + oeM;
              return sMin < oeMin && eMin > osMin;
            });
            if (overlaps.length > maxConcurrent) maxConcurrent = overlaps.length;
          });
        }
        if (maxConcurrent === 0) maxConcurrent = 1;

        // B. 關鍵修改：欄位寬度完全等於卡片總寬，不加額外的 padding
        const colWidth = Math.max(MIN_COL_WIDTH, maxConcurrent * CARD_WIDTH);

        const dayCol = document.createElement("div");
        dayCol.className = "flex flex-col border-r border-[#e9e9e7] shrink-0 relative bg-white";
        dayCol.style.width = `${colWidth}px`;

        // C. Header
        const header = document.createElement("div");
        header.className = "sticky top-0 z-40 bg-gray-50 border-b border-[#e9e9e7] text-lg font-bold text-gray-800 flex items-center justify-center shadow-sm";
        header.style.height = `${HEADER_HEIGHT}px`;
        header.textContent = dayNames[day - 1];
        dayCol.appendChild(header);

        // D. Content Layer
        const contentLayer = document.createElement("div");
        contentLayer.className = "relative w-full";
        contentLayer.style.height = `${slots.length * ROW_HEIGHT}px`;

        slots.forEach(() => {
          const line = document.createElement("div");
          line.className = "border-b border-[#e9e9e7] w-full";
          line.style.height = `${ROW_HEIGHT}px`;
          contentLayer.appendChild(line);
        });

        // F. 繪製卡片
        dayItems.forEach((item) => {
          const [sH, sM] = item.start_time.split(":").map(Number);
          const [eH, eM] = item.end_time.split(":").map(Number);
          if (sH < START_HOUR) return;

          const startMin = (sH - START_HOUR) * 60 + sM;
          const endMin = (eH - START_HOUR) * 60 + eM;

          const topPx = (startMin / 60) * ROW_HEIGHT;
          const heightPx = ((endMin - startMin) / 60) * ROW_HEIGHT;

          const overlaps = dayItems.filter(other => {
            const [osH, osM] = other.start_time.split(":").map(Number);
            const [oeH, oeM] = other.end_time.split(":").map(Number);
            const oStart = (osH - START_HOUR) * 60 + osM;
            const oEnd = (oeH - START_HOUR) * 60 + oeM;
            return startMin < oEnd && endMin > oStart;
          });

          const sortedGroup = [item, ...overlaps].sort((a, b) => a.id.localeCompare(b.id));
          const orderIndex = sortedGroup.findIndex(i => i.id === item.id);
          const leftPx = orderIndex * CARD_WIDTH;

          const card = document.createElement("div");
          card.className = `absolute rounded-md p-2 text-xs ${item.color_class || 'status-present'} border-l-4 border-white shadow-sm flex flex-col pointer-events-auto cursor-pointer transition-all duration-200 hover:shadow-xl hover:z-50 group box-border overflow-hidden`;

          card.style.cssText = `
                top: ${topPx}px; 
                height: ${heightPx + 1}px; 
                left: ${leftPx}px; 
                width: ${CARD_WIDTH}px; 
                z-index: 20;
            `;

          // --- 1. 電話處理邏輯 ---
          const rawPhone = item.phone || '';
          let phoneMain = rawPhone;
          let phoneNote = '';
          if (rawPhone.includes('(')) {
            const parts = rawPhone.split('(');
            phoneMain = parts[0];
            phoneNote = '(' + parts.slice(1).join('(');
          }
          const onlyDigits = phoneMain.replace(/\D/g, '');
          if (onlyDigits.length === 10 && onlyDigits.startsWith('09')) {
            phoneMain = `${onlyDigits.slice(0, 4)}-${onlyDigits.slice(4, 7)}-${onlyDigits.slice(7)}`;
          }

          // --- 2. 統一圖示設定 ---
          const subjectIcon = "music";
          const isShort = heightPx < 60;

          // --- 3. 視覺對齊優化 ---
          const phoneIconHtml = `
            <div class="w-4 h-4 flex items-center shrink-0">
                <i data-lucide="phone" class="w-3.5 h-3.5 text-gray-400"></i>
            </div>
          `;

          // 關鍵修改：
          // 1. -ml-[1px] 修正左右重心
          // 2. mt-[1px] 修正垂直重心，讓音符符號稍微往下壓一點
          const subjectIconHtml = `
            <div class="w-4 h-4 flex items-center shrink-0 -ml-[1px] mt-[1px]">
                <i data-lucide="${subjectIcon}" class="w-3.5 h-3.5 text-gray-400"></i>
            </div>
          `;

          card.innerHTML = `
                <div class="absolute top-1 right-1 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-30">
                    <button onclick="event.stopPropagation(); openEditModal(${JSON.stringify(item).replace(/"/g, "&quot;")})" class="p-1 bg-white/90 rounded text-gray-600 hover:text-blue-600 shadow-sm">
                        <i data-lucide="edit-3" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteCourse('${item.id}')" class="p-1 bg-white/90 rounded text-gray-600 hover:text-red-600 shadow-sm">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
                
                <div class="flex flex-col h-full min-w-0">
                    <div class="font-bold text-base text-neutral-800 truncate leading-tight">
                        ${item.course_name || '未命名'}
                    </div>

                    <div class="w-full mt-0.5 flex items-start gap-1 ${rawPhone ? 'block' : 'hidden'}">
                        ${phoneIconHtml}
                        <div class="flex flex-col min-w-0">
                            <span class="text-xs text-gray-600 font-medium truncate leading-4">
                                ${phoneMain}
                            </span>
                            <span class="text-[10px] text-gray-400 truncate leading-tight ${phoneNote ? 'block' : 'hidden'}">
                                ${phoneNote}
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 truncate opacity-90 mt-0.5 flex items-center gap-1 ${isShort ? 'hidden' : 'block'}">
                        ${subjectIconHtml}
                        <span>${item.subject || ''}</span>
                    </div>

                    <div class="text-xs font-mono text-gray-600 bg-white/50 rounded px-1 text-center ${isShort ? 'mt-1 self-start' : 'mt-auto self-start'}">
                        ${item.start_time.slice(0, 5)}-${item.end_time.slice(0, 5)}
                    </div>
                </div>
            `;
          contentLayer.appendChild(card);
        });

        dayCol.appendChild(contentLayer);
        container.appendChild(dayCol);
      }
      lucide.createIcons();
    }

    // 5. 老師管理功能
    async function addTeacher() {
      const name = document.getElementById("new-teacher-name").value.trim();
      if (!name) return;
      const { error } = await _client.from("teachers").insert([{ name }]);
      if (error) alert("新增失敗");
      document.getElementById("new-teacher-name").value = "";
      await fetchTeachers();
    }

    async function deleteTeacher(id) {
      if (!confirm("確定刪除老師嗎？相關課程也會一併刪除。")) return;
      await _client.from("teachers").delete().eq("id", id);
      if (currentTid === id) currentTid = null;
      await fetchTeachers();
    }

    // 6. 輔助函數
    function openModal() {
      document.getElementById("course-modal").classList.remove("hidden");
    }
    function closeModal() {
      editingId = null;
      document.getElementById("course-modal").classList.add("hidden");
      document.getElementById("course-form").reset();
      document.querySelector("#course-modal h3").textContent = "新增課程資料";
    }
    function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
    }
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
    }
    function setStatus(msg, type = "warn") {
      const el = document.getElementById("status-tag");
      el.textContent = `資料庫連線狀態：${msg}`;
      el.className = `text-xs px-3 py-1.5 rounded-full ${type === "error" ? "bg-red-100 text-red-800" : type === "success" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"} font-medium`;
    }

    // 7. 修改與刪除
    function openEditModal(item) {
      editingId = item.id;
      document.querySelector("#course-modal h3").textContent = "修改課程資料";
      const form = document.getElementById("course-form");
      form.day_of_week.value = item.day_of_week;
      form.teacher_id.value = item.teacher_id;
      form.course_name.value = item.course_name;
      form.start_time.value = item.start_time.slice(0, 5);
      form.end_time.value = item.end_time.slice(0, 5);
      form.room_no.value = item.room_no || "";
      form.amount.value = item.amount || 0;
      form.phone.value = item.phone || "";
      form.subject.value = item.subject || "";
      form.color_class.value = item.color_class;
      openModal();
    }

    async function deleteCourse(id) {
      if (!confirm("確定要刪除嗎？")) return;
      await _client.from("schedules").delete().eq("id", id);
      await refreshData();
    }

    // 8. 表單提交
    document
      .getElementById("course-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        if (f.get("start_time") >= f.get("end_time"))
          return alert("時間錯誤！");

        const data = {
          teacher_id: f.get("teacher_id"),
          day_of_week: parseInt(f.get("day_of_week")),
          course_name: f.get("course_name"), // 已補齊
          start_time: f.get("start_time") + ":00",
          end_time: f.get("end_time") + ":00",
          room_no: f.get("room_no"),         // 已改名
          amount: parseInt(f.get("amount")) || 0,
          phone: f.get("phone"),             // 已補齊
          subject: f.get("subject"),
          color_class: f.get("color_class"), // 已補齊
        };

        const res = editingId
          ? await _client.from("schedules").update(data).eq("id", editingId)
          : await _client.from("schedules").insert([data]);
        if (res.error) alert("操作失敗: " + res.error.message);
        else {
          closeModal();
          await refreshData();
        }
      });

    // --- 老師管理功能邏輯 ---

    // 1. 開啟管理視窗並讀取最新清單
    async function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
      await renderTeacherManageList();
      lucide.createIcons();
    }

    // 2. 關閉視窗
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
      document.getElementById("new-teacher-name").value = "";
    }

    // 3. 渲染管理視窗內的老師列表 (支援編輯模式)
    async function renderTeacherManageList() {
      const { data: teachers, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");
      if (error) return;

      const manageList = document.getElementById("teacher-manage-list");
      manageList.innerHTML = "";

      teachers.forEach((t) => {
        const item = document.createElement("div");
        // 加上 group 讓按鈕在 hover 時顯示
        item.className = "flex justify-between items-center p-2.5 bg-gray-50 rounded-lg border border-gray-100 group transition-all hover:bg-white hover:shadow-sm";

        // 使用 data-id 屬性方便後續操作
        item.dataset.id = t.id;

        // 這裡我們準備兩種狀態的 HTML：
        // 1. 顯示狀態 (預設)
        // 2. 編輯狀態 (預設隱藏)
        item.innerHTML = `
      <div class="view-mode flex items-center justify-between w-full">
        <span class="text-sm font-medium text-neutral-700 select-none cursor-pointer" onclick="toggleEditMode('${t.id}')" title="點擊修改">${t.name}</span>
        <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
          <button onclick="toggleEditMode('${t.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition-colors" title="修改">
            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
          </button>
          <button onclick="deleteTeacher('${t.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded-md hover:bg-red-50 transition-colors" title="刪除">
            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
          </button>
        </div>
      </div>

      <div class="edit-mode hidden w-full flex items-center gap-2">
        <input type="text" value="${t.name}" 
          class="edit-input flex-1 border border-blue-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100"
          onkeydown="if(event.key === 'Enter') updateTeacher('${t.id}', this.value)"
        />
        <button onclick="updateTeacher('${t.id}', this.previousElementSibling.value)" class="p-1 text-green-600 hover:bg-green-100 rounded">
          <i data-lucide="check" class="w-4 h-4"></i>
        </button>
        <button onclick="toggleEditMode('${t.id}', false)" class="p-1 text-gray-400 hover:bg-gray-100 rounded">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
    `;
        manageList.appendChild(item);
      });
      lucide.createIcons();
    }
    // --- 新增的功能：切換編輯模式 ---
    function toggleEditMode(id, showEdit = true) {
      const item = document.querySelector(`div[data-id="${id}"]`);
      if (!item) return;

      const viewMode = item.querySelector('.view-mode');
      const editMode = item.querySelector('.edit-mode');
      const input = item.querySelector('.edit-input');

      if (showEdit) {
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        input.focus(); // 自動聚焦到輸入框
        input.select(); // 全選文字方便修改
      } else {
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
      }
    }

    // --- 新增的功能：執行更新老師名字 ---
    async function updateTeacher(id, newName) {
      newName = newName.trim();
      if (!newName) return alert("老師名字不能為空！");

      setStatus("正在更新資料...");

      // 1. 更新資料庫
      const { error } = await _client
        .from("teachers")
        .update({ name: newName })
        .eq("id", id);

      if (error) {
        setStatus("更新失敗", "error");
        alert("更新失敗: " + error.message);
      } else {
        setStatus("更新成功", "success");

        // 2. 如果目前正好選中這位老師，要同步更新標題
        if (currentTid === id) {
          document.getElementById("main-title").textContent = `${newName} · 本週課表`;
        }

        // 3. 重新整理列表與側邊欄
        await fetchTeachers(); // 更新側邊欄
        await renderTeacherManageList(); // 更新管理列表 (會自動切回顯示模式)
      }
    }

    // 4. 執行新增老師到資料庫
    async function addTeacher() {
      const input = document.getElementById("new-teacher-name");
      const name = input.value.trim();

      if (!name) return alert("請輸入老師姓名");

      setStatus("正在新增老師...");
      const { error } = await _client.from("teachers").insert([{ name }]);

      if (error) {
        setStatus("新增失敗", "error");
        alert("新增失敗: " + error.message);
      } else {
        input.value = "";
        setStatus("老師新增成功", "success");
        // 關鍵：新增完後要同時更新側邊欄與管理清單
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 5. 執行刪除老師 (會連動刪除該老師的課表)
    async function deleteTeacher(id) {
      if (!confirm("確定要刪除這位老師嗎？相關的所有課程將會一併消失！"))
        return;

      setStatus("正在刪除老師...");
      const { error } = await _client.from("teachers").delete().eq("id", id);

      if (error) {
        setStatus("刪除失敗", "error");
        alert("刪除失敗: " + error.message);
      } else {
        setStatus("老師已刪除", "success");
        // 如果刪除的是當前選取的老師，重置 ID 避免顯示錯誤
        if (currentTid === id) currentTid = null;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // --- 側邊欄控制 ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      // 切換 CSS class
      if (sidebar.classList.contains('-translate-x-full')) {
        // 打開
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        // 關閉
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    // 點擊側邊欄選單後自動關閉 (提升手機體驗)
    async function switchTeacher(tid, name) {
      currentTid = tid;
      document.getElementById("main-title").textContent = `${name} · 本週課表`;

      document.querySelectorAll(".teacher-item").forEach((btn) => btn.classList.remove("active", "bg-gray-100"));

      // 新增：如果是手機版，點選後自動收起側邊欄
      if (window.innerWidth < 768) {
        toggleSidebar();
      }

      await refreshData();
    }
  </script>
</body>

</html>