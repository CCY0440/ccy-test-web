<!doctype html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>幕尼克音樂(金山校區)課表</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* 讓網頁載入前先隱形，並增加一點平滑過度的效果 */
    body {
      opacity: 0;
      font-family: "Noto Sans TC", sans-serif;
      transition: opacity 0.3s ease-in-out;
    }

    /* 當裝修好了，加上這個 class 就會顯示出來 */
    body.page-ready {
      opacity: 1;
    }

    /* ★ 解決拖曳感應不良：拖曳時，讓卡片內所有子元素滑鼠穿透 ★ */
    body.is-dragging .schedule-card * {
      pointer-events: none !important;
    }

    /* --- 新版卡片樣式：白底 + 左側色條 --- */

    /* 上課：綠色邊框 + 極淡綠底 */
    .status-present {
      background-color: #f0fdf4 !important;
      border-left: 4px solid #22c55e !important;
      /* 顯眼的左邊條 */
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #14532d !important;
    }

    /* 請假：琥珀色邊框 */
    .status-leave {
      background-color: #fffbeb !important;
      border-left: 4px solid #f59e0b !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #78350f !important;
    }

    /* 曠課：紅色邊框 */
    .status-absent {
      background-color: #fef2f2 !important;
      border-left: 4px solid #ef4444 !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #7f1d1d !important;
    }

    /* 學生練習：藍色邊框 */
    .status-practice {
      background-color: #eff6ff !important;
      border-left: 4px solid #3b82f6 !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #1e3a8a !important;
    }

    /* 尚未點名：灰色邊框 */
    .status-pending {
      background-color: #ffffff !important;
      border-left: 4px solid #d1d5db !important;
      border-top: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      color: #374151 !important;
    }

    /* 側邊欄選中狀態：加深背景色 */
    .teacher-item.active {
      background-color: #e2e8f0 !important;
      /* Slate-200 (比原本的灰色深) */
      color: #0f172a !important;
      /* 深藍黑色文字 */
      font-weight: 700 !important;
      /* 加粗文字 */
      border-right: 4px solid #3b82f6;
      /* (選用) 右邊加一條藍色線條增加識別度 */
    }

    /* 展開狀態的卡片樣式 */
    .card-expanded {
      height: auto !important;
      /* 讓內容決定高度 */
      min-height: min-content;
      z-index: 100 !important;
      /* 確保在最上層 */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding-bottom: 12px !important;
      /* 增加底部緩衝 */
    }

    /* 核心修正：強制讓隱形的日曆點擊感應區撐滿整個區域 */
    #date-picker::-webkit-calendar-picker-indicator {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 0;
      /* 完全透明但充滿整格 */
      z-index: 25;
    }

    @media (max-width: 768px) {

      /* 讓手機版的時間軸窄一點點，留更多空間給課表 */
      #schedule-container>div:first-child {
        width: 60px !important;
      }
    }
  </style>
</head>

<body class="text-neutral-800 h-[100dvh] overflow-hidden flex bg-[#fbfbfa]">
  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-[800] hidden md:hidden glass">
  </div>
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-[900] w-64 bg-white border-r border-[#e9e9e7] flex flex-col transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 shadow-xl md:shadow-none">
    <div class="p-6 flex justify-between items-center">
      <h1 class="font-bold text-lg flex items-center gap-2 text-neutral-800">
        <i data-lucide="users"></i> 老師名單
      </h1>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700">
        <i data-lucide="x"></i>
      </button>
    </div>

    <nav id="teacher-menu" class="flex-1 px-3 space-y-1 overflow-y-auto"></nav>

    <div class="px-4 py-2">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 shadow-sm relative group">
        <div class="flex items-center gap-1.5 mb-2 text-yellow-700/80">
          <i data-lucide="sticky-note" class="w-3.5 h-3.5"></i>
          <span class="text-xs font-bold">備忘錄</span>
          <span id="memo-status"
            class="ml-auto text-[10px] text-yellow-600 opacity-0 transition-opacity duration-500">已儲存</span>
        </div>
        <textarea id="teacher-memo"
          class="w-full bg-transparent text-xs text-gray-700 resize-none outline-none placeholder-yellow-700/30 leading-relaxed"
          rows="4" placeholder="隨手記點什麼..." oninput="handleMemoInput(this.value)"></textarea>
      </div>
    </div>

    <div class="p-4">

      <div id="user-profile-card"
        class="flex items-center gap-3 mb-4 p-2.5 bg-white border border-gray-200 rounded-xl shadow-sm">
        <div
          class="w-9 h-9 rounded-full bg-neutral-800 text-white flex items-center justify-center font-bold text-sm shrink-0 border-2 border-gray-100 shadow-sm">
          <span id="current-user-initial">?</span>
        </div>
        <div class="flex flex-col min-w-0">
          <div class="flex items-center gap-2"> <span class="text-xs font-bold text-neutral-800 truncate leading-tight"
              id="current-user-name">載入中...</span>
            <button onclick="openPasswordModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
              <i data-lucide="settings" class="w-3 h-3"></i>
            </button>
          </div>
          <span class="text-[10px] text-neutral-500 truncate leading-tight mt-0.5 flex items-center gap-1"
            id="current-user-role">
            <i data-lucide="shield-check" class="w-3 h-3"></i> 驗證中
          </span>
        </div>
      </div>

      <button id="admin-entry-btn" onclick="openAdminModal()"
        class="hidden w-full py-2 text-xs text-gray-500 hover:text-neutral-800 border border-dashed border-gray-300 hover:border-neutral-400 rounded-lg flex items-center justify-center gap-1.5 transition-all group">
        <i data-lucide="settings-2" class="w-3.5 h-3.5 group-hover:rotate-90 transition-transform"></i>
        <span class="font-bold">管理控制台</span>
      </button>

      <button onclick="openInstructionsModal()"
        class="w-full py-2 mt-2 text-xs text-amber-600 hover:bg-amber-50 border border-amber-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-medium">
        <i data-lucide="help-circle" class="w-3.5 h-3.5"></i> 系統使用說明
      </button>

      <button onclick="handleLogout()"
        class="w-full py-2 mt-2 text-xs text-red-600 hover:bg-red-50 border border-red-200 rounded-lg flex items-center justify-center gap-1 transition-colors font-bold">
        <i data-lucide="log-out" class="w-3.5 h-3.5"></i> 登出帳號
      </button>

      <div class="w-full border-t border-[#e9e9e7] my-4"></div>

      <div class="flex flex-col items-center justify-center text-gray-400 gap-1.5">
        <div class="text-[10px] font-medium">網頁版本 v1.5</div>
        <div class="text-[10px] font-mono opacity-60">Designed by @CCY</div>
      </div>

    </div>
  </aside>

  <main class="flex-1 flex flex-col w-full overflow-hidden">
    <header
      class="bg-white border-b border-[#e9e9e7] p-3 md:p-4 px-4 md:px-6 flex flex-wrap items-center gap-y-3 gap-x-4 shadow-sm sticky top-0 z-30">

      <div class="flex items-center gap-3 order-1 flex-1 min-w-[150px]">
        <button onclick="toggleSidebar()"
          class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg md:hidden shrink-0">
          <i data-lucide="menu"></i>
        </button>

        <div class="flex flex-col min-w-0">
          <h2 id="main-title" class="text-lg md:text-xl font-bold text-neutral-800 truncate leading-tight">
            載入中...
          </h2>
          <div id="status-tag"
            class="text-[10px] md:text-xs px-2.5 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium mt-0.5 -ml-2">
            嘗試連線...
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 order-2 lg:order-3 shrink-0">
        <button onclick="openSalaryModal()"
          class="flex items-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-emerald-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="calculator" class="w-4 h-4"></i>
          <span>薪資試算</span>
        </button>

        <button onclick="openBatchModal()"
          class="flex items-center gap-2 bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-indigo-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="sheet" class="w-4 h-4"></i>
          <span>批次管理</span>
        </button>

        <button onclick="freezeTeacherHistory()"
          class="flex items-center gap-2 bg-amber-50 text-amber-700 border border-amber-200 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-amber-100 transition-all shrink-0 shadow-sm">
          <i data-lucide="archive" class="w-4 h-4"></i>
          <span>凍結歷史</span>
        </button>

        <button onclick="openModal()"
          class="flex items-center gap-2 bg-neutral-800 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-neutral-700 transition-all shrink-0">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span class="hidden md:inline">新增課程</span><span class="md:hidden">新增</span>
        </button>
      </div>

      <div
        class="flex items-center justify-between gap-3 bg-white border border-gray-200 rounded-lg px-4 py-2 shadow-sm order-3 w-full lg:w-auto lg:mx-4 lg:order-2 relative overflow-hidden">

        <button onclick="changeWeek(-1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>

        <div class="relative flex-1 flex justify-center items-center group px-2 min-w-[220px]">

          <span id="current-date-range"
            class="text-sm md:text-base font-bold text-neutral-800 font-mono tracking-wide text-center cursor-pointer group-hover:text-blue-600 transition-colors select-none pointer-events-none whitespace-nowrap">
            計算中...
          </span>

          <input type="date" id="date-picker"
            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full appearance-none"
            onchange="handleDatePick(this.value)">
        </div>

        <button onclick="changeWeek(1)"
          class="p-1 hover:bg-gray-100 rounded-md text-gray-600 transition-colors shrink-0 z-20 relative">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>

    </header>

    <div class="flex-1 overflow-hidden bg-[#fbfbfa] relative">
      <div id="schedule-wrapper" class="w-full h-full overflow-auto">
        <div id="schedule-container" class="flex min-w-max">
        </div>
      </div>
    </div>
  </main>

  <div id="course-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1000] backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl w-[95%] md:w-full max-w-md shadow-2xl max-h-[90vh] flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50">
        <div class="flex items-center gap-2 text-blue-800">
          <i data-lucide="book-open" class="w-5 h-5"></i>
          <h3 class="font-bold m-0">新增課程資料</h3>
        </div>
        <button onclick="closeModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <form id="course-form" class="flex flex-col flex-1 min-h-0">
        <div class="p-6 overflow-y-auto bg-white space-y-4">

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div>
              <label class="block text-[11px] font-bold text-gray-500 mb-1">課程名稱 ( 如:EG-1、AG-1 )</label>
              <input type="text" name="subject" placeholder="請輸入科目名稱"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">學生姓名</label>
                <input type="text" name="course_name" required placeholder="姓名"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">學生電話 (多台請用空格)</label>
                <input type="tel" name="phone" placeholder="聯絡電話"
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none bg-gray-50 focus:bg-white transition-all shadow-inner" />
              </div>
            </div>
          </div>

          <div class="space-y-3 pb-4 border-b border-gray-100">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">負責老師</label>
                <select name="teacher_id" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner"></select>
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">上課星期</label>
                <select name="day_of_week" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                  <option value="1">週一</option>
                  <option value="2">週二</option>
                  <option value="3">週三</option>
                  <option value="4">週四</option>
                  <option value="5">週五</option>
                  <option value="6">週六</option>
                  <option value="7">週日</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">開始時間</label>
                <input type="time" name="start_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
              <div>
                <label class="block text-[11px] font-bold text-gray-500 mb-1">結束時間</label>
                <input type="time" name="end_time" required
                  class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
              </div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">教室</label>
              <input type="text" name="room_no" placeholder="教室名稱"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">薪資 (NT$)</label>
              <input type="number" name="amount" min="0" max="9999999" placeholder="0"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner" />
            </div>
            <div class="col-span-1">
              <label class="block text-[11px] font-bold text-gray-500 mb-1">預設狀態</label>
              <select name="color_class"
                class="w-full border border-gray-200 rounded-xl p-2.5 text-[11px] md:text-xs outline-none focus:ring-2 focus:ring-blue-400 bg-gray-50 focus:bg-white shadow-inner">
                <option value="status-pending" selected>⬜ 尚未點名</option>
                <option value="status-present">✅ 上課</option>
                <option value="status-leave">☕ 請假</option>
                <option value="status-absent">❌ 曠課</option>
                <option value="status-practice">🎹 學生練習</option>
              </select>
            </div>
          </div>

          <div class="mt-4 pt-4">
            <div
              class="bg-blue-50/50 border border-blue-100 rounded-xl p-4 relative overflow-hidden transition-all shadow-sm">
              <div class="flex items-center gap-2 relative z-10">
                <input type="checkbox" name="is_temporary" id="is_temporary"
                  class="w-4 h-4 cursor-pointer accent-blue-600 rounded"
                  onchange="document.getElementById('temp-date-wrapper').classList.toggle('hidden', !this.checked)">
                <label for="is_temporary" class="text-sm font-bold text-blue-800 cursor-pointer select-none">📌
                  設為「單次/臨時課程」</label>
              </div>
              <div id="temp-date-wrapper" class="hidden mt-3 relative z-10 pl-6 border-l-2 border-blue-300 ml-2">
                <label class="block text-[10px] font-bold text-blue-700 mb-1">上課日期 <span
                    class="font-normal text-blue-500">(將自動推算星期)</span></label>
                <input type="date" name="target_date" id="target_date_input"
                  class="w-full border border-blue-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 shadow-inner bg-white">
              </div>
            </div>
          </div>

        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2 shrink-0">
          <button type="button" onclick="closeModal()"
            class="px-5 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
          <button type="submit"
            class="px-5 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> 儲存設定
          </button>
        </div>
      </form>

    </div>
  </div>

  <div id="permissions-modal"
    class="hidden fixed inset-0 bg-black/50 z-[1600] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div
      class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh] border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-gray-800 flex items-center gap-2" id="perm-modal-title">
          <i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> 設定可見名單
        </h3>
        <button type="button" onclick="closePermissionsModal()"
          class="text-gray-400 hover:text-red-500 transition-colors bg-white p-1 rounded-full shadow-sm">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="p-2 overflow-y-auto flex-1 bg-white space-y-1" id="perm-checkbox-list">
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closePermissionsModal()"
          class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded-xl transition-colors">取消</button>
        <button type="button" onclick="savePermissions()"
          class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i> 儲存設定
        </button>
      </div>
    </div>
  </div>

  <div id="undo-modal"
    class="hidden fixed inset-0 bg-black/60 z-[2000] flex items-center justify-center backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm overflow-hidden flex flex-col border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex items-center gap-2 bg-amber-50">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i>
        <h3 class="font-bold text-amber-800" id="undo-modal-title">確認復原操作</h3>
      </div>
      <div class="p-5 text-sm text-gray-700 bg-white">
        <div id="undo-modal-content"
          class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-2 text-xs font-mono shadow-inner">
        </div>
        <p class="mt-4 text-[11px] font-bold text-red-500 text-center bg-red-50 py-1.5 rounded-lg border border-red-100"
          id="undo-modal-warning">
          👉 執行後，資料將退回到修改前的狀態！
        </p>
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button type="button" onclick="closeUndoModal()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
        <button type="button" onclick="confirmExecuteUndo()"
          class="px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-xl transition-colors font-bold shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="undo-2" class="w-4 h-4"></i> 確認復原
        </button>
      </div>
    </div>
  </div>

  <div id="instructions-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div
      class="bg-white rounded-2xl w-[95%] max-w-lg p-0 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col border border-neutral-200">

      <div class="bg-neutral-50 px-6 py-4 border-b border-neutral-200 flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2 text-neutral-800">
          📅 系統使用指南 (v1.5)
        </h3>
        <button onclick="closeInstructionsModal()"
          class="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-200 rounded-full transition-all">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 text-sm text-neutral-700 leading-relaxed">

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
            頂部工具列 (日期與管理)
          </h4>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
            <ul class="space-y-2 text-xs text-gray-700">
              <li class="flex items-start gap-2">
                <i data-lucide="calendar" class="w-3.5 h-3.5 mt-0.5 text-blue-500"></i>
                <span><b>日期切換：</b>點擊左右箭頭中間的日期可選起始日期，左右箭頭切換週次。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="calculator" class="w-3.5 h-3.5 mt-0.5 text-emerald-600"></i>
                <span><b>薪資試算：</b>計算指定日期範圍內的總薪資與堂數。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="sheet" class="w-3.5 h-3.5 mt-0.5 text-indigo-600"></i>
                <span><b>批次管理：</b>下載或匯入 Excel，可快速大量修改固定課表。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="archive" class="w-3.5 h-3.5 mt-0.5 text-amber-600"></i>
                <span><b>凍結歷史：</b>更改固定課表前，可先凍結舊日期的紀錄，以免舊資料跑掉。</span>
              </li>
              <li class="flex items-start gap-2">
                <i data-lucide="plus" class="w-3.5 h-3.5 mt-0.5 text-neutral-800"></i>
                <span><b>新增課程：</b>建立一堂新的固定課程或單次課程。</span>
              </li>
            </ul>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
            日常操作 (點名與卡片)
          </h4>
          <div class="grid gap-3">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-blue-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="mouse-pointer-2" class="w-3.5 h-3.5"></i> 點擊卡片區塊 (點名)
              </h5>
              <p class="text-xs text-blue-900/80">
                點一下切換狀態，顏色代表：(以此類推)<br>
                <span class="font-bold text-green-700">綠(上課)</span> →
                <span class="font-bold text-amber-700">咖(請假)</span> →
                <span class="font-bold text-red-700">紅(曠課)</span> →
                <span class="font-bold text-gray-500">灰(尚未點名)</span>。
              </p>
            </div>

            <div class="bg-orange-50 border-l-4 border-orange-400 p-3 rounded-r-lg">
              <h5 class="font-bold text-orange-800 mb-1 flex items-center gap-1 text-xs">
                <i data-lucide="edit-3" class="w-3.5 h-3.5"></i> 卡片右側按鈕
              </h5>
              <ul class="text-xs text-orange-900/80 list-disc pl-4 space-y-1">
                <li><b class="text-yellow-700">黃色便利貼：</b>寫備註。支援<b>「日期區間」</b>，可一次設定多週備註 (如長假)。</li>
                <li><b class="text-blue-700">藍色鉛筆：</b>修改這堂課的固定課表(如改電話、改上課時間等...)。</li>
                <li><b class="text-gray-600">灰色複製：</b>複製一個資訊完全相同的卡片(適合臨時加課、調課)。</li>
                <li><b class="text-red-600">紅色垃圾桶：</b>刪除這個的固定課表。</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h4 class="font-bold text-neutral-900 text-base mb-2 flex items-center gap-2">
            <span
              class="bg-neutral-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">3</span>
            實用小芝士🧀
          </h4>
          <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-3">
            <ul class="space-y-2 text-xs text-emerald-900">
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>隨手備忘錄：</b>側邊欄的黃色便條紙打字後會自動儲存，可隨手紀錄。</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>加課最速技：</b>按下「複製(灰)」按鈕 → 調整課堂資料 → 勾選「僅限本週」，就能快速新增本週課程。</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                <span><b>調課最速技：</b>按下「複製(灰)」按鈕 → 調整時間 → 勾選「僅限本週」，就能快速安排單次的調課。</span>
              </li>
            </ul>
          </div>
        </section>

        <section
          class="text-sm text-gray-400 px-4 space-y-1 bg-gray-50/50 py-3 rounded-lg border border-dashed border-gray-200">
          <p class="font-bold mb-1 text-gray-500">特別提醒</p>
          <ul class="space-y-1.5 text-xs">
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>初次登入請務必更改密碼及記住密碼，後台僅能協助重設密碼。</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>若使用過程有任何錯誤訊息，請截圖保留錯誤資訊給 <b class="text-gray-500">鮪魚老師</b>，謝謝。</p>
            </li>
            <li class="flex gap-2 items-start">
              <span class="w-1 h-1 rounded-full bg-gray-300 shrink-0 mt-1.5"></span>
              <p>有任何使用相關的問題或修改建議請聯繫 <b class="text-gray-500">鮪魚老師</b> :D</p>
            </li>
            <li class="flex gap-2 items-start">

          </ul>
        </section>

        <section class="text-center space-y-3 pt-2">
          <button onclick="closeInstructionsModal()"
            class="w-full bg-neutral-800 text-white py-3 rounded-xl font-bold hover:bg-black transition-all active:scale-95 shadow-md">
            我瞭解了
          </button>
        </section>

      </div>
    </div>
  </div>

  <div id="freeze-date-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1200] backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl w-80 shadow-2xl flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-amber-100 flex justify-between items-center bg-amber-50">
        <h3 class="font-bold text-amber-800 flex items-center gap-2 m-0">
          <i data-lucide="archive" class="w-5 h-5 text-amber-600"></i> 自訂凍結範圍
        </h3>
        <button onclick="closeFreezeModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="p-5 bg-white space-y-5">
        <div class="flex gap-2 bg-gray-50 p-1.5 rounded-xl border border-gray-200 shadow-inner">
          <button onclick="quickSetFreezeDates('current')"
            class="flex-1 py-1.5 bg-white shadow-sm text-gray-600 text-xs font-bold rounded-lg hover:text-amber-600 hover:border-amber-200 border border-gray-100 transition-colors">設定本月</button>
          <button onclick="quickSetFreezeDates('last')"
            class="flex-1 py-1.5 bg-white shadow-sm text-gray-600 text-xs font-bold rounded-lg hover:text-amber-600 hover:border-amber-200 border border-gray-100 transition-colors">設定上月</button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">起始日期 (From)</label>
            <input type="date" id="freeze-start-date"
              class="w-full border border-gray-300 bg-gray-50 focus:bg-white rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-400 transition-all shadow-inner" />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1">結束日期 (To)</label>
            <input type="date" id="freeze-end-date"
              class="w-full border border-gray-300 bg-gray-50 focus:bg-white rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-amber-400 transition-all shadow-inner" />
          </div>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-2">
        <button onclick="closeFreezeModal()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
        <button onclick="executeFreeze()"
          class="px-5 py-2 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700 transition-all text-sm shadow-md active:scale-95 flex items-center gap-2">
          <i data-lucide="lock" class="w-4 h-4"></i> 確認凍結
        </button>
      </div>

    </div>
  </div>

  <div id="batch-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-md p-6 shadow-2xl border border-indigo-100">

      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2 text-indigo-800">
          <i data-lucide="sheet" class="w-5 h-5"></i> 固定課表批次管理
        </h3>
        <button onclick="closeBatchModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="p-3 bg-indigo-50 rounded-lg text-xs text-indigo-900 leading-relaxed border border-indigo-100">
          <p class="font-bold mb-1">功能說明：</p>
          <ul class="list-disc pl-4 space-y-1">
            <li>此功能用於修改<b>「固定課表」</b>(如：漲學費、換教室、改電話)。</li>
            <li>Excel 包含所有欄位：姓名、電話、金額、科目、備註等。</li>
            <li>上傳修改後的Excel後會直接覆蓋現有的固定課表設定。</li>
          </ul>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="exportMasterData()"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="download" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">下載課表 Excel</span>
          </button>

          <button onclick="document.getElementById('import-master-input').click()"
            class="flex flex-col items-center justify-center gap-2 py-4 bg-white border-2 border-indigo-100 rounded-xl hover:border-indigo-500 hover:text-indigo-600 transition-all group">
            <div class="p-2 bg-indigo-50 rounded-full group-hover:bg-indigo-100 text-indigo-600">
              <i data-lucide="upload" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-bold text-gray-600 group-hover:text-indigo-700">上傳修改後的 Excel</span>
          </button>
        </div>

        <input type="file" id="import-master-input" accept=".xlsx, .xls" class="hidden"
          onchange="handleImportMaster(this)" />
      </div>

    </div>
  </div>

  <div id="salary-modal"
    class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1300] backdrop-blur-sm">
    <div class="bg-white rounded-xl w-[95%] max-w-2xl h-[85vh] p-6 shadow-2xl border border-emerald-100 flex flex-col">

      <div class="flex justify-between items-center mb-4 shrink-0">
        <h3 class="font-bold text-lg flex items-center gap-2 text-emerald-800">
          <i data-lucide="calculator" class="w-5 h-5"></i> 薪資結算報告
        </h3>
        <button onclick="closeSalaryModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div
        class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 shrink-0 bg-emerald-50/50 p-3 rounded-lg border border-emerald-100">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label>
          <input type="date" id="salary-start-date" onchange="autoUpdateEndDate(this.value)"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label>
          <input type="date" id="salary-end-date"
            class="w-full border border-gray-200 rounded-lg px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-emerald-200">
        </div>
        <div class="flex items-end">
          <button onclick="calculateSalary()"
            class="w-full bg-emerald-600 text-white py-1.5 rounded-lg text-sm font-bold shadow hover:bg-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 h-[34px]">
            <i data-lucide="search" class="w-4 h-4"></i> 開始計算
          </button>
        </div>
      </div>

      <div id="salary-result" class="hidden flex flex-col flex-1 min-h-0 overflow-hidden">

        <div class="flex gap-4 mb-4 shrink-0">
          <div
            class="flex-1 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="absolute -right-4 -bottom-4 opacity-20"><i data-lucide="coins" class="w-24 h-24"></i></div>
            <p class="text-emerald-100 text-xs font-bold mb-1">預估總薪資</p>
            <p class="text-3xl font-bold tracking-tight" id="total-salary">$0</p>
          </div>
          <div class="flex-1 bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs text-gray-500">總堂數</span>
              <span class="text-lg font-bold text-gray-800" id="total-count">0 堂</span>
            </div>
            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
              <div class="bg-emerald-500 h-full w-full"></div>
            </div>
            <div class="mt-2 text-[10px] text-gray-400">
              *僅計算「上課」與「曠課」
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto border border-gray-200 rounded-lg relative bg-white">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm select-none">
              <tr>
                <th onclick="sortSalary('date')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">日期 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('name')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">學生/課程 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('status')"
                  class="p-3 bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center gap-1">狀態 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
                <th onclick="sortSalary('amount')"
                  class="p-3 text-right bg-gray-50 whitespace-nowrap cursor-pointer hover:bg-gray-100 transition-colors group">
                  <div class="flex items-center justify-end gap-1">金額 <i data-lucide="arrow-up-down"
                      class="w-3 h-3 text-gray-300 group-hover:text-gray-500"></i></div>
                </th>
              </tr>
            </thead>
            <tbody id="salary-list" class="divide-y divide-gray-100 text-gray-700">
            </tbody>
          </table>
        </div>

        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col gap-3 shrink-0">

          <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg border border-emerald-100">
            <div class="flex flex-col">
              <span class="text-xs font-bold text-emerald-800">薪資結算修正</span>
              <span class="text-[10px] text-emerald-600">僅修改對應時間的「狀態、備註與當日薪資」，並不會修改到其他時間的課表。</span>
            </div>
            <div class="flex gap-2">
              <input type="file" id="import-daily-input" accept=".xlsx, .xls" class="hidden"
                onchange="handleImportDaily(this)" />
              <button onclick="exportDailyReport()"
                class="bg-white text-emerald-700 border border-emerald-200 text-xs font-bold px-3 py-2 rounded hover:bg-emerald-100 transition-all flex items-center gap-1">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> 匯出報表
              </button>
              <button onclick="document.getElementById('import-daily-input').click()"
                class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded shadow hover:bg-emerald-700 transition-all flex items-center gap-1">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> 匯入修正
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="password-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1100] backdrop-blur-sm">
    <div class="bg-white rounded-2xl w-[90%] max-w-xs p-6 shadow-2xl border border-neutral-200">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">🔑 修改登入密碼</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-gray-400 mb-1">新密碼</label>
          <input type="password" id="new-password"
            class="w-full border border-gray-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-neutral-800"
            placeholder="至少 6 位數">
        </div>
        <button onclick="handleUpdatePassword()"
          class="w-full bg-neutral-800 text-white py-2 rounded-lg font-bold hover:bg-black transition-all active:scale-95 shadow-md text-sm">
          確認變更
        </button>
        <button onclick="closePasswordModal()"
          class="w-full text-gray-400 text-xs py-1 hover:text-gray-600 transition-colors">
          取消
        </button>
      </div>
    </div>
  </div>

  <div id="remark-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1400] backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl w-80 shadow-2xl flex flex-col overflow-hidden border border-gray-100">

      <div class="p-4 border-b border-yellow-100 flex justify-between items-center bg-yellow-50">
        <h3 class="font-bold text-yellow-800 flex items-center gap-2 m-0">
          <i data-lucide="sticky-note" class="w-5 h-5 text-yellow-600"></i> 設定備註
        </h3>
        <button onclick="closeRemarkModal()"
          class="text-gray-400 hover:text-red-500 bg-white hover:bg-red-50 p-1.5 rounded-full transition-colors shadow-sm border border-gray-100">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="p-5 bg-white space-y-4 text-sm">
        <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-inner">
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">開始日期</label>
            <input type="date" id="remark-start-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          <div>
            <label class="block text-[10px] font-bold text-gray-500 mb-1">結束日期</label>
            <input type="date" id="remark-end-date"
              class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs bg-white outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
        </div>
        <div>
          <textarea id="quick-remark-input"
            class="w-full bg-gray-50 focus:bg-white border border-gray-200 focus:border-yellow-400 rounded-xl p-3 text-sm outline-none resize-none text-neutral-700 shadow-inner transition-colors"
            rows="3" placeholder="例如：補課、請假..."></textarea>
        </div>
      </div>

      <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-between gap-2 items-center">
        <button onclick="saveQuickRemark(true)"
          class="p-2 bg-white text-red-500 border border-gray-200 hover:bg-red-50 hover:border-red-200 rounded-xl font-bold transition-all shadow-sm flex items-center justify-center group"
          title="清空此區間的備註">
          <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
        </button>
        <div class="flex gap-2">
          <button onclick="closeRemarkModal()"
            class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-700 rounded-xl transition-colors">取消</button>
          <button onclick="saveQuickRemark(false)"
            class="px-5 py-2 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600 transition-all text-sm shadow-md active:scale-95 flex items-center gap-2">
            <i data-lucide="save" class="w-4 h-4"></i> 儲存
          </button>
        </div>
      </div>

    </div>
  </div>

  <div id="admin-modal"
    class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[1500] backdrop-blur-sm">
    <div
      class="bg-white rounded-xl w-[95%] max-w-4xl h-[90vh] shadow-2xl flex flex-col border border-neutral-200 overflow-hidden">

      <div class="bg-neutral-800 text-white flex shrink-0">
        <div class="px-6 py-4 font-bold text-lg flex items-center gap-2 border-r border-neutral-700 min-w-[200px]">
          <i data-lucide="shield-alert" class="w-5 h-5"></i> 管理控制台
        </div>
        <div class="flex flex-1 overflow-x-auto">
          <button onclick="switchAdminTab('directory')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-directory">
            <i data-lucide="contact" class="w-4 h-4"></i> 通訊錄
          </button>
          <button onclick="switchAdminTab('stats')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-stats">
            <i data-lucide="pie-chart" class="w-4 h-4"></i> 統計報表
          </button>
          <button onclick="switchAdminTab('teachers')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-teachers">
            <i data-lucide="users" class="w-4 h-4"></i> 老師管理
          </button>
          <button onclick="switchAdminTab('logs')"
            class="admin-tab px-5 py-4 text-sm font-bold text-gray-300 hover:text-white hover:bg-neutral-700 border-b-4 border-transparent transition-all flex items-center gap-2"
            id="tab-btn-logs">
            <i data-lucide="history" class="w-4 h-4"></i> 操作日誌
          </button>
        </div>
        <button onclick="closeAdminModal()"
          class="px-6 hover:bg-neutral-700 text-gray-400 hover:text-white transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="flex-1 bg-gray-50 overflow-hidden relative">

        <div id="tab-content-directory" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div class="flex justify-between items-center mb-4 shrink-0">
            <div class="relative w-72">
              <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
              <input type="text" id="dir-search" oninput="renderDirectory()" placeholder="搜尋姓名、電話..."
                class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-neutral-800">
            </div>
            <div class="text-xs text-gray-500">提示：點擊任何欄位即可複製</div>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('name')">
                    <div class="flex items-center gap-1">學生姓名 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('phone')">
                    <div class="flex items-center gap-1">電話 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('subject')">
                    <div class="flex items-center gap-1">科目 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                  <th class="p-4 cursor-pointer hover:bg-gray-100 transition-colors group"
                    onclick="sortDirectory('teacher')">
                    <div class="flex items-center gap-1">負責老師 <i data-lucide="arrow-up-down"
                        class="w-3.5 h-3.5 text-gray-300 group-hover:text-gray-500"></i></div>
                  </th>
                </tr>
              </thead>
              <tbody id="directory-list" class="divide-y divide-gray-100 text-neutral-700"></tbody>
            </table>
          </div>
        </div>

        <div id="tab-content-stats" class="admin-tab-content w-full h-full flex flex-col p-6 hidden overflow-y-auto">
          <div
            class="flex flex-wrap items-end gap-3 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm shrink-0">

            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1">1. 選擇老師</label>
              <select id="stat-teacher" onchange="updateStudentList()"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none bg-white min-w-[120px] focus:ring-2 focus:ring-neutral-800">
                <option value="all">ALL</option>
              </select>
            </div>

            <div class="flex-1 min-w-[180px] relative group">
              <label class="block text-xs font-bold text-gray-500 mb-1">2. 搜尋學生</label>

              <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                <input type="text" id="stat-student" placeholder="輸入姓名搜尋..."
                  class="w-full border border-gray-300 rounded-lg pl-9 pr-8 py-1.5 text-sm outline-none focus:ring-2 focus:ring-neutral-800 focus:border-neutral-800 transition-all"
                  oninput="filterStudentList(this.value)" onfocus="showStudentList()" autocomplete="off">

                <button id="clear-student-btn" onclick="clearStudentSearch()"
                  class="hidden absolute right-2 top-2 text-gray-400 hover:text-gray-600">
                  <i data-lucide="x-circle" class="w-4 h-4"></i>
                </button>
              </div>

              <ul id="student-dropdown-list"
                class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto divide-y divide-gray-50">
                <li class="p-3 text-sm text-gray-400 text-center">請先選擇老師...</li>
              </ul>
            </div>

            <div><label class="block text-xs font-bold text-gray-500 mb-1">開始日期</label><input type="date"
                id="stat-start" class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">結束日期</label><input type="date" id="stat-end"
                class="border border-gray-300 rounded-lg px-2 py-1.5 text-sm outline-none w-32"></div>

            <button onclick="calculateStats()"
              class="bg-neutral-800 text-white px-5 py-1.5 rounded-lg text-sm font-bold hover:bg-black transition-all shadow-md h-[34px] flex items-center">
              <i data-lucide="search" class="w-3.5 h-3.5 mr-1"></i> 查詢
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center min-h-[300px]">
              <h4 class="font-bold text-gray-700 mb-6 flex items-center gap-2"><i data-lucide="pie-chart"
                  class="w-4 h-4"></i> 整體狀態分佈</h4>
              <div id="stat-pie-chart" class="w-48 h-48 rounded-full shadow-inner relative"
                style="background: conic-gradient(#d1d5db 0% 100%);">
                <div
                  class="absolute inset-0 m-auto w-24 h-24 bg-white rounded-full flex items-center justify-center flex-col">
                  <span id="stat-total-lessons" class="text-xl font-bold text-neutral-800">0</span><span
                    class="text-[10px] text-gray-400">總堂數</span>
                </div>
              </div>
              <div class="mt-6 flex flex-wrap gap-4 justify-center text-xs font-bold">
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-green-500"></span> 上課 <span
                    id="label-present">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-amber-400"></span> 請假 <span
                    id="label-leave">0%</span></div>
                <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-red-500"></span> 曠課 <span
                    id="label-absent">0%</span></div>
                <div class="flex items-center gap-1.5">
                  <span class="w-3 h-3 rounded-full bg-gray-300"></span> 尚未點名 <span id="label-pending">0%</span>
                </div>
              </div>
            </div>
            <div class="bg-white p-0 rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col">
              <div class="p-4 bg-gray-50 border-b border-gray-200 font-bold text-gray-700">詳細數據</div>
              <div class="flex-1 overflow-y-auto p-4 space-y-3" id="stat-details">
                <p class="text-center text-gray-400 text-sm py-10">請選擇日期並開始分析...</p>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-content-teachers" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div class="flex gap-2 mb-4 shrink-0 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
            <input type="text" id="new-teacher-name" placeholder="輸入新老師姓名..."
              class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-100" />
            <button onclick="addTeacher()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md transition-all flex items-center gap-1">
              <i data-lucide="plus" class="w-4 h-4"></i> 新增老師
            </button>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm p-4">
            <div id="teacher-manage-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
          </div>
        </div>

        <div id="tab-content-logs" class="admin-tab-content w-full h-full flex flex-col p-6 hidden">
          <div
            class="flex justify-between items-center mb-4 shrink-0 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
            <h3 class="font-bold text-gray-800 flex items-center gap-2">
              <i data-lucide="activity" class="text-blue-500 w-5 h-5"></i> 系統操作軌跡
            </h3>
            <button onclick="loadLogs()"
              class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition-colors flex items-center gap-1">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> 重新整理
            </button>
          </div>
          <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full text-sm text-left">
              <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 z-10 shadow-sm select-none">
                <tr>
                  <th class="p-4 whitespace-nowrap">時間</th>
                  <th class="p-4 whitespace-nowrap">操作人員</th>
                  <th class="p-4 whitespace-nowrap">動作</th>
                  <th class="p-4 min-w-[250px]">詳細內容</th>
                  <th class="p-4 whitespace-nowrap text-center">復原</th>
                </tr>
              </thead>
              <tbody id="logs-list" class="divide-y divide-gray-100 text-neutral-700">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="sys-dialog-modal"
    class="hidden fixed inset-0 bg-black/40 z-[3000] flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
    <div
      class="bg-white rounded-xl shadow-2xl w-[85%] max-w-sm overflow-hidden flex flex-col transform scale-95 transition-transform duration-200"
      id="sys-dialog-box">
      <div class="p-6">
        <h3 class="font-bold text-gray-900 text-lg mb-2 flex items-center gap-2" id="sys-dialog-title">提示</h3>
        <p class="text-sm text-gray-600 leading-relaxed" id="sys-dialog-msg">內容</p>
      </div>
      <div class="px-5 py-3 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
        <button id="sys-dialog-cancel" onclick="closeSysDialog()"
          class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-200 hover:text-gray-800 rounded-lg transition-colors">取消</button>
        <button id="sys-dialog-confirm" onclick="execSysDialog()"
          class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95">確定</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://szudiyorlqmxyibxwaqp.supabase.co";
    const SUPABASE_KEY = "sb_publishable_0Dqlqe0ZXLRhjaevc7VB2g_39W_8eXP";
    const _client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ★ 全域變數：存目前登入者是誰 ★
    let currentUserInfo = null;

    let currentTid = null;
    let editingId = null;
    let editingCurrentStatus = null;
    let editingDateStr = null;
    // --- 新增全域變數：用來暫存資料與排序 ---
    let _cachedSchedule = []; // 暫存課表資料
    let _cachedRecords = [];  // 暫存紀錄資料
    let _userSortOrder = [];  // 記住使用者排好的卡片順序 (存 ID)

    // --- 使用說明彈窗控制 ---
    function openInstructionsModal() {
      // 開啟時自動收起手機版側邊欄
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
      document.getElementById("instructions-modal").classList.remove("hidden");
    }

    function closeInstructionsModal() {
      document.getElementById("instructions-modal").classList.add("hidden");
    }

    // --- 拖曳排序功能核心 (絲滑動畫版) ---
    // 1. 開始拖曳
    function handleDragStart(e, id) {
      e.dataTransfer.setData("text/plain", id);
      e.dataTransfer.effectAllowed = "move";
      e.target.style.opacity = '0.4';

      // ★ 關鍵新增：告訴整個網頁「現在進入拖曳模式了！」觸發 CSS 幽靈狀態
      document.body.classList.add('is-dragging');
    }

    // 2. 拖曳結束
    function handleDragEnd(e) {
      e.target.style.opacity = '1';

      // ★ 關鍵新增：解除拖曳模式，按鈕與文字恢復正常
      document.body.classList.remove('is-dragging');

      // 確保清除所有殘留的拖曳提示樣式
      document.querySelectorAll('.schedule-card').forEach(c => {
        c.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'opacity-60', 'z-50');
      });
    }

    function handleDrop(e, targetId) {
      e.preventDefault();
      e.stopPropagation();

      const sourceId = String(e.dataTransfer.getData("text/plain"));
      const tId = String(targetId);

      if (sourceId === tId) return;

      const fromIndex = _userSortOrder.indexOf(sourceId);
      const toIndex = _userSortOrder.indexOf(tId);

      if (fromIndex > -1 && toIndex > -1) {
        _userSortOrder.splice(fromIndex, 1);
        _userSortOrder.splice(toIndex, 0, sourceId);

        // 背景儲存資料庫 (不卡住畫面動畫)
        if (currentTid) {
          const orderStr = _userSortOrder.join(',');
          localStorage.setItem(`sort_order_${currentTid}`, orderStr);
          _client.from("teachers").update({ card_order: orderStr }).eq("id", currentTid)
            .then(({ error }) => {
              if (!error) setStatus("順序已永久儲存", "success");
            });
          const t = allTeachers.find(t => t.id === currentTid);
          if (t) t.card_order = orderStr;
        }

        // ★ 動畫 Step 1: 紀錄重繪前的「舊位置」
        const oldPositions = new Map();
        document.querySelectorAll('.schedule-card').forEach(card => {
          oldPositions.set(card.dataset.id, card.getBoundingClientRect());
        });

        // 重新繪製新順序的卡片
        renderSchedule(_cachedSchedule, _cachedRecords);

        // ★ 動畫 Step 2: 計算位移，播放滑動與綠色發光特效
        requestAnimationFrame(() => {
          document.querySelectorAll('.schedule-card').forEach(card => {
            const id = card.dataset.id;

            // 1. 滑動動畫 (FLIP)
            if (oldPositions.has(id)) {
              const oldPos = oldPositions.get(id);
              const newPos = card.getBoundingClientRect();
              const dx = oldPos.left - newPos.left;
              const dy = oldPos.top - newPos.top;

              if (dx !== 0 || dy !== 0) {
                card.style.transition = 'none';
                card.style.transform = `translate(${dx}px, ${dy}px)`;
                card.style.zIndex = '100'; // 動畫期間拉到最上層

                requestAnimationFrame(() => {
                  card.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                  card.style.transform = 'translate(0, 0)';
                  setTimeout(() => {
                    card.style.transition = '';
                    card.style.transform = '';
                    card.style.zIndex = '';
                  }, 400);
                });
              }
            }
          });
        });
      }
    }

    // --- 積木一：日期控制核心 ---
    // 1. 設定目前選擇的日期 (預設今天)
    let currentBaseDate = new Date();

    // 2. 工具：取得本週一的日期 (這樣我們才知道這週是從哪天開始)
    function getMonday(d) {
      d = new Date(d);
      var day = d.getDay(),
        diff = d.getDate() - day + (day == 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    // 3. 工具：加減天數 (用來切換上一週、下一週)
    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // 4. 工具：把日期變字串 (修正版：使用當地時間，解決早晨日期跑掉的問題)
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // 5. 切換週次的功能
    function changeWeek(direction) {
      // direction: -1 代表上一週， 1 代表下一週
      currentBaseDate = addDays(currentBaseDate, direction * 7);

      // 切換後，重新載入資料 (這樣畫面才會變)
      refreshData();
    }

    // 1. 處理日曆選擇 (滾動式：選哪天，哪天就是起點)
    function handleDatePick(val) {
      if (!val) return;
      // 直接把 currentBaseDate 設為使用者選的那一天 (不找禮拜一了)
      currentBaseDate = new Date(val);
      refreshData();
    }

    // ▼ 關鍵修正 1：宣告全域變數來存老師資料 ▼
    let allTeachers = [];
    let memoTimeout = null;

    window.onload = async () => {
      // A. 檢查登入
      const { data: { session } } = await _client.auth.getSession();
      if (!session) {
        window.location.href = "login.html";
        return;
      }

      // B. 抓資料 (這裡會一路等待課表畫完)
      await fetchUserProfile(session.user.email);
      await fetchTeachers();

      // C. 圖示渲染
      lucide.createIcons();

      // ★★★ 終極修正：給瀏覽器 100ms 的緩衝時間來「刷油漆」 ★★★
      setTimeout(() => {
        document.body.classList.add("page-ready");
      }, 550);
    };

    // 1. 登入檢查防呆
    async function fetchUserProfile(email) {
      const { data, error } = await _client.from("teachers").select("*").eq("email", email).maybeSingle();

      if (error || !data) {
        await sysAlert("錯誤：您的帳號未綁定教師資料，請聯繫管理員！", "登入失敗");
        await _client.auth.signOut();
        window.location.href = "login.html";
        return;
      }

      currentUserInfo = data;
      const initialEl = document.getElementById("current-user-initial");
      const nameEl = document.getElementById("current-user-name");
      const roleEl = document.getElementById("current-user-role");

      if (initialEl && nameEl && roleEl) {
        initialEl.textContent = data.name.charAt(0);
        nameEl.textContent = data.name;
        if (data.is_admin) {
          roleEl.innerHTML = `<i data-lucide="shield-alert" class="w-3 h-3 text-amber-500"></i> 系統管理員`;
          roleEl.classList.add("text-amber-600");
        } else {
          roleEl.innerHTML = `<i data-lucide="user" class="w-3 h-3"></i> 授課教師`;
          roleEl.classList.remove("text-amber-600");
        }
      }
    }

    // 2. 儲存權限防呆
    async function savePermissions() {
      const checkboxes = document.querySelectorAll('#perm-checkbox-list input[type="checkbox"]:checked:not(:disabled)');
      const selectedIds = Array.from(checkboxes).map(cb => cb.value);
      if (!selectedIds.includes(String(editingPermTeacherId))) {
        selectedIds.push(String(editingPermTeacherId));
      }
      const idsString = selectedIds.join(',');
      const res = await _client.from('teachers').update({ viewable_teachers: idsString }).eq('id', editingPermTeacherId);

      if (res.error) {
        await sysAlert('儲存失敗：' + res.error.message, "系統錯誤");
      } else {
        const t = allTeachers.find(t => t.id === editingPermTeacherId);
        if (t) t.viewable_teachers = idsString;
        setStatus('權限名單已成功儲存！', 'success');
        closePermissionsModal();
      }
    }

    // 登出函式
    async function handleLogout() {
      if (!(await sysConfirm("您確定要登出系統嗎？", "登出確認", "info"))) return;
      await _client.auth.signOut();
      window.location.href = "login.html";
    }

    // 2. 獲取老師列表 (修正版：開放批次管理給所有人)
    async function fetchTeachers() {
      const { data, error } = await _client
        .from("teachers")
        .select("*")
        .order("created_at");

      if (error) return setStatus("載入失敗", "error");

      allTeachers = data;

      const menu = document.getElementById("teacher-menu");
      const select = document.querySelector('select[name="teacher_id"]');

      menu.innerHTML = "";
      select.innerHTML = "";

      // 1. 過濾側邊欄名單 (★ 升級版：讀取剛剛設定的專屬權限)
      // 取得目前登入者「被允許看到」的老師 ID 陣列
      const viewableIds = currentUserInfo.viewable_teachers ? currentUserInfo.viewable_teachers.split(',') : [];

      const visibleTeachers = data.filter(t => {
        if (t.is_hidden) return false;

        // 如果登入的是管理員，無條件顯示所有人
        if (currentUserInfo.is_admin) return true;

        // 如果是一般老師，只顯示「自己」或「管理員勾給他看的人」
        return t.id === currentUserInfo.id || viewableIds.includes(String(t.id));
      });

      // 2. 渲染側邊欄按鈕
      visibleTeachers.forEach((t, index) => {
        const btn = document.createElement("button");
        btn.dataset.id = t.id;

        // 樣式設定
        btn.className = `teacher-item w-full flex items-center gap-2 py-1.5 px-2 rounded-lg text-left transition-all hover:bg-gray-100 ${currentTid === t.id ? "active bg-gray-100" : ""}`;
        btn.onclick = () => switchTeacher(t.id, t.name);

        // 內容設定 (統一灰色圖示)
        btn.innerHTML = `
            <div class="w-6 h-6 rounded flex items-center justify-center bg-gray-200 text-gray-600 text-[10px] font-bold shrink-0">
                ${t.name.charAt(0)}
            </div>
            <span class="font-medium text-sm truncate text-neutral-700">${t.name}</span>
        `;
        menu.appendChild(btn);

        // 預設選中第一位
        if (!currentTid && index === 0) switchTeacher(t.id, t.name);
      });

      // 3. 渲染下拉選單
      visibleTeachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });

      // ★★★ 權限按鈕控制 (修改重點在這裡) ★★★

      // ★ 修改處：控制側邊欄「管理控制台」按鈕的顯示
      const adminEntryBtn = document.getElementById("admin-entry-btn");
      if (adminEntryBtn) {
        if (currentUserInfo.is_admin) adminEntryBtn.classList.remove("hidden");
        else adminEntryBtn.classList.add("hidden");
      }

      // B. 批次管理 (★ 修改：無條件開放給所有人 ★)
      const batchBtn = document.querySelector("button[onclick='openBatchModal()']");
      if (batchBtn) {
        // 移除隱藏 class，讓大家都看得到
        batchBtn.classList.remove("hidden");
      }

      // 只有管理員需要渲染管理列表
      if (currentUserInfo.is_admin && typeof renderTeacherManageList === 'function') {
        renderTeacherManageList();
      }

      if (!currentTid && visibleTeachers.length > 0) {
        await switchTeacher(visibleTeachers[0].id, visibleTeachers[0].name);
      }

      lucide.createIcons();
    }

    async function switchTeacher(tid, name) {
      currentTid = tid;
      document.getElementById("main-title").textContent = `${name} · 本週課表`;

      // 處理按鈕變色邏輯
      document.querySelectorAll(".teacher-item").forEach((btn) => {
        btn.classList.remove("active");
        btn.classList.remove("bg-gray-100");
      });

      const activeBtn = document.querySelector(`.teacher-item[data-id="${tid}"]`);
      if (activeBtn) {
        activeBtn.classList.add("active");
      }

      // 讀取備忘錄
      const targetTeacher = allTeachers.find(t => t.id === tid);
      const memoInput = document.getElementById("teacher-memo");
      if (memoInput) {
        memoInput.value = (targetTeacher && targetTeacher.memo) ? targetTeacher.memo : "";
      }

      // ★★★ 關鍵修改 1：從資料庫讀取這位老師專屬的卡片順序 ★★★
      if (targetTeacher && targetTeacher.card_order) {
        _userSortOrder = targetTeacher.card_order.split(',');
      } else {
        _userSortOrder = [];
      }

      if (window.innerWidth < 768) {
        toggleSidebar();
      }

      await refreshData();
    }

    // 4. 備忘錄自動儲存功能 (新增)
    async function handleMemoInput(text) {
      const status = document.getElementById("memo-status");
      if (status) {
        status.textContent = "輸入中...";
        status.classList.remove("opacity-0");
      }

      // 防手震：清除上一次的計時器
      if (memoTimeout) clearTimeout(memoTimeout);

      // 設定新的計時器：停止打字 0.8 秒後才儲存
      memoTimeout = setTimeout(async () => {
        if (!currentTid) return;

        if (status) status.textContent = "儲存中...";

        // 更新資料庫
        const { error } = await _client
          .from("teachers")
          .update({ memo: text })
          .eq("id", currentTid);

        if (!error) {
          if (status) status.textContent = "已儲存";

          // ▼ 關鍵修正 4：儲存成功後，同步更新本地變數 allTeachers ▼
          // 這樣切換去別的老師再切回來，資料才會是新的
          const localTeacher = allTeachers.find(t => t.id === currentTid);
          if (localTeacher) {
            localTeacher.memo = text;
          }

          // 2秒後隱藏狀態文字
          setTimeout(() => {
            if (status) status.classList.add("opacity-0");
          }, 2000);
        } else {
          console.error("儲存失敗:", error); // 在 Console 顯示錯誤以便除錯
          if (status) {
            status.textContent = "儲存失敗";
            status.classList.remove("text-yellow-600");
            status.classList.add("text-red-500");
          }
        }
      }, 800);
    }

    // 2. 重新整理資料
    async function refreshData() {
      if (!currentTid) return;

      const startDate = new Date(currentBaseDate);
      const endDate = addDays(startDate, 6);

      const startStr = formatDate(startDate);
      const endStr = formatDate(endDate);

      document.getElementById("current-date-range").textContent = `${startStr} ~ ${endStr}`;
      const picker = document.getElementById("date-picker");
      if (picker) picker.value = startStr;

      setStatus("正在同步紀錄...");

      try {
        const { data: sData, error: sErr } = await _client
          .from("schedules")
          .select("*")
          .eq("teacher_id", currentTid)
          .or(`target_date.is.null,and(target_date.gte.${startStr},target_date.lte.${endStr})`);
        if (sErr) throw sErr;

        const { data: rData, error: rErr } = await _client.from("lesson_records").select("*")
          .eq("teacher_id", currentTid)
          .gte("actual_date", startStr)
          .lte("actual_date", endStr);
        if (rErr) throw rErr;

        _cachedSchedule = sData || [];
        _cachedRecords = rData || [];

        // ★ 同步排序清單
        let isOrderUpdated = false;
        _cachedSchedule.forEach(item => {
          const strId = String(item.id);
          if (!_userSortOrder.includes(strId)) {
            _userSortOrder.push(strId);
            isOrderUpdated = true;
          }
        });

        if (isOrderUpdated && currentTid) {
          const orderStr = _userSortOrder.join(',');

          // ★★★ 關鍵修復：這裡也加上 await ★★★
          await _client.from("teachers").update({ card_order: orderStr }).eq("id", currentTid);
          localStorage.setItem(`sort_order_${currentTid}`, orderStr);

          const t = allTeachers.find(t => t.id === currentTid);
          if (t) t.card_order = orderStr;
        }

        renderSchedule(_cachedSchedule, _cachedRecords, startDate);

        updateStatsUI();
      } catch (e) {
        console.error(e);
        setStatus(`連線錯誤: ${e.message}`, "error");
      }
    }

    // 1. 卡片點名切換狀態防呆
    async function toggleCourseStatus(id, currentStatus) {
      const statusCycle = { 'status-pending': 'status-present', 'status-present': 'status-leave', 'status-leave': 'status-absent', 'status-absent': 'status-pending' };
      const nextStatus = statusCycle[currentStatus] || 'status-present';
      const { error } = await _client.from("schedules").update({ color_class: nextStatus }).eq("id", id);

      if (!error) {
        await refreshData();
      } else {
        await sysAlert("狀態切換失敗", "系統錯誤");
      }
    }

    // 3. 繪圖函式 (數學精準撐高版 + 支援備註手動換行)
    function renderSchedule(list, records = [], startDate) {
      const container = document.getElementById("schedule-container");
      if (!container) return;
      container.innerHTML = "";

      const slots = ["09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24"];
      const BASE_ROW_HEIGHT = 120;
      const START_HOUR = 9;
      const CARD_WIDTH = 140;
      const dayNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
      const baseDate = startDate || currentBaseDate;

      function parseTime(tStr) {
        if (!tStr) return { h: 0, m: 0 };
        let h = parseInt(tStr.split(":")[0]);
        let m = parseInt(tStr.split(":")[1]);
        if (h === 0) h = 24;
        return { h, m };
      }

      let validItems = list.filter(item => {
        if (!item.start_time || !item.end_time) return false;
        return parseTime(item.start_time).h >= START_HOUR;
      });

      validItems.sort((a, b) => {
        const indexA = _userSortOrder.indexOf(String(a.id));
        const indexB = _userSortOrder.indexOf(String(b.id));
        let weightA = indexA === -1 ? 9999 : indexA;
        let weightB = indexB === -1 ? 9999 : indexB;
        if (weightA !== weightB) return weightA - weightB;

        const aTime = parseTime(a.start_time);
        const bTime = parseTime(b.start_time);
        return (aTime.h * 60 + aTime.m) - (bTime.h * 60 + bTime.m);
      });

      let hourHeights = new Array(slots.length).fill(BASE_ROW_HEIGHT);

      for (let i = 0; i < 7; i++) {
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);
        const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();
        const dayItems = validItems.filter(item => item.day_of_week === dbDay);

        dayItems.forEach(item => {
          const sT = parseTime(item.start_time);
          const eT = parseTime(item.end_time);
          const durationMins = (eT.h * 60 + eT.m) - (sT.h * 60 + sT.m);
          if (durationMins <= 0) return;

          let reqPx = 80;
          const phoneList = (item.phone || "").split(/\s+/).filter(p => p.trim() !== "");
          reqPx += phoneList.length * 16;

          const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          const remarkText = record ? record.remark : "";

          // ★★★ 數學引擎升級：精準計算「手動換行」需要的高度 ★★★
          if (remarkText) {
            const manualLines = remarkText.split('\n'); // 找出使用者按了幾次 Enter
            let totalLines = 0;
            manualLines.forEach(line => {
              // 每行如果超過 8 個字，也會自動折行
              totalLines += Math.max(1, Math.ceil(line.length / 8));
            });
            reqPx += 16 + (totalLines * 14);
          }

          const basePx = (durationMins / 60) * BASE_ROW_HEIGHT;

          if (reqPx > basePx) {
            const hIdx = sT.h - START_HOUR;
            if (hIdx >= 0 && hIdx < slots.length) {
              const extraNeeded = reqPx - basePx;
              hourHeights[hIdx] = Math.max(hourHeights[hIdx], BASE_ROW_HEIGHT + extraNeeded + 15);
            }
          }
        });
      }

      function getDynamicTop(h, m) {
        let top = 0;
        const hIdx = h - START_HOUR;
        for (let i = 0; i < hIdx && i < slots.length; i++) {
          top += hourHeights[i];
        }
        if (hIdx >= 0 && hIdx < slots.length) {
          top += (m / 60) * hourHeights[hIdx];
        }
        return top;
      }

      const timeCol = document.createElement("div");
      timeCol.className = "sticky left-0 z-[500] bg-white border-r border-[#e9e9e7] flex flex-col shrink-0 w-[60px] md:w-[90px]";
      const timeHeader = document.createElement("div");
      timeHeader.className = "sticky top-0 z-[600] bg-gray-50 border-b border-[#e9e9e7] text-xs md:text-sm font-bold text-gray-600 flex items-center justify-center h-[60px]";
      timeHeader.textContent = "時間";
      timeCol.appendChild(timeHeader);

      slots.forEach((h, index) => {
        const cell = document.createElement("div");
        cell.className = "flex items-center justify-center text-xs font-semibold text-gray-400 border-b border-[#e9e9e7] bg-gray-50/30 transition-all duration-300";
        cell.style.height = `${hourHeights[index]}px`;
        cell.textContent = `${h}:00`;
        timeCol.appendChild(cell);
      });
      container.appendChild(timeCol);

      for (let i = 0; i < 7; i++) {
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);
        const jsDay = thisDayDate.getDay();
        const dbDay = jsDay === 0 ? 7 : jsDay;
        const dayItems = validItems.filter(item => item.day_of_week === dbDay);

        const columns = [];
        const cardColIndex = {};
        dayItems.forEach(item => {
          const sT = parseTime(item.start_time);
          const eT = parseTime(item.end_time);
          const startMin = sT.h * 60 + sT.m;
          const endMin = eT.h * 60 + eT.m;

          let placed = false;
          for (let col = 0; col < columns.length; col++) {
            const hasOverlap = columns[col].some(other => {
              const osT = parseTime(other.start_time);
              const oeT = parseTime(other.end_time);
              const oStart = osT.h * 60 + osT.m;
              const oEnd = oeT.h * 60 + oeT.m;
              return (startMin < oEnd && endMin > oStart);
            });
            if (!hasOverlap) {
              columns[col].push(item);
              cardColIndex[item.id] = col;
              placed = true;
              break;
            }
          }
          if (!placed) {
            columns.push([item]);
            cardColIndex[item.id] = columns.length - 1;
          }
        });

        const maxConcurrent = columns.length || 1;
        const colWidth = maxConcurrent * CARD_WIDTH + 1;

        const dayCol = document.createElement("div");
        dayCol.className = "flex flex-col border-r border-[#e9e9e7] shrink-0 relative bg-white transition-all duration-300";
        dayCol.style.width = `${colWidth}px`;

        const header = document.createElement("div");
        header.className = "sticky top-0 z-[400] bg-gray-50 border-b border-[#e9e9e7] flex flex-col items-center justify-center h-[60px]";
        const isToday = formatDate(new Date()) === thisDayDateStr;
        header.innerHTML = `<span class="${isToday ? 'text-blue-600 font-bold' : 'text-gray-800 font-bold'}">${dayNames[jsDay]}</span><span class="text-[10px] text-gray-400">${thisDayDate.getMonth() + 1}/${thisDayDate.getDate()}</span>`;
        dayCol.appendChild(header);

        const contentLayer = document.createElement("div");
        contentLayer.className = "relative w-full";
        contentLayer.style.height = `${hourHeights.reduce((a, b) => a + b, 0)}px`;

        slots.forEach((_, index) => {
          const line = document.createElement("div");
          line.className = "border-b border-[#e9e9e7] w-full transition-all duration-300";
          line.style.height = `${hourHeights[index]}px`;
          contentLayer.appendChild(line);
        });

        dayItems.forEach((item) => {
          const sT = parseTime(item.start_time);
          const eT = parseTime(item.end_time);

          const topPx = getDynamicTop(sT.h, sT.m);
          const bottomPx = getDynamicTop(eT.h, eT.m);
          const heightPx = bottomPx - topPx;

          const myIndex = cardColIndex[item.id];
          const leftPos = myIndex * CARD_WIDTH;

          const record = records.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          let displayStatus = record ? record.status : (item.color_class || 'status-pending');
          const remarkText = record ? record.remark : "";

          // ★★★ 翻譯蒟蒻：把 \n 轉成 <br> 讓畫面可以換行 ★★★
          const displayRemark = remarkText ? remarkText.replace(/\n/g, '<br>') : "";

          let statusBorder = 'border-l-4 border-gray-300';
          let bgClass = 'bg-white';
          if (displayStatus === 'attended' || displayStatus === 'status-present') { statusBorder = 'border-l-4 border-green-500'; bgClass = 'bg-green-50'; }
          else if (displayStatus === 'leave' || displayStatus === 'status-leave') { statusBorder = 'border-l-4 border-amber-400'; bgClass = 'bg-amber-50'; }
          else if (displayStatus === 'absent' || displayStatus === 'status-absent') { statusBorder = 'border-l-4 border-red-500'; bgClass = 'bg-red-50'; }
          else if (displayStatus === 'status-practice') { statusBorder = 'border-l-4 border-blue-400'; bgClass = 'bg-blue-50'; }

          const card = document.createElement("div");
          card.className = `schedule-card absolute rounded-r-md rounded-l-sm p-2 pb-3 text-sm shadow-md flex flex-col transition-all duration-200 group box-border hover:shadow-xl ${statusBorder} ${bgClass}`;
          card.dataset.id = item.id;
          card.style.cssText = `top: ${topPx}px; min-height: ${heightPx}px; height: max-content; left: ${leftPos}px; width: ${CARD_WIDTH}px; z-index: 20;`;

          card.draggable = true;
          card.ondragstart = (e) => handleDragStart(e, item.id);
          card.ondragend = (e) => handleDragEnd(e);
          card.ondragover = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
          };
          card.ondragenter = (e) => {
            e.preventDefault();
            card.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'opacity-60', 'z-50');
          };
          card.ondragleave = (e) => {
            card.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'opacity-60', 'z-50');
          };
          card.ondrop = (e) => {
            card.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'opacity-60', 'z-50');
            handleDrop(e, item.id);
          };

          const phoneRaw = item.phone || "";
          const phoneList = phoneRaw.split(/\s+/).filter(p => p.trim() !== "");
          let phoneHtml = phoneList.map(p => `<div class="flex items-center gap-0.5 text-[10px] text-gray-500 leading-tight group-hover:text-neutral-800 transition-colors"><i data-lucide="phone" class="w-2.5 h-2.5 text-green-500 shrink-0"></i><span class="font-mono tracking-tight">${p}</span></div>`).join('');

          const roomDisplay = item.room_no || "無教室";
          const amountDisplay = item.amount ? `$${item.amount}` : "$0";
          const subjectDisplay = item.subject || "";

          card.innerHTML = `
            <div class="absolute top-1 right-1 flex flex-row items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] bg-white/95 backdrop-blur-sm px-1.5 py-1 rounded-full shadow-md border border-gray-200" 
                 style="pointer-events: auto;"
                 onmousedown="event.stopPropagation();"
                 ondragstart="return false;"
                 onclick="event.stopPropagation();">
                <button type="button" onclick="openRemarkModal('${item.id}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-yellow-600 hover:scale-110 hover:bg-yellow-50 transition-all cursor-pointer" title="設定備註"><i data-lucide="sticky-note" class="w-3.5 h-3.5 pointer-events-none"></i></button>
                <button type="button" onclick="openEditModal('${item.id}', '${displayStatus}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-blue-600 hover:scale-110 hover:bg-blue-50 transition-all cursor-pointer" title="修改固定課表"><i data-lucide="pencil" class="w-3.5 h-3.5 pointer-events-none"></i></button>
                <button type="button" onclick="copyCourse('${item.id}', '${thisDayDateStr}'); return false;" class="p-1 rounded-full text-gray-500 hover:text-amber-600 hover:scale-110 transition-all cursor-pointer" title="複製課程"><i data-lucide="copy" class="w-3.5 h-3.5 pointer-events-none"></i></button>
                <button type="button" onmousedown="event.stopPropagation()" onclick="deleteCourse('${item.id}');" class="p-1 rounded-full text-red-500 hover:scale-110 hover:bg-red-50 transition-all cursor-pointer" title="刪除課程"><i data-lucide="trash-2" class="w-3.5 h-3.5 pointer-events-none"></i></button>
            </div>
            
            <div class="flex flex-col h-full min-w-0 pr-1 cursor-pointer relative z-10" onclick="toggleRecordStatus('${item.id}', '${thisDayDateStr}', '${displayStatus}')">
                <div class="flex items-baseline gap-1 min-w-0 pointer-events-none">
                    <span class="font-bold text-neutral-900 text-[13px] truncate leading-tight">${item.course_name}</span>
                    ${subjectDisplay ? `<span class="text-[10px] text-gray-500 truncate bg-gray-100 px-1 rounded">${subjectDisplay}</span>` : ''}
                </div>
                <div class="text-[10px] text-gray-400 font-mono mt-0.5 leading-none pointer-events-none">${item.start_time.slice(0, 5)} - ${item.end_time.slice(0, 5)}</div>
                <div class="mt-1.5 flex flex-col gap-0.5 pointer-events-none">
                    <div class="flex items-center gap-0.5 text-[10px] text-gray-600 leading-tight"><i data-lucide="map-pin" class="w-2.5 h-2.5 text-blue-400"></i><span class="truncate">${roomDisplay}</span></div>
                    <div class="flex items-center gap-0.5 text-[10px] text-gray-600 leading-tight"><i data-lucide="coins" class="w-2.5 h-2.5 text-amber-500"></i><span class="font-mono text-gray-700">${amountDisplay}</span></div>
                    ${phoneHtml}
                </div>
                <div class="mt-auto pt-1 pointer-events-none">
                    ${displayRemark ? `<div class="flex items-start gap-0.5 p-1 rounded bg-red-50 border border-red-100 text-red-700 text-[10px] font-bold leading-tight break-words"><i data-lucide="pin" class="w-2.5 h-2.5 shrink-0 mt-0.5"></i> <span class="w-full">${displayRemark}</span></div>` : ''}
                </div>
            </div>
          `;
          contentLayer.appendChild(card);
        });
        dayCol.appendChild(contentLayer);
        container.appendChild(dayCol);
      }
      lucide.createIcons();
    }

    // --- 2. 複製課程功能 (升級版：預設帶入所點擊的日期) ---
    function copyCourse(itemId, dateStr) {
      // 先打開編輯視窗，把舊資料都填進去
      openEditModal(itemId, null, dateStr);

      document.querySelector("#course-modal h3").textContent = "複製並排入新日期";
      editingId = null; // 變成新增模式

      // ★ 自動切換為「單次/臨時課程」模式，並展開日曆
      const tempCheckbox = document.getElementById("is_temporary");
      const dateWrapper = document.getElementById("temp-date-wrapper");
      const dateInput = document.getElementById("target_date_input");

      if (tempCheckbox) tempCheckbox.checked = true;
      if (dateWrapper) dateWrapper.classList.remove('hidden');
      if (dateInput) {
        // ★ 關鍵修改：將 formatDate(new Date()) 改成 dateStr
        // 這樣日曆就會直接預設為「妳點擊的那一天」！
        dateInput.value = dateStr;
      }
    }

    // --- 點名狀態切換核心邏輯 (升級版：樂觀更新，點多快都不漏算！) ---
    async function toggleRecordStatus(scheduleId, dateStr, currentStatus) {
      let nextStatus = '';

      // 1. 決定下一個狀態 (循環：灰 -> 綠 -> 咖 -> 紅 -> 灰)
      if (!currentStatus || currentStatus === 'status-pending') {
        nextStatus = 'status-present';
      } else if (currentStatus === 'attended' || currentStatus === 'status-present') {
        nextStatus = 'status-leave';
      } else if (currentStatus === 'leave' || currentStatus === 'status-leave') {
        nextStatus = 'status-absent';
      } else {
        nextStatus = 'status-pending';
      }

      // 2. 取得這堂課母版的「預設狀態」
      const masterItem = _cachedSchedule.find(s => s.id === scheduleId);
      const masterDefault = (masterItem && masterItem.color_class) ? masterItem.color_class : 'status-pending';

      // ★★★ 3. 樂觀更新 (Optimistic UI)：直接竄改本地記憶體，不等資料庫了！ ★★★
      let existingRecordIndex = _cachedRecords.findIndex(r => r.schedule_id === scheduleId && r.actual_date === dateStr);

      if (nextStatus === masterDefault) {
        // 如果切回預設狀態，就從記憶體裡把這筆特別紀錄刪掉
        if (existingRecordIndex !== -1) _cachedRecords.splice(existingRecordIndex, 1);
      } else {
        // 否則，更新記憶體，或是塞一筆新的進去
        if (existingRecordIndex !== -1) {
          _cachedRecords[existingRecordIndex].status = nextStatus;
        } else {
          _cachedRecords.push({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus, remark: "" });
        }
      }

      // ★ 瞬間重畫卡片顏色，並瞬間更新左上角的數字！(0延遲)
      renderSchedule(_cachedSchedule, _cachedRecords);
      updateStatsUI();

      // 4. 背景默默存檔
      try {
        if (nextStatus === masterDefault) {
          await _client.from("lesson_records").delete().eq("schedule_id", scheduleId).eq("actual_date", dateStr);
        } else {
          const { data: existing } = await _client.from("lesson_records").select("id").eq("schedule_id", scheduleId).eq("actual_date", dateStr).maybeSingle();
          if (existing) {
            await _client.from("lesson_records").update({ status: nextStatus }).eq("id", existing.id);
          } else {
            await _client.from("lesson_records").insert({ schedule_id: scheduleId, teacher_id: currentTid, actual_date: dateStr, status: nextStatus });
          }
        }

        // ★ 監視器：寫入點名日誌 (把英文狀態翻譯成中文比較好看)
        const statusZhMap = { 'status-present': '上課', 'status-leave': '請假', 'status-absent': '曠課', 'status-pending': '尚未點名', 'status-practice': '練習' };
        const statusZh = statusZhMap[nextStatus] || nextStatus;

        await recordLog('修改點名', `將 [${masterItem.course_name}] 在 ${dateStr} 的狀態改為 [${statusZh}]`, 'lesson_records',
          { schedule_id: scheduleId, actual_date: dateStr, status: currentStatus }, // 舊狀態
          { schedule_id: scheduleId, actual_date: dateStr, status: nextStatus }     // 新狀態
        );

      } catch (err) {
        console.error("點名狀態存檔失敗:", err);
      }
    }

    // --- 專門處理卡片展開/收合的函式 ---
    function handleToggleExpand(btn) {
      // 1. 找到該按鈕所屬的卡片
      const card = btn.closest('.absolute.rounded-md');
      if (!card) return;

      // 2. 切換展開 class
      const isExpanded = card.classList.toggle('card-expanded');

      // 3. 視覺回饋：旋轉箭頭 180 度
      if (isExpanded) {
        btn.style.transform = 'rotate(180deg)';
      } else {
        btn.style.transform = 'rotate(0deg)';
      }

      // 4. 重新觸發 Lucide 圖示渲染 (確保圖示正確顯示)
      lucide.createIcons();
    }

    // 5. 老師管理功能
    async function addTeacher() {
      const name = document.getElementById("new-teacher-name").value.trim();
      if (!name) return;
      const { error } = await _client.from("teachers").insert([{ name }]);
      if (error) alert("新增失敗");
      document.getElementById("new-teacher-name").value = "";
      await fetchTeachers();
    }

    // 6. 輔助函數 (加大版：px-2.5, py-1, -ml-2)
    function setStatus(msg, type = "warn") {
      const el = document.getElementById("status-tag");
      el.textContent = `資料庫連線狀態：${msg}`;

      // 定義顏色
      let colorClass = "bg-yellow-100 text-yellow-800"; // 預設 (黃)
      if (type === "error") colorClass = "bg-red-100 text-red-800"; // 錯誤 (紅)
      if (type === "success") colorClass = "bg-green-100 text-green-800"; // 成功 (綠)

      // 套用樣式 (同步加大與對齊修正)
      el.className = `text-[10px] md:text-xs px-2.5 py-1 rounded-md font-medium mt-0.5 -ml-2 ${colorClass}`;
    }

    // --- 獨立的統計數字更新器 (所見即所得精準版) ---
    function updateStatsUI() {
      if (!_cachedSchedule) return;

      const START_HOUR = 9;

      // 工具：處理時間格式
      function parseTime(tStr) {
        if (!tStr) return { h: 0, m: 0 };
        let h = parseInt(tStr.split(":")[0]);
        let m = parseInt(tStr.split(":")[1]);
        if (h === 0) h = 24;
        return { h, m };
      }

      // 1. 抓出真正有顯示在畫面上的課 (過濾掉沒時間或太早的)
      let validItems = _cachedSchedule.filter(item => {
        if (!item.start_time || !item.end_time) return false;
        return parseTime(item.start_time).h >= START_HOUR;
      });

      let total = 0;
      let presentOrAbsentCount = 0;
      let leaveCount = 0;

      const baseDate = currentBaseDate;

      // 2. 模擬畫 7 天的卡片，精準結算每一天每一堂課的「最終顏色」
      for (let i = 0; i < 7; i++) {
        const thisDayDate = addDays(baseDate, i);
        const thisDayDateStr = formatDate(thisDayDate);
        const dbDay = thisDayDate.getDay() === 0 ? 7 : thisDayDate.getDay();

        // 找出這天所有的課
        const dayItems = validItems.filter(item => item.day_of_week === dbDay);

        dayItems.forEach(item => {
          total++; // 只要這天有這堂課，總堂數就 +1

          // ★ 核心邏輯：判斷這堂課「最終顯示」的狀態
          // (優先看有沒有特別的點名紀錄，沒有的話就看母版的預設狀態)
          const record = _cachedRecords.find(r => r.schedule_id === item.id && r.actual_date === thisDayDateStr);
          const displayStatus = record ? record.status : (item.color_class || 'status-pending');

          // 根據最終顯示狀態來加總
          if (['attended', 'status-present', 'absent', 'status-absent'].includes(displayStatus)) {
            presentOrAbsentCount++;
          } else if (['leave', 'status-leave'].includes(displayStatus)) {
            leaveCount++;
          }
        });
      }

      // 3. 輸出到畫面上
      setStatus(`總堂數：${total} | 已點名+曠課：${presentOrAbsentCount} | 請假：${leaveCount}`, "success");
    }

    // 新增這個函式，讓彈窗可以打開
    function openModal() {
      document.getElementById("course-modal").classList.remove("hidden");
    }
    function closeModal() {
      editingId = null;
      document.getElementById("course-modal").classList.add("hidden");
      document.getElementById("course-form").reset();
      document.querySelector("#course-modal h3").textContent = "新增課程資料";
    }
    function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
    }
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
    }

    // 7. 修改與刪除
    function openEditModal(id, status, dateStr) {
      editingId = id;
      editingDateStr = dateStr;

      const item = _cachedSchedule.find(i => i.id === id);
      if (!item) return;

      const form = document.getElementById("course-form");
      form.day_of_week.value = item.day_of_week;
      form.teacher_id.value = item.teacher_id;
      form.course_name.value = item.course_name;
      form.start_time.value = item.start_time.slice(0, 5);
      form.end_time.value = item.end_time.slice(0, 5);
      form.room_no.value = item.room_no || "";
      form.amount.value = item.amount || 0;
      form.phone.value = item.phone || "";
      form.subject.value = item.subject || "";

      const record = _cachedRecords.find(r => r.schedule_id === id && r.actual_date === dateStr);
      let displayStatus = item.color_class || 'status-pending';
      if (record) displayStatus = record.status;

      form.color_class.value = displayStatus;
      if (displayStatus === 'attended') form.color_class.value = 'status-present';
      if (displayStatus === 'leave') form.color_class.value = 'status-leave';
      if (displayStatus === 'absent') form.color_class.value = 'status-absent';

      // ★ 處理單次課程勾選與日期顯示
      const tempCheckbox = document.getElementById("is_temporary");
      const dateWrapper = document.getElementById("temp-date-wrapper");
      const dateInput = document.getElementById("target_date_input");

      if (tempCheckbox) {
        tempCheckbox.checked = item.is_temporary || false;
        if (dateWrapper) dateWrapper.classList.toggle('hidden', !tempCheckbox.checked);
        if (dateInput) {
          // 如果這堂課本來就是單次課，填入它的指定日期；否則預設帶入當天
          dateInput.value = item.target_date || dateStr || formatDate(new Date());
        }
      }

      document.querySelector("#course-modal h3").textContent = "修改固定課表";
      openModal();
    }

    async function deleteCourse(id) {
      // 注意：前面一定要加 await 喔！
      if (!(await sysConfirm("確定要刪除這堂課嗎？<br><span class='text-xs text-red-500'>*此操作將會記錄在系統日誌中</span>", "刪除確認", "danger"))) return;

      // ★ 監視器：先偷偷記住死者的長相 (為了之後能復活他)
      const oldData = _cachedSchedule.find(s => s.id === id);

      const { error } = await _client.from("schedules").delete().eq("id", id);

      if (!error && oldData) {
        // ★ 監視器：寫入日誌
        await recordLog('刪除課程', `刪除了 [${oldData.course_name}] 的課程`, 'schedules', oldData, null);
      }

      await refreshData();
    }

    // 8. 表單提交 (支援 00:00 跨夜邏輯與指定日期智慧推算)
    document.getElementById("course-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = new FormData(e.target);

      let sTime = f.get("start_time");
      let eTime = f.get("end_time");
      let checkETime = eTime === "00:00" ? "24:00" : eTime;

      if (sTime >= checkETime) {
        return sysAlert("結束時間必須晚於開始時間", "時間設定錯誤");
      }

      const isTemporary = document.getElementById("is_temporary").checked;
      let finalTargetDate = null;
      let dayOfWeek = parseInt(f.get("day_of_week"));

      // ★ 神級防呆：如果勾選了單次課程，直接拿妳選的日期來反推星期幾！
      // (這樣妳就不用管上面那個「上課星期」的下拉選單了)
      if (isTemporary) {
        finalTargetDate = f.get("target_date");
        if (!finalTargetDate) return sysAlert("請選擇單次課程的日期！", "資料不齊全");

        const d = new Date(finalTargetDate);
        dayOfWeek = d.getDay();
        if (dayOfWeek === 0) dayOfWeek = 7; // 週日轉換為 7
      }

      const data = {
        teacher_id: f.get("teacher_id"),
        day_of_week: dayOfWeek, // 這裡已經是自動算好的正確星期了
        course_name: f.get("course_name"),
        start_time: sTime + ":00",
        end_time: eTime + ":00",
        room_no: f.get("room_no"),
        amount: parseInt(f.get("amount")) || 0,
        phone: f.get("phone"),
        subject: f.get("subject"),
        color_class: f.get("color_class"),
        target_date: finalTargetDate,
        is_temporary: isTemporary
      };

      // ★ 監視器：拍照記下修改前的樣子
      const oldData = editingId ? _cachedSchedule.find(s => s.id === editingId) : null;

      // ★ 加上 .select() 讓資料庫存完後順便把新資料傳回來給我們
      const res = editingId
        ? await _client.from("schedules").update(data).eq("id", editingId).select()
        : await _client.from("schedules").insert([data]).select();

      if (res.error) {
        return sysAlert("操作失敗: " + res.error.message, "系統錯誤");
      }

      // ★ 監視器升級：精準抓出到底「改了哪些欄位」
      const newData = res.data[0];
      let actionType = '新增課程';
      let actionDesc = `[${newData.course_name}]：新增了一堂課`;

      // 如果是修改模式，啟動差異比對引擎！
      if (editingId && oldData) {
        actionType = '修改課程';
        let changes = [];

        // 定義我們要檢查的欄位，以及它們的中文名稱
        const fieldMap = {
          course_name: '姓名', phone: '電話', subject: '科目', amount: '金額',
          day_of_week: '星期', start_time: '開始時間', end_time: '結束時間',
          room_no: '教室', is_temporary: '單次屬性'
        };
        const dayMap = { 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六', 7: '日' };

        for (let key in fieldMap) {
          let oldV = oldData[key];
          let newV = newData[key];

          // 針對特殊格式進行翻譯 (例如星期 1 要變成 星期一)
          if (key === 'day_of_week') {
            oldV = dayMap[oldV] || oldV; newV = dayMap[newV] || newV;
          } else if (key === 'is_temporary') {
            oldV = oldV ? '是' : '否'; newV = newV ? '是' : '否';
          } else if (key === 'start_time' || key === 'end_time') {
            oldV = oldV ? String(oldV).slice(0, 5) : ''; newV = newV ? String(newV).slice(0, 5) : '';
          }

          // 清理空白並把 null 轉成空字串，防止誤判
          let sOld = (oldV === null || oldV === undefined) ? '' : String(oldV).trim();
          let sNew = (newV === null || newV === undefined) ? '' : String(newV).trim();

          // 如果不一樣，就把這條改變寫進清單裡
          if (sOld !== sNew) {
            changes.push(`${fieldMap[key]}: ${sOld || '無'} ➔ ${sNew || '無'}`);
          }
        }

        // 組裝最終的白話文
        if (changes.length > 0) {
          // 把所有改變用 | 串起來
          actionDesc = `[${newData.course_name}]：${changes.join(' | ')}`;
        } else {
          actionDesc = `[${newData.course_name}]：點擊了儲存 (無欄位變動)`;
        }
      }

      // 寫入日誌
      await recordLog(actionType, actionDesc, 'schedules', oldData, newData);

      if (editingId && editingDateStr) {
        await _client.from("lesson_records")
          .update({ status: data.color_class })
          .match({ schedule_id: editingId, actual_date: editingDateStr });
      }

      closeModal();
      await refreshData();
    });

    // --- 老師管理功能邏輯 ---

    // 1. 開啟管理視窗並讀取最新清單
    async function openTeacherModal() {
      document.getElementById("teacher-modal").classList.remove("hidden");
      await renderTeacherManageList();
      lucide.createIcons();
    }

    // 2. 關閉視窗
    function closeTeacherModal() {
      document.getElementById("teacher-modal").classList.add("hidden");
      document.getElementById("new-teacher-name").value = "";
    }

    // 3. 渲染管理視窗內的老師列表 (修正版：隱藏 is_hidden 的管理者)
    // 老師管理 (美化版) ---
    async function renderTeacherManageList() {
      const { data: teachers } = await _client.from("teachers").select("*").order("created_at");
      const list = document.getElementById("teacher-manage-list");
      list.innerHTML = "";

      teachers.forEach(t => {
        if (t.is_hidden) return; // 隱藏管理員自己
        const item = document.createElement("div");
        item.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100 group hover:border-blue-200 transition-all shadow-sm";
        item.dataset.id = t.id;

        item.innerHTML = `
          <div class="view-mode flex items-center gap-3 w-full">
            <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center font-bold text-gray-500 text-xs">${t.name.charAt(0)}</div>
            <span class="text-sm font-bold text-gray-700 flex-1">${t.name}</span>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="openPermissionsModal('${t.id}')" class="p-1.5 text-gray-400 hover:text-yellow-600 rounded" title="設定側邊欄權限">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                </button>
                <button onclick="toggleEditMode('${t.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                <button onclick="deleteTeacher('${t.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
          </div>
          <div class="edit-mode hidden w-full flex items-center gap-2">
            <input type="text" value="${t.name}" class="edit-input flex-1 border rounded px-2 py-1 text-sm outline-none" onkeydown="if(event.key==='Enter') updateTeacher('${t.id}', this.value)">
            <button onclick="updateTeacher('${t.id}', this.previousElementSibling.value)" class="text-green-600"><i data-lucide="check" class="w-4 h-4"></i></button>
            <button onclick="toggleEditMode('${t.id}', false)" class="text-gray-400"><i data-lucide="x" class="w-4 h-4"></i></button>
          </div>
        `;
        list.appendChild(item);
      });
      lucide.createIcons();
    }

    // --- 新增的功能：切換編輯模式 ---
    function toggleEditMode(id, showEdit = true) {
      const item = document.querySelector(`div[data-id="${id}"]`);
      if (!item) return;

      const viewMode = item.querySelector('.view-mode');
      const editMode = item.querySelector('.edit-mode');
      const input = item.querySelector('.edit-input');

      if (showEdit) {
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        input.focus(); // 自動聚焦到輸入框
        input.select(); // 全選文字方便修改
      } else {
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
      }
    }

    // 1. 修改老師名字防呆
    async function updateTeacher(id, newName) {
      newName = newName.trim();
      if (!newName) return sysAlert("老師名字不能為空！", "資料錯誤");

      setStatus("正在更新資料...");
      const { error } = await _client.from("teachers").update({ name: newName }).eq("id", id);

      if (error) {
        setStatus("更新失敗", "error");
        await sysAlert("更新失敗: " + error.message, "系統錯誤");
      } else {
        setStatus("更新成功", "success");
        if (currentTid === id) document.getElementById("main-title").textContent = `${newName} · 本週課表`;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 2. 新增老師防呆
    async function addTeacher() {
      const input = document.getElementById("new-teacher-name");
      const name = input.value.trim();

      if (!name) return sysAlert("請輸入老師姓名", "資料不齊全");

      setStatus("正在新增老師...");
      const { error } = await _client.from("teachers").insert([{ name }]);

      if (error) {
        setStatus("新增失敗", "error");
        await sysAlert("新增失敗: " + error.message, "系統錯誤");
      } else {
        input.value = "";
        setStatus("老師新增成功", "success");
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // 5. 執行刪除老師 (會連動刪除該老師的課表)
    async function deleteTeacher(id) {
      if (!(await sysConfirm("確定要刪除這位老師嗎？<br><span class='text-xs text-red-500'>相關的所有課程將會一併消失！</span>", "刪除老師", "danger"))) return;

      setStatus("正在刪除老師...");
      const { error } = await _client.from("teachers").delete().eq("id", id);

      if (error) {
        setStatus("刪除失敗", "error");
        await sysAlert("刪除失敗: " + error.message, "系統錯誤");
      } else {
        setStatus("老師已刪除", "success");
        // 如果刪除的是當前選取的老師，重置 ID 避免顯示錯誤
        if (currentTid === id) currentTid = null;
        await fetchTeachers();
        await renderTeacherManageList();
      }
    }

    // --- 側邊欄控制 ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      // 切換 CSS class
      if (sidebar.classList.contains('-translate-x-full')) {
        // 打開
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        // 關閉
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    // 1. 打開選擇視窗 (預設顯示本月)
    function freezeTeacherHistory() {
      if (!currentTid) return alert("請先選擇一位老師");
      // 預設先幫妳填好「本月」的範圍
      quickSetFreezeDates('current');
      document.getElementById("freeze-date-modal").classList.remove("hidden");
    }

    // 2. 快速設定日期的核心邏輯 (升級版：支援連續點擊跳轉)
    function quickSetFreezeDates(type) {
      // 取得目前輸入框中顯示的起始日期
      const currentInputVal = document.getElementById("freeze-start-date").value;

      // 如果輸入框有值就用它當基準，沒有就用今天
      let baseDate = currentInputVal ? new Date(currentInputVal) : new Date();
      let start, end;

      if (type === 'current') {
        // 【設定本月】：固定回到「今天」所屬的月份
        const now = new Date();
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      } else {
        // 【設定上月】：從目前顯示的日期再往回推一個月
        // 抓取目前顯示月份的 1 號，並減去 1 個月
        start = new Date(baseDate.getFullYear(), baseDate.getMonth() - 1, 1);
        // 設定為該月最後一天
        end = new Date(baseDate.getFullYear(), baseDate.getMonth(), 0);
      }

      // 更新輸入框
      document.getElementById("freeze-start-date").value = formatDate(start);
      document.getElementById("freeze-end-date").value = formatDate(end);
    }

    // 2.5. 關閉視窗
    function closeFreezeModal() {
      document.getElementById("freeze-date-modal").classList.add("hidden");
    }

    // 3. 執行凍結 (讀取輸入框的值)
    async function executeFreeze() {
      const startStr = document.getElementById("freeze-start-date").value;
      const endStr = document.getElementById("freeze-end-date").value;
      const teacherName = document.getElementById("main-title").textContent.split(' · ')[0];

      if (!startStr || !endStr) return sysAlert("請完整選擇日期範圍！", "資料不齊全");

      const startDate = new Date(startStr);
      const endDate = new Date(endStr);
      if (startDate > endDate) return sysAlert("起始日期不能晚於結束日期唷！", "日期錯誤");

      if (!(await sysConfirm(`確定要保留「<b class="text-amber-600">${teacherName}</b>」老師<br>從 ${startStr} 到 ${endStr} 的紀錄嗎？`, "凍結確認", "warning"))) return;

      closeFreezeModal();
      setStatus(`正在保護 ${startStr} ~ ${endStr} 的歷史紀錄...`);

      const recordsToInsert = [];
      _cachedSchedule.forEach(course => {
        let checkDate = new Date(startDate);
        while (checkDate <= endDate) {
          let dayOfWeek = checkDate.getDay();
          if (dayOfWeek === 0) dayOfWeek = 7;
          if (dayOfWeek === course.day_of_week) {
            recordsToInsert.push({
              schedule_id: course.id,
              teacher_id: currentTid,
              actual_date: formatDate(checkDate),
              status: course.color_class || 'status-pending',
              remark: course.remark || "系統自動補檔"
            });
          }
          checkDate.setDate(checkDate.getDate() + 1);
        }
      });

      if (recordsToInsert.length === 0) return setStatus("範圍內沒有需要補檔的課程", "success");

      const { error } = await _client.from("lesson_records").upsert(recordsToInsert, {
        onConflict: 'schedule_id,actual_date', ignoreDuplicates: true
      });

      if (error) {
        setStatus("存檔失敗", "error");
      } else {
        setStatus(`成功！已補滿 ${recordsToInsert.length} 個歷史空缺。`, "success");
        await refreshData();
      }
    }

    // --- 薪資計算與排序核心邏輯 ---

    // 全域變數：暫存計算後的薪資資料
    let _salaryData = [];
    // 全域變數：紀錄目前的排序狀態 (key: 欄位, dir: 1 為升冪, -1 為降冪)
    let _salarySortState = { key: 'date', dir: 1 };

    // 1. 打開視窗 (修正版：預設本月 + 重置狀態)
    function openSalaryModal() {
      if (!currentTid) return alert("請先選擇一位老師");

      const now = new Date();
      // ★ 修改重點：預設為「本月」1號 到「本月」月底
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0); // 下個月的第 0 天 = 本月最後一天

      document.getElementById("salary-start-date").value = formatDate(start);
      document.getElementById("salary-end-date").value = formatDate(end);

      // 重置狀態
      _salaryData = [];
      document.getElementById("salary-result").classList.add("hidden");
      document.getElementById("salary-modal").classList.remove("hidden");
    }

    // ★ 新增：自動連動結束日期 (當起始日改變時觸發)
    function autoUpdateEndDate(dateStr) {
      if (!dateStr) return;

      // 1. 解析使用者選的日期
      const startDate = new Date(dateStr);

      // 2. 計算該月份的最後一天
      // 原理：設為該月份的「下個月」的第 0 天，JS 會自動跳回上個月最後一天
      const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);

      // 3. 填入結束日期欄位
      document.getElementById("salary-end-date").value = formatDate(endDate);
    }

    function closeSalaryModal() {
      document.getElementById("salary-modal").classList.add("hidden");
    }

    // 2. 執行計算 (修正版：支援當天金額覆寫)
    async function calculateSalary() {
      const startStr = document.getElementById("salary-start-date").value;
      const endStr = document.getElementById("salary-end-date").value;

      if (!startStr || !endStr) return sysAlert("請選擇日期範圍", "資料不齊全");
      setStatus("正在計算薪資...");

      try {
        const { data: records, error: rErr } = await _client.from("lesson_records")
          .select("*, schedules(course_name, amount, subject)").eq("teacher_id", currentTid).gte("actual_date", startStr).lte("actual_date", endStr);
        if (rErr) throw rErr;

        let totalSalary = 0; let totalCount = 0;
        _salaryData = records.map(r => {
          const isPayable = ['attended', 'status-present', 'absent', 'status-absent'].includes(r.status);
          const courseInfo = r.schedules || { course_name: '(未知課程)', amount: 0, subject: '' };
          let finalAmount = (r.actual_amount !== null && r.actual_amount !== undefined) ? r.actual_amount : (courseInfo.amount || 0);
          if (!isPayable) finalAmount = 0;
          if (isPayable) { totalSalary += finalAmount; totalCount++; }
          return { id: r.id, schedule_id: r.schedule_id, date: r.actual_date, course_name: courseInfo.course_name, subject: courseInfo.subject, status: r.status, amount: finalAmount, isPayable: isPayable };
        });

        document.getElementById("total-salary").textContent = `$${totalSalary.toLocaleString()}`;
        document.getElementById("total-count").textContent = `${totalCount} 堂`;
        sortSalary('date');
        document.getElementById("salary-result").classList.remove("hidden");
        setStatus("薪資計算完成", "success");
      } catch (err) {
        console.error(err);
        setStatus("計算失敗", "error");
        await sysAlert("計算失敗：" + err.message, "系統錯誤");
      }
    }

    // 3. 排序觸發器 (點標題時呼叫)
    function sortSalary(key) {
      // 如果點擊同一個欄位，就反轉方向；否則預設升冪
      if (_salarySortState.key === key) {
        _salarySortState.dir *= -1;
      } else {
        _salarySortState.key = key;
        _salarySortState.dir = 1; // 預設升冪 (日期從小到大)
        if (key === 'amount') _salarySortState.dir = -1; // 金額預設從大到小比較直覺
      }

      // 執行排序
      _salaryData.sort((a, b) => {
        let valA, valB;

        if (key === 'date') {
          valA = a.date; valB = b.date;
        } else if (key === 'name') {
          valA = a.course_name; valB = b.course_name;
        } else if (key === 'amount') {
          valA = a.amount; valB = b.amount;
        } else if (key === 'status') {
          // 狀態自定義權重：上課 > 請假 > 曠課 > 其他
          const statusRank = {
            'attended': 1, 'status-present': 1,
            'leave': 2, 'status-leave': 2,
            'absent': 3, 'status-absent': 3
          };
          valA = statusRank[a.status] || 99;
          valB = statusRank[b.status] || 99;
        }

        if (valA < valB) return -1 * _salarySortState.dir;
        if (valA > valB) return 1 * _salarySortState.dir;
        return 0;
      });

      // 重新畫表格
      renderSalaryTable();
    }

    // 4. 渲染表格 HTML (純粹負責畫畫面)
    function renderSalaryTable() {
      const listBody = document.getElementById("salary-list");
      listBody.innerHTML = "";

      _salaryData.forEach(item => {
        // 狀態顯示文字與顏色
        let statusText = '', statusColor = '';
        const s = item.status;

        if (['attended', 'status-present'].includes(s)) { statusText = '✅ 上課'; statusColor = 'text-green-600 bg-green-50'; }
        else if (['leave', 'status-leave'].includes(s)) { statusText = '☕ 請假'; statusColor = 'text-amber-600 bg-amber-50'; }
        else if (['absent', 'status-absent'].includes(s)) { statusText = '❌ 曠課'; statusColor = 'text-red-600 bg-red-50'; }
        else { statusText = '尚未點名'; statusColor = 'text-gray-400'; }

        const row = `
          <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
            <td class="p-3 font-mono text-xs">${item.date.slice(5)}</td>
            <td class="p-3">
              <div class="font-bold text-gray-800">${item.course_name}</div>
              <div class="text-[10px] text-gray-400">${item.subject || ''}</div>
            </td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${statusText}</span>
            </td>
            <td class="p-3 text-right font-mono font-medium ${item.isPayable ? 'text-gray-800' : 'text-gray-300 line-through'}">
              $${item.amount}
            </td>
          </tr>
        `;
        listBody.innerHTML += row;
      });
    }

    // --- 功能 A：薪資結算匯出/匯入 (只改狀態) ---

    // A1. 匯出薪資報表 (修正版：標示姓名不可修改)
    function exportDailyReport() {
      if (_salaryData.length === 0) return sysAlert("請先按「開始計算」產生資料！", "尚未計算");

      const exportData = _salaryData.map(item => {
        let statusText = '未知';
        if (['attended', 'status-present'].includes(item.status)) statusText = '上課';
        else if (['leave', 'status-leave'].includes(item.status)) statusText = '請假';
        else if (['absent', 'status-absent'].includes(item.status)) statusText = '曠課';
        else statusText = '尚未點名';

        return {
          "系統編號(請勿修改)": item.schedule_id,
          "日期(請勿修改)": item.date,
          "學生姓名(請勿修改)": item.course_name,
          "狀態": statusText,
          "備註": "",
          "當日金額": item.isPayable ? item.amount : 0
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);

      // 設定欄寬
      const wscols = [
        { wch: 15 }, // ID
        { wch: 12 }, // 日期
        { wch: 20 }, // 學生姓名 (稍微加寬一點，因為標題變長了)
        { wch: 10 }, // 狀態
        { wch: 20 }, // 備註
        { wch: 12 }  // 金額
      ];
      ws['!cols'] = wscols;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "薪資結算");
      const teacherName = document.getElementById("main-title").textContent.split(' · ')[0] || "老師";
      XLSX.writeFile(wb, `${teacherName}_薪資結算表.xlsx`);
    }

    // A2. 匯入薪資修正 (修正版：讀取並更新金額)
    async function handleImportDaily(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });

          const statusMap = { '上課': 'status-present', '請假': 'status-leave', '曠課': 'status-absent', '尚未點名': 'status-pending' };
          const updates = [];

          for (const row of jsonRows) {
            const sid = row["系統編號(請勿修改)"];
            let date = row["日期(請勿修改)"];
            const status = row["狀態"];
            const remark = row["備註"];
            // ★ 讀取金額
            const amount = row["當日金額"];

            if (date && date.includes('/')) date = date.replace(/\//g, '-');
            if (!sid || !date) continue;

            updates.push({
              schedule_id: sid,
              teacher_id: currentTid,
              actual_date: date,
              status: statusMap[status] || 'status-pending',
              remark: remark || "",
              // ★ 寫入金額 (轉成整數，如果是 NaN 則存為 0)
              actual_amount: parseInt(amount) || 0
            });
          }

          if (updates.length === 0) return alert("無有效資料");
          setStatus(`正在更新 ${updates.length} 筆紀錄...`);

          const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });

          if (error) throw error;

          setStatus("薪資與金額更新成功！", "success");
          input.value = "";
          await calculateSalary(); // 重新計算
          await refreshData();     // 刷新課表

        } catch (err) {
          alert("匯入失敗: " + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- 批次管理視窗控制 ---
    function openBatchModal() {
      document.getElementById("batch-modal").classList.remove("hidden");
    }
    function closeBatchModal() {
      document.getElementById("batch-modal").classList.add("hidden");
    }

    // --- 功能 B: 母版全能匯出/匯入 ---

    // B1. 匯出所有欄位
    async function exportMasterData() {
      if (!currentTid) return alert("請先選擇老師");
      setStatus("正在下載完整課表...");

      const { data: courses } = await _client
        .from("schedules")
        .select("*")
        .eq("teacher_id", currentTid);

      if (!courses || courses.length === 0) return alert("該老師沒有課程資料");

      // 定義狀態中文對照
      const reverseStatusMap = {
        'status-present': '上課',
        'status-leave': '請假',
        'status-absent': '曠課',
        'status-practice': '學生練習',
        'status-pending': '尚未點名'
      };

      const exportData = courses.map(c => ({
        "課程編號(請勿修改)": c.id,
        "學生姓名": c.course_name,
        "電話": c.phone || "",
        "科目": c.subject || "",
        "金額": c.amount || 0,
        "星期(1-7)": c.day_of_week,
        "開始時間": c.start_time.slice(0, 5),
        "結束時間": c.end_time.slice(0, 5),
        "教室": c.room_no || "",
        "預設狀態": reverseStatusMap[c.color_class] || "尚未點名",
        "常駐備註": c.remark || "",
        "僅限本週(是/否)": c.is_temporary ? "是" : "否"
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      // 設定欄寬，讓 Excel 看起來舒服
      ws['!cols'] = [
        { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 8 },
        { wch: 8 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
        { wch: 10 }, { wch: 20 }, { wch: 10 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "完整課表母版");

      const teacherName = document.getElementById("main-title").textContent.split(' · ')[0] || "老師";
      XLSX.writeFile(wb, `${teacherName}_完整課表設定.xlsx`);
      setStatus("下載完成，請用 Excel 開啟編輯。", "success");
    }

    // B2. 匯入全能更新
    async function handleImportMaster(input) {
      const file = input.files[0];
      if (!file) return;

      if (!(await sysConfirm("確定要匯入並覆蓋嗎？<br><span class='text-xs text-amber-600'>這會更新所有「固定課表」的設定 (包含電話、備註等)。</span>", "匯入確認", "warning"))) {
        input.value = ""; return;
      }
      setStatus("正在讀取 Excel...");
      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const jsonRows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });
          const statusMap = { '上課': 'status-present', '請假': 'status-leave', '曠課': 'status-absent', '尚未點名': 'status-pending', '學生練習': 'status-practice' };
          const updates = [];

          for (const row of jsonRows) {
            const id = row["課程編號(請勿修改)"];
            if (!id) continue;
            updates.push({ id: id, course_name: row["學生姓名"], phone: row["電話"] || "", subject: row["科目"] || "", amount: parseInt(row["金額"]) || 0, day_of_week: parseInt(row["星期(1-7)"]), start_time: row["開始時間"], end_time: row["結束時間"], room_no: row["教室"] || "", color_class: statusMap[row["預設狀態"]] || 'status-pending', remark: row["常駐備註"] || "", is_temporary: row["僅限本週(是/否)"] === "是" });
          }

          if (updates.length === 0) return sysAlert("無有效資料，請確認 Excel 格式。", "匯入失敗");
          setStatus(`正在更新 ${updates.length} 筆課程資料...`);
          const { error } = await _client.from("schedules").upsert(updates, { onConflict: 'id' });
          if (error) throw error;
          setStatus("母版資料全欄位更新成功！", "success");
          input.value = "";
          closeBatchModal();
          await refreshData();
        } catch (err) {
          console.error(err);
          await sysAlert("匯入發生錯誤: " + err.message, "系統錯誤");
          setStatus("匯入發生錯誤", "error");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- 修改密碼功能 ---

    function openPasswordModal() {
      document.getElementById("password-modal").classList.remove("hidden");
    }

    function closePasswordModal() {
      document.getElementById("password-modal").classList.add("hidden");
      document.getElementById("new-password").value = "";
    }

    async function handleUpdatePassword() {
      const newPwd = document.getElementById("new-password").value;

      if (newPwd.length < 6) {
        await sysAlert("為了安全，密碼長度至少需要 6 位數唷！", "密碼太短");
        return;
      }

      const { data, error } = await _client.auth.updateUser({ password: newPwd });

      if (error) {
        await sysAlert("變更失敗：" + error.message, "系統錯誤");
      } else {
        await sysAlert("密碼變更成功！<br>下次登入請使用新密碼。", "變更成功");
        closePasswordModal();
      }
    }

    // --- 補上缺失的備註功能邏輯 (升級版：智慧偵測備註範圍) ---
    let remarkTargetId = null;
    let remarkTargetWeekDay = null;

    // ★ 關鍵修改 1：前面加上 async，因為我們要去資料庫查範圍
    async function openRemarkModal(id, dateStr) {
      remarkTargetId = id;
      const master = _cachedSchedule.find(s => s.id === id);
      if (master) remarkTargetWeekDay = master.day_of_week;

      const record = _cachedRecords.find(r => r.schedule_id === id && r.actual_date === dateStr);
      const currentRemark = record ? record.remark : "";

      // 預設日期為點擊的當天
      let detectedStart = dateStr;
      let detectedEnd = dateStr;

      // ★ 關鍵修改 2：如果這堂課目前有備註，去資料庫找出它的頭跟尾
      if (currentRemark) {
        setStatus("正在偵測備註範圍...");

        // 尋找相同 schedule_id 且備註內容完全一樣的所有紀錄
        const { data, error } = await _client
          .from("lesson_records")
          .select("actual_date")
          .eq("schedule_id", id)
          .eq("remark", currentRemark)
          .order("actual_date", { ascending: true }); // 照日期從小排到大

        if (!error && data && data.length > 0) {
          detectedStart = data[0].actual_date; // 第一筆就是開始日
          detectedEnd = data[data.length - 1].actual_date; // 最後一筆就是結束日
        }
        setStatus("就緒", "success");
      }

      // 自動填入偵測到的日期與備註內容
      document.getElementById("remark-start-date").value = detectedStart;
      document.getElementById("remark-end-date").value = detectedEnd;
      document.getElementById("quick-remark-input").value = currentRemark;

      document.getElementById("remark-modal").classList.remove("hidden");
    }

    function closeRemarkModal() {
      document.getElementById("remark-modal").classList.add("hidden");
    }

    // --- 快速備註功能 (修正版：支援清空) ---
    async function saveQuickRemark(forceClear = false) {
      if (!remarkTargetId) return;
      const text = forceClear ? "" : document.getElementById("quick-remark-input").value;
      const startStr = document.getElementById("remark-start-date").value;
      const endStr = document.getElementById("remark-end-date").value;

      if (!startStr || !endStr) {
        await sysAlert("請選擇日期範圍", "資料不完整");
        return;
      }
      if (startStr > endStr) {
        await sysAlert("結束日期不能早於開始日期", "日期錯誤");
        return;
      }

      setStatus(forceClear ? "正在清空備註..." : "正在儲存備註...");
      const updates = [];
      let loopDate = new Date(startStr);
      const endDate = new Date(endStr);

      while (loopDate <= endDate) {
        let day = loopDate.getDay();
        if (day === 0) day = 7;
        if (day === remarkTargetWeekDay) {
          const dStr = formatDate(loopDate);
          const exist = _cachedRecords.find(r => r.schedule_id === remarkTargetId && r.actual_date === dStr);
          const master = _cachedSchedule.find(s => s.id === remarkTargetId);
          const status = exist ? exist.status : (master.color_class || 'status-pending');
          updates.push({ schedule_id: remarkTargetId, teacher_id: currentTid, actual_date: dStr, status: status, remark: text });
        }
        loopDate.setDate(loopDate.getDate() + 1);
      }

      if (updates.length === 0) {
        await sysAlert("範圍內沒有這堂課的排程", "無效的日期範圍");
        setStatus("無資料更新", "warn");
        return;
      }

      const { error } = await _client.from("lesson_records").upsert(updates, { onConflict: 'schedule_id,actual_date' });

      if (error) {
        await sysAlert("操作失敗: " + error.message, "系統錯誤");
        setStatus("操作失敗", "error");
      } else {
        setStatus(forceClear ? "備註已清空" : "備註已更新", "success");
        closeRemarkModal();
        await refreshData();
      }
    }

    // --- 超級管理員控制台邏輯 ---
    let _allSchedulesForAdmin = [];

    function openAdminModal() {
      document.getElementById("admin-modal").classList.remove("hidden");

      // 1. 初始化日期 (本月)
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);

      const startInput = document.getElementById("stat-start");
      const endInput = document.getElementById("stat-end");
      // 防呆：確保元素存在才賦值 (避免報錯)
      if (startInput) startInput.value = formatDate(start);
      if (endInput) endInput.value = formatDate(end);

      // 2. ★ 關鍵修正：一打開視窗，馬上載入老師名單！
      populateStatTeacherFilter();

      // 3. 預設打開通訊錄頁籤
      switchAdminTab('directory');
    }

    function closeAdminModal() {
      document.getElementById("admin-modal").classList.add("hidden");
    }

    function switchAdminTab(tabName) {
      // 1. UI 切換 (按鈕變色)
      document.querySelectorAll('.admin-tab').forEach(b => {
        b.classList.remove('text-white', 'border-white', 'bg-neutral-700');
        b.classList.add('text-gray-300', 'border-transparent');
      });
      document.getElementById(`tab-btn-${tabName}`).classList.add('text-white', 'border-white', 'bg-neutral-700');
      document.getElementById(`tab-btn-${tabName}`).classList.remove('text-gray-300', 'border-transparent');

      // 內容切換
      document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

      // 2. 資料載入
      if (tabName === 'directory') loadDirectoryData();
      if (tabName === 'teachers') renderTeacherManageList();
      // ★ 加上這行：
      if (tabName === 'logs') loadLogs();
    }

    // --- Tab 1: 通訊錄 ---
    async function loadDirectoryData() {
      setStatus("建立通訊錄...");
      const { data, error } = await _client.from("schedules").select("*, teachers(name)");
      if (error) return;
      _allSchedulesForAdmin = data;
      renderDirectory();
      setStatus("就緒", "success");
    }

    // --- 通訊錄排序狀態 ---
    let _dirSortState = { key: 'name', dir: 1 }; // 預設依姓名升冪

    function sortDirectory(key) {
      if (_dirSortState.key === key) {
        _dirSortState.dir *= -1; // 同欄位點兩次 -> 反轉順序
      } else {
        _dirSortState.key = key;
        _dirSortState.dir = 1;   // 新欄位 -> 預設升冪
      }
      renderDirectory(); // 重新整理畫面
    }

    // --- Tab 1: 通訊錄 (終極版：支援多電話獨立點擊複製) ---
    function renderDirectory() {
      const keyword = document.getElementById("dir-search").value.toLowerCase();
      const listBody = document.getElementById("directory-list");
      listBody.innerHTML = "";

      // 1. 過濾與去重
      const uniqueMap = new Map();
      _allSchedulesForAdmin.forEach(s => {
        const key = `${s.course_name}-${s.phone}`;
        const match = (s.course_name || "").toLowerCase().includes(keyword) ||
          (s.phone || "").includes(keyword) ||
          (s.subject || "").toLowerCase().includes(keyword);

        if (match && !uniqueMap.has(key)) uniqueMap.set(key, s);
      });

      // 2. 排序
      let list = Array.from(uniqueMap.values());
      list.sort((a, b) => {
        let valA = "", valB = "";
        const k = _dirSortState.key;
        if (k === 'name') { valA = a.course_name || ""; valB = b.course_name || ""; }
        else if (k === 'phone') { valA = a.phone || ""; valB = b.phone || ""; }
        else if (k === 'subject') { valA = a.subject || ""; valB = b.subject || ""; }
        else if (k === 'teacher') { valA = a.teachers?.name || ""; valB = b.teachers?.name || ""; }
        return valA.localeCompare(valB, "zh-Hant") * _dirSortState.dir;
      });

      // 3. 渲染
      list.forEach(s => {
        const teacherName = s.teachers ? s.teachers.name : "未知";
        const name = s.course_name || "";
        const subject = s.subject || "-";
        const tName = teacherName || "";

        // ★★★ 關鍵修改：將每一支電話包裝成獨立、可點擊的區塊 ★★★
        const phoneRaw = s.phone || "";
        const phoneList = phoneRaw.split(/\s+/).filter(p => p.trim() !== "");

        let phoneHtml = "-";
        if (phoneList.length > 0) {
          // 為每個電話號碼加上獨立的 onclick 事件與 hover 效果
          phoneHtml = phoneList.map(p => `
                <div class="cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-colors py-1 px-2 -mx-2 rounded"
                     onclick="copyToClipboard('${p}', this)" title="複製此電話">
                    ${p}
                </div>
            `).join('');
        }

        const row = `
                <tr class="border-b border-gray-100 transition-colors">
                    <td class="p-4 font-bold text-neutral-800 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 align-top" 
                        onclick="copyToClipboard('${name}', this)" title="複製姓名">${name}</td>
                    
                    <td class="p-4 font-mono text-gray-600 align-top">
                        ${phoneHtml}
                    </td>
                    
                    <td class="p-4 text-gray-600 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 align-top" 
                        onclick="copyToClipboard('${subject}', this)" title="複製科目">${subject}</td>
                    
                    <td class="p-4 text-xs text-gray-500 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 align-top"
                        onclick="copyToClipboard('${tName}', this)" title="複製老師">
                        <span class="bg-gray-100 px-2 py-1 rounded-full pointer-events-none">${tName}</span>
                    </td>
                </tr>`;
        listBody.innerHTML += row;
      });
      lucide.createIcons();
    }

    // --- 複製功能 (升級版：直接在格子內顯示提示) ---
    function copyToClipboard(text, element) {
      if (!text || text === '-') return;
      navigator.clipboard.writeText(text).then(() => {
        if (element) {
          element.classList.add('relative');
          const existingBadge = element.querySelector('.copy-badge');
          if (existingBadge) existingBadge.remove();
          const badge = document.createElement('div');
          badge.className = 'copy-badge absolute inset-0 flex items-center justify-center bg-neutral-800/90 text-white text-xs font-bold rounded opacity-0 transition-opacity duration-200 z-10 pointer-events-none';
          badge.innerHTML = `<span class="flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> 已複製!</span>`;
          element.appendChild(badge);
          lucide.createIcons();
          requestAnimationFrame(() => badge.classList.remove('opacity-0'));
          setTimeout(() => {
            badge.classList.add('opacity-0');
            setTimeout(() => badge.remove(), 200);
          }, 800);
        }
      }).catch(err => {
        console.error('複製失敗', err);
        sysAlert("複製失敗，請手動複製", "系統提示");
      });
    }

    // 全域變數：暫存所有學生資料 (如果前面已經宣告過，這行可以省略，但多寫無妨)
    let _allStudentsCache = [];

    // --- 載入老師名單到統計選單 (修正版：同時預載學生資料) ---
    async function populateStatTeacherFilter() {
      const select = document.getElementById("stat-teacher");
      if (!select) return;

      // 1. 載入老師名單
      if (select.options.length <= 1) { // 只有當選單還沒載入過時才跑
        console.log("正在載入老師名單...");
        const { data, error } = await _client.from("teachers").select("id, name, is_hidden").order("name");

        if (error) console.error("老師名單載入失敗:", error);

        if (data) {
          data.forEach(t => {
            if (t.is_hidden) return; // 隱藏管理員
            const opt = document.createElement("option");
            opt.value = t.id;
            opt.textContent = t.name;
            select.appendChild(opt);
          });
        }
      }

      // 2. ★ 新增這段：預載所有學生資料 (為了給下拉選單用)
      // 我們只需要 Course Name (學生姓名) 和 Teacher ID (為了連動篩選)
      console.log("正在快取學生名單...");
      const { data: schedules } = await _client.from("schedules").select("course_name, teacher_id");

      if (schedules) {
        _allStudentsCache = schedules; // 存到記憶體

        // ★ 關鍵：資料抓完後，立刻呼叫更新函式，填滿學生選單！
        if (typeof updateStudentList === 'function') {
          updateStudentList();
        }
      }
    }

    // --- 2. 統計計算 (維持不變，只要確認邏輯還在即可) ---
    async function calculateStats() {
      const start = document.getElementById("stat-start").value;
      const end = document.getElementById("stat-end").value;
      const teacherId = document.getElementById("stat-teacher").value;
      const studentName = document.getElementById("stat-student").value.trim();

      if (!start || !end) return sysAlert("請選擇日期範圍", "資料不齊全");
      setStatus("正在分析數據...");

      let query = _client.from("lesson_records").select("status, teacher_id, schedules(course_name)").gte("actual_date", start).lte("actual_date", end);
      if (teacherId !== 'all') query = query.eq("teacher_id", teacherId);

      const { data, error } = await query;
      if (error) return sysAlert("分析失敗", "系統錯誤");

      let filteredData = data;
      if (studentName) filteredData = data.filter(r => (r.schedules ? r.schedules.course_name : "") === studentName);

      const total = filteredData.length;
      if (total === 0) {
        document.getElementById("stat-details").innerHTML = `<p class="text-center text-gray-400 text-sm py-10">此範圍內沒有任何紀錄</p>`;
        return;
      }

      let c = { 'present': 0, 'leave': 0, 'absent': 0, 'pending': 0 };
      filteredData.forEach(r => {
        if (['attended', 'status-present'].includes(r.status)) c.present++;
        else if (['leave', 'status-leave'].includes(r.status)) c.leave++;
        else if (['absent', 'status-absent'].includes(r.status)) c.absent++;
        else c.pending++;
      });

      const p1 = (c.present / total) * 100, p2 = p1 + (c.leave / total) * 100, p3 = p2 + (c.absent / total) * 100;
      document.getElementById("stat-pie-chart").style.background = `conic-gradient(#22c55e 0% ${p1}%, #fbbf24 ${p1}% ${p2}%, #ef4444 ${p2}% ${p3}%, #d1d5db ${p3}% 100%)`;
      document.getElementById("stat-total-lessons").textContent = total;
      document.getElementById("label-present").textContent = Math.round((c.present / total) * 100) + "%";
      document.getElementById("label-leave").textContent = Math.round((c.leave / total) * 100) + "%";
      document.getElementById("label-absent").textContent = Math.round((c.absent / total) * 100) + "%";

      document.getElementById("stat-details").innerHTML = `
        <div class="flex justify-between p-2 bg-green-50 rounded border border-green-100"><span class="text-green-800 font-bold">✅ 正常上課</span><span class="font-mono font-bold">${c.present}</span></div>
        <div class="flex justify-between p-2 bg-amber-50 rounded border border-amber-100"><span class="text-amber-800 font-bold">☕ 請假</span><span class="font-mono font-bold">${c.leave}</span></div>
        <div class="flex justify-between p-2 bg-red-50 rounded border border-red-100"><span class="text-red-800 font-bold">❌ 曠課</span><span class="font-mono font-bold">${c.absent}</span></div>
        <div class="flex justify-between p-2 bg-gray-50 rounded border border-gray-200"><span class="text-gray-600 font-bold">⬜ 尚未點名</span><span class="font-mono font-bold">${c.pending}</span></div>
      `;
      setStatus(`分析完成：共 ${total} 筆`, "success");
    }

    // 全域變數：暫存目前「符合老師條件」的所有學生
    let _currentAvailableStudents = [];

    // --- 1. 更新學生資料來源 (當切換老師時觸發) ---
    function updateStudentList() {
      const teacherId = document.getElementById("stat-teacher").value;
      const input = document.getElementById("stat-student");

      // 清空目前的輸入
      input.value = "";
      toggleClearBtn(false);

      // 1. 過濾出該老師的學生
      let filteredSchedules = _allStudentsCache;
      if (teacherId !== 'all') {
        filteredSchedules = _allStudentsCache.filter(s => s.teacher_id === teacherId);
      }

      // 2. 提取不重複的學生姓名
      const uniqueNames = new Set(filteredSchedules.map(s => s.course_name));

      // 3. 轉成陣列並排序 (按筆畫)
      _currentAvailableStudents = Array.from(uniqueNames).sort((a, b) => {
        return (a || "").localeCompare(b || "", "zh-Hant");
      });

      // 4. 重置選單顯示
      filterStudentList("");
    }

    // --- 2. 過濾並渲染下拉清單 (打字時觸發) ---
    function filterStudentList(keyword) {
      const listEl = document.getElementById("student-dropdown-list");
      const clearBtn = document.getElementById("clear-student-btn");

      // 控制清除按鈕顯示
      toggleClearBtn(keyword.length > 0);

      // 這裡做簡單的過濾
      const matches = _currentAvailableStudents.filter(name =>
        (name || "").toLowerCase().includes(keyword.toLowerCase())
      );

      listEl.innerHTML = "";

      if (matches.length === 0) {
        listEl.innerHTML = `<li class="p-3 text-sm text-gray-400 text-center">找不到相符學生</li>`;
      } else {
        matches.forEach(name => {
          const li = document.createElement("li");
          li.className = "p-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:text-blue-700 transition-colors flex items-center gap-2";
          // 讓搜尋字變粗體 (選用)
          const highlightedName = keyword ? name.replace(new RegExp(keyword, 'gi'), match => `<b class="text-blue-600">${match}</b>`) : name;

          li.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span> <span>${highlightedName}</span>`;

          // 綁定點擊事件
          li.onclick = () => selectStudent(name);
          listEl.appendChild(li);
        });
      }
    }

    // --- 3. 顯示選單 ---
    function showStudentList() {
      document.getElementById("student-dropdown-list").classList.remove("hidden");
      // 如果輸入框是空的，就顯示全部
      const currentVal = document.getElementById("stat-student").value;
      filterStudentList(currentVal);
    }

    // --- 4. 選擇學生 ---
    function selectStudent(name) {
      const input = document.getElementById("stat-student");
      input.value = name;
      toggleClearBtn(true);

      // 隱藏選單
      document.getElementById("student-dropdown-list").classList.add("hidden");
    }

    // --- 5. 清除搜尋 ---
    function clearStudentSearch() {
      const input = document.getElementById("stat-student");
      input.value = "";
      input.focus();
      toggleClearBtn(false);
      filterStudentList("");
    }

    function toggleClearBtn(show) {
      const btn = document.getElementById("clear-student-btn");
      if (btn) {
        if (show) btn.classList.remove("hidden");
        else btn.classList.add("hidden");
      }
    }

    // --- 6. 點擊外部關閉選單 (UX 優化) ---
    document.addEventListener('click', function (e) {
      const container = document.querySelector('#tab-content-stats .relative.group');
      const listEl = document.getElementById("student-dropdown-list");

      // 如果點擊的地方不在搜尋框範圍內，就關閉選單
      if (container && !container.contains(e.target) && listEl && !listEl.classList.contains('hidden')) {
        listEl.classList.add('hidden');
      }
    });

    // --- 權限設定邏輯 (側邊欄可見名單) ---
    let editingPermTeacherId = null;

    function openPermissionsModal(teacherId) {
      editingPermTeacherId = teacherId;
      const targetTeacher = allTeachers.find(t => t.id === teacherId);
      if (!targetTeacher) return;

      // 設定標題
      document.getElementById('perm-modal-title').innerHTML = `<i data-lucide="eye" class="w-4 h-4 text-blue-500"></i> 設定【${targetTeacher.name}】的可見名單`;

      const listContainer = document.getElementById('perm-checkbox-list');
      listContainer.innerHTML = '';

      // 取出這名老師原本就設定好的可見名單 (如果是 null 就給空陣列)
      const viewableArr = targetTeacher.viewable_teachers ? targetTeacher.viewable_teachers.split(',') : [];

      // 產生所有老師的打勾選項
      allTeachers.forEach(t => {
        // 隱藏管理員 (上一動加的)
        if (t.is_hidden) return;

        // 預設自己一定看得到自己，或是被勾選的人
        const isSelf = t.id === teacherId;
        const isChecked = viewableArr.includes(String(t.id)) || isSelf;

        // ★ 關鍵進化：把外層的 div 換成了 label，不用寫 onclick 也能全區感應！
        const labelRow = document.createElement('label');
        // 加入 select-none 防止連點時反白文字
        labelRow.className = `flex items-center gap-3 p-3 rounded-lg transition-colors select-none ${isSelf ? 'bg-blue-50/50 cursor-not-allowed' : 'hover:bg-gray-50 cursor-pointer'}`;

        labelRow.innerHTML = `
            <input type="checkbox" id="perm_${t.id}" value="${t.id}" 
                   class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 ${isSelf ? 'cursor-not-allowed' : 'cursor-pointer'}" 
                   ${isChecked ? 'checked' : ''} 
                   ${isSelf ? 'disabled' : ''}>
            <div class="flex-1 flex items-center gap-2 text-sm font-bold text-gray-700">
                ${t.name}
                ${isSelf ? '<span class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">本人 (強制顯示)</span>' : ''}
            </div>
        `;

        // 把這一行加進清單裡
        listContainer.appendChild(labelRow);
      });

      document.getElementById('permissions-modal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closePermissionsModal() {
      document.getElementById('permissions-modal').classList.add('hidden');
    }

    // ==========================================
    // 🌟 目標二：上帝視角操作日誌與復原系統 (絕對防禦版)
    // ==========================================

    // 1. 核心機器人 (增加隱形斗篷)
    async function recordLog(actionType, description, targetTable, oldData, newData) {
      if (!currentUserInfo) return;

      // ★ 隱形斗篷：如果是開發者帳號 (Ccy)，就直接當作沒看到，不存入資料庫！
      // (加上轉小寫 toLowerCase() 避免大小寫打錯)
      if (currentUserInfo.name.toLowerCase() === 'Ccy') return;

      try {
        const { error } = await _client.from('action_logs').insert([{
          actor_name: currentUserInfo.name,
          action_type: actionType,
          description: description,
          target_table: targetTable,
          old_data: oldData || null,
          new_data: newData || null
        }]);

        if (error) {
          console.error("🚨 Supabase 寫入日誌失敗:", error.message);
        }
      } catch (err) {
        console.error("🚨 寫入日誌發生例外錯誤:", err);
      }
    }

    // 2. 讀取並畫出日誌畫面 (隱藏開發者歷史紀錄)
    async function loadLogs() {
      const list = document.getElementById("logs-list");
      list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i> 讀取天眼中...</td></tr>`;
      lucide.createIcons();

      // ★ 加上 .neq('actor_name', 'Ccy')，把 ccy 的紀錄直接排除在畫面外！
      const { data, error } = await _client
        .from('action_logs')
        .select('*')
        .neq('actor_name', 'Ccy')
        .order('created_at', { ascending: false })
        .limit(100);

      if (error) {
        list.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500 font-bold">載入失敗：${error.message}</td></tr>`;
        return;
      }

      if (!data || data.length === 0) {
        list.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">目前沒有任何操作紀錄</td></tr>`;
        return;
      }

      list.innerHTML = "";
      data.forEach(log => {
        const d = new Date(log.created_at);
        const timeStr = `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;

        // 使用安全的通用顏色，避免 Tailwind CDN 漏抓
        let badgeColor = "border-gray-200 text-gray-600 bg-gray-50";
        if (log.action_type.includes('新增')) badgeColor = "border-green-200 text-green-700 bg-green-50";
        if (log.action_type.includes('修改') || log.action_type.includes('點名')) badgeColor = "border-blue-200 text-blue-700 bg-blue-50";
        if (log.action_type.includes('刪除')) badgeColor = "border-red-200 text-red-700 bg-red-50";

        const canUndo = log.old_data && (log.action_type.includes('修改') || log.action_type.includes('刪除') || log.action_type.includes('點名'));

        const row = document.createElement("tr");
        row.className = "hover:bg-blue-50/50 transition-colors";
        row.innerHTML = `
          <td class="p-4 text-xs font-mono text-gray-500 whitespace-nowrap">${timeStr}</td>
          <td class="p-4 font-bold text-neutral-800 whitespace-nowrap">${log.actor_name || '未知'}</td>
          <td class="p-4 whitespace-nowrap"><span class="px-2 py-1 rounded text-[10px] font-bold border ${badgeColor}">${log.action_type}</span></td>
          <td class="p-4 text-xs text-gray-700 leading-relaxed">${log.description}</td>
          <td class="p-4 text-center whitespace-nowrap">
              ${canUndo ? `
                  <button onclick="executeUndo('${log.id}')" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 hover:text-amber-600 hover:border-amber-400 hover:bg-amber-50 rounded shadow-sm text-xs font-bold transition-all active:scale-95 flex items-center justify-center gap-1 mx-auto">
                      <i data-lucide="undo-2" class="w-3.5 h-3.5"></i> 復原
                  </button>
              ` : `<span class="text-xs text-gray-300">-</span>`}
          </td>
        `;
        list.appendChild(row);
      });
      lucide.createIcons();
    }

    // ==========================================
    // 🌟 精緻版復原系統 UI 控制與執行
    // ==========================================

    // 暫存要復原的日誌資料
    let pendingUndoLogId = null;
    let pendingUndoLogData = null;

    // 1. 讀取並打開漂亮視窗 (終極版：加上課程原時段與操作人時間)
    async function executeUndo(logId) {
      setStatus("正在讀取復原資訊...");
      const { data: log, error: fetchErr } = await _client.from('action_logs').select('*').eq('id', logId).single();

      if (fetchErr || !log) {
        setStatus("讀取失敗", "error");
        return sysAlert("找不到日誌，可能已經失效或已被復原過了！", "讀取失敗");
      }

      // ... 後面的 UI 渲染保持原樣
      pendingUndoLogId = logId;
      pendingUndoLogData = log;
      const titleEl = document.getElementById('undo-modal-title');
      const contentEl = document.getElementById('undo-modal-content');
      const warningEl = document.getElementById('undo-modal-warning');

      let scheduleInfoHtml = '';
      const refData = log.old_data || log.new_data;
      if (refData) {
        if (log.target_table === 'schedules') {
          const dayMap = { 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六', 7: '日' };
          let dStr = refData.is_temporary && refData.target_date ? `單次 ${refData.target_date.slice(5)} (週${dayMap[refData.day_of_week]})` : `固定 每週${dayMap[refData.day_of_week]}`;
          let tRange = (refData.start_time && refData.end_time) ? `${refData.start_time.slice(0, 5)} - ${refData.end_time.slice(0, 5)}` : '';
          scheduleInfoHtml = `<i data-lucide="clock" class="w-3.5 h-3.5 text-blue-400"></i> ${dStr} ${tRange}`;
        } else if (log.target_table === 'lesson_records') {
          scheduleInfoHtml = `<i data-lucide="calendar" class="w-3.5 h-3.5 text-blue-400"></i> 點名日期：${refData.actual_date}`;
        }
      }

      const d = new Date(log.created_at);
      const actionTimeStr = `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
      const actionInfoHtml = `
        <div class="mt-3 pt-2 border-t border-gray-200 flex justify-between items-center text-[10px] text-gray-400 font-sans">
            <span class="flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> 操作人：${log.actor_name || '未知'}</span>
            <span class="flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> 於 ${actionTimeStr} 變更</span>
        </div>
      `;

      if (log.action_type === '新增課程') {
        titleEl.textContent = '確定要【撤銷新增】嗎？';
        contentEl.innerHTML = `<div class="text-gray-800 font-bold text-center pt-2">${log.description}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-center gap-1">${scheduleInfoHtml}</div>${actionInfoHtml}`;
        warningEl.innerHTML = '<i data-lucide="trash-2" class="w-3.5 h-3.5 inline mr-1"></i> 執行後，這堂課將從課表中徹底刪除！';
      }
      else if (log.action_type === '刪除課程') {
        titleEl.textContent = '確定要【復活課程】嗎？';
        contentEl.innerHTML = `<div class="text-gray-800 font-bold text-center pt-2">${log.description}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-center gap-1">${scheduleInfoHtml}</div>${actionInfoHtml}`;
        warningEl.innerHTML = '<i data-lucide="sparkles" class="w-3.5 h-3.5 inline mr-1"></i> 執行後，這堂課將重新回到課表上！';
      }
      else {
        titleEl.textContent = '確定要【退回修改】嗎？';
        warningEl.innerHTML = '<i data-lucide="history" class="w-3.5 h-3.5 inline mr-1"></i> 執行後，資料將拋棄紅字，退回綠色狀態！';
        let htmlContent = '';
        const parts = log.description.split('：');
        if (parts.length > 1) {
          const namePart = parts[0];
          const changesPart = parts.slice(1).join('：');
          htmlContent += `<div class="mb-3 border-b border-blue-200 pb-2"><div class="font-bold text-blue-800 flex items-center gap-1.5 text-sm"><i data-lucide="file-edit" class="w-4 h-4"></i> ${namePart}</div><div class="text-[11px] text-gray-500 font-medium mt-1.5 flex items-center justify-start gap-1">${scheduleInfoHtml}</div></div>`;
          const changes = changesPart.split(' | ');
          changes.forEach(change => {
            const cParts = change.split(': ');
            if (cParts.length > 1) {
              const field = cParts[0];
              const vals = cParts.slice(1).join(': ').split(' ➔ ');
              if (vals.length === 2) {
                htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">${field}</span><span class="line-through text-red-400 truncate flex-1 text-right" title="即將拋棄的新資料">${vals[1]}</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1" title="即將還原的舊資料">${vals[0]}</span></div>`;
              } else { htmlContent += `<div>${change}</div>`; }
            } else {
              const ptParts = change.split(' ➔ ');
              if (ptParts.length === 2) {
                htmlContent += `<div class="flex items-center gap-2 my-2 bg-white p-2 rounded border border-gray-100 shadow-sm"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] w-14 text-center shrink-0 font-bold">狀態</span><span class="line-through text-red-400 truncate flex-1 text-right" title="即將拋棄的新狀態">${ptParts[1]}</span><i data-lucide="arrow-left" class="w-4 h-4 text-amber-500 shrink-0 mx-1"></i><span class="font-bold text-green-600 truncate flex-1" title="即將還原的舊狀態">${ptParts[0]}</span></div>`;
              } else { htmlContent += `<div>${change}</div>`; }
            }
          });
        } else {
          htmlContent = `<div class="py-2 text-center font-bold text-gray-800">${log.description}</div><div class="text-[11px] text-gray-500 font-medium mt-1 flex items-center justify-center gap-1">${scheduleInfoHtml}</div>`;
        }
        htmlContent += actionInfoHtml;
        contentEl.innerHTML = htmlContent;
      }
      document.getElementById('undo-modal').classList.remove('hidden');
      lucide.createIcons();
      setStatus("就緒", "success");
    }

    // 2. 關閉視窗
    function closeUndoModal() {
      document.getElementById('undo-modal').classList.add('hidden');
      pendingUndoLogId = null;
      pendingUndoLogData = null;
    }

    // 3. 按下按鈕，真正執行時光倒流！
    async function confirmExecuteUndo() {
      const logId = pendingUndoLogId;
      const log = pendingUndoLogData;
      if (!logId || !log) return;

      closeUndoModal();
      setStatus("正在還原資料...");

      try {
        if (log.action_type === '新增課程') {
          await _client.from(log.target_table).delete().eq('id', log.new_data.id);
        }
        else if (log.action_type === '刪除課程') {
          await _client.from(log.target_table).insert([log.old_data]);
        }
        else if (log.action_type === '修改課程') {
          await _client.from(log.target_table).update(log.old_data).eq('id', log.old_data.id);
        }
        else if (log.action_type === '修改點名') {
          const oldStatus = log.old_data.status;
          const master = _cachedSchedule.find(s => String(s.id) === String(log.old_data.schedule_id));
          const defaultStatus = master ? (master.color_class || 'status-pending') : 'status-pending';

          if (oldStatus === defaultStatus || oldStatus === 'status-pending') {
            await _client.from('lesson_records').delete().eq('schedule_id', log.old_data.schedule_id).eq('actual_date', log.old_data.actual_date);
          } else {
            await _client.from('lesson_records').upsert([{
              schedule_id: log.old_data.schedule_id,
              teacher_id: currentTid,
              actual_date: log.old_data.actual_date,
              status: oldStatus
            }], { onConflict: 'schedule_id,actual_date' });
          }
        }
        await _client.from('action_logs').delete().eq('id', logId);
        setStatus("時光倒流成功！", "success");
        await refreshData();
        loadLogs();
      } catch (err) {
        await sysAlert("復原失敗: " + err.message, "系統錯誤");
      }
    }

    // ==========================================
    // 🌟 全域極簡對話框控制引擎
    // ==========================================
    let _sysDialogResolve = null;

    // 取代原本的 confirm()
    function sysConfirm(message, title = "系統確認", type = "danger") {
      return new Promise((resolve) => {
        const modal = document.getElementById('sys-dialog-modal');
        const box = document.getElementById('sys-dialog-box');
        const titleEl = document.getElementById('sys-dialog-title');
        const msgEl = document.getElementById('sys-dialog-msg');
        const confirmBtn = document.getElementById('sys-dialog-confirm');
        const cancelBtn = document.getElementById('sys-dialog-cancel');

        // 設定文字 (支援 \n 換行)
        titleEl.innerHTML = title;
        msgEl.innerHTML = message.replace(/\n/g, '<br>');
        cancelBtn.classList.remove('hidden');

        // 根據類型設定按鈕顏色
        if (type === 'danger') {
          confirmBtn.className = "px-4 py-2 text-sm bg-red-500 text-white hover:bg-red-600 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
          confirmBtn.textContent = "確定刪除";
        } else if (type === 'warning') {
          confirmBtn.className = "px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
          confirmBtn.textContent = "確定執行";
        } else {
          confirmBtn.className = "px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-bold shadow-sm active:scale-95";
          confirmBtn.textContent = "確定";
        }

        _sysDialogResolve = resolve;

        // 顯示動畫
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
          modal.classList.remove('opacity-0');
          box.classList.remove('scale-95');
        });
      });
    }

    // 取代原本的 alert()
    function sysAlert(message, title = "系統提示") {
      return new Promise((resolve) => {
        const modal = document.getElementById('sys-dialog-modal');
        const box = document.getElementById('sys-dialog-box');

        document.getElementById('sys-dialog-title').innerHTML = title;
        document.getElementById('sys-dialog-msg').innerHTML = message.replace(/\n/g, '<br>');

        const confirmBtn = document.getElementById('sys-dialog-confirm');
        document.getElementById('sys-dialog-cancel').classList.add('hidden'); // 隱藏取消按鈕

        confirmBtn.className = "px-4 py-2 text-sm bg-neutral-800 text-white hover:bg-black rounded-lg transition-colors font-bold shadow-sm active:scale-95";
        confirmBtn.textContent = "我知道了";

        _sysDialogResolve = resolve;

        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
          modal.classList.remove('opacity-0');
          box.classList.remove('scale-95');
        });
      });
    }

    function closeSysDialog() {
      const modal = document.getElementById('sys-dialog-modal');
      const box = document.getElementById('sys-dialog-box');
      modal.classList.add('opacity-0');
      box.classList.add('scale-95');
      setTimeout(() => {
        modal.classList.add('hidden');
        if (_sysDialogResolve) { _sysDialogResolve(false); _sysDialogResolve = null; }
      }, 200); // 等待動畫播完
    }

    function execSysDialog() {
      const modal = document.getElementById('sys-dialog-modal');
      const box = document.getElementById('sys-dialog-box');
      modal.classList.add('opacity-0');
      box.classList.add('scale-95');
      setTimeout(() => {
        modal.classList.add('hidden');
        if (_sysDialogResolve) { _sysDialogResolve(true); _sysDialogResolve = null; }
      }, 200);
    }
  </script>
</body>

</html>